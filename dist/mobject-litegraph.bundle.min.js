/**
 * MIT License
 *
 * Copyright (c) 2024 benhar-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Third Party Licenses
 * --------------------
 *
 * MIT License
 * 
 * Copyright (C) 2013 by Javi Agenjo
 * Copyright (C) 2022 by atlasan
 * Copyright (C) 2024 by Daniel Lewis
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).MobjectLitegraph={})}(this,(function(exports){"use strict";function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=Array(t);n<t;n++)i[n]=e[n];return i}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _assertClassBrand(e,t,n){if("function"==typeof e?e===t:e.has(t))return arguments.length<3?t:n;throw new TypeError("Private element is not present on this object")}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _callSuper(e,t,n){return t=_getPrototypeOf(t),_possibleConstructorReturn(e,_isNativeReflectConstruct()?Reflect.construct(t,n||[],_getPrototypeOf(e).constructor):t.apply(e,n))}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}function _construct(e,t,n){if(_isNativeReflectConstruct())return Reflect.construct.apply(null,arguments);var i=[null];i.push.apply(i,t);var o=new(e.bind.apply(e,i));return n&&_setPrototypeOf(o,n.prototype),o}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,_toPropertyKey(i.key),i)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return r=e.done,e},e:function(e){s=!0,a=e},f:function(){try{r||null==n.return||n.return()}finally{if(s)throw a}}}}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _isNativeReflectConstruct(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(_isNativeReflectConstruct=function(){return!!e})()}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,o,a,r,s=[],l=!0,h=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(i=a.call(n)).done)&&(s.push(i.value),s.length!==t);l=!0);}catch(e){h=!0,o=e}finally{try{if(!l&&null!=n.return&&(r=n.return(),Object(r)!==r))return}finally{if(h)throw o}}return s}}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var i=n.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}var LLink=function(){return _createClass((function e(t,n,i,o,a,r){_classCallCheck(this,e),this.id=t,this.type=n,this.origin_id=i,this.origin_slot=o,this.target_id=a,this.target_slot=r,this._data=null,this._pos=new Float32Array(2)}),[{key:"configure",value:function(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)}},{key:"serialize",value:function(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}])}(),CallbackHandler=function(){return _createClass((function e(t){_classCallCheck(this,e),_defineProperty(this,"debug",!1),_defineProperty(this,"registerCallbackHandler",(function(e,t,n){n&&"object"===_typeof(n)||(n={});if(n=Object.assign({priority:0,is_default:!1,call_once:!1},n),"function"!=typeof t)return"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_error("registerCallbackHandler","Invalid callback"),!1;void 0===this.callbacks_handlers[e]&&(this.callbacks_handlers[e]={last_id:0,handlers:[]});var i=this.callbacks_handlers[e].last_id++;return"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("registerCallbackHandler","new callback handler",e,i),this.callbacks_handlers[e].handlers.push({id:i,priority:n.priority,callback:t,data:n}),this.callbacks_handlers[e].handlers.sort((function(e,t){return t.priority-e.priority})),i})),this.callbacks_handlers={},this.ob_ref=t,"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("CallbackHandler Initialize callbacks",t)}),[{key:"unregisterCallbackHandler",value:function(e,t){if(void 0!==this.callbacks_handlers[e]){var n=this.callbacks_handlers[e].handlers.length;if(this.callbacks_handlers[e].handlers=this.callbacks_handlers[e].handlers.filter((function(n){return n.id===t&&LiteGraph.log_info("unregisterCallbackHandler",e,t),n.id!==t})),this.callbacks_handlers[e].handlers.length<n)return!0}return LiteGraph.log_warn("unregisterCallbackHandler","no handlers for",e,t),!1}},{key:"processCallbackHandlers",value:function(e,t){t&&"object"===_typeof(t)||(t={});t=Object.assign({def_cb:!1},t);var n=this;"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose.apply(LiteGraph,["**processCallbackHandlers**"].concat(Array.prototype.slice.call(arguments))),void 0===this.callbacks_handlers[e]&&(this.callbacks_handlers[e]={last_id:0,handlers:[]});var i,o=[].slice.call(arguments).slice(2),a=null,r=null,s=[],l={},h=!1,u=!1,c=!1,p=function(){var e;u||"function"!=typeof t.def_cb?"function"==typeof t.def_cb&&n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","preventing default passed",t.def_cb):(n.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose.apply(LiteGraph,["Calling DEFAULT w Args"].concat(_toConsumableArray(o))),a=(e=t.def_cb).call.apply(e,[n.ob_ref].concat(_toConsumableArray(o))),n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","default callback executed",a),d());h=!0},d=function(){if(s.push(a),n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stepRet check",a),"object"==_typeof(a)){if(n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result is object",a),void 0!==a.prevent_default&&a.prevent_default&&(u=!0),void 0!==a.return_value?(n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result from object",a,l),r=a):(n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result, not object",a,l),r=a),void 0!==a.stop_replication&&a.stop_replication)return n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stop_replication",l),void(c=!0)}else n.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result NOT object",a),null!=a&&(r=a)},_=_createForOfIteratorHelper(this.callbacks_handlers[e].handlers);try{for(_.s();!(i=_.n()).done;){var g,v=i.value;if(u&&v.is_default)"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","preventing default registered",v);else{if(v.priority<0&&!h&&("object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","process default passed","nextCb:",v),p(),c))break;if(l={name:e,id:v.id,current_return_value:r,data:v.data,results_chain:s},a=(g=v.callback).call.apply(g,[this.ob_ref,l].concat(_toConsumableArray(o))),"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","callback executed",a,l),d(),"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","result checked","cbRet",r,"aResChain",s,"cbResPriority",0,"defCbChecked",h,"preventDefCb",u,"breakCycle",c),c)break;v.data.call_once&&(this.unregisterCallbackHandler(e,v.id),"object"==_typeof(this)&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","unregistered call_once",l))}}}catch(e){_.e(e)}finally{_.f()}return h||p(),r}}])}(),DragAndScale=function(){return _createClass((function e(t,n){var i=this;_classCallCheck(this,e),_defineProperty(this,"onMouseDown",(function(e){if(i.enabled){var t=i.element.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;e.canvasx=n,e.canvasy=o,e.dragging=i.dragging,(!i.viewport||i.viewport&&n>=i.viewport[0]&&n<i.viewport[0]+i.viewport[2]&&o>=i.viewport[1]&&o<i.viewport[1]+i.viewport[3])&&(i.dragging=!0,i.abortController=new AbortController,document.addEventListener("pointermove",i.onMouseMove,{signal:i.abortController.signal}),document.addEventListener("pointerup",i.onMouseUp,{signal:i.abortController.signal})),i.last_mouse[0]=n,i.last_mouse[1]=o}})),_defineProperty(this,"onMouseMove",(function(e){if(i.enabled){var t=i.element.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;e.canvasx=n,e.canvasy=o,e.dragging=i.dragging;var a=n-i.last_mouse[0],r=o-i.last_mouse[1];i.dragging&&i.mouseDrag(a,r),i.last_mouse[0]=n,i.last_mouse[1]=o}})),_defineProperty(this,"onMouseUp",(function(e){var t;i.dragging=!1,null===(t=i.abortController)||void 0===t||t.abort()})),_defineProperty(this,"onWheel",(function(e){e.wheel=-e.deltaY,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,i.changeDeltaScale(1+.05*e.delta)})),this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),t&&(this.element=t,n||this.bindEvents(t))}),[{key:"bindEvents",value:function(e){this.last_mouse=new Float32Array(2),e.addEventListener("pointerdown",this.onMouseDown),e.addEventListener("wheel",this.onWheel)}},{key:"computeVisibleArea",value:function(e){if(this.element){var t=this.element.width,n=this.element.height,i=-this.offset[0],o=-this.offset[1];if(e){i+=e[0]/this.scale,o+=e[1]/this.scale;var a=_slicedToArray(e.slice(2),2);t=a[0],n=a[1]}var r=[i,o,i+t/this.scale-i,o+n/this.scale-o];return this.visible_area.set(r),r}this.visible_area.set([0,0,0,0])}},{key:"toCanvasContext",value:function(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])}},{key:"convertOffsetToCanvas",value:function(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]}},{key:"convertCanvasToOffset",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0];return t[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t}},{key:"mouseDrag",value:function(e,t){var n;this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,null===(n=this.onredraw)||void 0===n||n.call(this,this)}},{key:"changeScale",value:function(e,t){var n;if(LiteGraph.log_debug("dragandscale","changeScale",e,t),(e=LiteGraph.clamp(e,this.min_scale,this.max_scale))!=this.scale&&this.element){var i=this.element.getBoundingClientRect();if(i){t=t||[.5*i.width,.5*i.height];var o=this.convertCanvasToOffset(t);LiteGraph.log_debug("dragandscale","changeScale","center",o),this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var a=this.convertCanvasToOffset(t);LiteGraph.log_debug("dragandscale","changeScale","new center",a);var r=[a[0]-o[0],a[1]-o[1]];LiteGraph.log_debug("dragandscale","changeScale",e,t),this.offset[0]+=r[0],this.offset[1]+=r[1],null===(n=this.onredraw)||void 0===n||n.call(this,this)}}}},{key:"changeDeltaScale",value:function(e,t){this.changeScale(this.scale*e,t)}},{key:"reset",value:function(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}])}(),_ContextMenu_brand=new WeakSet,ContextMenu=function(){function e(t){var n,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,e),_classPrivateMethodInitSpec(this,_ContextMenu_brand),this.options=o,null!==(n=o.scroll_speed)&&void 0!==n||(o.scroll_speed=.1),null!==(i=o.filter_enabled)&&void 0!==i||(o.filter_enabled=!0),this.menu_elements=[],_assertClassBrand(_ContextMenu_brand,this,_linkToParent).call(this),_assertClassBrand(_ContextMenu_brand,this,_validateEventClass).call(this),_assertClassBrand(_ContextMenu_brand,this,_createRoot).call(this),_assertClassBrand(_ContextMenu_brand,this,_bindEvents).call(this),this.setTitle(this.options.title),this.addItems(t),_assertClassBrand(_ContextMenu_brand,this,_insertMenu).call(this),_assertClassBrand(_ContextMenu_brand,this,_calculateBestPosition).call(this),LiteGraph.context_menu_filter_enabled&&o.filter_enabled&&this.createFilter(t,o)}return _createClass(e,[{key:"createFilter",value:function(e,t){var n=this;if(e&&e.length&&1!=e.length){var i=document.createElement("input");i.classList.add("context-menu-filter"),i.placeholder="Filter list",this.root.prepend(i);var o=Array.from(this.root.querySelectorAll(".litemenu-entry")),a=[].concat(o),r=a.length;console.info(t),requestAnimationFrame((function(){var s,l=t.extra,h=null==l||null===(s=l.widgets)||void 0===s||null===(s=s.filter((function(t){return"combo"===t.type&&t.options.values.length===e.length})).find((function(t){return t.options.values.every((function(t,n){return t===e[n]}))})))||void 0===s?void 0:s.value,u=h?e.findIndex((function(e){return e===h})):0;u<0&&(u=0);var c=a[u];function p(){var e,t,n,i;null===(e=c)||void 0===e||e.style.setProperty("background-color",""),null===(t=c)||void 0===t||t.style.setProperty("color",""),null===(n=c=a[u])||void 0===n||n.style.setProperty("background-color","#ccc","important"),null===(i=c)||void 0===i||i.style.setProperty("color","#000","important")}p();var d=function(){if(n.root.getBoundingClientRect().top<0){var e=1-n.root.getBoundingClientRect().height/n.root.clientHeight,t=n.root.clientHeight*e/2;n.root.style.top=-t+"px"}};i.addEventListener("keydown",(function(e){var t,i;switch(e.key){case"ArrowUp":e.preventDefault(),0===u?u=r-1:u--,p();break;case"ArrowRight":null===(t=c)||void 0===t||t.do_click(e);break;case"ArrowDown":e.preventDefault(),u===r-1?u=0:u++,p();break;case"ArrowLeft":var o=n.parentMenu;if(n.close(e,!0),o){var a=Array.from(o.root.querySelectorAll(".context-menu-filter"));a&&a.length&&(a[0].style.display="block",a[0].focus())}break;case"Enter":null===(i=c)||void 0===i||i.do_click(e);break;case"Escape":n.close()}})),i.addEventListener("input",(function(){var e=i.value.toLocaleLowerCase();if(a=o.filter((function(t){var n=!e||t.textContent.toLocaleLowerCase().includes(e);return t.style.display=n?"block":"none",n})),u=0,a.includes(c)&&(u=a.findIndex((function(e){return e===c}))),r=a.length,p(),t.event){var s=t.event.clientY-10,l=document.body.getBoundingClientRect(),h=n.root.getBoundingClientRect();l.height&&s>l.height-h.height-10&&(s=Math.max(0,l.height-h.height-10)),n.root.style.top=s+"px",d()}})),requestAnimationFrame((function(){i.focus(),d()}))}))}}},{key:"setTitle",value:function(e){var t;if(e){null!==(t=this.titleElement)&&void 0!==t||(this.titleElement=document.createElement("div"));var n=this.titleElement;n.className="litemenu-title",n.innerHTML=e,this.root.parentElement||this.root.appendChild(n)}}},{key:"addItems",value:function(e){for(var t=0;t<e.length;t++){var n=e[t];"string"!=typeof n&&(n=n&&void 0!==n.content?String(n.content):String(n));var i=e[t];this.addItem(n,i,this.options)}}},{key:"addItem",value:function(e,t){var n=this,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};LiteGraph.log_verbose.apply(LiteGraph,["contextmenu","addItem"].concat(Array.prototype.slice.call(arguments)));var o=document.createElement("div");o.className="litemenu-entry submenu";var a,r=!1,s=o;if(null===t)o.classList.add("separator");else if(o.innerHTML=null!==(a=null==t?void 0:t.title)&&void 0!==a?a:e,o.value=t,t&&(t.disabled&&(r=!0,o.classList.add("disabled")),(t.submenu||t.has_submenu)&&o.classList.add("has_submenu")),"function"==typeof t?(o.dataset.value=e,o.onclick_callback=t):o.dataset.value=t,t.className&&(o.className+=" "+t.className),void 0!==t.callbacks_on_element_created){"function"==typeof t.callbacks_on_element_created&&(t.callbacks_on_element_created=[t.callbacks_on_element_created]);var l=this;t.callbacks_on_element_created.forEach((function(e){"function"==typeof e&&(LiteGraph.log_debug("contextmenu","addItem","callbacks_on_element_created",o,e),e(o,l))}))}this.root.appendChild(o),r||(o.addEventListener("click",u),o.do_click=function(e,t){e?e.clientX?LiteGraph.log_verbose("contextmenu","addItem","do_click","has clientX",e):LiteGraph.log_warn("contextmenu","addItem","do_click","event has no clientX info",e):LiteGraph.log_warn.apply(LiteGraph,["contextmenu","addItem","do_click","has no event"].concat(Array.prototype.slice.call(arguments))),u.call(s,e,t)}),!r&&i.autoopen&&o.addEventListener("pointerenter",(function(e){var t=n.value;t&&t.has_submenu&&u.call(n,e)}));var h=this;function u(e){var t,n=this.value,o=!0;LiteGraph.log_debug("contextmenu","handleMenuItemClick","process",n,e,i,o,this.current_submenu,this),null===(t=h.current_submenu)||void 0===t||t.close(e);var a=Array.from(h.root.querySelectorAll(".context-menu-filter"));if(a&&a.length&&(a[0].style.display="none"),i.callback){LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback",this,n,i,e,h,i.node);var r=i.callback.call(this,n,i,e,h,i.node);!0===r?(LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, dont close parent?",r),o=!1):LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, will close parent",r)}if(n){if(n.callback&&!i.ignore_item_callbacks&&!0!==n.disabled)LiteGraph.log_debug("contextmenu","handleMenuItemClick","using value callback and !ignore_item_callbacks",this,n,i,e,h,i.node),!0===n.callback.call(this,n,i,e,h,i.extra)&&(o=!1);if(n.submenu){if(LiteGraph.log_debug("contextmenu","handleMenuItemClick","SUBMENU",this,n,n.submenu.options,e,h,i),!n.submenu.options)return void LiteGraph.log_warn("contextmenu","handleMenuItemClick","SUBMENU","submenu needs options");new h.constructor(n.submenu.options,{callback:n.submenu.callback,event:e,parentMenu:h,ignore_item_callbacks:n.submenu.ignore_item_callbacks,title:n.submenu.title,extra:n.submenu.extra,autoopen:i.autoopen}),o=!1}}o&&!h.lock&&h.close()}return this.menu_elements.push(o),o}},{key:"close",value:function(t,n){var i;this.parentMenu&&!n&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===t?this.parentMenu.close():t&&!e.isCursorOverElement(t,this.parentMenu.root)&&e.trigger(this.parentMenu.root,"pointerleave",t)),null===(i=this.current_submenu)||void 0===i||i.close(t,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}},{key:"getTopMenu",value:function(){var e,t;return null!==(e=null===(t=this.options.parentMenu)||void 0===t?void 0:t.getTopMenu())&&void 0!==e?e:this}},{key:"getFirstEvent",value:function(){var e,t;return null!==(e=null===(t=this.options.parentMenu)||void 0===t?void 0:t.getFirstEvent())&&void 0!==e?e:this.options.event}}],[{key:"trigger",value:function(e,t,n,i){var o=new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:n});return Object.defineProperty(o,"target",{value:i}),e.dispatchEvent?e.dispatchEvent(o):e.__events&&e.__events.dispatchEvent(o),o}},{key:"isCursorOverElement",value:function(e,t){return LiteGraph.isInsideRectangle(e.clientX,e.clientY,t.left,t.top,t.width,t.height)}}])}();function _createRoot(){var e=this.root=document.createElement("div");return this.options.className&&(e.className=this.options.className),e.classList.add("litegraph","litecontextmenu","litemenubar-panel"),e.style.minWidth="80px",e.style.minHeight="10px",e}function _bindEvents(){var e=this,t=this.root;LiteGraph.log_info("**contextmenu**","binding events on root",t,this),t.style.pointerEvents="none",setTimeout((function(){t.style.pointerEvents="auto"}),100),t.addEventListener("pointerup",(function(e){return e.preventDefault(),!0})),t.addEventListener("contextmenu",(function(e){return 2!=e.button||e.preventDefault(),!1})),t.addEventListener("pointerdown",(function(t){if(2==t.button)return e.close(),t.preventDefault(),!0})),t.addEventListener("wheel",(function(n){var i=parseInt(t.style.top);return t.style.top=(i+n.deltaY*e.options.scroll_speed).toFixed()+"px",n.preventDefault(),!0})),t.addEventListener("pointerenter",(function(e){t.closing_timer&&clearTimeout(t.closing_timer)}))}function _linkToParent(){var e=this.options.parentMenu;if(e){if(e.constructor!==this.constructor)return LiteGraph.log_error("contextmenu","linkToParent","parentMenu must be of class ContextMenu, ignoring it"),void(this.options.parentMenu=null);this.parentMenu=e,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this}}function _validateEventClass(){if(this.options.event)if(this.options.isCustomEvent)LiteGraph.log_verbose("contextmenu","linkToParent","Custom event for ContextMenu.",this.options.event);else{var e=this.options.event.constructor.name;"MouseEvent"!==e&&"CustomEvent"!==e&&"PointerEvent"!==e&&LiteGraph.log_warn("Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Was originally ignoring it. (".concat(e,")"))}}function _insertMenu(){var e,t,n,i=null!==(e=null===(t=this.options.event)||void 0===t?void 0:t.target.ownerDocument)&&void 0!==e?e:document,o=null!==(n=i.fullscreenElement)&&void 0!==n?n:i.body;this.root,o.appendChild(this.root)}function _calculateBestPosition(){var e=this.options,t=this.root,n=e.left||0,i=e.top||0;if(this.top_original=i,e.event){if(n=e.event.clientX-10,i=e.event.clientY-10,e.title&&(i-=20),this.top_original=i,e.parentMenu){var o=e.parentMenu.root.getBoundingClientRect();n=o.left+o.width}var a=document.body.getBoundingClientRect(),r=t.getBoundingClientRect();0===a.height&&LiteGraph.log_error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),a.width&&n>a.width-r.width-10&&(n=a.width-r.width-10),a.height&&i>a.height-r.height-10&&(i=a.height-r.height-10)}else LiteGraph.log_debug("contextmenu","calculateBestPosition","has no event");t.style.left="".concat(n,"px"),t.style.top="".concat(i,"px"),e.scale&&(t.style.transform="scale(".concat(e.scale,")"))}_defineProperty(ContextMenu,"closeAll",(function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:window,n=null==t||null===(e=t.document)||void 0===e?void 0:e.querySelectorAll(".litecontextmenu");n&&n.length&&n.forEach((function(e){var t;e.close?e.close():null===(t=e.parentNode)||void 0===t||t.removeChild(e)}))}));var LGraphCanvas=function(){function LGraphCanvas(e,t,n){var i,o=this;_classCallCheck(this,LGraphCanvas),_defineProperty(this,"processMouseWheel",(function(e){if(o.graph&&o.allow_dragcanvas){var t=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail;o.adjustMouseEvent(e);var n=e.clientX,i=e.clientY;if(!o.viewport||o.viewport&&n>=o.viewport[0]&&n<o.viewport[0]+o.viewport[2]&&i>=o.viewport[1]&&i<o.viewport[1]+o.viewport[3]){var a=o.ds.scale;t>0?a*=1.1:t<0&&(a*=1/1.1);var r=e.target.getBoundingClientRect();return o.setZoom(a,[e.clientX-r.left,e.clientY-r.top]),o.graph.change(),e.preventDefault(),!1}}})),_defineProperty(this,"processKey",(function(e){if(o.graph){var t=!1,n=null;if(LiteGraph.log_verbose("lgraphcanvas","processKey",e),"input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(o.dragging_canvas=!0,t=!0),27==e.keyCode&&(o.node_panel&&o.node_panel.close(),t=!0),65==e.keyCode&&e.ctrlKey&&(o.selectNodes(),t=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||o.selected_nodes&&(o.copyToClipboard(),t=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&o.pasteFromClipboard(e.shiftKey),(46==e.keyCode||LiteGraph.backspace_delete&&8==e.keyCode)&&"input"!=e.target.localName&&"textarea"!=e.target.localName&&(o.deleteSelectedNodes(),t=!0),LiteGraph.actionHistory_enabled&&(89==e.keyCode&&e.ctrlKey||90==e.keyCode&&e.ctrlKey&&e.shiftKey?o.graph.actionHistoryForward():90==e.keyCode&&e.ctrlKey&&o.graph.actionHistoryBack()),Object.keys(o.selected_nodes).length)for(var i in o.selected_nodes)null!==(n=o.selected_nodes[i].processCallbackHandlers("onKeyDown",{def_cb:o.selected_nodes[i].onKeyDown},e))&&(!0===n||"object"==_typeof(n)&&!0===n.return_value)&&(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),t=!0);null!==(n=o.processCallbackHandlers("onKeyDown",{def_cb:o.onKeyDown},e))&&(!0===n||"object"==_typeof(n)&&!0===n.return_value)?(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),t=!0):LiteGraph.log_verbose("lgraphcanvas","processKey","onKeyDown processed by CB handlers",n)}else if("keyup"==e.type&&(32==e.keyCode&&(o.dragging_canvas=!1),o.selected_nodes))for(var a in o.selected_nodes)o.selected_nodes[a].processCallbackHandlers("onKeyUp",{def_cb:o.selected_nodes[a].onKeyUp},e);return o.graph.change(),t?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}}})),_defineProperty(this,"processDrop",(function(e){e.preventDefault(),o.adjustMouseEvent(e);var t=null,n=e.clientX,i=e.clientY,a=!o.viewport||o.viewport&&n>=o.viewport[0]&&n<o.viewport[0]+o.viewport[2]&&i>=o.viewport[1]&&i<o.viewport[1]+o.viewport[3];if(a){if(n=e.localX,i=e.localY,a=!o.viewport||o.viewport&&n>=o.viewport[0]&&n<o.viewport[0]+o.viewport[2]&&i>=o.viewport[1]&&i<o.viewport[1]+o.viewport[3]){var r=[e.canvasX,e.canvasY],s=o.graph?o.graph.getNodeOnPos(r[0],r[1]):null;if(LiteGraph.log_verbose("graphcanvas processDrop","going to process",r,s),s){var l=e.dataTransfer.files;if(l&&l.length)for(var h=0;h<l.length;h++){var u=e.dataTransfer.files[0],c=u.name;if(LiteGraph.log_debug("lgraphcanvas","processDrop","file on node",u),!(t=s.processCallbackHandlers("onDropFile",{def_cb:s.onDropFile},u))||"object"==_typeof(t)&&!t.return_value){var p=new FileReader;p.onload=function(e){var t=e.target.result;LiteGraph.log_debug("lgraphcanvas","processDrop","data on node",t,c,u),s.processCallbackHandlers("onDropData",{def_cb:s.onDropData},t,c,u)};var d=u.type.split("/")[0];"text"==d||""==d?p.readAsText(u):"image"==d?p.readAsDataURL(u):p.readAsArrayBuffer(u)}}return!!(!0===(t=s.processCallbackHandlers("onDropItem",{def_cb:s.onDropItem},e))||"object"==_typeof(t)&&t.return_value)||(!!(!0===(t=o.processCallbackHandlers("onDropItem",{def_cb:o.onDropItem},e))||"object"==_typeof(t)&&t.return_value)||(LiteGraph.log_info("lgraphcanvas","processDrop","neither node and canvas has processed the drop"),!1))}return LiteGraph.log_verbose("lgraphcanvas","processDrop","look for drop implemetation in CANVAS",e),null===(t=o.processCallbackHandlers("onDropItem",{def_cb:o.onDropItem},e))||!t||"object"==_typeof(t)&&!t.return_value?(LiteGraph.log_verbose("lgraphcanvas","processDrop","running default implementation",e),o.checkDropItem(e),null===t?t:"object"==_typeof(t)?t.return_value:t):t}LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (local)",n,i)}else LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (client)",n,i)})),null!==(i=n)&&void 0!==i||(n={skip_render:!1,autoresize:!1,clip_all_nodes:!1,free_resize:!0,groups_alpha:.21,groups_border_alpha:.45,groups_triangle_handler_size:15,groups_title_font:"Arial",groups_title_alignment:"left",groups_title_font_size:24,groups_title_wrap:!0,groups_add_around_selected:!0,groups_add_default_spacing:15,hide_widget_label_when_small:150}),this.options=n,this.callbackhandler_setup(),this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font="".concat(LiteGraph.NODE_TEXT_SIZE,"px Arial"),this.inner_text_font="normal ".concat(LiteGraph.NODE_SUBTEXT_SIZE,"px Arial"),this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.move_destination_link_without_shift=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.autoresize=n.autoresize,this.skip_render=n.skip_render,this.clip_all_nodes=n.clip_all_nodes,this.free_resize=n.free_resize,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_widget=null,this.over_node=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=n.viewport||null,this.low_quality_rendering_threshold=5,null==t||t.attachCanvas(this),this.setCanvas(e,n.skip_events),this.clear(),this.skip_render||n.skip_render||this.startRendering(),this.callbackhandler_setup(),LiteGraph.processCallbackHandlers("on_lgraphcanvas_construct",{def_cb:LiteGraph.on_lgraphcanvas_construct},this)}return _createClass(LGraphCanvas,[{key:"callbackhandler_setup",value:function(){this.cb_handler=new CallbackHandler(this)}},{key:"registerCallbackHandler",value:function(){var e;return(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)}},{key:"unregisterCallbackHandler",value:function(){var e;return(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)}},{key:"processCallbackHandlers",value:function(){var e;return(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)}},{key:"clear",value:function(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.low_quality_rendering_counter=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.connecting=!1,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.processCallbackHandlers("onClear",{def_cb:this.onClear})}},{key:"setGraph",value:function(e,t){var n;this.graph!=e&&(t||this.clear(),e?(e.attachCanvas(this),LiteGraph.log_debug("lgraphcanvas","setGraph",e,this),this._graph_stack&&(this._graph_stack=null),this.setDirty(!0,!0)):null===(n=this.graph)||void 0===n||n.detachCanvas(this))}},{key:"getTopGraph",value:function(){return this._graph_stack.length?this._graph_stack[0]:this.graph}},{key:"openSubgraph",value:function(e){if(!e)throw new Error("graph cannot be null");if(this.graph==e)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||(this._graph_stack=[]),this._graph_stack.push(this.graph));var t=this.graph;this.processCallbackHandlers("onOpenSubgraph",{def_cb:this.onOpenSubgraph},e,t),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}},{key:"closeSubgraph",value:function(){if(this._graph_stack&&0!=this._graph_stack.length){var e=this.graph._subgraph_node,t=this.graph,n=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},this.processCallbackHandlers("onCloseSubgraph",{def_cb:this.onCloseSubgraph},n,t,e),n.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}}},{key:"getCurrentGraph",value:function(){return this.graph}},{key:"setCanvas",value:function(e,t){if(e&&e.constructor===String&&!(e=document.getElementById(e)))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null==e.getContext){if("canvas"!=e.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName);throw new Error("This browser doesn't support Canvas")}null==(this.ctx=e.getContext("2d"))&&(e.webgl_enabled||LiteGraph.log_info("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}}},{key:"_doNothing",value:function(e){return LiteGraph.log_verbose("pointerevents: _doNothing "+e.type),e.preventDefault(),!1}},{key:"_doReturnTrue",value:function(e){return e.preventDefault(),!0}},{key:"bindEvents",value:function(){if(this._events_binded)LiteGraph.log_warn("LGraphCanvas: events already binded");else{this._events_binded=!0;var e=this.canvas,t=this.getCanvasWindow().document;LiteGraph.log_info("[lgraphcanvas]","BINDing events",e,t),this._mousedown_callback=this.processMouseDown.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e.addEventListener("pointerdown",this._mousedown_callback),e.addEventListener("pointermove",this._mousemove_callback),e.addEventListener("pointerup",this._mouseup_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("wheel",this.processMouseWheel),e.addEventListener("keydown",this.processKey),t.addEventListener("keyup",this.processKey),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this.processDrop),e.addEventListener("dragenter",this._doReturnTrue,!1)}}},{key:"unbindEvents",value:function(){if(this._events_binded){this._events_binded=!1;var e=this.canvas,t=this.getCanvasWindow().document;LiteGraph.log_info("[lgraphcanvas]","UNbinding events",e,t),e.removeEventListener("pointerdown",this._mousedown_callback),e.removeEventListener("pointermove",this._mousemove_callback),e.removeEventListener("pointerup",this._mouseup_callback),e.removeEventListener("contextmenu",this._doNothing),e.removeEventListener("wheel",this.processMouseWheel),e.removeEventListener("keydown",this.processKey),t.removeEventListener("keyup",this.processKey),e.removeEventListener("dragover",this._doNothing,!1),e.removeEventListener("dragend",this._doNothing,!1),e.removeEventListener("drop",this.processDrop),e.removeEventListener("dragenter",this._doReturnTrue,!1),this._mousedown_callback=null}else LiteGraph.log_warn("LGraphCanvas: no events binded")}},{key:"enableWebGL",value:function(){if("undefined"==typeof GL)throw new Error("litegl.js must be included to use a WebGL canvas");if("undefined"==typeof enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}},{key:"setDirty",value:function(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)}},{key:"getCanvasWindow",value:function(){var e;if(!this.canvas)return window;var t=this.canvas.ownerDocument;return null!==(e=t.defaultView)&&void 0!==e?e:t.parentWindow}},{key:"startRendering",value:function(){this.is_rendering||(this.is_rendering=!0,function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}.call(this))}},{key:"stopRendering",value:function(){this.is_rendering=!1}},{key:"blockClick",value:function(){this.block_click=!0,this.last_mouseclick=0}},{key:"processUserInputDown",value:function(e){if(this.pointer_is_down&&void 0!==e.isPrimary&&!e.isPrimary?this.userInput_isNotPrimary=!0:this.userInput_isNotPrimary=!1,this.userInput_type=!!e.pointerType&&e.pointerType,this.userInput_id=!!e.pointerId&&e.pointerId,e.pointerType)switch(e.pointerType){case"mouse":case"pen":case"touch":break;default:LiteGraph.log_debug("pointerType unknown "+ev.pointerType)}return void 0!==e.button&&(this.userInput_button=e.button,LiteGraph.log_verbose("input button ",e.button),e.button),void 0!==e.buttons&&(this.userInput_button_s=e.buttons,LiteGraph.log_verbose("input button_S ",e.buttons)),this.userInput_touches=void 0!==e.changedTouches&&void 0!==e.changedTouches.length&&e.changedTouches,this.userInput_touches&&this.userInput_touches.length&&LiteGraph.log_debug("check multiTouches",e.changedTouches),this.processMouseDown(e)}},{key:"processMouseDown",value:function(e){var t=this;if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var n=this.getCanvasWindow();LGraphCanvas.active_canvas=this;var i=e.clientX,o=e.clientY;LiteGraph.log_debug("lgraphcanvas","processMouseDown","pointerId:"+e.pointerId+" which:"+e.which+" isPrimary:"+e.isPrimary+" :: x y "+i+" "+o,"previousClick",this.last_mouseclick,"diffTimeClick",this.last_mouseclick?LiteGraph.getTime()-this.last_mouseclick:"notlast"),LiteGraph.log_verbose("coordinates",i,o,this.viewport,"canvas coordinates",e.canvasX,e.canvasY),this.ds.viewport=this.viewport;var a=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&o>=this.viewport[1]&&o<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(this.canvas.removeEventListener("pointermove",this._mousemove_callback),n.document.addEventListener("pointermove",this._mousemove_callback,!0),n.document.addEventListener("pointerup",this._mouseup_callback,!0)),a){var r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),s=!1,l=LiteGraph.getTime(),h=void 0===e.isPrimary||e.isPrimary,u=l-this.last_mouseclick<300&&h;this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&h?(this.pointer_is_double=!0,LiteGraph.log_verbose("pointerevents: pointer_is_double start")):this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.ContextMenuClass.closeAll(n);var c=this.processCallbackHandlers("onClear",{def_cb:this.onMouse},e);if(null==c||!1!==c&&("object"!=_typeof(c)||!1!==c.return_value)){if(1!=e.which||this.userInput_isNotPrimary)if(2==e.which)if(LiteGraph.middle_click_slot_add_default_node){if(r&&this.allow_interaction&&!s&&!this.read_only&&!this.connecting_node&&!r.flags.collapsed&&!this.live_mode){var p=!1,d=!1,_=!1;if(r.outputs)for(var g=0,v=r.outputs.length;g<v;++g){var f=r.outputs[g],y=r.getConnectionPos(!1,g);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,y[0]-15,y[1]-10,30,20)){p=f,d=g,_=!0;break}}if(r.inputs)for(var b=0,k=r.inputs.length;b<k;++b){var L=r.inputs[b],m=r.getConnectionPos(!0,b);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,m[0]-15,m[1]-10,30,20)){p=L,d=b,_=!1;break}}if(LiteGraph.log_verbose("middleClickSlots? "+p+" & "+(!1!==d)),p&&!1!==d){var G=.5-(d+1)/(_?r.outputs.length:r.inputs.length),C=r.getBounding(),w=[_?C[0]+C[2]:C[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:_?r:null,slotFrom:_?d:null,nodeTo:_?null:r,slotTo:_?null:d,position:w,nodeType:"AUTO",posAdd:[_?30:-30,130*-G],posSizeFix:[_?0:-1,0]})}}}else!s&&this.allow_dragcanvas&&(LiteGraph.log_verbose("pointerevents: dragging_canvas start from middle button"),this.dragging_canvas=!0);else(3==e.which||LiteGraph.two_fingers_opens_menu&&this.userInput_isNotPrimary)&&(!this.allow_interaction||s||this.read_only||(r&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[r.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[r.id]||this.selectNodes([r],!0):this.selectNodes([r])),this.processContextMenu(r,e)));else{if(e.ctrlKey&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","starting box selection"),this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,s=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&r&&this.allow_interaction&&!s&&!this.read_only){LiteGraph.log_debug("lgraphcanvas","processMouseDown","cloning node");var E=r,T=r.clone();if(T){if(T.pos[0]+=5,T.pos[1]+=5,this.graph.add(T,!1,{doCalcSize:!1}),r=T,LiteGraph.alt_shift_drag_connect_clone_with_input&&e.shiftKey&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","altCloned",E,r),E.inputs&&E.inputs.length))for(var O=0;O<E.inputs.length;++O){var N=E.inputs[O];if(N&&null!=N.link){var S=this.graph.links[N.link];if(S)if(S.type!==LiteGraph.EVENT){var I;S.origin_id&&(I=this.graph.getNodeById(S.origin_id));var A=r;I&&A&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","alt drag cloning","connect newly created",I,A,S),I.connect(S.origin_slot,A,S.target_slot))}else LiteGraph.log_info("lgraphcanvas","processMouseDown","alt drag cloning","skip moving events",N);else LiteGraph.log_warn("lgraphcanvas","processMouseDown","not graph link info for input",N,E)}}s=!0,ee||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=r),this.selected_nodes[r.id]||this.processNodeSelected(r,e))}}var P=!1;if(!r||!this.allow_interaction&&!r.flags.allow_interaction||s||this.read_only){if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked outside nodes"),!s){if(!this.read_only)for(var x=0;x<this.visible_links.length;++x){var D=this.visible_links[x],H=D._pos;if(!(!H||e.canvasX<H[0]-4||e.canvasX>H[0]+4||e.canvasY<H[1]-4||e.canvasY>H[1]+4)){LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on link",D),this.showLinkMenu(D,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on group",D),e.ctrlKey&&(this.dragging_rectangle=null),LiteGraph.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<this.options.groups_triangle_handler_size?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();u&&!this.read_only&&this.allow_searchbox&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","showing search box"),this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),LiteGraph.log_debug("DEBUG canvas click is_double_click,this.allow_searchbox",u,this.allow_searchbox),P=!0}}else{if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicking on node"),this.live_mode||r.flags.pinned||this.bringToFront(r),this.allow_interaction&&!this.connecting_node&&!r.flags.collapsed&&!this.live_mode)if(!s&&!1!==r.resizable&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,r.pos[0]+r.size[0]-9,r.pos[1]+r.size[1]-9,18,18))LiteGraph.log_debug("lgraphcanvas","processMouseDown","start resizing node"),this.graph.beforeChange(),this.resizing_node=r,this.canvas.style.cursor="se-resize",s=!0;else{if(r.outputs)for(var M=0,R=r.outputs.length;M<R;++M){var B=r.outputs[M],F=r.getConnectionPos(!1,M);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,F[0]-15,F[1]-10,30,20)){if(this.connecting_node=r,this.connecting_output=B,this.connecting_output.slot_index=M,this.connecting_pos=r.getConnectionPos(!1,M),this.connecting_slot=M,LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on output slot",r,B),LiteGraph.shift_click_do_break_link_from)e.shiftKey&&r.disconnectOutput(M);else if(e.shiftKey){LiteGraph.log_debug("lgraphcanvas","processMouseDown","will move link source slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos);var j=[],z=[],U=[],W=[];if(null!==B.links&&B.links.length)for(var V in B.links){var X=!1,Y=this.graph.links[B.links[V]];Y&&this.graph._nodes_by_id[Y.target_id]&&(X=this.graph._nodes_by_id[Y.target_id])&&(j.push(Y),z.push(X),U.push(Y.target_slot),W.push({node:X,slot:Y.target_slot,link:Y}))}if(j.length){r.disconnectOutput(M),this.connecting_output=!1,this.connecting={inputs:W},LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving links source slot",this.connecting);var q=j[0];this.connecting_node=this.graph._nodes_by_id[q.target_id],this.connecting_slot=q.target_slot,this.connecting_input=this.connecting_node.inputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!0,this.connecting_slot),this.dirty_bgcanvas=!0,s=!0}}u?r.processCallbackHandlers("onOutputDblClick",{def_cb:r.onOutputDblClick},M,e):r.processCallbackHandlers("onOutputClick",{def_cb:r.onOutputClick},M,e),s=!0;break}}if(r.inputs)for(var K=0,Z=r.inputs.length;K<Z;++K){var J=r.inputs[K],Q=r.getConnectionPos(!0,K);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,Q[0]-15,Q[1]-10,30,20)){if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on input slot",r,J),u?r.processCallbackHandlers("onInputDblClick",{def_cb:r.onInputDblClick},K,e):r.processCallbackHandlers("onInputClick",{def_cb:r.onInputDblClick},K,e),null!==J.link){var $=this.graph.links[J.link];LiteGraph.click_do_break_link_to&&(r.disconnectInput(K),this.dirty_bgcanvas=!0,s=!0),e.shiftKey&&(LiteGraph.click_do_break_link_to||r.disconnectInput(K),this.connecting_node=this.graph._nodes_by_id[$.origin_id],this.connecting_slot=$.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving link destination slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos),this.dirty_bgcanvas=!0,s=!0)}s||(this.connecting_node=r,this.connecting_input=J,this.connecting_input.slot_index=K,this.connecting_pos=r.getConnectionPos(!0,K),this.connecting_slot=K,this.dirty_bgcanvas=!0,s=!0)}}}if(!s){LiteGraph.log_debug("lgraphcanvas","processMouseDown","check clicked on node",r);var ee=!1,te=[e.canvasX-r.pos[0],e.canvasY-r.pos[1]],ne=this.processNodeWidgets(r,this.graph_mouse,e);ne&&(ee=!0,this.node_widget=[r,ne]);var ie=null;this.allow_interaction&&u&&this.selected_nodes[r.id]&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","double clicked on node",r),null!==(ie=r.processCallbackHandlers("onDblClick",{def_cb:r.onDblClick},e,te,this))&&(!0===ie||"object"==_typeof(ie)&&ie.return_value)?LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onDblClick",ie):this.processNodeDblClicked(r),ee=!0),null!==(ie=r.processCallbackHandlers("onMouseDown",{def_cb:r.onMouseDown},e,te,this))&&(!0===ie||"object"==_typeof(ie)&&ie.return_value)?(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onMouseDownCbRet",ie),ee=!0):(r.subgraph&&!r.skip_subgraph_button&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on subgraph"),!r.flags.collapsed&&te[0]>r.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&te[1]<0&&setTimeout((function(){t.openSubgraph(r.subgraph)}),10)),this.live_mode&&(P=!0,ee=!0)),ee?r.is_selected||(LiteGraph.log_debug("lgraphcanvas","processMouseDown","node selected",r),this.processNodeSelected(r,e)):(this.allow_dragnodes&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","started dragging",r),this.graph.beforeChange(),this.node_dragged=r),this.processNodeSelected(r,e)),this.dirty_canvas=!0}}!s&&P&&this.allow_dragcanvas&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging_canvas start"),this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!n.document.activeElement||"input"!=n.document.activeElement.nodeName.toLowerCase()&&"textarea"!=n.document.activeElement.nodeName.toLowerCase())&&e.preventDefault(),e.stopPropagation(),this.processCallbackHandlers("onMouseDown",{def_cb:this.onMouseDown},e),!1}LiteGraph.log_info("lgraphcanvas","processMouseDown","callback prevents continue")}}}},{key:"processMouseMove",value:function(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var n=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return LiteGraph.log_verbose("lgraphcanvas","processMouseMove","block_click"),e.preventDefault(),!1;this.over_widget=!1,e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var i=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.over_node=i,this.dragging_rectangle)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","making rectangle"),this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","resizing group"),this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging group");var o=n[0]/this.ds.scale,a=n[1]/this.ds.scale;this.selected_group.move(o,a,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0),(o||a)&&this.processCallbackHandlers("onGroupMoving",{def_cb:this.onGroupMoving},this.selected_group,o,a)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging_canvas"),this.ds.offset[0]+=n[0]/this.ds.scale,this.ds.offset[1]+=n[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||i&&i.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(var r=0,s=this.graph._nodes.length;r<s;++r)this.graph._nodes[r].mouseOver&&i!=this.graph._nodes[r]&&(this.graph._nodes[r].mouseOver=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseLeave",{def_cb:this.node_over.onMouseLeave},e),this.node_over=null,this.dirty_canvas=!0);if(i){i.redraw_on_mouse&&(this.dirty_canvas=!0),i.mouseOver||(i.mouseOver=!0,this.node_over=i,this.dirty_canvas=!0,i.processCallbackHandlers("onMouseEnter",{def_cb:i.onMouseEnter},e)),i.processCallbackHandlers("onMouseMove",{def_cb:i.onMouseMove},e,[e.canvasX-i.pos[0],e.canvasY-i.pos[1]],this);var l,h=this.processNodeWidgets(i,this.graph_mouse);if(h&&(this.over_widget=h),this.connecting_node)if(this.connecting_output){if(l=this._highlight_input||[0,0],!this.isOverNodeBox(i,e.canvasX,e.canvasY)){var u=this.isOverNodeInput(i,e.canvasX,e.canvasY,l);if(-1!=u&&i.inputs[u]){var c=i.inputs[u].type;LiteGraph.isValidConnection(this.connecting_output.type,c)&&(this._highlight_input=l,this._highlight_input_slot=i.inputs[u])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input&&(l=this._highlight_output||[0,0],this.isOverNodeBox(i,e.canvasX,e.canvasY))){var p=this.isOverNodeOutput(i,e.canvasX,e.canvasY,l);if(-1!=p&&i.outputs[p]){var d=i.outputs[p].type;LiteGraph.isValidConnection(this.connecting_input.type,d)&&(this._highlight_output=l)}else this._highlight_output=null}this.canvas&&(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,i.pos[0]+i.size[0]-5,i.pos[1]+i.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{for(var _=null,g=0;g<this.visible_links.length;++g){var v=this.visible_links[g],f=v._pos;if(!(!f||e.canvasX<f[0]-4||e.canvasX>f[0]+4||e.canvasY<f[1]-4||e.canvasY>f[1]+4)){_=v;break}}_!=this.over_link_center&&(this.over_link_center=_,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=i&&this.node_capturing_input.processCallbackHandlers("onMouseMove",{def_cb:this.node_capturing_input.onMouseMove},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){for(var y in LiteGraph.log_verbose("lgraphcanvas","processMouseMove","draggin!",this.selected_nodes),this.selected_nodes){var b=this.selected_nodes[y],k=[n[0]/this.ds.scale,n[1]/this.ds.scale];b.pos[0]+=k[0],b.pos[1]+=k[1],b.is_selected||this.processNodeSelected(b,e),b.processCallbackHandlers("onDrag",{def_cb:b.onDrag},k)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var L=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],m=this.free_resize?LiteGraph.NODE_MIN_SIZE:this.resizing_node.computeSize();L[0]=Math.max(m[0],L[0]),L[1]=Math.max(m[1],L[1]),this.resizing_node.setSize(L),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}else this.read_only?LiteGraph.log_verbose("lgraphcanvas","processMouseMove","canvas is read only",this):LiteGraph.log_verbose("lgraphcanvas","processMouseMove","interaction not allowed (nor canvas and node)",this.allow_interaction,i.flags);return e.preventDefault(),!1}LiteGraph.log_warn("lgraphcanvas","processMouseMove","no canvas ref")}},{key:"processMouseUp",value:function(e){var t=void 0===e.isPrimary||e.isPrimary;if(!t)return LiteGraph.log_verbose("pointerevents: processMouseUp pointerN_stop "+e.pointerId+" "+e.isPrimary),!1;if(LiteGraph.log_verbose("pointerevents: processMouseUp "+e.pointerId+" "+e.isPrimary+" :: "+e.clientX+" "+e.clientY),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var n=this.getCanvasWindow().document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.log_verbose("pointerevents: processMouseUp restoreEventListener"),n.removeEventListener("pointermove",this._mousemove_callback,!0),this.canvas.addEventListener("pointermove",this._mousemove_callback),n.removeEventListener("pointerup",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var i=LiteGraph.getTime();if(e.click_time=i-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(LiteGraph.log_verbose("pointerevents: processMouseUp block_clicks"),this.block_click=!1),LiteGraph.log_debug("pointerevents: processMouseUp which: "+e.which),1==e.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e),this.node_widget=null,this.selected_group){var o=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),a=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(o,a,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group.recomputeInsideNodes(),this.selected_group_resizing?(this.processCallbackHandlers("onGroupResized",{def_cb:this.onGroupResized},this.selected_group),this.graph.onGraphChanged({action:"groupResize",doSave:!0}),this.graph.afterChange()):(o||a)&&(this.processCallbackHandlers("onGroupMoved",{def_cb:this.onGroupMoved},this.selected_group),this.graph.onGraphChanged({action:"groupMove",doSave:!0}),this.graph.afterChange()),this.selected_group=null}this.selected_group_resizing=!1;var r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var s=this.graph._nodes,l=new Float32Array(4),h=Math.abs(this.dragging_rectangle[2]),u=Math.abs(this.dragging_rectangle[3]),c=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-h:this.dragging_rectangle[0],p=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-u:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=c,this.dragging_rectangle[1]=p,this.dragging_rectangle[2]=h,this.dragging_rectangle[3]=u,!r||h>10&&u>10){LiteGraph.log_debug("lgraphcanvas","processMouseUp","computing box selection for nodes",this.dragging_rectangle);for(var d=[],_=0;_<s.length;++_){var g=s[_];g.getBounding(l),LiteGraph.overlapBounding(this.dragging_rectangle,l)&&d.push(g)}d.length&&(LiteGraph.log_debug("lgraphcanvas","processMouseUp","selecting nodes",d),this.selectNodes(d,e.shiftKey))}else this.selectNodes([r],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var v,f=(this.connecting_output||this.connecting_input).type;if(r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)){if(this.connecting_output)LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_output",this.connecting_output,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),-1!=(v=this.isOverNodeInput(r,e.canvasX,e.canvasY))?this.connecting_node.connect(this.connecting_slot,r,v):this.connecting_node.connectByType(this.connecting_slot,r,f);else if(this.connecting_input)if(LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_input",this.connecting_input,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),-1!=(v=this.isOverNodeOutput(r,e.canvasX,e.canvasY)))if(this.connecting&&this.connecting.inputs)for(var y in this.connecting.inputs)r.connect(v,this.connecting.inputs[y].node,this.connecting.inputs[y].slot);else r.connect(v,this.connecting_node,this.connecting_slot);else this.connecting_node.connectByTypeOutput(this.connecting_slot,r,f)}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1,this.connecting=!1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){for(var b in(r=this.node_dragged)&&e.click_time<300&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,r.pos[0],r.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&r.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.processCallbackHandlers("onNodeMoved",{def_cb:this.onNodeMoved},this.node_dragged,this.selected_nodes),this.selected_nodes){var k=this.selected_nodes[b];k.processCallbackHandlers("onMoved",{def_cb:k.onMoved},this.node_dragged,this.selected_nodes)}this.graph.onGraphChanged({action:"nodeDrag",doSave:!0}),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!(r=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseUp",{def_cb:this.node_over.onMouseUp},e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.processCallbackHandlers("onMouseUp",{def_cb:this.node_capturing_input.onMouseUp},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),LiteGraph.log_verbose("pointerevents: processMouseUp stopPropagation"),e.stopPropagation(),e.preventDefault(),!1}LiteGraph.log_warn("lgraphcanvas","processMouseUp","has not graph",this)}},{key:"isOverNodeBox",value:function(e,t,n){var i=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(t,n,e.pos[0]+2,e.pos[1]+2-i,i-4,i-4)}},{key:"isOverNodeInput",value:function(e,t,n,i){if(e.inputs)for(var o=0,a=e.inputs.length;o<a;++o){var r=e.getConnectionPos(!0,o);if(e.horizontal?LiteGraph.isInsideRectangle(t,n,r[0]-5,r[1]-10,10,20):LiteGraph.isInsideRectangle(t,n,r[0]-10,r[1]-5,40,10))return i&&(i[0]=r[0],i[1]=r[1]),o}return-1}},{key:"isOverNodeOutput",value:function(e,t,n,i){if(e.outputs)for(var o=0,a=e.outputs.length;o<a;++o){var r=e.getConnectionPos(!1,o);if(e.horizontal?LiteGraph.isInsideRectangle(t,n,r[0]-5,r[1]-10,10,20):LiteGraph.isInsideRectangle(t,n,r[0]-10,r[1]-5,40,10))return i&&(i[0]=r[0],i[1]=r[1]),o}return-1}},{key:"copyToClipboard",value:function(){var e={nodes:[],links:[]},t=0,n=[];for(var i in this.selected_nodes){var o=this.selected_nodes[i];!1!==o.clonable&&(o._relative_id=t,n.push(o),t+=1)}for(var a=0;a<n.length;++a){var r=n[a];if(!1!==r.clonable){var s=r.clone();if(s){if(e.nodes.push(s.serialize()),r.inputs&&r.inputs.length)for(var l=0;l<r.inputs.length;++l){var h=r.inputs[l];if(h&&null!=h.link){var u=this.graph.links[h.link];if(u){var c=this.graph.getNodeById(u.origin_id);c&&e.links.push([c._relative_id,u.origin_slot,r._relative_id,u.target_slot,c.id])}}}}else LiteGraph.log_warn("node type not found: "+r.type)}}LiteGraph.log_verbose("copyToClipboard",e),localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))}},{key:"pasteFromClipboard",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!e){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();for(var n=JSON.parse(t),i=!1,o=!1,a=0;a<n.nodes.length;++a)i?(i[0]>n.nodes[a].pos[0]&&(i[0]=n.nodes[a].pos[0],o[0]=a),i[1]>n.nodes[a].pos[1]&&(i[1]=n.nodes[a].pos[1],o[1]=a)):(i=[n.nodes[a].pos[0],n.nodes[a].pos[1]],o=[a,a]);for(var r=[],s=0;s<n.nodes.length;++s){var l=n.nodes[s],h=LiteGraph.createNode(l.type);h&&(h.configure(l),h.pos[0]+=this.graph_mouse[0]-i[0],h.pos[1]+=this.graph_mouse[1]-i[1],this.graph.add(h,{doProcessChange:!1}),r.push(h))}for(var u=0;u<n.links.length;++u){var c=n.links[u],p=void 0,d=c[0];if(null!=d)p=r[d];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var _=c[4];_&&(p=this.graph.getNodeById(_))}var g=r[c[2]];p&&g?p.connect(c[1],g,c[3]):LiteGraph.log_warn("Warning, nodes missing on pasting")}this.selectNodes(r),this.graph.onGraphChanged({action:"paste",doSave:!0}),this.graph.afterChange()}}}},{key:"checkDropItem",value:function(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],n=LGraphCanvas.getFileExtension(t.name),i=LiteGraph.node_types_by_file_extension[n];if(i){this.graph.beforeChange();var o=LiteGraph.createNode(i.type);if(!o)return void console.log(i.type,"is not available to handle",n);o.pos=[e.canvasX,e.canvasY],this.graph.add(o,!1,{doProcessChange:!0}),o.processCallbackHandlers("onDropFile",{def_cb:o.onDropFile},t,i.widgetName||null),this.graph.onGraphChanged({action:"fileDrop",doSave:!0}),this.graph.afterChange()}}}},{key:"processNodeDblClicked",value:function(e){var t=this.processCallbackHandlers("onShowNodePanel",{def_cb:this.onShowNodePanel},e);null!==t&&("object"!=_typeof(t)||null!==t.return_value&&t.return_value)||this.showShowNodePanel(e),this.processCallbackHandlers("onNodeDblClicked",{def_cb:this.onNodeDblClicked},e),this.setDirty(!0)}},{key:"processNodeSelected",value:function(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.processCallbackHandlers("onNodeSelected",{def_cb:this.onNodeSelected},e)}},{key:"selectNode",value:function(e,t){null==e?this.deselectAllNodes():this.selectNodes([e],t)}},{key:"selectNodes",value:function(e,t){var n=this;t||this.deselectAllNodes(),"string"==typeof(e=e||this.graph._nodes)&&(e=[e]),void 0===e.length&&(e=[e]),Object.values(e).forEach((function(e){var t,i;e.is_selected?n.deselectNode(e):(e.is_selected=!0,n.selected_nodes[e.id]=e,e.processCallbackHandlers("onSelected",{def_cb:e.onSelected}),null===(t=e.inputs)||void 0===t||t.forEach((function(e){n.highlighted_links[e.link]=!0})),null===(i=e.outputs)||void 0===i||i.forEach((function(e){var t;null===(t=e.links)||void 0===t||t.forEach((function(e){n.highlighted_links[e]=!0}))})))})),this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0)}},{key:"deselectNode",value:function(e){var t,n,i=this;e.is_selected&&(e.processCallbackHandlers("onDeselected",{def_cb:e.onDeselected}),e.is_selected=!1,this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},e),null===(t=e.inputs)||void 0===t||t.forEach((function(e){var t;null===(t=i.highlighted_links)||void 0===t||delete t[e.link]})),null===(n=e.outputs)||void 0===n||n.forEach((function(e){var t;null===(t=e.links)||void 0===t||t.forEach((function(e){var t;return null===(t=i.highlighted_links)||void 0===t||delete t[e]}))})))}},{key:"deselectAllNodes",value:function(){var e,t=this;this.graph&&(null===(e=this.graph._nodes)||void 0===e||e.forEach((function(e){e.is_selected&&(e.processCallbackHandlers("onDeselected",{def_cb:e.onDeselected}),e.is_selected=!1,t.processCallbackHandlers("onNodeDeselected",{def_cb:t.onNodeDeselected},e))})),this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0))}},{key:"deleteSelectedNodes",value:function(){for(var e in this.graph.beforeChange(),this.selected_nodes){var t=this.selected_nodes[e];if(!t.block_delete){if(t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&LiteGraph.isValidConnection(t.inputs[0].type,t.outputs[0].type)&&t.inputs[0].link&&t.outputs[0].links&&t.outputs[0].links.length){var n=t.graph.links[t.inputs[0].link],i=t.graph.links[t.outputs[0].links[0]],o=t.getInputNode(0),a=t.getOutputNodes(0)[0];o&&a&&o.connect(n.origin_slot,a,i.target_slot)}this.graph.remove(t),this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},t)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}},{key:"centerOnNode",value:function(e){this.ds.offset[0]=-e.pos[0]-.5*e.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-e.pos[1]-.5*e.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}},{key:"recenter",value:function(){this.ds.offset[0]=0,this.ds.offset[1]=0,this.setDirty(!0,!0)}},{key:"getMouseCoordinates",value:function(){return this.graph_mouse}},{key:"adjustMouseEvent",value:function(e){var t=0,n=0,i=0,o=0;if(e.clientX)n=e.clientX,o=e.clientY;else{var a=this.getMouseCoordinates(),r=this.convertOffsetToEditorArea(a);try{e.clientX=r[0],e.clientY=r[1]}catch(t){LiteGraph.log_debug("lgraphcanvas","adjustMouseEvent","failed set custom prop on event",e)}n=r[0],o=r[1]}if(this.canvas){var s=this.canvas.getBoundingClientRect();t=n-s.left,i=o-s.top}else t=n,i=o;this.last_mouse_position[0]=t,this.last_mouse_position[1]=i,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=i/this.ds.scale-this.ds.offset[1]}},{key:"setZoom",value:function(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}},{key:"convertOffsetToCanvas",value:function(e,t){return this.ds.convertOffsetToCanvas(e,t)}},{key:"convertCanvasToOffset",value:function(e,t){return this.ds.convertCanvasToOffset(e,t)}},{key:"convertOffsetToEditorArea",value:function(e){var t=this.canvas.getBoundingClientRect(),n=this.convertOffsetToCanvas(e);return[n[0]+t.left,n[1]+t.top]}},{key:"convertEventToCanvasOffset",value:function(e){var t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])}},{key:"cumulativeOffset",value:function(e){var t=0,n=0;do{t+=e.offsetTop||0,n+=e.offsetLeft||0,e=e.offsetParent}while(e);return[n,t]}},{key:"bringToFront",value:function(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))}},{key:"sendToBack",value:function(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))}},{key:"computeVisibleNodes",value:function(e,t){var n=t||[];n.length=0;for(var i=0,o=(e=e||this.graph._nodes).length;i<o;++i){var a=e[i];(!this.live_mode||a.onDrawBackground||a.onDrawForeground)&&(LiteGraph.overlapBounding(this.visible_area,a.getBounding(temp,!0))&&n.push(a))}return n}},{key:"draw",value:function(e,t){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var n=LiteGraph.getTime();this.render_time=.001*(n-this.last_draw_time),this.last_draw_time=n,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&n-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas();var i=this.dirty_canvas||e;if(i&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1,this.ds.scale<.7){if(i){var o=this.low_quality_rendering_threshold;this.fps<45?(this.low_quality_rendering_counter+=45/this.fps,this.low_quality_rendering_counter=Math.min(this.low_quality_rendering_counter,2*o)):(this.low_quality_rendering_counter-=this.fps/45*.01,this.low_quality_rendering_counter=Math.max(this.low_quality_rendering_counter,0))}}else this.low_quality_rendering_counter=0}}},{key:"drawFrontCanvas",value:function(){var e;this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var t=this.ctx;if(t){var n=this.canvas;t.start2D&&!this.viewport&&(t.start2D(),t.restore(),t.setTransform(1,0,0,1,0,0));var i=this.viewport||this.dirty_area;if(i&&(t.save(),t.beginPath(),t.rect(i[0],i[1],i[2],i[3]),t.clip()),this.clear_background&&(i?t.clearRect(i[0],i[1],i[2],i[3]):t.clearRect(0,0,n.width,n.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():t.drawImage(this.bgcanvas,0,0),this.processCallbackHandlers("onRender",{def_cb:this.onRender},n,t),this.show_info&&this.renderInfo(t,i?i[0]:0,i?i[1]:0),this.graph){t.save(),this.ds.toCanvasContext(t);for(var o=this.computeVisibleNodes(null,this.visible_nodes),a=0;a<o.length;++a){var r=o[a];t.save(),t.translate(r.pos[0],r.pos[1]),this.drawNode(r,t),t.restore()}if(this.render_execution_order&&this.drawExecutionOrder(t),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(t)),null!=this.connecting_pos){t.lineWidth=this.connections_width;var s=null,l=this.connecting_output||this.connecting_input,h=l.type,u=l.dir;null==u&&(u=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var c=l.shape;switch(h){case LiteGraph.EVENT:case LiteGraph.ACTION:s=LiteGraph.EVENT_LINK_COLOR;break;default:s=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(t,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,s,u,LiteGraph.CENTER),t.beginPath(),h===LiteGraph.EVENT||h===LiteGraph.ACTION||c===LiteGraph.BOX_SHAPE?(t.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),t.fill(),t.beginPath(),t.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):c===LiteGraph.ARROW_SHAPE?(t.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),t.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),t.closePath()):(t.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),t.fill(),t.beginPath(),t.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),t.fill(),t.fillStyle="#ffcc00",this._highlight_input){t.beginPath();var p=this._highlight_input_slot.shape;p===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),t.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),t.closePath()):t.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),t.fill()}this._highlight_output&&(t.beginPath(),p===LiteGraph.ARROW_SHAPE?(t.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),t.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),t.closePath()):t.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),t.fill())}this.dragging_rectangle&&(t.strokeStyle="#FFF",t.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(t,this.over_link_center):this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},t,null),this.processCallbackHandlers("onDrawForeground",{def_cb:this.onDrawForeground},t,this.visible_rect),t.restore()}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no graph",this);this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(t),this.processCallbackHandlers("onDrawOverlay",{def_cb:this.onDrawOverlay},t),i&&t.restore(),null===(e=t.finish2D)||void 0===e||e.call(t)}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no ctx",this)}},{key:"drawSubgraphPanel",value:function(e){var t=this.graph;if(t){var n=t._subgraph_node;n?(this.drawSubgraphPanelLeft(t,n,e),this.drawSubgraphPanelRight(t,n,e)):LiteGraph.log_warn("subgraph without subnode")}}},{key:"drawSubgraphPanelLeft",value:function(e,t,n){var i=t.inputs?t.inputs.length:0,o=200,a=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(10,10,o,(i+1)*a+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left",n.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var r=50;if(n.font="14px Arial",t.inputs)for(var s=0;s<t.inputs.length;++s){var l=t.inputs[s];if(!l.not_subgraph_input){if(this.drawButton(20,r+2,180,a-2)){var h=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var u=LiteGraph.createNode(h);u?(e.add(u,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",l.name),u.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",h)}n.fillStyle="#9C9",n.beginPath(),n.arc(184,r+.5*a,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(l.name,30,r+.75*a),n.fillStyle="#777",n.fillText(l.type,130,r+.75*a),r+=a}}this.drawButton(20,r+2,180,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)}}},{key:"drawSubgraphPanelRight",value:function(e,t,n){var i=t.outputs?t.outputs.length:0,o=this.bgcanvas.width,a=200,r=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);n.fillStyle="#111",n.globalAlpha=.8,n.beginPath(),n.roundRect(o-a-10,10,a,(i+1)*r+50,[8]),n.fill(),n.globalAlpha=1,n.fillStyle="#888",n.font="14px Arial",n.textAlign="left";var s="Graph Outputs",l=n.measureText(s).width;if(n.fillText(s,o-l-20,34),this.drawButton(o-a,20,20,20,"X","#151515"))this.closeSubgraph();else{var h=50;if(n.font="14px Arial",t.outputs)for(var u=0;u<t.outputs.length;++u){var c=t.outputs[u];if(!c.not_subgraph_input){if(this.drawButton(o-a,h+2,180,r-2)){var p=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var d=LiteGraph.createNode(p);d?(e.add(d,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([d]),this.node_dragged=d,this.dragging_canvas=!1,d.setProperty("name",c.name),d.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",p)}n.fillStyle="#9C9",n.beginPath(),n.arc(o-a+16,h+.5*r,5,0,2*Math.PI),n.fill(),n.fillStyle="#AAA",n.fillText(c.name,o-a+30,h+.75*r),n.fillStyle="#777",n.fillText(c.type,o-a+130,h+.75*r),h+=r}}this.drawButton(o-a,h+2,180,r-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)}}},{key:"drawButton",value:function(e,t,n,i,o,a,r,s){var l=this.ctx;a=a||LiteGraph.NODE_DEFAULT_COLOR,r=r||"#555",s=s||LiteGraph.NODE_TEXT_COLOR;var h=this.ds.convertOffsetToCanvas(this.graph_mouse),u=LiteGraph.isInsideRectangle(h[0],h[1],e,t,n,i);if(h=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null){var c=this.canvas.getBoundingClientRect();h[0]-=c.left,h[1]-=c.top}var p=h&&LiteGraph.isInsideRectangle(h[0],h[1],e,t,n,i);l.fillStyle=u?r:a,p&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,n,i,[4]),l.fill(),null!=o&&o.constructor==String&&(l.fillStyle=s,l.textAlign="center",l.font=(.65*i|0)+"px Arial",l.fillText(o,e+.5*n,t+.75*i),l.textAlign="left");var d=p&&!this.block_click;return p&&this.blockClick(),d}},{key:"isAreaClicked",value:function(e,t,n,i,o){var a=this.last_click_position,r=a&&LiteGraph.isInsideRectangle(a[0],a[1],e,t,n,i),s=r&&!this.block_click;return r&&o&&this.blockClick(),s}},{key:"renderInfo",value:function(e,t,n){t=t||10,n=n||this.canvas.height-80,e.save(),e.translate(t,n),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),e.fillText("I: "+this.graph.iteration,5,26),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),e.fillText("V: "+this.graph._version,5,52),e.fillText("FPS:"+this.fps.toFixed(2),5,65)):e.fillText("No graph selected",5,13),e.restore()}},{key:"drawBackCanvas",value:function(){var e,t=this,n=this.bgcanvas;this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var i=this.bgctx;i.start&&i.start();var o=this.viewport||[0,0,i.canvas.width,i.canvas.height];if(this.clear_background&&i.clearRect(o[0],o[1],o[2],o[3]),this._graph_stack&&this._graph_stack.length){i.save();var a=this.graph._subgraph_node;i.strokeStyle=a.bgcolor,i.lineWidth=10,i.strokeRect(1,1,n.width-2,n.height-2),i.lineWidth=1,i.font="40px Arial",i.textAlign="center",i.fillStyle=a.bgcolor||"#AAA";var r="";this._graph_stack.slice(1).forEach((function(e,n){r+="".concat(e._subgraph_node.getTitle()," ").concat(n<t._graph_stack.length-2?">> ":"")})),i.fillText(r+a.getTitle(),.5*n.width,40),i.restore()}var s=!1,l=this.processCallbackHandlers("onRenderBackground",{def_cb:this.onRenderBackground},n,i);if(null!==l&&(!0===l||"object"==_typeof(l)&&!0===l.return_value)&&(s=!0),this.viewport||(i.restore(),i.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(i.save(),this.ds.toCanvasContext(i),this.ds.scale<1.5&&!s&&this.clear_background_color&&(i.fillStyle=this.clear_background_color,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!s){if(this.zoom_modify_alpha?i.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:i.globalAlpha=this.editor_alpha,i.imageSmoothingEnabled=i.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var h=this;this._bg_img.onload=function(){h.draw(!0,!0)}}var u=null;null==this._pattern&&this._bg_img.width>0?(u=i.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=u):u=this._pattern,u&&(i.fillStyle=u,i.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),i.fillStyle="transparent"),i.globalAlpha=1,i.imageSmoothingEnabled=i.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(n,i),this.processCallbackHandlers("onDrawBackground",{def_cb:this.onDrawBackground},i,this.visible_area),this.onBackgroundRender&&(LiteGraph.log_error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(i.strokeStyle="#235",i.strokeRect(0,0,n.width,n.height)),this.render_connections_shadows?(i.shadowColor="#000",i.shadowOffsetX=0,i.shadowOffsetY=0,i.shadowBlur=6):i.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(i),i.shadowColor="rgba(0,0,0,0)",i.restore()}null===(e=i.finish)||void 0===e||e.call(i),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}},{key:"drawNode",value:function(e,t){this.current_node=e;var n=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,i=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,o=this.ds.scale<.6;if(this.live_mode)e.flags.collapsed||(t.shadowColor="transparent",e.processCallbackHandlers("onDrawForeground",{def_cb:e.onDrawForeground},t,this,this.canvas));else{var a=this.editor_alpha;if(t.globalAlpha=a,this.render_shadows&&!o?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",e.flags.collapsed){var r=e.processCallbackHandlers("onDrawCollapsed",{def_cb:e.onDrawCollapsed},t,this);if(null!==r&&(!0===r||"object"==_typeof(r)&&!0===r.return_value))return}var s=e._shape||LiteGraph.BOX_SHAPE,l=temp_vec2;temp_vec2.set(e.size);var h=e.horizontal;if(e.flags.collapsed){t.font=this.title_text_font;var u=e.getTitle?e.getTitle():e.title;null!=u&&(e._collapsed_width=Math.min(e.size[0],t.measureText(u).width+2*LiteGraph.NODE_TITLE_HEIGHT),l[0]=e._collapsed_width,l[1]=0)}(e.clip_area||this.clip_all_nodes)&&(t.save(),t.beginPath(),s==LiteGraph.BOX_SHAPE?t.rect(0,0,l[0],l[1]):s==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,l[0],l[1],[10]):s==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*l[0],.5*l[1],.5*l[0],0,2*Math.PI),t.clip()),e.has_errors&&(i="red"),this.drawNodeShape(e,t,l,n,i,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.processCallbackHandlers("onDrawForeground",{def_cb:e.onDrawForeground},t,this,this.canvas),LiteGraph.show_node_tooltip&&e.mouseOver&&e.is_selected&&(!this.selected_nodes||Object.keys(this.selected_nodes).length<=1)&&this.drawNodeTooltip(t,e),t.textAlign=h?"center":"left",t.font=this.inner_text_font;var c=!this.lowQualityRenderingRequired(.6),p=this.connecting_output,d=this.connecting_input;t.lineWidth=1;var _,g=0,v=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var f=null,y=null;if(e.inputs)for(var b=0;b<e.inputs.length;b++){var k=e.inputs[b];if(null!=k.link){f=k;break}}if(e.outputs)for(var L=0;L<e.outputs.length;L++){var m=e.outputs[L];m.links&&m.links.length&&(y=m)}if(f){var G=0,C=-.5*LiteGraph.NODE_TITLE_HEIGHT;h&&(G=.5*e._collapsed_width,C=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),f.type===LiteGraph.EVENT||f.type===LiteGraph.ACTION||f.shape===LiteGraph.BOX_SHAPE?t.rect(G-7+.5,C-4,14,8):f.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(G+8,C),t.lineTo(G+-4,C-4),t.lineTo(G+-4,C+4),t.closePath()):t.arc(G,C,4,0,2*Math.PI),t.fill()}if(y){var w=e._collapsed_width,E=-.5*LiteGraph.NODE_TITLE_HEIGHT;h&&(w=.5*e._collapsed_width,E=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),y.type===LiteGraph.EVENT||y.type===LiteGraph.ACTION||y.shape===LiteGraph.BOX_SHAPE?t.rect(w-7+.5,E-4,14,8):y.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(w+6,E),t.lineTo(w-6,E-4),t.lineTo(w-6,E+4),t.closePath()):t.arc(w,E,4,0,2*Math.PI),t.fill()}}}else{if(e.inputs)for(var T=0;T<e.inputs.length;T++){var O=e.inputs[T],N=O.type,S=O.shape;t.globalAlpha=a,this.connecting_output&&!LiteGraph.isValidConnection(O.type,p.type)&&(t.globalAlpha=.4*a),t.fillStyle=null!=O.link?O.color_on||this.default_connection_color_byType[N]||this.default_connection_color.input_on:O.color_off||this.default_connection_color_byTypeOff[N]||this.default_connection_color_byType[N]||this.default_connection_color.input_off;var I=e.getConnectionPos(!0,T,v);if(I[0]-=e.pos[0],I[1]-=e.pos[1],g<I[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=I[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.beginPath(),"array"==N?S=LiteGraph.GRID_SHAPE:"onTrigger"==O.name||"onExecuted"==O.name?S=LiteGraph.ARROW_SHAPE:N!==LiteGraph.EVENT&&N!==LiteGraph.ACTION||(S=LiteGraph.BOX_SHAPE),_=!0,S===LiteGraph.BOX_SHAPE?h?t.rect(I[0]-5+.5,I[1]-8+.5,10,14):t.rect(I[0]-6+.5,I[1]-5+.5,14,10):S===LiteGraph.ARROW_SHAPE?(t.moveTo(I[0]+8,I[1]+.5),t.lineTo(I[0]-4,I[1]+6+.5),t.lineTo(I[0]-4,I[1]-6+.5),t.closePath()):S===LiteGraph.GRID_SHAPE?(t.rect(I[0]-4,I[1]-4,2,2),t.rect(I[0]-1,I[1]-4,2,2),t.rect(I[0]+2,I[1]-4,2,2),t.rect(I[0]-4,I[1]-1,2,2),t.rect(I[0]-1,I[1]-1,2,2),t.rect(I[0]+2,I[1]-1,2,2),t.rect(I[0]-4,I[1]+2,2,2),t.rect(I[0]-1,I[1]+2,2,2),t.rect(I[0]+2,I[1]+2,2,2),_=!1):o?t.rect(I[0]-4,I[1]-4,8,8):t.arc(I[0],I[1],4,0,2*Math.PI),t.fill(),c&&"onTrigger"!=O.name&&"onExecuted"!=O.name){var A=null!=O.label?O.label:O.name;A&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,h||O.dir==LiteGraph.UP?t.fillText(A,I[0],I[1]-10):t.fillText(A,I[0]+10,I[1]+5))}}if(t.textAlign=h?"center":"right",t.strokeStyle="black",e.outputs)for(var P=0;P<e.outputs.length;P++){var x=e.outputs[P],D=x.type,H=x.shape;this.connecting_input&&!LiteGraph.isValidConnection(D,d.type)&&(t.globalAlpha=.4*a);var M=e.getConnectionPos(!1,P,v);if(M[0]-=e.pos[0],M[1]-=e.pos[1],g<M[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=M[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.fillStyle=x.links&&x.links.length?x.color_on||this.default_connection_color_byType[D]||this.default_connection_color.output_on:x.color_off||this.default_connection_color_byTypeOff[D]||this.default_connection_color_byType[D]||this.default_connection_color.output_off,t.beginPath(),"array"==D?H=LiteGraph.GRID_SHAPE:"onTrigger"==x.name||"onExecuted"==x.name?H=LiteGraph.ARROW_SHAPE:D!==LiteGraph.EVENT&&D!==LiteGraph.ACTION||(H=LiteGraph.BOX_SHAPE),_=!0,H===LiteGraph.BOX_SHAPE?h?t.rect(M[0]-5+.5,M[1]-8+.5,10,14):t.rect(M[0]-6+.5,M[1]-5+.5,14,10):H===LiteGraph.ARROW_SHAPE?(t.moveTo(M[0]+8,M[1]+.5),t.lineTo(M[0]-4,M[1]+6+.5),t.lineTo(M[0]-4,M[1]-6+.5),t.closePath()):H===LiteGraph.GRID_SHAPE?(t.rect(M[0]-4,M[1]-4,2,2),t.rect(M[0]-1,M[1]-4,2,2),t.rect(M[0]+2,M[1]-4,2,2),t.rect(M[0]-4,M[1]-1,2,2),t.rect(M[0]-1,M[1]-1,2,2),t.rect(M[0]+2,M[1]-1,2,2),t.rect(M[0]-4,M[1]+2,2,2),t.rect(M[0]-1,M[1]+2,2,2),t.rect(M[0]+2,M[1]+2,2,2),_=!1):o?t.rect(M[0]-4,M[1]-4,8,8):t.arc(M[0],M[1],4,0,2*Math.PI),t.fill(),!o&&_&&t.stroke(),c&&"onTrigger"!=x.name&&"onExecuted"!=x.name){var R=null!=x.label?x.label:x.name;R&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,h||x.dir==LiteGraph.DOWN?t.fillText(R,M[0],M[1]-8):t.fillText(R,M[0]-10,M[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var B=g;(h||e.widgets_up)&&(B=2),null!=e.widgets_start_y&&(B=e.widgets_start_y),this.drawNodeWidgets(e,B,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null)}}(e.clip_area||this.clip_all_nodes)&&t.restore(),t.globalAlpha=1}}},{key:"drawNodeTooltip",value:function(e,t){if(t&&e){var n=null!=t.properties.tooltip?t.properties.tooltip:"";if(n&&""!=n||LiteGraph.show_node_tooltip_use_descr_property&&t.constructor.desc&&(n=t.constructor.desc),(n=(n+"").trim())&&""!=n){var i=[0,-LiteGraph.NODE_TITLE_HEIGHT],o=t.flags.collapsed?[LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT]:t.size;e.font="14px Courier New";var a=Math.max(t.size[0],160)+20,r=t.ttip_oTMultiRet?t.ttip_oTMultiRet.height+15:21;e.globalAlpha=.7*this.editor_alpha,e.shadowColor=t.ttip_oTMultiRet?"black":"transparent",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle=t.ttip_oTMultiRet?"#454":"transparent",e.beginPath(),e.roundRect(i[0]-.5*a+o[0]/2,i[1]-15-r,a,r,[3]),e.moveTo(i[0]-10+o[0]/2,i[1]-15),e.lineTo(i[0]+10+o[0]/2,i[1]-15),e.lineTo(i[0]+o[0]/2,i[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle=t.ttip_oTMultiRet?"#CEC":"transparent",e.globalAlpha=this.editor_alpha;var s=LiteGraph.canvasFillTextMultiline(e,n,i[0]+o[0]/2,i[1]-r,a,14);t.ttip_oTMultiRet=s,e.closePath()}}else LiteGraph.log_warn("drawNodeTooltip: invalid node or ctx",t,e)}},{key:"drawLinkTooltip",value:function(e,t){var n=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(n[0],n[1],3,0,2*Math.PI),e.fill(),null!=t.data){var i=this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},e,t,this);if(null===i||!0!==i&&("object"!=_typeof(i)||!0!==i.return_value)){var o=t.data,a=null;if(o.constructor===Number)a=o.toFixed(2);else if(o.constructor===String)a='"'+o+'"';else if(o.constructor===Boolean)a=String(o);else if(o.toToolTip)a=o.toToolTip();else try{a="["+o.constructor.name+"]"}catch(e){a="["+_typeof(o)+"]"}if(null!=a){a=a.substr(0,30),e.font="14px Courier New";var r=e.measureText(a).width+20;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(n[0]-.5*r,n[1]-15-24,r,24,[3]),e.moveTo(n[0]-10,n[1]-15),e.lineTo(n[0]+10,n[1]-15),e.lineTo(n[0],n[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(a,n[0],n[1]-15-24*.3)}}}}},{key:"drawNodeShape",value:function(e,t,n,i,o,a,r){t.strokeStyle=i,t.fillStyle=o;var s=null,l=LiteGraph.NODE_TITLE_HEIGHT,h=this.lowQualityRenderingRequired(.5),u=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,c=e.constructor.title_mode,p=!0;c==LiteGraph.TRANSPARENT_TITLE||c==LiteGraph.NO_TITLE?p=!1:c==LiteGraph.AUTOHIDE_TITLE&&r&&(p=!0);var d=tmp_area;d[0]=0,d[1]=p?-l:0,d[2]=n[0]+1,d[3]=p?n[1]+l:n[1];var _=t.globalAlpha;if(t.beginPath(),u==LiteGraph.BOX_SHAPE||h?t.fillRect(d[0],d[1],d[2],d[3]):u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CARD_SHAPE?t.roundRect(d[0],d[1],d[2],d[3],u==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):u==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*n[0],.5*n[1],.5*n[0],0,2*Math.PI),t.fill(),!e.flags.collapsed&&p&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,d[2],2)),t.shadowColor="transparent",e.processCallbackHandlers("onDrawBackground",{def_cb:e.onDrawBackground},t,this,this.canvas,this.graph_mouse),p||c==LiteGraph.TRANSPARENT_TITLE){if(null!==(s=e.processCallbackHandlers("onDrawTitleBar",{def_cb:e.onDrawTitleBar},t,l,n,this.ds.scale,i))&&(!0===s||"object"==_typeof(s)&&!0===s.return_value));else if(c!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var g=e.constructor.title_color||i;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var v=LGraphCanvas.gradients[g];v||((v=LGraphCanvas.gradients[g]=t.createLinearGradient(0,0,400,0)).addColorStop(0,g),v.addColorStop(1,"#000")),t.fillStyle=v}else t.fillStyle=g;t.beginPath(),u==LiteGraph.BOX_SHAPE||h?t.rect(0,-l,n[0]+1,l):u!=LiteGraph.ROUND_SHAPE&&u!=LiteGraph.CARD_SHAPE||t.roundRect(0,-l,n[0]+1,l,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}var f=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(f=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(f=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":f);var y=10;if(null!==(s=e.processCallbackHandlers("onDrawTitleBox",{def_cb:e.onDrawTitleBox},t,l,n,this.ds.scale))&&(!0===s||"object"==_typeof(s)&&!0===s.return_value)||(u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CIRCLE_SHAPE||u==LiteGraph.CARD_SHAPE?(h&&(t.fillStyle="black",t.beginPath(),t.arc(.5*l,-.5*l,6,0,2*Math.PI),t.fill()),t.fillStyle=e.boxcolor||f||LiteGraph.NODE_DEFAULT_BOXCOLOR,h?t.fillRect(.5*l-5,-.5*l-5,y,y):(t.beginPath(),t.arc(.5*l,-.5*l,5,0,2*Math.PI),t.fill())):(h&&(t.fillStyle="black",t.fillRect(.5*(l-y)-1,-.5*(l+y)-1,12,12)),t.fillStyle=e.boxcolor||f||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect(.5*(l-y),-.5*(l+y),y,y))),t.globalAlpha=_,e.processCallbackHandlers("onDrawTitleText",{def_cb:e.onDrawTitleText},t,l,n,this.ds.scale,this.title_text_font,a),!h){t.font=this.title_text_font;var b=String(e.getTitle());b&&(t.fillStyle=a?LiteGraph.NODE_SELECTED_TITLE_COLOR:e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.fillText(b,l,LiteGraph.NODE_TITLE_TEXT_Y-l),t.textAlign="left"):(t.textAlign="left",t.fillText(b,l,LiteGraph.NODE_TITLE_TEXT_Y-l)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var k=LiteGraph.NODE_TITLE_HEIGHT,L=e.size[0]-k,m=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],L+2,2-k,k-4,k-4);t.fillStyle=m?"#888":"#555",u==LiteGraph.BOX_SHAPE||h?t.fillRect(L+2,2-k,k-4,k-4):(t.beginPath(),t.roundRect(L+2,2-k,k-4,k-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(L+.2*k,.6*-k),t.lineTo(L+.8*k,.6*-k),t.lineTo(L+.5*k,.3*-k),t.fill()}e.processCallbackHandlers("onDrawTitle",{def_cb:e.onDrawTitle},t)}a&&(e.processCallbackHandlers("onBounding",{def_cb:e.onBounding},d),c==LiteGraph.TRANSPARENT_TITLE&&(d[1]-=l,d[3]+=l),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),u==LiteGraph.BOX_SHAPE?t.rect(-6+d[0],-6+d[1],12+d[2],12+d[3]):u==LiteGraph.ROUND_SHAPE||u==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[2*this.round_radius]):u==LiteGraph.CARD_SHAPE?t.roundRect(-6+d[0],-6+d[1],12+d[2],12+d[3],[2*this.round_radius,2,2*this.round_radius,2]):u==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*n[0],.5*n[1],.5*n[0]+6,0,2*Math.PI),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=i,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--}},{key:"drawConnections",value:function(e){var t=LiteGraph.getTime(),n=this.visible_area;margin_area[0]=n[0]-20,margin_area[1]=n[1]-20,margin_area[2]=n[2]+40,margin_area[3]=n[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var i=this.graph._nodes,o=0,a=i.length;o<a;++o){var r=i[o];if(r.inputs&&r.inputs.length)for(var s=0;s<r.inputs.length;++s){var l=r.inputs[s];if(l&&null!=l.link){var h=l.link,u=this.graph.links[h];if(u){var c=this.graph.getNodeById(u.origin_id);if(null!=c){var p=u.origin_slot,d=null;d=-1==p?[c.pos[0]+10,c.pos[1]+10]:c.getConnectionPos(!1,p,tempA);var _=r.getConnectionPos(!0,s,tempB);if(link_bounding[0]=d[0],link_bounding[1]=d[1],link_bounding[2]=_[0]-d[0],link_bounding[3]=_[1]-d[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),LiteGraph.overlapBounding(link_bounding,margin_area)){var g=c.outputs[p],v=r.inputs[s];if(g&&v){var f=g.dir||(c.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),y=v.dir||(r.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,d,_,u,!1,0,null,f,y),u&&u._last_time&&t-u._last_time<1e3){var b=2-.002*(t-u._last_time),k=e.globalAlpha;e.globalAlpha=k*b,this.renderLink(e,d,_,u,!0,b,"white",f,y),e.globalAlpha=k}}}}}}}}e.globalAlpha=1}},{key:"renderLink",value:function(e,t,n,i,o,a,r,s,l,h){i&&this.visible_links.push(i),!r&&i&&(r=i.color||LGraphCanvas.link_type_colors[i.type]),r||(r=this.default_link_color),null!=i&&this.highlighted_links[i.id]&&(r="#FFF"),s=s||LiteGraph.RIGHT,l=l||LiteGraph.LEFT;var u=LiteGraph.distance(t,n);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",(h=h||1)>1&&(e.lineWidth=.5),e.beginPath();for(var c=0;c<h;c+=1){var p=5*(c-.5*(h-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+p);var d=0,_=0,g=0,v=0;switch(s){case LiteGraph.LEFT:d=-.25*u;break;case LiteGraph.RIGHT:d=.25*u;break;case LiteGraph.UP:_=-.25*u;break;case LiteGraph.DOWN:_=.25*u}switch(l){case LiteGraph.LEFT:g=-.25*u;break;case LiteGraph.RIGHT:g=.25*u;break;case LiteGraph.UP:v=-.25*u;break;case LiteGraph.DOWN:v=.25*u}e.bezierCurveTo(t[0]+d,t[1]+_+p,n[0]+g,n[1]+v+p,n[0],n[1]+p)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+p);var f=0,y=0,b=0,k=0;switch(s){case LiteGraph.LEFT:f=-1;break;case LiteGraph.RIGHT:f=1;break;case LiteGraph.UP:y=-1;break;case LiteGraph.DOWN:y=1}switch(l){case LiteGraph.LEFT:b=-1;break;case LiteGraph.RIGHT:b=1;break;case LiteGraph.UP:k=-1;break;case LiteGraph.DOWN:k=1}e.lineTo(t[0]+15*f,t[1]+15*y+p),e.lineTo(n[0]+15*b,n[1]+15*k+p),e.lineTo(n[0],n[1]+p)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;e.moveTo(t[0],t[1]);var L=t[0],m=t[1],G=n[0],C=n[1];s==LiteGraph.RIGHT?L+=10:m+=10,l==LiteGraph.LEFT?G-=10:C-=10,e.lineTo(L,m),e.lineTo(.5*(L+G),m),e.lineTo(.5*(L+G),C),e.lineTo(G,C),e.lineTo(n[0],n[1])}}this.render_connections_border&&this.ds.scale>.6&&!o&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=r,e.stroke();var w=this.computeConnectionPoint(t,n,.5,s,l);if(i&&i._pos&&(i._pos[0]=w[0],i._pos[1]=w[1]),this.ds.scale>=.6&&this.highquality_render&&l!=LiteGraph.CENTER){if(this.render_connection_arrows){var E=this.computeConnectionPoint(t,n,.25,s,l),T=this.computeConnectionPoint(t,n,.26,s,l),O=this.computeConnectionPoint(t,n,.75,s,l),N=this.computeConnectionPoint(t,n,.76,s,l),S=0,I=0;this.render_curved_connections?(S=-Math.atan2(T[0]-E[0],T[1]-E[1]),I=-Math.atan2(N[0]-O[0],N[1]-O[1])):I=S=n[1]>t[1]?0:Math.PI,e.save(),e.translate(E[0],E[1]),e.rotate(S),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(O[0],O[1]),e.rotate(I),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(w[0],w[1],5,0,2*Math.PI),e.fill()}if(a){e.fillStyle=r;for(var A=0;A<5;++A){var P=(.001*LiteGraph.getTime()+.2*A)%1;w=this.computeConnectionPoint(t,n,P,s,l),e.beginPath(),e.arc(w[0],w[1],5,0,2*Math.PI),e.fill()}}}},{key:"computeConnectionPoint",value:function(e,t,n,i,o){i=i||LiteGraph.RIGHT,o=o||LiteGraph.LEFT;var a=LiteGraph.distance(e,t),r=e,s=[e[0],e[1]],l=[t[0],t[1]],h=t;switch(i){case LiteGraph.LEFT:s[0]+=-.25*a;break;case LiteGraph.RIGHT:s[0]+=.25*a;break;case LiteGraph.UP:s[1]+=-.25*a;break;case LiteGraph.DOWN:s[1]+=.25*a}switch(o){case LiteGraph.LEFT:l[0]+=-.25*a;break;case LiteGraph.RIGHT:l[0]+=.25*a;break;case LiteGraph.UP:l[1]+=-.25*a;break;case LiteGraph.DOWN:l[1]+=.25*a}var u=(1-n)*(1-n)*(1-n),c=(1-n)*(1-n)*3*n,p=3*(1-n)*(n*n),d=n*n*n;return[u*r[0]+c*s[0]+p*l[0]+d*h[0],u*r[1]+c*s[1]+p*l[1]+d*h[1]]}},{key:"drawExecutionOrder",value:function(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;for(var t=this.visible_nodes,n=0;n<t.length;++n){var i=t[n];e.fillStyle="black",e.fillRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==i.order&&e.strokeRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(i.order,i.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-6)}e.globalAlpha=1}},{key:"drawNodeWidgets",value:function(e,t,n,i){if(!e.widgets||!e.widgets.length)return 0;var o=e.size[0],a=e.widgets;t+=2;var r=LiteGraph.NODE_WIDGET_HEIGHT,s=!this.lowQualityRenderingRequired(.5);n.save(),n.globalAlpha=this.editor_alpha;for(var l=LiteGraph.WIDGET_OUTLINE_COLOR,h=LiteGraph.WIDGET_BGCOLOR,u=LiteGraph.WIDGET_TEXT_COLOR,c=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,p=15,d=!1,_=0;_<a.length;++_){var g=a[_],v=t;g.y&&(v=g.y),g.last_y=v,n.strokeStyle=l,n.fillStyle="#222",n.textAlign="left",g.disabled&&(n.globalAlpha*=.5);var f=g.width||o;switch(d=this.over_widget==g,g.type){case"button":g.clicked&&(n.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),n.fillRect(p,v,f-30,r),s&&!g.disabled&&n.strokeRect(p,v,f-30,r),s&&(n.textAlign="center",n.fillStyle=u,(d||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<o)&&n.fillText(g.label||g.name,.5*f,v+.7*r));break;case"toggle":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),s?n.roundRect(p,v,f-30,r,[.5*r]):n.rect(p,v,f-30,r),n.fill(),s&&!g.disabled&&n.stroke(),n.fillStyle=g.value?"#89A":"#333",n.beginPath(),n.arc(f-30,v+.5*r,.36*r,0,2*Math.PI),n.fill(),s){n.fillStyle=c;var y=g.label||g.name;null!=y&&(d||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<o)&&n.fillText(y,30,v+.7*r),n.fillStyle=g.value?u:c,n.textAlign="right",n.fillText(g.value?g.options.on||"on":g.options.off||"off",f-40,v+.7*r)}break;case"slider":n.fillStyle=h,n.fillRect(p,v,f-30,r);var b=g.options.max-g.options.min,k=(g.value-g.options.min)/b;if(k<0&&(k=0),k>1&&(k=1),n.fillStyle=g.options.hasOwnProperty("slider_color")?g.options.slider_color:i==g?"#89A":"#678",n.fillRect(p,v,k*(f-30),r),s&&!g.disabled&&n.strokeRect(p,v,f-30,r),g.marker){var L=(g.marker-g.options.min)/b;L<0&&(L=0),L>1&&(L=1),n.fillStyle=g.options.hasOwnProperty("marker_color")?g.options.marker_color:"#AA9",n.fillRect(p+L*(f-30),v,2,r)}s&&(n.textAlign="center",n.fillStyle=u,(d||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<o)&&n.fillText(g.label||g.name+"  "+LiteGraph.formatNumber(g.value,null!=g.options.precision?g.options.precision:3),.5*f,v+.7*r));break;case"number":case"combo":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),s?n.roundRect(p,v,f-30,r,[.5*r]):n.rect(p,v,f-30,r),n.fill(),s)if(g.disabled||n.stroke(),n.fillStyle=u,g.disabled||(n.beginPath(),n.moveTo(31,v+5),n.lineTo(21,v+.5*r),n.lineTo(31,v+r-5),n.fill(),n.beginPath(),n.moveTo(f-p-16,v+5),n.lineTo(f-p-6,v+.5*r),n.lineTo(f-p-16,v+r-5),n.fill()),n.fillStyle=c,(d||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<o)&&n.fillText(g.label||g.name,35,v+.7*r),n.fillStyle=u,n.textAlign="right","number"==g.type)n.fillText(LiteGraph.formatNumber(g.value,void 0!==g.options.precision?g.options.precision:3),f-30-20,v+.7*r);else{var m=g.value;if(g.options.values){var G=g.options.values;G.constructor===Function&&(G=G()),G&&G.constructor!==Array&&(m=G[g.value])}n.fillText(m,f-30-20,v+.7*r)}break;case"string":case"text":if(n.textAlign="left",n.strokeStyle=l,n.fillStyle=h,n.beginPath(),s?n.roundRect(p,v,f-30,r,[.5*r]):n.rect(p,v,f-30,r),n.fill(),s){g.disabled||n.stroke(),n.save(),n.beginPath(),n.rect(p,v,f-30,r),n.clip(),n.fillStyle=c;var C=g.label||g.name;null!=C&&(d||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<o)&&n.fillText(C,30,v+.7*r),n.fillStyle=u,n.textAlign="right",n.fillText(String(g.value).substr(0,30),f-30,v+.7*r),n.restore()}break;default:g.draw&&g.draw(n,e,f,v,r)}t+=(g.computeSize?g.computeSize(f)[1]:r)+4,n.globalAlpha=this.editor_alpha}n.restore(),n.textAlign="left"}},{key:"processNodeWidgets",value:function processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return node.widgets&&node.widgets.length||LiteGraph.log_verbose("graph processNodeWidgets","no widgets for node",node),this.allow_interaction||node.flags.allow_interaction||LiteGraph.log_verbose("graph processNodeWidgets","interaction not allowed on graph and not overridden on node",node),null;for(var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],height=LiteGraph.NODE_WIDGET_HEIGHT,deltaX=(null==event?void 0:event.deltaX)||(null==event?void 0:event.deltax)||0,that=this,ref_window=this.getCanvasWindow(),widget_width=width,widget_height=height,i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){if("function"==typeof w.computeSize){var wSize=w.computeSize(node.size[0],node.size[1]);widget_width=wSize[0],widget_height=wSize[1]}else widget_width=w.width||width,widget_height=w.height||height;if(w==active_widget||!(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;if(LiteGraph.log_verbose("graph processNodeWidgets","has widget",w),event)switch(w.type){case"button":"pointerdown"===event.type?(w.callback?(LiteGraph.log_debug("graph processNodeWidgets","button, calling callback",w.callback),setTimeout((function(){w.callback(w,that,node,pos,event)}),20)):LiteGraph.log_verbose("graph processNodeWidgets","button, has not callback",w),w.clicked=!0,this.dirty_canvas=!0):LiteGraph.log_verbose("graph processNodeWidgets","button, event is not pointer down",event);break;case"slider":var nvalue=LiteGraph.clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout((function(){inner_value_change(w,w.value,old_value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":case"enum":if("pointermove"==event.type&&"number"==w.type)deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if("pointerdown"==event.type){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));var delta=x<40?-1:x>widget_width-40?1:0;if("number"==w.type)w.value+=delta*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(delta){var index=-1;this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+delta:values_list.indexOf(w.value)+delta,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:(console.debug("ARROW_ComboOrOtherWidget","clickCHECK",w,index,values),w.value=values!=values_list?Object.keys(values)[index]:index)}else{var entries=[];values!=values_list?Object.keys(values).forEach((function(e){entries.push({value:e,content:values[e]})})):entries=values,console.debug("ComboOrOtherWidget","filling from",values,"to",entries);var inner_clicked=function(e,t,n,i,o,a){var r;return(r=console).debug.apply(r,["ComboOrOtherWidget","inner_clicked"].concat(Array.prototype.slice.call(arguments))),console.debug("ComboOrOtherWidget","inner_clicked",e,entries,values,values_list,"old_value",old_value),"object"==_typeof(e)&&void 0!==e.value?(console.debug("ComboOrOtherWidget","inner_clicked","using object key value",e),this.value=e.value,inner_value_change(this,e.value,old_value)):(console.debug("ComboOrOtherWidget","inner_clicked","using simple",e),this.value=e,inner_value_change(this,e,old_value)),that.dirty_canvas=!0,!1};LiteGraph.ContextMenu(entries,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:inner_clicked.bind(w)},ref_window)}}else if("pointerup"==event.type&&"number"==w.type){var _delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&0==_delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){LiteGraph.log_warn(e)}this.value=Number(v),inner_value_change(this,this.value,old_value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value,old_value)}.bind(w),20),this.dirty_canvas=!0;break;case"boolean":case"toggle":"pointerdown"==event.type&&(w.value=!w.value,setTimeout((function(){inner_value_change(w,w.value)}),20));break;case"string":case"text":"pointerdown"==event.type&&this.prompt("Value",w.value,function(e){inner_value_change(this,e)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return w}}}function inner_value_change(e,t,n){LiteGraph.log_debug("inner_value_change for processNodeWidgets",e,t);var i=t;n!=w.value&&(node.processCallbackHandlers("onWidgetChanged",{def_cb:node.onWidgetChanged},w.name,w.value,n,w),node.graph.onGraphChanged({action:"widgetChanged",doSave:!0})),"number"==e.type&&(t=Number(t)),e.value=t,e.options&&e.options.property&&void 0!==node.properties[e.options.property]&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event,i)}return null}},{key:"drawGroups",value:function(e,t){if(this.graph){var n=this.graph._groups;t.save();for(var i=0;i<n.length;++i){var o=n[i];if(LiteGraph.overlapBounding(this.visible_area,o._bounding)){t.fillStyle=o.color||"#335",t.strokeStyle=o.color||"#335",this.options.groups_border_alpha>=0&&t.setStrokeColor&&t.setStrokeColor(t.strokeStyle,this.options.groups_border_alpha);var a=o._pos,r=o._size;t.globalAlpha=this.options.groups_alpha*this.editor_alpha,t.beginPath(),t.rect(a[0]+.5,a[1]+.5,r[0],r[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(a[0]+r[0],a[1]+r[1]),t.lineTo(a[0]+r[0]-this.options.groups_triangle_handler_size,a[1]+r[1]),t.lineTo(a[0]+r[0],a[1]+r[1]-this.options.groups_triangle_handler_size),t.fill();var s=o.font_size||this.options.groups_title_font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=s+"px "+this.options.groups_title_font,t.textAlign=this.options.groups_title_alignment,this.options.groups_title_wrap?LiteGraph.canvasFillTextMultiline(t,o.title,a[0]+4,a[1]+s,r[0],s):t.fillText(o.title,a[0]+4,a[1]+s)}}t.restore()}}},{key:"adjustNodesSize",value:function(){for(var e=this.graph._nodes,t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)}},{key:"resize",value:function(e,t){if(e||t)LiteGraph.log_debug("lgraphcanvas","resize","passed",e,t,n);else{var n=this.canvas.parentNode;e=n.offsetWidth,t=n.offsetHeight,LiteGraph.log_debug("lgraphcanvas","resize","not passed: AUTO",n,e,t)}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}},{key:"switchLiveMode",value:function(e){if(!e)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var t=this,n=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var i=setInterval((function(){t.editor_alpha*=n,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,n<1&&t.editor_alpha<.01&&(clearInterval(i),n<1&&(t.live_mode=!0)),n>1&&t.editor_alpha>.99&&(clearInterval(i),t.editor_alpha=1)}),1)}},{key:"boundaryNodesForSelection",value:function(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}},{key:"getBoundaryForSelection",value:function(){var e=this.boundaryNodesForSelection();if(!e||null===e.left)return!1;var t=e.left.getBounding(),n=e.top.getBounding(),i=e.right.getBounding(),o=e.bottom.getBounding();return[t[0],n[1],i[0]+i[2]-t[0],o[1]+o[3]-n[1]]}},{key:"getCoordinateCenter",value:function(e){return[e[0]+e[2]/2,e[1]+e[3]/2]}},{key:"doShowMenuNodeProperties",value:function(e,t,n,i,o){LGraphCanvas.onShowMenuNodeProperties(e,t,n,i,o)}},{key:"showLinkMenu",value:function(e,t){var n=this;LiteGraph.log_verbose(e);var i=n.graph.getNodeById(e.origin_id),o=n.graph.getNodeById(e.target_id),a=!1;i&&i.outputs&&i.outputs[e.origin_slot]&&(a=i.outputs[e.origin_slot].type);var r=!1;o&&o.outputs&&o.outputs[e.target_slot]&&(r=o.inputs[e.target_slot].type);var s=LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=e.data?e.data.constructor.name:null,callback:function(t,l,h){switch(t){case"Add Node":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","calling onMenuAdd"),LGraphCanvas.onMenuAdd(null,null,h,s,(function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&(LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","node autoconnect on add node on link"),i.connectByType(e.origin_slot,t,a)&&(t.connectByType(e.target_slot,o,r),t.pos[0]-=.5*t.size[0]))}));break;case"Delete":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","remove link"),n.graph.removeLink(e.id);break;default:LiteGraph.log_debug.apply(LiteGraph,["lgraphcanvas","showLinkMenu","inner_clicked","node in the middle or other operation"].concat(Array.prototype.slice.call(arguments)))}}});return!1}},{key:"createDefaultNodeForSlot",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},e),n=t.nodeFrom&&null!==t.slotFrom,i=!n&&t.nodeTo&&null!==t.slotTo;if(!n&&!i)return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No data passed "+t.nodeFrom+" "+t.slotFrom+" "+t.nodeTo+" "+t.slotTo),!1;if(!t.nodeType)return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No type"),!1;var o=n?t.nodeFrom:t.nodeTo,a=n?t.slotFrom:t.slotTo,r=!1;switch(_typeof(a)){case"string":r=n?o.findOutputSlot(a,!1):o.findInputSlot(a,!1),a=n?o.outputs[a]:o.inputs[a];break;case"object":r=n?o.findOutputSlot(a.name):o.findInputSlot(a.name);break;case"number":r=a,a=n?o.outputs[a]:o.inputs[a];break;default:return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","Cant get slot information "+a),!1}!1!==a&&!1!==r||LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","bad slotX "+a+" "+r);var s=a.type==LiteGraph.EVENT?"_event_":a.type,l=n?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(l&&l[s]){a.link;var h=!1;if("object"==_typeof(l[s])){for(var u in l[s])if(t.nodeType==l[s][u]||"AUTO"==t.nodeType){h=l[s][u],LiteGraph.log_verbose("lgraphcanvas","createDefaultNodeForSlot","opts.nodeType == slotTypesDefault[fromSlotType][typeX] :: "+t.nodeType);break}}else t.nodeType!=l[s]&&"AUTO"!=t.nodeType||(h=l[s]);if(h){var c=!1;"object"==_typeof(h)&&h.node&&(c=h,h=h.node);var p=LiteGraph.createNode(h);if(p){if(c){if(c.properties)for(var d=0,_=Object.entries(c.properties);d<_.length;d++){var g=_slicedToArray(_[d],2),v=g[0],f=g[1];p.addProperty(v,f)}c.inputs&&(p.inputs=[],Object.values(c.inputs).forEach((function(e){p.addOutput(e[0],e[1])}))),c.outputs&&(p.outputs=[],Object.values(c.outputs).forEach((function(e){p.addOutput(e[0],e[1])}))),c.title&&(p.title=c.title),c.json&&p.configure(c.json)}return this.graph.add(p),p.pos=[t.position[0]+t.posAdd[0]+(t.posSizeFix[0]?t.posSizeFix[0]*p.size[0]:0),t.position[1]+t.posAdd[1]+(t.posSizeFix[1]?t.posSizeFix[1]*p.size[1]:0)],n?t.nodeFrom.connectByType(r,p,s):t.nodeTo.connectByTypeOutput(r,p,s),!0}LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","failed creating "+h)}}return!1}},{key:"showConnectionMenu",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null,isCustomEvent:!1},e),n=this,i=t.nodeFrom&&t.slotFrom,o=!i&&t.nodeTo&&t.slotTo;if(!i&&!o)return LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","No data passed to showConnectionMenu"),!1;var a=i?t.nodeFrom:t.nodeTo,r=i?t.slotFrom:t.slotTo,s=!1;switch(_typeof(r)){case"string":s=i?a.findOutputSlot(r,!1):a.findInputSlot(r,!1),r=i?a.outputs[r]:a.inputs[r];break;case"object":s=i?a.findOutputSlot(r.name):a.findInputSlot(r.name);break;case"number":s=r,r=i?a.outputs[r]:a.inputs[r];break;default:return LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","Cant get slot information "+r),!1}var l=["Add Node",null];n.allow_searchbox&&(l.push("Search"),l.push(null));var h=r.type===LiteGraph.EVENT?"_event_":r.type,u=i?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(u&&u[h]){var c=u[h];Array.isArray(c)||"object"===_typeof(c)?Object.values(c).forEach((function(e){l.push(e)})):l.push(c)}var p=LiteGraph.ContextMenu(l,{event:t.e,isCustomEvent:t.isCustomEvent,title:(r&&""!=r.name?r.name+(h?" | ":""):"")+(r&&h?h:""),callback:function(e,o,a){var l={"Add Node":function(){LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","Add Node calling onMenuAdd",e,o,a),LGraphCanvas.onMenuAdd(null,null,a,p,(function(e){i?t.nodeFrom.connectByType(s,e,h):t.nodeTo.connectByTypeOutput(s,e,h)}))},Search:function(){i?n.showSearchBox(a,{node_from:t.nodeFrom,slot_from:r,type_filter_in:h}):n.showSearchBox(a,{node_to:t.nodeTo,slot_from:r,type_filter_out:h})},default:function(){LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","createDefaultNodeForSlot",e,o,a);var i=[t.e.canvasX,t.e.canvasY];n.createDefaultNodeForSlot(Object.assign(t,{position:i,nodeType:e}))}};(l[e]||l.default)()}});return!1}},{key:"doShowNodeInfoEditor",value:function(e,t,n,i){LGraphCanvas.onShowNodeInfoEditor(t,i,n,null,e)}},{key:"prompt",value:function(){var e,t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",i=arguments.length>1?arguments[1]:void 0,o=arguments.length>2?arguments[2]:void 0,a=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,s=document.createElement("div");s.is_modified=!1,s.className="graphdialog rounded",s.innerHTML=r?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",s.close=function(){var e;t.prompt_box=null,null===(e=s.parentNode)||void 0===e||e.removeChild(s)};var l=LGraphCanvas.active_canvas.canvas;l.parentNode.appendChild(s),this.ds.scale>1&&(s.style.transform="scale(".concat(this.ds.scale,")"));var h=null;s.addEventListener("pointerleave",(function(e){LiteGraph.dialog_close_on_mouse_leave&&!s.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(h=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),s.addEventListener("pointerenter",(function(e){LiteGraph.dialog_close_on_mouse_leave&&h&&clearTimeout(h)}));var u=s.querySelectorAll("select");u&&u.forEach((function(e){e.addEventListener("click",(function(e){})),e.addEventListener("blur",(function(e){})),e.addEventListener("change",(function(e){}))})),null===(e=this.prompt_box)||void 0===e||e.close(),this.prompt_box=s,s.querySelector(".name").innerText=n;var c=s.querySelector(".value");c.value=i;var p=c;p.addEventListener("keydown",(function(e){switch(s.is_modified=!0,e.keyCode){case 27:s.close();break;case 13:"textarea"!==e.target.localName&&"function"==typeof o&&(o(p.value),t.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 ENTER",p.value,e.target.localName,o),s.close();break;default:return}e.preventDefault(),e.stopPropagation()})),s.querySelector("button").addEventListener("click",(function(e){"function"==typeof o&&(o(p.value),t.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 OK",p.value,o),s.close()}));var d=l.getBoundingClientRect(),_=-20,g=-20;return d&&(_-=d.left,g-=d.top),a?(s.style.left=a.clientX+_+"px",s.style.top=a.clientY+g+"px"):(s.style.left=.5*l.width+_+"px",s.style.top=.5*l.height+g+"px"),setTimeout((function(){p.focus()}),10),s}},{key:"showSearchBox",value:function(e,t){var n={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,hide_on_mouse_leave_time:LiteGraph.search_hide_on_mouse_leave_time,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};if(t=Object.assign(n,t||{}),"object"===_typeof(e)&&void 0!==e.target||void 0!==t.event&&(LiteGraph.log_debug("lgraphcanvas","showSearchBox","event not passed directly, using event from options",t.event,"first par was:",e),e=t.event),LiteGraph.log_debug("lgraphcanvas","showSearchBox",e,t),void 0===i)var i=this;else LiteGraph.log_debug("lgraphcanvas","showSearchBox","using already present graphcanvas reference",i,"this is other?",this);var o=LGraphCanvas.active_canvas,a=o.canvas,r=a.ownerDocument||document,s=document.createElement("div");if(s.className="litegraph litesearchbox graphdialog rounded",s.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(s.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",s.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),t.show_close_button&&(s.innerHTML+="<button class='close_searchbox close'>X</button>"),s.innerHTML+="<div class='helper'></div>",r.fullscreenElement?r.fullscreenElement.appendChild(s):(r.body.appendChild(s),r.body.style.overflow="hidden"),t.do_type_filter)var l=s.querySelector(".slot_in_type_filter"),h=s.querySelector(".slot_out_type_filter");if(s.close=function(){i.search_box=null,this.blur(),a.focus(),r.body.style.overflow="",setTimeout((function(){var e;null===(e=i.canvas)||void 0===e||e.focus(),i.canvas||LiteGraph.log_debug("lgraphcanvas","showSearchBox","dont have reference to canvas",i,"this is other?",this)}),20),s.parentNode&&s.parentNode.removeChild(s)},void 0!==i.ds?i.ds.scale>1&&(s.style.transform="scale(".concat(i.ds.scale,")")):LiteGraph.log_debug("lgraphcanvas","showSearchBox","ds reference not found, is this graphcanvas or what","that",i,"this",this),t.hide_on_mouse_leave){var u=!1,c=null;s.addEventListener("pointerenter",(function(e){c&&(clearTimeout(c),c=null)})),s.addEventListener("pointerleave",(function(e){u||(c=setTimeout((function(){s.close()}),t.hide_on_mouse_leave_time))})),t.do_type_filter&&(l.addEventListener("click",(function(e){u++})),l.addEventListener("blur",(function(e){u=0})),l.addEventListener("change",(function(e){u=-1})),h.addEventListener("click",(function(e){u++})),h.addEventListener("blur",(function(e){u=0})),h.addEventListener("change",(function(e){u=-1})))}i.search_box&&i.search_box.close(),i.search_box=s;var p=s.querySelector(".helper"),d=null,_=null,g=null,v=s.querySelector("input");if(v&&(v.addEventListener("blur",(function(e){i.search_box&&this.focus()})),v.addEventListener("keydown",(function(e){if(38==e.keyCode)N(!1);else if(40==e.keyCode)N(!0);else if(27==e.keyCode)s.close();else{if(13!=e.keyCode)return _&&clearInterval(_),void(_=setTimeout(S,250));S(),g?O(g.innerHTML):d?O(d):s.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0}))),t.do_type_filter){if(l){var f=LiteGraph.slot_types_in,y=f.length;t.type_filter_in!=LiteGraph.EVENT&&t.type_filter_in!=LiteGraph.ACTION||(t.type_filter_in="_event_");for(var b=0;b<y;b++){var k=document.createElement("option");k.value=f[b],k.innerHTML=f[b],l.appendChild(k),!1!==t.type_filter_in&&(t.type_filter_in+"").toLowerCase()==(f[b]+"").toLowerCase()&&(k.selected=!0)}l.addEventListener("change",(function(){S()}))}if(h){var L=LiteGraph.slot_types_out,m=L.length;t.type_filter_out!=LiteGraph.EVENT&&t.type_filter_out!=LiteGraph.ACTION||(t.type_filter_out="_event_");for(var G=0;G<m;G++){var C=document.createElement("option");C.value=L[G],C.innerHTML=L[G],h.appendChild(C),!1!==t.type_filter_out&&(t.type_filter_out+"").toLowerCase()==(L[G]+"").toLowerCase()&&(C.selected=!0)}h.addEventListener("change",(function(){S()}))}}t.show_close_button&&s.querySelector(".close").addEventListener("click",s.close);var w=a.getBoundingClientRect(),E=(e?e.clientX:w.left+.5*w.width)-80,T=(e?e.clientY:w.top+.5*w.height)-20;function O(n){if(n){if(!i||"object"!==_typeof(i)||void 0===i.processCallbackHandlers)return void LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","that reference is wrong",i,s,this,t);var a=i.processCallbackHandlers("onSearchBoxSelection",{def_cb:i.onSearchBoxSelection},n,e,o);if(null!==a&&(!0===a||"object"==_typeof(a)&&!0===a.return_value));else{var r=LiteGraph.searchbox_extras[n.toLowerCase()];r&&(n=r.type),o.graph.beforeChange();var l,h=LiteGraph.createNode(n);if(!h)return LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","failed creating the node",h),s.close(),!1;if(h.pos=o.convertEventToCanvasOffset(e),o.graph.add(h,!1,{doProcessChange:!1}),r&&r.data){if(r.data.properties)for(var u in r.data.properties)h.addProperty(u,r.data.properties[u]);if(r.data.inputs)for(var c in h.inputs=[],r.data.inputs)h.addOutput(r.data.inputs[c][0],r.data.inputs[c][1]);if(r.data.outputs)for(var p in h.outputs=[],r.data.outputs)h.addOutput(r.data.outputs[p][0],r.data.outputs[p][1]);r.data.title&&(h.title=r.data.title),r.data.json&&h.configure(r.data.json)}if(t.node_from){switch(l=!1,_typeof(t.slot_from)){case"string":l=t.node_from.findOutputSlot(t.slot_from);break;case"object":-1==(l=t.slot_from.name?t.node_from.findOutputSlot(t.slot_from.name):-1)&&void 0!==t.slot_from.slot_index&&(l=t.slot_from.slot_index);break;case"number":l=t.slot_from;break;default:l=0}void 0!==t.node_from.outputs[l]?!1!==l&&l>-1&&t.node_from.connectByType(l,h,t.node_from.outputs[l].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_from to join using from slot type",t.slot_from,t.node_from.outputs)}if(t.node_to){switch(l=!1,_typeof(t.slot_from)){case"string":l=t.node_to.findInputSlot(t.slot_from);break;case"object":-1==(l=t.slot_from.name?t.node_to.findInputSlot(t.slot_from.name):-1)&&void 0!==t.slot_from.slot_index&&(l=t.slot_from.slot_index);break;case"number":l=t.slot_from;break;default:l=0}void 0!==t.node_to.inputs[l]?!1!==l&&l>-1&&t.node_to.connectByTypeOutput(l,h,t.node_to.inputs[l].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_to to join using from slot type",t.slot_from,t.node_to.inputs)}o.graph.afterChange()}}s.close()}function N(e){var t=g;g&&g.classList.remove("selected"),g?(g=e?g.nextSibling:g.previousSibling)||(g=t):g=e?p.childNodes[0]:p.childNodes[p.childNodes.length],g&&(g.classList.add("selected"),g.scrollIntoView({block:"end",behavior:"smooth"}))}function S(){_=null;var e=v.value;if(d=null,p.innerHTML="",e||t.show_all_if_empty)if(i.onSearchBox){var n=i.onSearchBox(p,e,o);if(n)for(var a=0;a<n.length;++a)x(n[a])}else{var r=function(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},i),a=LiteGraph.registered_node_types[n];if(u&&a.filter!=u)return!1;var r,s=n.toLowerCase(),c=!0,p=_createForOfIteratorHelper(e.toLowerCase().split(" "));try{for(p.s();!(r=p.n()).done;){var d=r.value;if(LiteGraph.log_verbose("search","check",d,s),""!==d.trim()&&-1==s.indexOf(d)){c=!1,LiteGraph.log_verbose("search","do not pass",d,s);break}}}catch(e){p.e(e)}finally{p.f()}if((!t.show_all_if_empty||e)&&!c)return!1;if(t.do_type_filter&&!o.skipFilter){var _=n,g=l.value;if(!1!==o.inTypeOverride&&(g=o.inTypeOverride),l&&g&&LiteGraph.registered_slot_in_types[g]&&LiteGraph.registered_slot_in_types[g].nodes&&!1===LiteGraph.registered_slot_in_types[g].nodes.includes(_))return!1;if(g=h.value,!1!==o.outTypeOverride&&(g=o.outTypeOverride),h&&g&&LiteGraph.registered_slot_out_types[g]&&LiteGraph.registered_slot_out_types[g].nodes&&!1===LiteGraph.registered_slot_out_types[g].nodes.includes(_))return!1}return!0},s=0;e=e.toLowerCase();var l,h,u=o.filter||o.graph.filter;for(var c in t.do_type_filter&&i.search_box?(l=i.search_box.querySelector(".slot_in_type_filter"),h=i.search_box.querySelector(".slot_out_type_filter")):(l=!1,h=!1),LiteGraph.searchbox_extras){var g,f=LiteGraph.searchbox_extras[c],y=f.desc.toLowerCase(),b=f.title?f.title.toLowerCase():"",k=!0,L=_createForOfIteratorHelper(e.toLowerCase().split(" "));try{for(L.s();!(g=L.n()).done;){var m=g.value;if(""!==m.trim()&&(-1==y.indexOf(m)&&-1==b.indexOf(m))){k=!1;break}}}catch(e){L.e(e)}finally{L.f()}if(t.show_all_if_empty&&!e||k){var G=LiteGraph.registered_node_types[f.type];if((!G||G.filter==u)&&r(f.type)&&(x(f.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit&&s++>LGraphCanvas.search_limit))break}}var C=null;if(Array.prototype.filter)C=Object.keys(LiteGraph.registered_node_types).filter(r);else for(var w in C=[],LiteGraph.registered_node_types)r(w)&&C.push(w);for(var E=0;E<C.length&&(x(C[E]),!(-1!==LGraphCanvas.search_limit&&s++>LGraphCanvas.search_limit));E++);if(t.show_general_after_typefiltered&&(l.value||h.value)){var T=[];for(var N in LiteGraph.registered_node_types)r(N,{inTypeOverride:!(!l||!l.value)&&"*",outTypeOverride:!(!h||!h.value)&&"*"})&&T.push(N);for(var S=0;S<T.length&&(x(T[S],"generic_type"),!(-1!==LGraphCanvas.search_limit&&s++>LGraphCanvas.search_limit));S++);}if((l.value||h.value)&&0==p.childNodes.length&&t.show_general_if_none_on_typefilter){var I=[];for(var A in LiteGraph.registered_node_types)r(A,{skipFilter:!0})&&I.push(A);for(var P=0;P<I.length&&(x(I[P],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&s++>LGraphCanvas.search_limit));P++);}}function x(e,t){var n=document.createElement("div");d||(d=e),n.innerText=e,n.dataset.type=escape(e),n.className="litegraph lite-search-item",t&&(n.className+=" "+t),n.addEventListener("click",(function(e){O(unescape(this.dataset.type))})),p.appendChild(n)}}return w.width-E<470&&(E=w.width-470),w.height-T<220&&(T=w.height-220),E<w.left+20&&(E=w.left+20),T<w.top+20&&(T=w.top+20),s.style.left=E+"px",s.style.top=T+"px",v.focus(),t.show_all_on_open&&S(),s}},{key:"showEditPropertyValue",value:function(e,t,n){if(e&&void 0!==e.properties[t]){n=n||{};var i,o=e.getPropertyInfo(t),a=o&&null!==o?o.type:"string";if("string"==a||"number"==a||"array"==a||"object"==a||"code"==a)i="<input autofocus type='text' class='value'/>";else if("enum"!=a&&"combo"!=a||!o.values){if("boolean"!=a&&"toggle"!=a)return void LiteGraph.log_warn("lgraphcanvas","showEditPropertyValue","unknown type",a);i="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>"}else{for(var r in LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","CREATING ENUM COMBO",h,a,l),i="<select autofocus type='text' class='value'>",o.values){var s=r;o.values.constructor===Array&&(s=o.values[r]),i+="<option value='"+s+"' "+(s==e.properties[t]?"selected":"")+">"+o.values[r]+"</option>"}i+="</select>"}var l=this.createDialog("<span class='name'>"+(o.label?o.label:t)+"</span>"+i+"<button>OK</button>",n),h=!1;return"enum"!=a&&"combo"!=a||!o.values?"boolean"==a||"toggle"==a?(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","TOGGLE",h,a,l),(h=l.querySelector("input"))&&h.addEventListener("click",(function(e){l.modified(),c(!!h.checked)}))):(h=l.querySelector("input"),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue",h,a,l),h&&(h.addEventListener("blur",(function(e){this.focus()})),s=void 0!==e.properties[t]?e.properties[t]:"","string"!==a&&(s=JSON.stringify(s)),h.value=s,h.addEventListener("keydown",(function(e){if(27==e.keyCode)l.close();else if(13==e.keyCode)u();else if(13!=e.keyCode)return void l.modified();e.preventDefault(),e.stopPropagation()})))):(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","showEditPropertyValue ENUM COMBO",h,a,l),(h=l.querySelector("select")).addEventListener("change",(function(e){l.modified(),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","Enum change",h,o,e.target),c(e.target.value)}))),h&&h.focus(),l.querySelector("button").addEventListener("click",u),l}function u(){c(h.value)}function c(i){var r;o&&o.values&&o.values.constructor===Object&&null!=o.values[i]&&(i=o.values[i]),"number"==typeof e.properties[t]&&(i=Number(i)),"array"!=a&&"object"!=a||(i=JSON.parse(i));var s=e.properties[t];e.properties[t]=i,null===(r=e.graph)||void 0===r||r.onGraphChanged({action:"propertyChanged",doSave:!0});var h=e.processCallbackHandlers("onPropertyChanged",{def_cb:e.onPropertyChanged},t,i,s);(!1===h||null!==h&&"object"==_typeof(h)&&!1===h.return_value)&&(e.properties[t]=s,LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","setValue","prevent property set by cbHandler",t,i,s,h)),n.onclose&&n.onclose(),l.close(),e.setDirtyCanvas(!0,!0)}}},{key:"createDialog",value:function(e,t){t=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},t||{});var n=document.createElement("div");n.className="graphdialog",n.innerHTML=e,n.is_modified=!1;var i=this.canvas.getBoundingClientRect(),o=-20,a=-20;if(i&&(o-=i.left,a-=i.top),t.position?(o+=t.position[0],a+=t.position[1]):t.event?(o+=t.event.clientX,a+=t.event.clientY):(o+=.5*this.canvas.width,a+=.5*this.canvas.height),n.style.left=o+"px",n.style.top=a+"px",this.canvas.parentNode.appendChild(n),t.checkForInput){var r=[];(r=n.querySelectorAll("input"))&&r.forEach((function(e){e.addEventListener("keydown",(function(e){if(n.modified(),27==e.keyCode)n.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()})),e.focus()}))}n.modified=function(){n.is_modified=!0},n.close=function(){n.parentNode&&n.parentNode.removeChild(n)};var s=null,l=!1;n.addEventListener("pointerleave",(function(e){l||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!n.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(s=setTimeout(n.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),n.addEventListener("pointerenter",(function(e){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&s&&clearTimeout(s)}));var h=n.querySelectorAll("select");return h&&h.forEach((function(e){e.addEventListener("click",(function(e){l++})),e.addEventListener("blur",(function(e){l=0})),e.addEventListener("change",(function(e){l=-1}))})),n}},{key:"createPanel",value:function(e,t){var n=(t=t||{}).window||window,i=document.createElement("div");if(i.className="litegraph dialog",i.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",i.header=i.querySelector(".dialog-header"),t.width&&(i.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(i.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var o=document.createElement("span");o.innerHTML="&#10005;",o.classList.add("close"),o.addEventListener("click",(function(){i.close()})),i.header.appendChild(o)}return i.title_element=i.querySelector(".dialog-title"),i.title_element.innerText=e,i.content=i.querySelector(".dialog-content"),i.alt_content=i.querySelector(".dialog-alt-content"),i.footer=i.querySelector(".dialog-footer"),i.close=function(){i.onClose&&"function"==typeof i.onClose&&i.onClose(),i.parentNode&&i.parentNode.removeChild(i),this.parentNode&&this.parentNode.removeChild(this)},i.toggleAltContent=function(e){var t,n;void 0!==e?(t=e?"block":"none",n=e?"none":"block"):(t="block"!=i.alt_content.style.display?"block":"none",n="block"!=i.alt_content.style.display?"none":"block"),i.alt_content.style.display=t,i.content.style.display=n},i.toggleFooterVisibility=function(e){var t;t=void 0!==e?e?"block":"none":"block"!=i.footer.style.display?"block":"none",i.footer.style.display=t},i.clear=function(){this.content.innerHTML=""},i.addHTML=function(e,t,n){var o=document.createElement("div");return t&&(o.className=t),o.innerHTML=e,n?i.footer.appendChild(o):i.content.appendChild(o),o},i.addButton=function(e,t,n){var o=document.createElement("button");return o.innerText=e,o.options=n,o.classList.add("btn"),o.addEventListener("click",t),i.footer.appendChild(o),o},i.addSeparator=function(){var e=document.createElement("div");e.className="separator",i.content.appendChild(e)},i.addWidget=function(e,t,o,a,r){a=a||{};var s=String(o);"number"==(e=e.toLowerCase())&&(s=LiteGraph.formatNumber(o,3));var l=document.createElement("div");l.className="property",l.innerHTML="<span class='property_name'></span><span class='property_value'></span>",l.querySelector(".property_name").innerText=a.label||t;var h=l.querySelector(".property_value");function u(e,t){LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","innerChange",e,t,a),a.callback&&a.callback(e,t,a),r&&r(e,t,a)}return h.innerText=s,l.dataset.property=t,l.dataset.type=a.type||e,l.options=a,l.value=o,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget",e,o,h,a),"code"==e?l.addEventListener("click",(function(e){i.inner_showCodePad(this.dataset.property)})):"boolean"==e?(l.classList.add("boolean"),o&&l.classList.add("bool-on"),l.addEventListener("click",(function(){var e=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"on":"off",u(e,this.value)}))):"string"==e||"number"==e?(h.setAttribute("contenteditable",!0),h.addEventListener("keydown",(function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())})),h.addEventListener("blur",(function(){var e=this.innerText,t=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(e=Number(e)),u(t,e)}))):"enum"!=e&&"combo"!=e||(s=LGraphCanvas.getPropertyPrintableValue(o,a.values),h.innerText=s,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","ENUM COMBO",e,s,h,a),h.addEventListener("click",(function(e){var t=a.values||[],i=this.parentNode.dataset.property,o=this;LiteGraph.ContextMenu(t,{event:e,className:"dark",callback:function(e){return o.innerText=e,u(i,e),!1}},n)}))),i.content.appendChild(l),l},i.onOpen&&"function"==typeof i.onOpen&&i.onOpen(),i}},{key:"showShowGraphOptionsPanel",value:function(e,t){var n;if(this.constructor&&"HTMLDivElement"==this.constructor.name){var i;if(null==t||null===(i=t.event)||void 0===i||null===(i=i.target)||void 0===i||!i.lgraphcanvas)return LiteGraph.log_warn("lgraphcanvas","showShowGraphOptionsPanel","References not found to add optionPanel",e,t),void LiteGraph.log_debug("lgraphcanvas","showShowGraphOptionsPanel","!obEv || !obEv.event || !obEv.event.target || !obEv.event.target.lgraphcanvas",t,t.event,t.event.target,t.event.target.lgraphcanvas);n=t.event.target.lgraphcanvas}else n=this;n.closePanels();var o=n.getCanvasWindow();panel=n.createPanel("Options",{closable:!0,window:o,onOpen:function(){n.OPTIONPANEL_IS_OPEN=!0},onClose:function(){n.OPTIONPANEL_IS_OPEN=!1,n.options_panel=null}}),n.options_panel=panel,panel.id="option-panel",panel.classList.add("settings"),function(){panel.content.innerHTML="";var e=function(e,t,i){LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","want to update graph options: "+e+": "+t),i&&i.key&&(e=i.key),i.values&&(t=Object.values(i.values).indexOf(t)),LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","update graph option: "+e+": "+t),n[e]=t},t=LiteGraph.availableCanvasOptions;for(var i in t.sort(),t){var o=t[i];panel.addWidget("boolean",o,n[o],{key:o,on:"on",off:"off"},e)}panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[n.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},e),panel.addSeparator(),panel.footer.innerHTML=""}(),n.canvas.parentNode.appendChild(panel)}},{key:"showShowNodePanel",value:function(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),n=this,i=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){n.NODEPANEL_IS_OPEN=!0},onClose:function(){n.NODEPANEL_IS_OPEN=!1,n.node_panel=null}});function o(){i.content.innerHTML="",i.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),i.addHTML("<h3>Properties</h3>");var t=function(t,i){switch(n.graph.beforeChange(e),t){case"Title":e.title=i;break;case"Mode":var o=Object.values(LiteGraph.NODE_MODES).indexOf(i);o>=0&&LiteGraph.NODE_MODES[o]?e.changeMode(o):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected mode",i,o);break;case"Color":LGraphCanvas.node_colors[i]?(e.color=LGraphCanvas.node_colors[i].color,e.bgcolor=LGraphCanvas.node_colors[i].bgcolor):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected color",i);break;default:e.setProperty(t,i)}n.graph.afterChange(),n.dirty_canvas=!0};i.addWidget("string","Title",e.title,{},t),i.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},t);var o="";for(var a in void 0!==e.color&&(o=Object.keys(LGraphCanvas.node_colors).filter((function(t){return LGraphCanvas.node_colors[t].color==e.color}))),i.addWidget("combo","Color",o,{values:Object.keys(LGraphCanvas.node_colors)},t),e.properties){var r=e.properties[a],s=e.getPropertyInfo(a),l=s&&null!==s?s.type:"string";e.onAddPropertyToPanel&&e.onAddPropertyToPanel(a,i,r,s,t)||i.addWidget(s.widget||l,a,r,s,t)}i.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(i),i.footer.innerHTML="",i.addButton("Delete",(function(){e.block_delete||(e.graph.remove(e),i.close())})).classList.add("delete")}n.node_panel=i,i.id="node-panel",i.node=e,i.classList.add("settings"),i.inner_showCodePad=function(t){i.classList.remove("settings"),i.classList.add("centered"),i.alt_content.innerHTML="<textarea class='code'></textarea>";var n=i.alt_content.querySelector("textarea"),a=function(){i.toggleAltContent(!1),i.toggleFooterVisibility(!0),n.parentNode.removeChild(n),i.classList.add("settings"),i.classList.remove("centered"),o()};n.value=e.properties[t],n.addEventListener("keydown",(function(i){"Enter"==i.code&&i.ctrlKey&&(e.setProperty(t,n.value),a())})),i.toggleAltContent(!0),i.toggleFooterVisibility(!1),n.style.height="calc(100% - 40px)";var r=i.addButton("Assign",(function(){e.setProperty(t,n.value),a()}));i.alt_content.appendChild(r);var s=i.addButton("Close",a);s.style.float="right",i.alt_content.appendChild(s)},o(),this.canvas.parentNode.appendChild(i)}},{key:"showSubgraphPropertiesDialog",value:function(e){LiteGraph.log_debug("lgraphcanvas","showSubgraphPropertiesDialog","showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function i(){if(n.clear(),e.inputs)for(var t=0;t<e.inputs.length;++t){var o=e.inputs[t];if(!o.not_subgraph_input){var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=o.name,a.dataset.slot=t,a.querySelector(".name").innerText=o.name,a.querySelector(".type").innerText=o.type,a.querySelector("button").addEventListener("click",(function(t){e.removeInput(Number(this.parentNode.dataset.slot)),i()}))}}}n.node=e,n.classList.add("subgraph_dialog");return n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(t){var n=this.parentNode,o=n.querySelector(".name").value,a=n.querySelector(".type").value;o&&-1==e.findInputSlot(o)&&(["event","action"].indexOf(a)>-1&&(a=LiteGraph.EVENT),e.addInput(o,a),n.querySelector(".name").value="",n.querySelector(".type").value="",i())})),i(),this.canvas.parentNode.appendChild(n),n}},{key:"showSubgraphPropertiesDialogRight",value:function(e){LiteGraph.log_verbose("lgraphcanvas","showSubgraphPropertiesDialogRight","showing subgraph properties dialog RIGHT");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var n=this.createPanel("Subgraph Outputs",{closable:!0,width:500});function i(){if(n.clear(),e.outputs)for(var t=0;t<e.outputs.length;++t){var o=e.outputs[t];if(!o.not_subgraph_output){var a=n.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");a.dataset.name=o.name,a.dataset.slot=t,a.querySelector(".name").innerText=o.name,a.querySelector(".type").innerText=o.type,a.querySelector("button").addEventListener("click",(function(t){e.removeOutput(Number(this.parentNode.dataset.slot)),i()}))}}}n.node=e,n.classList.add("subgraph_dialog");var o=n.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function a(){var t=this.parentNode,n=t.querySelector(".name").value,o=t.querySelector(".type").value;n&&-1==e.findOutputSlot(n)&&(["event","action"].indexOf(o)>-1&&(o=LiteGraph.EVENT),e.addOutput(n,o),t.querySelector(".name").value="",t.querySelector(".type").value="",i())}return o.querySelector(".name").addEventListener("keydown",(function(e){13==e.keyCode&&a.apply(this)})),o.querySelector("button").addEventListener("click",(function(e){a.apply(this)})),i(),this.canvas.parentNode.appendChild(n),n}},{key:"closePanels",value:function(){var e=document.querySelector("#node-panel");e&&e.close(),(e=document.querySelector("#option-panel"))&&e.close()}},{key:"checkPanels",value:function(){if(this.canvas)for(var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog"),t=0;t<e.length;++t){var n=e[t];n.node&&(n.node.graph&&n.graph==this.graph||n.close())}}},{key:"getCanvasMenuOptions",value:function(){var e=null,t=this.processCallbackHandlers("getMenuOptions",{def_cb:this.getMenuOptions});return null!==t&&(!0===t||"object"==_typeof(t)&&!0===t.return_value)||(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Search",has_submenu:!1,callback:this.showSearchBox},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),null!==(t=this.processCallbackHandlers("getExtraMenuOptions",{def_cb:this.getExtraMenuOptions},this,e))&&"object"==_typeof(t)&&"object"==_typeof(t.return_value)&&(e=e.concat(t.return_value)),e}},{key:"getNodeMenuOptions",value:function(e){var t=null,n=e.processCallbackHandlers("getMenuOptions",{def_cb:e.getMenuOptions},this);return null!==n&&"object"==_typeof(n)&&"object"==_typeof(n.return_value)&&(t=n.return_value),null===t&&(t=[{content:"Inputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],!1!==e.resizable&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),LiteGraph.do_add_triggers_slots&&(t[1].disabled=!1),null!==(n=e.processCallbackHandlers("getExtraMenuOptions",{def_cb:e.getExtraMenuOptions},this,t))&&"object"==_typeof(n)&&"object"==_typeof(n.return_value)&&void 0!==n.return_value.length&&n.return_value.length&&(extra.push(null),t=extra.concat(n.return_value)),!1!==e.clonable&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(!1!==e.removable&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.processCallbackHandlers("onGetNodeMenuOptions",{def_cb:e.graph.onGetNodeMenuOptions},t,e),t}},{key:"getGroupMenuOptions",value:function(){return[{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowNodeInfoEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}},{key:"processContextMenu",value:function(e,t){var n=this,i=LGraphCanvas.active_canvas.getCanvasWindow(),o=null,a={event:t,callback:function(t,i){if(!t)return;var o;if("Remove Slot"==t.content)return o=t.slot,e.graph.beforeChange(),o.input?e.removeInput(o.slot):o.output&&e.removeOutput(o.slot),void e.graph.afterChange();if("Disconnect Links"==t.content)return o=t.slot,e.graph.beforeChange(),o.output?e.disconnectOutput(o.slot):o.input&&e.disconnectInput(o.slot),void e.graph.afterChange();if("Rename Slot"==t.content){var a=(o=t.slot).input?e.getInputInfo(o.slot):e.getOutputInfo(o.slot),r=n.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",i),s=r.querySelector("input");s&&a&&(s.value=a.label||"");var l=function(){e.graph.beforeChange(),s.value&&(a&&(a.label=s.value),n.setDirty(!0)),r.close(),e.graph.afterChange()};r.querySelector("button").addEventListener("click",l),s.addEventListener("keydown",(function(e){if(r.is_modified=!0,27==e.keyCode)r.close();else if(13==e.keyCode)l();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})),s.focus()}},extra:e};e&&(a.title=e.type);var r=null;if(e&&(r=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),r){o=[];var s=e.processCallbackHandlers("getSlotMenuOptions",{def_cb:e.getSlotMenuOptions},r);if(null!==s&&"object"==_typeof(s)&&"object"==_typeof(s.return_value))o=s.return_value;else{var l,h;(null!==(l=r)&&void 0!==l&&null!==(l=l.output)&&void 0!==l&&null!==(l=l.links)&&void 0!==l&&l.length||null!==(h=r.input)&&void 0!==h&&h.link)&&o.push({content:"Disconnect Links",slot:r});var u=r.input||r.output;u.removable&&LiteGraph.canRemoveSlots&&o.push(u.locked?"Cannot remove":{content:"Remove Slot",slot:r}),!u.nameLocked&&LiteGraph.canRenameSlots&&o.push({content:"Rename Slot",slot:r})}var c=r.input||r.output;a.title=c.type||"*",c.type==LiteGraph.ACTION?a.title="Action":c.type==LiteGraph.EVENT&&(a.title="Event")}else if(e)o=this.getNodeMenuOptions(e);else{o=this.getCanvasMenuOptions();var p=this.graph.getGroupOnPos(t.canvasX,t.canvasY);a.filter_enabled=!1,p&&(o.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:p,options:this.getGroupMenuOptions(p)}}),o.push(null,{content:"Select nodes",canvas:this,group:p,callback:function(e,t,n,i){console.warn(e),e.canvas.selectNodes(e.group._nodes)}}))}o&&LiteGraph.ContextMenu(o,a,i)}},{key:"lowQualityRenderingRequired",value:function(e){return this.ds.scale<e&&this.low_quality_rendering_counter>this.low_quality_rendering_threshold}},{key:"updateBackground",value:function(e,t){var n=this;this._bg_img=new Image,this._bg_img.name=e,this._bg_img.src=e,this._bg_img.onload=function(){n.draw(!0,!0)},this.background_image=e,this.clear_background=!0,this.clear_background_color=t,this._pattern=null}}],[{key:"getFileExtension",value:function(e){return(e=e?e+"":"").slice(2+(e.lastIndexOf(".")-1>>>0)).toLowerCase()}},{key:"onGroupAdd",value:function(e,t,n){var i=LGraphCanvas.active_canvas,o=new LiteGraph.LGraphGroup;if(i.options.groups_add_around_selected&&Object.keys(i.selected_nodes).length){var a=i.getBoundaryForSelection();if(a){var r=i.options.groups_add_default_spacing,s=1.5*i.options.groups_title_font_size;o.pos=[a[0]-r,a[1]-s-r],o.size=[a[2]+2*r,a[3]+s+2*r],LiteGraph.log_debug("lgraphcanvas","onGroupAdd","groups_add_around_selected",a,o)}else o.pos=i.convertEventToCanvasOffset(n)}else o.pos=i.convertEventToCanvasOffset(n);i.graph.add(o)}},{key:"getBoundaryNodes",value:function(e){var t=null,n=null,i=null,o=null;for(var a in e){var r=e[a],s=_slicedToArray(r.pos,2),l=s[0],h=s[1],u=_slicedToArray(r.size,2),c=u[0],p=u[1];(null===t||h<t.pos[1])&&(t=r),(null===n||l+c>n.pos[0]+n.size[0])&&(n=r),(null===i||h+p>i.pos[1]+i.size[1])&&(i=r),(null===o||l<o.pos[0])&&(o=r)}return{top:t,right:n,bottom:i,left:o}}},{key:"alignNodes",value:function(e,t,n){if(e){var i=LGraphCanvas.active_canvas,o=[];o=void 0===n?LGraphCanvas.getBoundaryNodes(e):{top:n,right:n,bottom:n,left:n};for(var a=0,r=Object.entries(i.selected_nodes);a<r.length;a++){var s=_slicedToArray(r[a],2);s[0];var l=s[1];switch(t){case"right":l.pos[0]=o.right.pos[0]+o.right.size[0]-l.size[0];break;case"left":l.pos[0]=o.left.pos[0];break;case"top":l.pos[1]=o.top.pos[1];break;case"bottom":l.pos[1]=o.bottom.pos[1]+o.bottom.size[1]-l.size[1]}}i.dirty_canvas=!0,i.dirty_bgcanvas=!0}}},{key:"onNodeAlign",value:function(e,t,n,i,o){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase(),o)},parentMenu:i})}},{key:"onGroupAlign",value:function(e,t,n,i){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:n,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase())},parentMenu:i})}},{key:"onMenuAdd",value:function(e,t,n,i,o){var a=LGraphCanvas.active_canvas,r=a.getCanvasWindow(),s=a.graph;if(s)return function e(i,l){var h=LiteGraph.getNodeTypesCategories(a.filter||s.filter).filter((function(e){return e.startsWith(i)})),u=[];h.map((function(t){if(t){var n=new RegExp("^("+i+")"),o=t.replace(n,"").split("/")[0],a=""===i?o+"/":i+o+"/",r=o;-1!=r.indexOf("::")&&(r=r.split("::")[1]),-1===u.findIndex((function(e){return e.value===a}))&&u.push({value:a,content:r,has_submenu:!0,callback:function(t,n,i,o){LiteGraph.log_debug.apply(LiteGraph,["onMenuAdd","inner_onMenuAdded","categories callback"].concat(Array.prototype.slice.call(arguments))),e(t.value,o)}})}})),LiteGraph.getNodeTypesInCategory(i.slice(0,-1),a.filter||s.filter).map((function(e){if(!e.skip_list){var t={value:e.type,content:e.title,has_submenu:!1,callback:function(e,t,n,i){var r=i.getFirstEvent();a.graph.beforeChange();var s=LiteGraph.createNode(e.value);LiteGraph.log_debug.apply(LiteGraph,["onMenuAdd","inner_onMenuAdded","node entry callback",r].concat(Array.prototype.slice.call(arguments))),s&&(s.pos=a.convertEventToCanvasOffset(r),a.graph.add(s)),o&&o(s),a.graph.afterChange()}};u.push(t)}}));var c=n||t.event;LiteGraph.log_debug("lgraphcanvas","onMenuAdd","inner_onMenuAdded","opening ContextMenu",u,{event:c,parentMenu:l},r),LiteGraph.ContextMenu(u,{event:c,parentMenu:l},r)}("",i),!1}},{key:"onMenuCollapseAll",value:function(){}},{key:"onMenuNodeEdit",value:function(){}},{key:"showMenuNodeOptionalInputs",value:function(e,t,n,i,o){if(o){var a=this,r=null,s=LGraphCanvas.active_canvas.getCanvasWindow();t=o.optional_inputs,null!==(r=o.processCallbackHandlers("onGetInputs",{def_cb:o.onGetInputs}))&&"object"==_typeof(r)&&("object"==_typeof(r.return_value)?t=r.return_value:void 0!==r.length&&(t=r));var l=[];if(t)for(var h=0;h<t.length;h++){var u=t[h];if(u){var c=u[0];u[2]||(u[2]={}),u[2].label&&(c=u[2].label),u[2].removable=!0,u[2].optional=!0;var p={content:c,value:u};u[1]==LiteGraph.ACTION&&(p.className="event"),l.push(p)}else l.push(null)}if(null!==(r=o.processCallbackHandlers("onMenuNodeInputs",{def_cb:o.onMenuNodeInputs},l))&&"object"==_typeof(r)&&"object"==_typeof(r.return_value)&&(l=r.return_value),LiteGraph.do_add_triggers_slots&&-1==o.findInputSlot("onTrigger")&&l.push({content:"On Trigger",value:["onTrigger",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),l.length)return LiteGraph.ContextMenu(l,{event:n,callback:function(e,t,n){if(!o)return;e.callback&&e.callback.call(a,o,e,t,n);if(e.value){o.graph.beforeChange();var i={};e.value[2]&&(i=Object.assign(i,e.value[2])),o.addInput(e.value[0],e.value[1],i),o.processCallbackHandlers("onNodeInputAdd",{def_cb:o.onNodeInputAdd},e.value),o.setDirtyCanvas(!0,!0),o.graph.afterChange()}},parentMenu:i,node:o},s),!1;LiteGraph.log_debug("lgraphcanvas","showMenuNodeOptionalInputs","no input entries")}}},{key:"showMenuNodeOptionalOutputs",value:function(e,t,n,i,o){if(o){var a=this,r=LGraphCanvas.active_canvas.getCanvasWindow();t=o.optional_outputs;var s=o.processCallbackHandlers("onGetOutputs",{def_cb:o.onGetOutputs});null!==s&&"object"==_typeof(s)&&("object"==_typeof(s.return_value)?t=s.return_value:void 0!==s.length&&(t=s));var l=[];if(t)for(var h=0;h<t.length;h++){var u=t[h];if(u){if(!o.flags||!o.flags.skip_repeated_outputs||-1==o.findOutputSlot(u[0])){var c=u[0];u[2]||(u[2]={}),u[2].label&&(c=u[2].label),u[2].removable=!0,u[2].optional=!0;var p={content:c,value:u};u[1]==LiteGraph.EVENT&&(p.className="event"),l.push(p)}}else l.push(null)}if(null!==(s=o.processCallbackHandlers("onMenuNodeOutputs",{def_cb:o.onMenuNodeOutputs},l))&&"object"==_typeof(s)&&"object"==_typeof(s.return_value)&&(l=s.return_value),LiteGraph.do_add_triggers_slots&&-1==o.findOutputSlot("onExecuted")&&l.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),l.length)return LiteGraph.ContextMenu(l,{event:n,callback:function e(t,n,r){if(!o)return;t.callback&&t.callback.call(a,o,t,n,r);if(!t.value)return;var s=t.value[1];if(s&&(s.constructor===Object||s.constructor===Array)){var l=[];for(var h in s)l.push({content:h,value:s[h]});return LiteGraph.ContextMenu(l,{event:n,callback:e,parentMenu:i,node:o}),!1}o.graph.beforeChange();var u={};t.value[2]&&(u=Object.assign(u,t.value[2])),o.addOutput(t.value[0],t.value[1],u),o.processCallbackHandlers("onNodeOutputAdd",{def_cb:o.onNodeOutputAdd},t.value),o.setDirtyCanvas(!0,!0),o.graph.afterChange()},parentMenu:i,node:o},r),!1}}},{key:"onShowMenuNodeProperties",value:function(e,t,n,i,o){if(o&&o.properties){var a=LGraphCanvas.active_canvas,r=a.getCanvasWindow(),s=[],l=function(){var e=void 0!==o.properties[h]?o.properties[h]:" ";"object"==_typeof(e)&&(e=JSON.stringify(e));var t=o.getPropertyInfo(h),n=t&&null!==t?t.type:"string",i=!(!t||null===t)&&!!t.readonly,a=!(!t||null===t)&&!!t.prevent_input_bind,r=!(!t||null===t)&&!!t.prevent_output_bind,l=t&&null!==t&&t.label?t.label:h;"enum"!=n&&"combo"!=n||(e=LGraphCanvas.getPropertyPrintableValue(e,t.values)),e=LGraphCanvas.decodeHTML(e);var u,c="<span class='property_name'>"+l+"</span><span class='property_value'>"+e+"</span>",p=[];if(!a&&!i&&LiteGraph.properties_allow_input_binding){var d=o.findInputSlot(l,!0),_=-1!==d,g=!!_&&d.param_bind;c+="<span class='property_input_bind'>"+(g?"<span class='property_input_binded'>linked</span>":_?"<span class='property_input_exist'><input type='button' class='btn_bind_in btn_bind_property_to_input' value='link input' /></span>":"<span class=''><input type='button' class='btn_bind_in btn_bind_property_to_input' value='create input' /></span>")+"</span>",p.push((function(e,t){LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","calling callback_on_element_created",l,e,g,d);var i=e.querySelector(".btn_bind_in");i?(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_bind_in binding!",i,l),i.addEventListener("click",(function(e){var i;(d=o.findInputSlot(l,!0),g=!!(_=-1!==d)&&d.param_bind)?LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Property already binded",d,l):(_||(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","CREATING NEW INPUT ON NODE",d,l),o.addInput(l,n,{removable:!0,nameLocked:!0}),d=o.findInputSlot(l,!0)),LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Linking property to input",d),d.param_bind=!0,null===(i=t.close)||void 0===i||i.call(t,e,!0));e.preventDefault(),e.stopPropagation()}))):(e.disabled="disabled",LiteGraph.log_warn("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_bind_in not found",l,e))}))}if(!r&&LiteGraph.properties_allow_output_binding){var v=o.findOutputSlot(l,!0),f=-1!==v,y=!!f&&v.param_bind;c+="<span class='property_output_bind'>"+(y?"<span class='property_output_binded'>linked</span>":f?"<span class='property_output_exist'><input type='button' class='btn_bind_out btn_bind_property_to_output' value='link output' /></span>":"<span class=''><input type='button' class='btn_bind_out btn_bind_property_to_output' value='create output' /></span>")+"</span>",p.push((function(e,t){LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output calling callback_on_element_created",l,e,y,v);var i=e.querySelector(".btn_bind_out");i?(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output .btn_bind_out binding!",i,l),i.addEventListener("click",(function(e){var i;(v=o.findOutputSlot(l,!0),y=!!(f=-1!==v)&&v.param_bind)?LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","Property already binded",v,l):(f||(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","CREATING NEW OUTPUT ON NODE",v,l),o.addOutput(l,n,{removable:!0,nameLocked:!0}),v=o.findOutputSlot(l,!0)),LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","Linking property to output",v),v.param_bind=!0,null===(i=t.close)||void 0===i||i.call(t,e,!0));e.preventDefault(),e.stopPropagation()}))):(e.disabled="disabled",LiteGraph.log_warn("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output .btn_bind_out not found",l,e))}))}LiteGraph.properties_allow_widget_binding&&(null===(u=o.widgets)||void 0===u||u.find((function(e){var t;return e&&(null===(t=e.options)||void 0===t?void 0:t.property)===l})));s.push({content:c,value:h,callbacks_on_element_created:p,readonly:i})};for(var h in o.properties)l();if(s.length)return LiteGraph.ContextMenu(s,{event:n,callback:function(e,t,n,i,r){if(LiteGraph.log_debug.apply(LiteGraph,["lgraphcanvas","onShowMenuNodeProperties","inner_clicked",this].concat(Array.prototype.slice.call(arguments))),!o)return;if(!(console.warn("**showeditproperty**",e,t),this.disabled||e.disabled||e.readonly)){var s=this.getBoundingClientRect();a.showEditPropertyValue(o,e.value,{position:[s.left,s.top]})}},parentMenu:i,allow_html:!0,node:o},r),!1}}},{key:"decodeHTML",value:function(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML}},{key:"onMenuResizeNode",value:function(e,t,n,i,o){if(o){var a=LGraphCanvas.active_canvas;a.getCanvasWindow();var r=a.graph;null==r||r.onGraphChanged({action:"resize",doSave:!0});var s=function(e){e.size=e.computeSize(),e.processCallbackHandlers("onResize",{def_cb:e.onResize},e.size)},l=LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)s(o);else for(var h in l.selected_nodes)s(l.selected_nodes[h]);o.setDirtyCanvas(!0,!0)}}},{key:"onShowNodeInfoEditor",value:function(e,t,n,i,o){var a=e.property||"title",r=o[a],s=document.createElement("div");s.is_modified=!1,s.className="graphdialog",s.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",s.close=function(){var e;null===(e=s.parentNode)||void 0===e||e.removeChild(s)},s.querySelector(".name").innerText=a;var l=s.querySelector(".value"),h=function(){l&&g(l.value)};l&&(l.value=r,l.addEventListener("blur",(function(e){this.focus()})),l.addEventListener("keydown",(function(e){if(s.is_modified=!0,27==e.keyCode)s.close();else if(13==e.keyCode)h();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})));var u=LGraphCanvas.active_canvas.canvas,c=u.getBoundingClientRect(),p=-20,d=-20;c&&(p-=c.left,d-=c.top),event?(s.style.left=event.clientX+p+"px",s.style.top=event.clientY+d+"px"):(s.style.left=.5*u.width+p+"px",s.style.top=.5*u.height+d+"px"),s.querySelector("button").addEventListener("click",h),u.parentNode.appendChild(s),l&&l.focus();var _=null;s.addEventListener("pointerleave",(function(e){LiteGraph.dialog_close_on_mouse_leave&&!s.is_modified&&(_=setTimeout(s.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),s.addEventListener("pointerenter",(function(e){LiteGraph.dialog_close_on_mouse_leave&&_&&clearTimeout(_)}));var g=function(t){var n;switch(e.type){case"Number":t=Number(t);break;case"Boolean":t=Boolean(t)}o[a]=t,null===(n=s.parentNode)||void 0===n||n.removeChild(s),o.setDirtyCanvas(!0,!0)}}},{key:"getPropertyPrintableValue",value:function(e,t){if(!t)return String(e);if(t.constructor===Array)return String(e);if(t.constructor===Object){var n="";for(var i in t)if(t[i]==e){n=i;break}return String(e)+" ("+n+")"}}},{key:"onMenuNodeCollapse",value:function(e,t,n,i,o){o.graph.beforeChange();var a=function(e){e.collapse()},r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)a(o);else for(var s in r.selected_nodes)a(r.selected_nodes[s]);o.graph.afterChange()}},{key:"onMenuNodePin",value:function(e,t,n,i,o){o.pin()}},{key:"onMenuNodeMode",value:function(e,t,n,i,o){return LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:n,callback:function(e){if(!o)return;var t=Object.values(LiteGraph.NODE_MODES).indexOf(e),n=function(n){t>=0&&LiteGraph.NODE_MODES[t]?n.changeMode(t):(LiteGraph.log_warn("lgraphcanvas","onMenuNodeMode","unexpected mode",e,t),n.changeMode(LiteGraph.ALWAYS))},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)n(o);else for(var a in i.selected_nodes)n(i.selected_nodes[a])},parentMenu:i,node:o}),!1}},{key:"onMenuNodeColors",value:function(e,t,n,i,o){if(o){var a=[];for(var r in a.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"}),LGraphCanvas.node_colors){var s=LGraphCanvas.node_colors[r];e={value:r,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+s.color+"; background-color:"+s.bgcolor+"'>"+r+"</span>"},a.push(e)}return LiteGraph.ContextMenu(a,{event:n,callback:function(e){if(!o)return void LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","inner_clicked","no node");var t=e.value?LGraphCanvas.node_colors[e.value]:null,n=function(e){t?e.constructor===LiteGraph.LGraphGroup?e.color=t.groupcolor:(e.color=t.color,e.bgcolor=t.bgcolor):(delete e.color,delete e.bgcolor)},i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)n(o);else for(var a in i.selected_nodes)n(i.selected_nodes[a]);o.setDirtyCanvas(!0,!0)},parentMenu:i,node:o}),!1}LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","invalid node")}},{key:"onMenuNodeShapes",value:function(e,t,n,i,o){if(o)return LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:n,callback:function(e){if(!o)return void LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","inner_clicked","no node");o.graph.beforeChange();var t=function(t){t.shape=e},n=LGraphCanvas.active_canvas;if(!n.selected_nodes||Object.keys(n.selected_nodes).length<=1)t(o);else for(var i in n.selected_nodes)t(n.selected_nodes[i]);o.graph.afterChange(),o.setDirtyCanvas(!0)},parentMenu:i,node:o}),!1;LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node")}},{key:"onMenuNodeRemove",value:function(e,t,n,i,o){if(o){var a=o.graph;a.beforeChange();var r=function(e){!1!==e.removable&&a.remove(e)},s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)r(o);else for(var l in s.selected_nodes)r(s.selected_nodes[l]);a.afterChange(),o.setDirtyCanvas(!0,!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node")}},{key:"onMenuNodeToSubgraph",value:function(e,t,n,i,o){var a=o.graph,r=LGraphCanvas.active_canvas;if(r){var s=Object.values(r.selected_nodes||{});s.length||(s=[o]);var l=LiteGraph.createNode("graph/subgraph");l.pos=o.pos.concat(),a.add(l),l.buildFromNodes(s),r.deselectAllNodes(),o.setDirtyCanvas(!0,!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeToSubgraph","graphcanvas invalid")}},{key:"onMenuNodeClone",value:function(e,t,n,i,o){o.graph.beforeChange();var a={},r=function(e){if(!1!==e.clonable){var t=e.clone();t&&(t.pos=[e.pos[0]+5,e.pos[1]+5],e.graph.add(t),a[t.id]=t)}},s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)r(o);else for(var l in s.selected_nodes)r(s.selected_nodes[l]);Object.keys(a).length&&s.selectNodes(a),o.graph.afterChange(),o.setDirtyCanvas(!0,!0)}}])}();_defineProperty(LGraphCanvas,"DEFAULT_BACKGROUND_IMAGE","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII="),_defineProperty(LGraphCanvas,"link_type_colors",{"-1":"#A86",number:"#AAA",node:"#DCA",string:"#77F",boolean:"#F77"}),_defineProperty(LGraphCanvas,"gradients",{}),_defineProperty(LGraphCanvas,"search_limit",-1),_defineProperty(LGraphCanvas,"node_colors",{red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}});var temp=new Float32Array(4),temp_vec2=new Float32Array(2),tmp_area=new Float32Array(4),margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2),LGraph=function(){function e(t){_classCallCheck(this,e),LiteGraph.log_debug("Graph created",t),this.list_of_graphcanvas=null,this.callbackhandler_setup(),this.clear(),t&&this.configure(t),LiteGraph.processCallbackHandlers("on_lgraph_construct",{def_cb:LiteGraph.on_lgraph_construct},this)}return _createClass(e,[{key:"callbackhandler_setup",value:function(){this.cb_handler=new CallbackHandler(this)}},{key:"registerCallbackHandler",value:function(){var e;return(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)}},{key:"unregisterCallbackHandler",value:function(){var e;return(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)}},{key:"processCallbackHandlers",value:function(){var e;return(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)}},{key:"getSupportedTypes",value:function(){var t;return null!==(t=this.supported_types)&&void 0!==t?t:e.supported_types}},{key:"clear",value:function(){var t;this.stop(),this.status=e.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,null===(t=this._nodes)||void 0===t||t.forEach((function(e){e.processCallbackHandlers("onRemoved",{def_cb:e.onRemoved})})),this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.configApplyDefaults(),this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.history={actionHistory:[],actionHistoryVersions:[],actionHistoryPtr:0},this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}},{key:"configApply",value:function(e){this.config=Object.assign(this.config,e)}},{key:"configApplyDefaults",value:function(){var e=LiteGraph.graphDefaultConfig;this.configApply(e)}},{key:"attachCanvas",value:function(e){var t;if(!(e instanceof LGraphCanvas))throw new Error("attachCanvas expects a LiteGraph.LGraphCanvas instance");e.graph&&e.graph!=this&&(LiteGraph.log_debug("lgraph","attachCanvas","detaching previous"),e.graph.detachCanvas(e)),e.graph=this,null!==(t=this.list_of_graphcanvas)&&void 0!==t||(this.list_of_graphcanvas=[]),-1==this.list_of_graphcanvas.indexOf(e)?(LiteGraph.log_debug("lgraph","attachCanvas","attaching canvas"),this.list_of_graphcanvas.push(e)):LiteGraph.log_debug("lgraph","attachCanvas","canvas was already attached")}},{key:"detachCanvas",value:function(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);-1!=t&&(LiteGraph.log_debug("lgraph","detachCanvas",t,this.list_of_graphcanvas,this),this.list_of_graphcanvas.splice(t,1))}}},{key:"getCanvas",value:function(){if(this.list_of_graphcanvas)return this.list_of_graphcanvas[0]}},{key:"start",value:function(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this.status!==e.STATUS_RUNNING){this.status=e.STATUS_RUNNING,this.processCallbackHandlers("onPlayEvent",{def_cb:this.onPlayEvent}),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;var i=function(){-1===t.execution_timer_id&&(window.requestAnimationFrame(i),t.processCallbackHandlers("onBeforeStep",{def_cb:t.onBeforeStep}),t.runStep(1,!t.catch_errors),t.processCallbackHandlers("onAfterStep",{def_cb:t.onAfterStep}))};0===n&&"object"===("undefined"==typeof window?"undefined":_typeof(window))&&window.requestAnimationFrame?(this.execution_timer_id=-1,i()):this.execution_timer_id=setInterval((function(){t.processCallbackHandlers("onBeforeStep",{def_cb:t.onBeforeStep}),t.runStep(1,!t.catch_errors),t.processCallbackHandlers("onAfterStep",{def_cb:t.onAfterStep})}),n)}}},{key:"stop",value:function(){this.status!=e.STATUS_STOPPED&&(this.status=e.STATUS_STOPPED,this.processCallbackHandlers("onStopEvent",{def_cb:this.onStopEvent}),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}},{key:"runStep",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,o=LiteGraph.getTime();this.globaltime=.001*(o-this.starttime);var a=null!==(e=this._nodes_executable)&&void 0!==e?e:this._nodes;if(a){if(i||(i=a.length),n){for(var r=0;r<t;r++)a.forEach((function(e){var t,n;(LiteGraph.use_deferred_actions&&null!==(t=e._waiting_actions)&&void 0!==t&&t.length&&e.executePendingActions(),e.mode===LiteGraph.ALWAYS)&&(null===(n=e.doExecute)||void 0===n||n.call(e))})),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute})}else try{for(var s=0;s<t;s++)a.forEach((function(e){var t,n;(LiteGraph.use_deferred_actions&&null!==(t=e._waiting_actions)&&void 0!==t&&t.length&&e.executePendingActions(),e.mode===LiteGraph.ALWAYS)&&(null===(n=e.doExecute)||void 0===n||n.call(e))})),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute}),this.errors_in_execution=!1}catch(e){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw e;LiteGraph.log_warn("lgraph","Error during execution",e),this.stop()}var l=LiteGraph.getTime(),h=l-o;0==h&&(h=1),this.execution_time=.001*h,this.globaltime+=.001*h,this.iteration+=1,this.elapsed_time=.001*(l-this.last_update_time),this.last_update_time=l,this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[]}}},{key:"updateExecutionOrder",value:function(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])}},{key:"computeExecutionOrder",value:function(e,t){for(var n=[],i=[],o={},a={},r={},s=0,l=this._nodes.length;s<l;++s){var h=this._nodes[s];if(!e||h.onExecute){o[h.id]=h;var u=0;if(h.inputs)for(var c=0,p=h.inputs.length;c<p;c++)h.inputs[c]&&null!=h.inputs[c].link&&(u+=1);0==u?(i.push(h),t&&(h._level=1)):(t&&(h._level=0),r[h.id]=u)}}for(;0!=i.length;){var d=i.shift();if(n.push(d),delete o[d.id],d.outputs)for(var _=0;_<d.outputs.length;_++){var g=d.outputs[_];if(null!=g&&null!=g.links&&0!=g.links.length)for(var v=0;v<g.links.length;v++){var f=g.links[v],y=this.links[f];if(y&&!a[y.id]){var b=this.getNodeById(y.target_id);null!=b?(t&&(!b._level||b._level<=d._level)&&(b._level=d._level+1),a[y.id]=!0,r[b.id]-=1,0==r[b.id]&&i.push(b)):a[y.id]=!0}}}}for(var k in o)n.push(o[k]);n.length!=this._nodes.length&&LiteGraph.debug&&LiteGraph.log_warn("lgraph","computeExecutionOrder","something went wrong, nodes missing");for(var L=n.length,m=0;m<L;++m)n[m].order=m;n=n.sort((function(e,t){var n=e.constructor.priority||e.priority||0,i=t.constructor.priority||t.priority||0;return n==i?e.order-t.order:n-i}));for(var G=0;G<L;++G)n[G].order=G;return n}},{key:"getAncestors",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Object.assign({modesSkip:[],modesOnly:[],typesSkip:[],typesOnly:[]},t),i=[],o=[],a=[e],r={};a.length;){var s=a.shift();if(s&&!r[s.id]){if(r[s.id]=!0,s.id!=e.id){if(n.modesSkip&&n.modesSkip.length&&-1!=n.modesSkip.indexOf(s.mode))continue;if(n.modesOnly&&n.modesOnly.length&&-1==n.modesOnly.indexOf(s.mode))continue;-1==o.indexOf(s.id)&&(i.push(s),o.push(s.id))}if(s.inputs)for(var l=0;l<s.inputs.length;++l){var h=s.getInputNode(l);if(h){var u=s.inputs[l].type;n.typesSkip&&n.typesSkip.length&&-1!=n.typesSkip.indexOf(u)||n.typesOnly&&n.typesOnly.length&&-1==n.typesOnly.indexOf(h.mode)||-1==o.indexOf(h.id)&&(r[h.id]||a.push(h))}}}}return i.sort((function(e,t){return e.order-t.order})),i}},{key:"arrange",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,t=arguments.length>1?arguments[1]:void 0,n=this.computeExecutionOrder(!1,!0),i=[],o=0;o<n.length;++o){var a,r=n[o],s=r._level||1;null!==(a=i[s])&&void 0!==a||(i[s]=[]),i[s].push(r)}for(var l=e,h=0;h<i.length;++h){var u=i[h];if(u){for(var c=100,p=e+LiteGraph.NODE_TITLE_HEIGHT,d=0;d<u.length;++d){var _=u[d];_.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?p:l,_.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?l:p;var g=t==LiteGraph.VERTICAL_LAYOUT?1:0;_.size[g]>c&&(c=_.size[g]);var v=t==LiteGraph.VERTICAL_LAYOUT?0:1;p+=_.size[v]+e+LiteGraph.NODE_TITLE_HEIGHT}l+=c+e}}this.setDirtyCanvas(!0,!0)}},{key:"getTime",value:function(){return this.globaltime}},{key:"getFixedTime",value:function(){return this.fixedtime}},{key:"getElapsedTime",value:function(){return this.elapsed_time}},{key:"sendEventToAllNodes",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:LiteGraph.ALWAYS,i=this._nodes_in_order?this._nodes_in_order:this._nodes;if(i)for(var o=0,a=i.length;o<a;++o){var r=i[o];r.constructor!==LiteGraph.Subgraph||"onExecute"===e?"function"==typeof r[e]&&r.mode===n&&(void 0===t?r[e]():Array.isArray(t)?r[e].apply(r,t):r[e](t)):r.mode==n&&r.sendEventToAllNodes(e,t,n)}}},{key:"sendActionToCanvas",value:function(e,t){if(this.list_of_graphcanvas){var n,i=_createForOfIteratorHelper(this.list_of_graphcanvas);try{for(i.s();!(n=i.n()).done;){var o=n.value;"function"==typeof o[e]&&o[e]&&t&&o[e].apply(o,_toConsumableArray(t))}}catch(e){i.e(e)}finally{i.f()}}}},{key:"add",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=Object.assign({doProcessChange:!0,doCalcSize:!0},n);if(e){if(e.constructor===LiteGraph.LGraphGroup)return this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,void this.onGraphChanged({action:"groupAdd",doSave:i.doProcessChange});if(-1!=e.id&&null!=this._nodes_by_id[e.id]&&(LiteGraph.log_debug("lgraph","add","there is already a node with this ID, changing it",e),LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),!(LiteGraph.MAX_NUMBER_OF_NODES>0&&this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES))return LiteGraph.use_uuids?null!=e.id&&-1!=e.id||(e.id=LiteGraph.uuidv4()):null==e.id||-1==e.id?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this.onGraphChanged({action:"nodeAdd",doSave:i.doProcessChange}),this._nodes.push(e),this._nodes_by_id[e.id]=e,e.processCallbackHandlers("onAdded",{def_cb:e.onAdded},this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.processCallbackHandlers("onNodeAdded",{def_cb:this.onNodeAdded},e),i.doCalcSize&&e.setSize(e.computeSize()),this.setDirtyCanvas(!0),this.change(),e;LiteGraph.log_error("lgraph","add","max number of nodes in a graph reached",LiteGraph.MAX_NUMBER_OF_NODES)}}},{key:"remove",value:function(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);return-1!=t&&this._groups.splice(t,1),e.graph=null,this.onGraphChanged({action:"groupRemove"}),this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[e.id]&&!e.ignore_remove){if(e.inputs)for(var n=0;n<e.inputs.length;n++){null!=e.inputs[n].link&&e.disconnectInput(n,{doProcessChange:!1})}if(e.outputs)for(var i=0;i<e.outputs.length;i++){var o=e.outputs[i];null!=o.links&&o.links.length&&e.disconnectOutput(i,!1,{doProcessChange:!1})}if(e.processCallbackHandlers("onRemoved",{def_cb:e.onRemoved},this),e.graph=null,this.list_of_graphcanvas)for(var a=0;a<this.list_of_graphcanvas.length;++a){var r=this.list_of_graphcanvas[a];r.selected_nodes[e.id]&&delete r.selected_nodes[e.id],r.node_dragged==e&&(r.node_dragged=null)}var s=this._nodes.indexOf(e);-1!=s&&this._nodes.splice(s,1),delete this._nodes_by_id[e.id],this.processCallbackHandlers("onNodeRemoved",{def_cb:this.onNodeRemoved},e),this.onGraphChanged({action:"nodeRemove"}),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}}},{key:"getNodeById",value:function(e){return null==e?null:this._nodes_by_id[e]}},{key:"findNodesByClass",value:function(e){return this._nodes.filter((function(t){return t.constructor===e}))}},{key:"findNodesByType",value:function(e){var t=e.toLowerCase();return this._nodes.filter((function(e){return e.type.toLowerCase()===t}))}},{key:"findNodeByTitle",value:function(e){var t;return null!==(t=this._nodes.find((function(t){return t.title===e})))&&void 0!==t?t:null}},{key:"findNodesByTitle",value:function(e){return this._nodes.filter((function(t){return t.title===e}))}},{key:"getNodeOnPos",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._nodes,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return null!==(n=i.reverse().find((function(n){return n.isPointInside(e,t,o)})))&&void 0!==n?n:null}},{key:"getGroupOnPos",value:function(e,t){var n=this._groups.filter((function(n,i){return n.isPointInside(e,t,2,!0)}));if(!n.length)return null;LiteGraph.log_verbose("lgraph","getGroupOnPos","matching groups by x,y",e,t,n);var i=n.sort((function(e,n){return Math.abs(e._pos[1]-t)>Math.abs(n._pos[1]-t)}));return LiteGraph.log_verbose("lgraph","getGroupOnPos","sorted groups y distance",i),i[0]}},{key:"checkNodeTypes",value:function(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],n=LiteGraph.registered_node_types[t.type];if(t.constructor!=n){LiteGraph.log_debug("lgraph","checkNodeTypes","node being replaced by newer version",t.type);var i=LiteGraph.createNode(t.type);this._nodes[e]=i,i.configure(t.serialize()),i.graph=this,this._nodes_by_id[i.id]=i,t.inputs&&(i.inputs=t.inputs.concat()),t.outputs&&(i.outputs=t.outputs.concat())}}this.updateExecutionOrder()}},{key:"onAction",value:function(e,t,n){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes),LiteGraph.log_debug.apply(LiteGraph,["lgraph","onAction","will trigger actionDo on input nodes",this._input_nodes,"with name(?!)"].concat(Array.prototype.slice.call(arguments)));for(var i=0;i<this._input_nodes.length;++i){var o=this._input_nodes[i];if(o.properties.name==e){LiteGraph.log_debug.apply(LiteGraph,["lgraph","onAction",o,"node actionDo"].concat(Array.prototype.slice.call(arguments))),o.actionDo(e,t,n);break}}}},{key:"trigger",value:function(e,t){LiteGraph.log_debug("lgraph","trigger",e,t),this.processCallbackHandlers("onTrigger",{def_cb:this.onTrigger},e,t)}},{key:"addInput",value:function(e,t,n){this.inputs[e]||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:n},this.onGraphChanged({action:"addInput"}),this.afterChange(),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}},{key:"setInputData",value:function(e,t){var n=this.inputs[e];n&&(n.value=t)}},{key:"getInputData",value:function(e){var t=this.inputs[e];return t?t.value:null}},{key:"renameInput",value:function(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return LiteGraph.log_error("lgraph","renameInut","there is already one input with that name"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this.onGraphChanged({action:"renameInput"}),this.processCallbackHandlers("onInputRenamed",{def_cb:this.onInputRenamed},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})}}},{key:"changeInputType",value:function(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this.onGraphChanged({action:"changeInputType"}),this.processCallbackHandlers("onInputTypeChanged",{def_cb:this.onInputTypeChanged},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}},{key:"removeInput",value:function(e){return!!this.inputs[e]&&(delete this.inputs[e],this.onGraphChanged({action:"graphRemoveInput"}),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},e),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}},{key:"addOutput",value:function(e,t,n){this.outputs[e]={name:e,type:t,value:n},this.onGraphChanged({action:"addOutput"}),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})}},{key:"setOutputData",value:function(e,t){var n=this.outputs[e];n&&(n.value=t)}},{key:"getOutputData",value:function(e){var t=this.outputs[e];return t?t.value:null}},{key:"renameOutput",value:function(e,t){return!!this.outputs[e]&&(this.outputs[t]?(LiteGraph.log_error("lgraph","renameOutput","there is already one output with that name"),!1):(this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.processCallbackHandlers("onOutputRenamed",{def_cb:this.onOutputRenamed},e,t),void this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})))}},{key:"changeOutputType",value:function(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this.onGraphChanged({action:"changeOutputType"}),this.processCallbackHandlers("onOutputTypeChanged",{def_cb:this.onOutputTypeChanged},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}},{key:"removeOutput",value:function(e){return!!this.outputs[e]&&(delete this.outputs[e],this.onGraphChanged({action:"removeOutput"}),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},e),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}},{key:"triggerInput",value:function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].onTrigger(t)}},{key:"setCallback",value:function(e,t){for(var n=this.findNodesByTitle(e),i=0;i<n.length;++i)n[i].setTrigger(t)}},{key:"beforeChange",value:function(e){this.processCallbackHandlers("onBeforeChange",{def_cb:this.onBeforeChange},this,e),this.sendActionToCanvas("onBeforeChange",this)}},{key:"afterChange",value:function(e){this.processCallbackHandlers("onAfterChange",{def_cb:this.onAfterChange},this,e),this.sendActionToCanvas("onAfterChange",this)}},{key:"connectionChange",value:function(e){this.updateExecutionOrder(),this.processCallbackHandlers("onConnectionChange",{def_cb:this.onConnectionChange},e),this.onGraphChanged({action:"connectionChange",doSave:!1}),this.sendActionToCanvas("onConnectionChange")}},{key:"isLive",value:function(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){if(this.list_of_graphcanvas[e].live_mode)return!0}return!1}},{key:"clearTriggeredSlots",value:function(){for(var e in this.links){var t,n=this.links[e];n&&((t=n)._last_time&&(t._last_time=0))}}},{key:"change",value:function(){LiteGraph.log_verbose("lgraph","change","Graph visually changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.processCallbackHandlers("on_change",{def_cb:this.on_change},this)}},{key:"setDirtyCanvas",value:function(e,t){this.sendActionToCanvas("setDirty",[e,t])}},{key:"removeLink",value:function(e){var t=this.links[e];if(t){var n=this.getNodeById(t.target_id);n&&(this.beforeChange(),n.disconnectInput(t.target_slot),this.afterChange())}}},{key:"serialize",value:function(){var e=this._nodes.map((function(e){return e.serialize()})),t=[];for(var n in this.links){var i=this.links[n];if(!i.serialize){LiteGraph.log_warn("lgraph","serialize","weird LLink bug, link info is not a LLink but a regular object");var o=new LLink;for(var a in i)o[a]=i[a];this.links[n]=o,i=o}t.push(i.serialize())}var r=this._groups.map((function(e){return e.serialize()})),s={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:t,groups:r,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},s),LiteGraph.log_verbose("lgraph","serialize",s),s}},{key:"configure",value:function(e,t){var n,i=this;if(e){t||this.clear();var o=e.nodes;if(e.links&&e.links.constructor===Array){for(var a=[],r=0;r<e.links.length;++r){var s=e.links[r];if(s){var l=new LLink;l.configure(s),a[l.id]=l}else LiteGraph.log_warn("lgraph","configure","serialized graph link data contains errors, skipping.",s,r,e.links)}e.links=a}for(var h in e)["nodes","groups"].includes(h)||(this[h]=e[h]);var u=!1;if(this._nodes=[],o){for(var c=0,p=o.length;c<p;++c){var d=o[c],_=LiteGraph.createNode(d.type,d.title);_||(LiteGraph.log_warn("lgraph","configure","Node not found or has errors",d.type,d),(_=new LiteGraph.LGraphNode).last_serialization=d,_.has_errors=!0,u=!0),_.id=d.id,this.add(_,!0,{doProcessChange:!1})}o.forEach((function(e){var t=i.getNodeById(e.id);null==t||t.configure(e)}))}return this._groups.length=0,e.groups&&e.groups.forEach((function(e){var t=new LiteGraph.LGraphGroup;t.configure(e),i.add(t,!0,{doProcessChange:!1})})),this.updateExecutionOrder(),this.extra=null!==(n=e.extra)&&void 0!==n?n:{},this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},e),e._version?LiteGraph.log_debug("lgraph","configure","skip onGraphChanged when configure passing version too!"):this.onGraphChanged({action:"graphConfigure",doSave:!1}),this.setDirtyCanvas(!0,!0),u}}},{key:"load",value:function(e,t){var n=this;if(e.constructor===File||e.constructor===Blob){var i=new FileReader;return i.addEventListener("load",(function(e){var i=JSON.parse(e.target.result);n.configure(i),null==t||t()})),void i.readAsText(e)}var o=new XMLHttpRequest;o.open("GET",e,!0),o.send(null),o.onload=function(e){if(200===o.status){var i=JSON.parse(o.response);n.configure(i),null==t||t()}else LiteGraph.log_error("Error loading graph:",o.status,o.response)},o.onerror=function(e){LiteGraph.log_error("Error loading graph:",e)}}},{key:"onGraphSaved",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},e);LiteGraph.log_debug("onGraphSaved",t),this.savedVersion=this._version}},{key:"onGraphLoaded",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({},e);LiteGraph.log_debug("onGraphLoaded",t),this.savedVersion=this._version}},{key:"onGraphChanged",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({action:"",doSave:!0,doSaveGraph:!0},e);if(this._version++,t.action?LiteGraph.log_debug("Graph change",t.action):LiteGraph.log_debug("Graph change, no action",t),t.doSave&&LiteGraph.actionHistory_enabled){LiteGraph.log_debug("LG_history","onGraphChanged SAVE :: "+t.action);var n={actionName:t.action};t.doSaveGraph&&(n=Object.assign(n,{graphSave:this.serialize()}));for(var i=this.history;i.actionHistoryPtr<i.actionHistoryVersions.length-1;)LiteGraph.log_debug("LG_history","popping: gone back? "+i.actionHistoryPtr+" < "+(i.actionHistoryVersions.length-1)),i.actionHistoryVersions.pop();if(i.actionHistoryVersions.length>=LiteGraph.actionHistoryMaxSave){var o=i.actionHistoryVersions.shift();LiteGraph.log_debug("LG_history","maximum saves reached: "+i.actionHistoryVersions.length+", remove older: "+o),i.actionHistory[o]=!1}i.actionHistoryPtr=i.actionHistoryVersions.length,i.actionHistoryVersions.push(i.actionHistoryPtr),i.actionHistory[i.actionHistoryPtr]=n,this.onGraphSaved({iVersion:i.actionHistoryPtr}),LiteGraph.log_debug("LG_history","saved: "+i.actionHistoryPtr,n.actionName)}}},{key:"actionHistoryBack",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({steps:1},e),n=this.history;return null!=n.actionHistoryPtr&&n.actionHistoryPtr>=0?(n.actionHistoryPtr-=t.steps,LiteGraph.log_debug("LG_history","step back: "+n.actionHistoryPtr),this.actionHistoryLoad({iVersion:n.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded back: "+n.actionHistoryPtr),LiteGraph.log_debug(this.history),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+n.actionHistoryPtr),n.actionHistoryPtr+=t.steps,!1)):(LiteGraph.log_debug("LG_history","is already at older state"),!1)}},{key:"actionHistoryForward",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({steps:1},e),n=this.history;return n.actionHistoryPtr<n.actionHistoryVersions.length?(n.actionHistoryPtr+=t.steps,LiteGraph.log_debug("LG_history","step forward: "+n.actionHistoryPtr),this.actionHistoryLoad({iVersion:n.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded forward: "+n.actionHistoryPtr),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+n.actionHistoryPtr),n.actionHistoryPtr-=t.steps,!1)):(LiteGraph.log_debug("LG_history","is already at newer state"),!1)}},{key:"actionHistoryLoad",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({iVersion:!1,backStep:!1},e),n=this.history;if(n.actionHistory[t.iVersion]&&n.actionHistory[t.iVersion].graphSave){var i=JSON.stringify(this.history);return this.configure(n.actionHistory[t.iVersion].graphSave),this.history=JSON.parse(i),LiteGraph.log_debug("history loaded: "+t.iVersion,n.actionHistory[t.iVersion].actionName),this.onGraphLoaded({iVersion:t.iVersion}),!0}return!1}},{key:"autoConnectNodes",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=Object.assign({keep_alredy_connected:!0},n);if(!(e&&t&&e.outputs&&e.outputs.length&&t.inputs&&t.inputs.length))return!1;for(var o=0;o<e.outputs.length;o++){var a=e.outputs[o];!i.keep_alredy_connected&&null!==a.links&&a.links.length>0||e.connectByType(o,t,a.type,{preferFreeSlot:!0})}}},{key:"updateNodeLinks",value:function(e,t,n,i){for(var o in LiteGraph.log_debug("lgraph","updateNodeLinks","looking for links",e.id,t,n,i),this.links){var a=this.links[o];null!==a&&a&&(t?a.target_id==e.id&&a.target_slot==n&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link input",this.links[o],e,t,n,i),this.links[o].target_slot=i):a.origin_id==e.id&&a.origin_slot==n&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link output",this.links[o],e,t,n,i),this.links[o].origin_slot=i))}}}])}();_defineProperty(LGraph,"supported_types",["number","string","boolean"]),_defineProperty(LGraph,"STATUS_STOPPED",1),_defineProperty(LGraph,"STATUS_RUNNING",2);var LGraphNode=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";_classCallCheck(this,e),_defineProperty(this,"cb_handler",!1),LiteGraph.log_verbose("lgraphNODE","ORIGINAL constructor",this,t),this.title=t,this.post_constructor.apply(this,arguments)}return _createClass(e,[{key:"post_constructor",value:function(){var e,t,n,i,o,a,r,s,l,h,u,c,p;(null!==(e=this.size)&&void 0!==e||(this.size=LiteGraph.NODE_MIN_SIZE),null!==(t=this.size_basic)&&void 0!==t||(this.size_basic=this.size),null!==(n=this.graph)&&void 0!==n||(this.graph=null),null!==(i=this._pos)&&void 0!==i||(this._pos=new Float32Array(10,10)),LiteGraph.use_uuids)?null!==(c=this.id)&&void 0!==c||(this.id=LiteGraph.uuidv4()):null!==(p=this.id)&&void 0!==p||(this.id=-1);null!==(o=this.type)&&void 0!==o||(this.type=null),null!==(a=this.inputs)&&void 0!==a||(this.inputs=[]),null!==(r=this.outputs)&&void 0!==r||(this.outputs=[]),null!==(s=this.connections)&&void 0!==s||(this.connections=[]),null!==(l=this.properties)&&void 0!==l||(this.properties={}),null!==(h=this.properties_info)&&void 0!==h||(this.properties_info=[]),null!==(u=this.flags)&&void 0!==u||(this.flags={}),this.callbackhandler_setup(),this.processCallbackHandlers("onPostConstruct",{def_cb:this.onPostConstruct}),LiteGraph.processCallbackHandlers("on_lgraphnode_construct",{def_cb:LiteGraph.on_lgraphnode_construct},this)}},{key:"callbackhandler_setup",value:function(){this.cb_handler=new CallbackHandler(this)}},{key:"registerCallbackHandler",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)}},{key:"unregisterCallbackHandler",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)}},{key:"processCallbackHandlers",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)}},{key:"pos",get:function(){return this._pos},set:function(e){var t;!e||e.length<2||(null!==(t=this._pos)&&void 0!==t||(this._pos=new Float32Array(10,10)),this._pos[0]=e[0],this._pos[1]=e[1])}},{key:"configure",value:function(e){var t,n,i,o,a=this;(LiteGraph.log_debug("lgraphnode","configure",this,e),this.graph&&this.graph.onGraphChanged({action:"nodeBeforeConfigure",doSave:!1}),Object.entries(e).forEach((function(t){var n=_slicedToArray(t,2),i=n[0],o=n[1];if("properties"!==i)if(!LiteGraph.reprocess_slot_while_node_configure||"inputs"!==i&&"outputs"!==i)null!==o?"object"===_typeof(o)?a[i]&&"function"==typeof a[i].configure?(a[i].configure(o),LiteGraph.log_verbose("lgraphnode","configure","use var internal configure method",i,o)):(LiteGraph.log_verbose("lgraphnode","configure","set ob var key",i,o,a[i]),a[i]=LiteGraph.cloneObject(o,a[i])):(LiteGraph.log_verbose("lgraphnode","configure","set node var",i,o),a[i]=o):LiteGraph.log_verbose("lgraphnode","configure","should copy null value key? probably should",i,a[i]);else{LiteGraph.log_debug("lgraphnode","syncObjectByProperty",i,e[i],a[i]);var r=a.syncObjectByProperty(e[i],a[i],"name");if(a[i]=r.ob_dest,r.keys_remap&&Object.keys(r.keys_remap).length&&a.graph)for(var s in r.keys_remap){var l=r.keys_remap[s];a.graph.updateNodeLinks(a,"inputs"===i,s,l)}}else for(var h in o)a.properties[h]=o[h],a.processCallbackHandlers("onPropertyChanged",{def_cb:a.onPropertyChanged},h,o[h])})),e.title||(this.title=this.constructor.title),null===(t=this.inputs)||void 0===t||t.forEach((function(e,t){if(e.link){var n=a.graph?a.graph.links[e.link]:null;a.processCallbackHandlers("onConnectionsChange",{def_cb:a.onConnectionsChange},LiteGraph.INPUT,t,!0,n,e),a.processCallbackHandlers("onInputAdded",{def_cb:a.onInputAdded},e)}})),null===(n=this.outputs)||void 0===n||n.forEach((function(e,t){e.links&&(e.links.forEach((function(t,n){var i,o=(null===(i=a.graph)||void 0===i?void 0:i.links[t])||null;LiteGraph.log_verbose("lgraphnode","configure","cycle outputlinks",t,n,o),a.processCallbackHandlers("onConnectionsChange",{def_cb:a.onConnectionsChange},LiteGraph.OUTPUT,n,!0,o,e)})),a.processCallbackHandlers("onOutputAdded",{def_cb:a.onOutputAdded},e))})),this.widgets)&&(this.widgets.forEach((function(e){e&&e.options&&e.options.property&&void 0!==a.properties[e.options.property]&&(e.value=JSON.parse(JSON.stringify(a.properties[e.options.property])))})),null===(o=e.widgets_values)||void 0===o||o.forEach((function(e,t){a.widgets[t]&&(a.widgets[t].value=e)})));this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},e),null===(i=this.graph)||void 0===i||i.onGraphChanged({action:"nodeConfigure",doSave:!1}),LiteGraph.log_debug("lgraphnode","configure complete",this)}},{key:"serialize",value:function(){var t,n={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===e&&this.last_serialization)return this.last_serialization;this.inputs&&(n.inputs=LiteGraph.cloneObject(this.inputs)),this.outputs&&(this.outputs.forEach((function(e){delete e._data})),n.outputs=LiteGraph.cloneObject(this.outputs)),this.title&&this.title!=this.constructor.title&&(n.title=this.title),this.properties&&(n.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets&&(n.widgets_values=this.widgets.map((function(e){var t;return null!==(t=null==e?void 0:e.value)&&void 0!==t?t:null}))),null!==(t=n.type)&&void 0!==t||(n.type=this.constructor.type),this.color&&(n.color=this.color),this.bgcolor&&(n.bgcolor=this.bgcolor),this.boxcolor&&(n.boxcolor=this.boxcolor),this.shape&&(n.shape=this.shape);var i=this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},n);return null!==i&&"object"==_typeof(i)&&null!==i.return_value&&LiteGraph.log_warn("lgraphnode","onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),n}},{key:"clone",value:function(){var e,t,n=LiteGraph.createNode(this.type);if(!n)return null;var i=LiteGraph.cloneObject(this.serialize());return null===(e=i.inputs)||void 0===e||e.forEach((function(e){e.link=null})),null===(t=i.outputs)||void 0===t||t.forEach((function(e){e.links&&(e.links.length=0)})),delete i.id,LiteGraph.use_uuids&&(i.id=LiteGraph.uuidv4()),n.configure(i),n}},{key:"toString",value:function(){return JSON.stringify(this.serialize())}},{key:"getTitle",value:function(){var e;return null!==(e=this.title)&&void 0!==e?e:this.constructor.title}},{key:"setProperty",value:function(e,t){var n;if(this.properties||(this.properties={}),t!==this.properties[e]){var i=this.properties[e];this.properties[e]=t;var o=this.processCallbackHandlers("onPropertyChanged",{def_cb:this.onPropertyChanged},e,t,i);(!1===o||null!==o&&"object"==_typeof(o)&&!1===o.return_value)&&(this.properties[e]=i,LiteGraph.log_debug("lgraphnode","setProperty","prevent property set by cbHandler",e,t,i,o));var a=null===(n=this.widgets)||void 0===n?void 0:n.find((function(t){var n;return t&&(null===(n=t.options)||void 0===n?void 0:n.property)===e}));a&&(a.value=t)}}},{key:"setOutputData",value:function(e,t){var n,i,o=this;if(this.outputs&&((null===(n=e)||void 0===n?void 0:n.constructor)===String&&(e=this.findOutputSlot(e)),!(-1==e||e>=this.outputs.length))){e=this.getOutputSlot(e);var a=this.outputs[e];a&&(a._data=t,null===(i=this.outputs[e].links)||void 0===i||i.forEach((function(e){var n=o.graph.links[e];n&&(n.data=t)})))}}},{key:"setOutputDataType",value:function(e,t){var n,i,o=this;if(this.outputs&&((null===(n=e)||void 0===n?void 0:n.constructor)===String&&(e=this.findOutputSlot(e)),!(-1==e||e>=this.outputs.length))){var a=this.outputs[e];a&&(a.type=t,null===(i=this.outputs[e])||void 0===i||null===(i=i.links)||void 0===i||i.forEach((function(e){o.graph.links[e]&&(o.graph.links[e].type=t)})))}}},{key:"getInputData",value:function(e,t,n){var i,o;if(this.inputs&&((null===(i=e)||void 0===i?void 0:i.constructor)===String&&(e=this.findInputSlot(e)),!(-1==e||e>=this.inputs.length)&&this.inputs[e].type!=LiteGraph.ACTION)){var a=this.inputs[e];if(void 0!==a.hard_coded_value)return console.debug("HARD_CODED_INPUT",this,a,a.hard_coded_value),a.hard_coded_value;var r=a.link,s=null===(o=this.graph)||void 0===o?void 0:o.links[r];if(!s)return null;if(!t)return s.data;var l=this.graph.getNodeById(s.origin_id);if(!l)return LiteGraph.log_debug("lgraphnode","getInputData","No origin node, return the link data",s.data,s,e,this),s.data;if(n){LiteGraph.log_warn("CHECK THIS","lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",s,e,this),LiteGraph.log_debug("lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",s,e,this);var h=this.id+"_getInputData_forced_"+LiteGraph.uuidv4(),u={action:h,options:{action_call:h}};this.refreshAncestors(u)}return l.updateOutputData?l.updateOutputData(s.origin_slot):l.doExecute(),s.data}}},{key:"getInputDataType",value:function(e){var t;if(!this.inputs)return null;if((null===(t=e)||void 0===t?void 0:t.constructor)===String&&(e=this.findInputSlot(e)),e>=this.inputs.length||null==this.inputs[e].link)return null;if(this.inputs[e].type!=LiteGraph.ACTION){var n=this.inputs[e].link,i=this.graph.links[n];if(!i)return LiteGraph.log_warn("lgraphnode","getInputDataType","No link",n,e,this),null;var o=this.graph.getNodeById(i.origin_id);if(!o)return i.type;var a=o.outputs[i.origin_slot];return a?a.type:null}}},{key:"getInputDataByName",value:function(e,t){var n=this.findInputSlot(e);return-1==n?null:this.getInputData(n,t)}},{key:"isInputConnected",value:function(e){return!!this.inputs&&(e<this.inputs.length&&null!=this.inputs[e].link)}},{key:"getInputInfo",value:function(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null}},{key:"getInputLink",value:function(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null}},{key:"getInputNode",value:function(e){if(!this.inputs)return null;if(e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||null===t.link)return null;var n=this.graph.links[t.link];return n?this.graph.getNodeById(n.origin_id):null}},{key:"getInputOrProperty",value:function(e){if(this.inputs)for(var t=0,n=this.inputs.length;t<n;++t){var i=this.inputs[t];if(e==i.name&&null!=i.link){var o=this.graph.links[i.link];if(o)return o.data}}return this.properties?this.properties[e]:null}},{key:"getOutputData",value:function(e){return this.outputs?e>=this.outputs.length?null:this.outputs[e]._data:null}},{key:"getOutputInfo",value:function(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null}},{key:"isOutputConnected",value:function(e){return!!this.outputs&&(e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length)}},{key:"isAnyOutputConnected",value:function(){return!!this.outputs&&this.outputs.some((function(e){return e.links&&e.links.length}))}},{key:"getOutputNodes",value:function(e){var t=this;if(!this.outputs||e>=this.outputs.length)return null;var n=this.outputs[e];return n.links&&0!==n.links.length?n.links.map((function(e){return t.graph.links[e]})).filter((function(e){return e})).map((function(e){return t.graph.getNodeById(e.target_id)})).filter((function(e){return e})):null}},{key:"addOnTriggerInput",value:function(){var e=this.findInputSlot("onTrigger");return-1==e?(this.addInput("onTrigger",LiteGraph.EVENT,{removable:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):e}},{key:"addOnExecutedOutput",value:function(){var e=this.findOutputSlot("onExecuted");return-1==e?(this.addOutput("onExecuted",LiteGraph.ACTION,{removable:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):e}},{key:"onAfterExecuteNode",value:function(e,t){var n=this.findOutputSlot("onExecuted");-1!=n&&(LiteGraph.log_verbose("lgraphnode","onAfterExecuteNode",this.id+":"+this.order+" triggering slot onAfterExecute",e,t),this.triggerSlot(n,e,null,t))}},{key:"onAfterActionedNode",value:function(e,t){var n=this.findOutputSlot("onExecuted");-1!=n&&(LiteGraph.log_verbose("lgraphnode","onAfterActionedNode",this.id+":"+this.order+" triggering slot onAfterActionedNode",this,n,e,t),this.triggerSlot(n,e,null,t))}},{key:"onResize",value:function(e){}},{key:"changeMode",value:function(e){switch(e){case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.ON_EVENT:case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0}},{key:"executePendingActions",value:function(){var e=this;this._waiting_actions&&this._waiting_actions.length&&(this._waiting_actions.forEach((function(t){e.onAction(t[0],t[1],t[2],t[3],t[4])})),this._waiting_actions.length=0)}},{key:"doExecute",value:function(e){var t,n,i,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.mode!==LiteGraph.NEVER?(null!==(t=o.action_call)&&void 0!==t||(o.action_call="".concat(this.id,"_exec_").concat(LiteGraph.uuidv4())),null!==(n=this.graph)&&void 0!==n&&n.nodes_executing&&null!==(i=this.graph)&&void 0!==i&&i.nodes_executing[this.id]?LiteGraph.log_debug("lgraphNODE","doExecute","already executing! Prevent! "+this.id+":"+this.order):LiteGraph.ensureNodeSingleExecution&&this.exec_version&&this.exec_version>=this.graph.iteration&&void 0!==this.exec_version?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already EXECUTED THIS STEP !! "+this.exec_version):LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&o&&o.action_call&&this.graph.nodes_executedAction[this.id]==o.action_call?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already ACTION THIS STEP !! "+o.action_call):(this.graph.nodes_executing[this.id]=!0,LiteGraph.properties_allow_input_binding&&this.doUpdateBindedInputProperties(),this.processCallbackHandlers("onExecute",{def_cb:this.onExecute},e,o),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,o&&o.action_call&&(this.action_call=o.action_call,this.graph.nodes_executedAction[this.id]=o.action_call),LiteGraph.properties_allow_output_binding&&this.doUpdateBindedOutputProperties(),this.execute_triggered=2,this.processCallbackHandlers("onAfterExecuteNode",{def_cb:this.onAfterExecuteNode},e,o))):LiteGraph.log_verbose("lgraphNODE","doExecute","prevent execution in mode NEVER",this.id)}},{key:"execute",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return LiteGraph.log_debug("lgraphnode","execute","You should replace .execute with .doExecute, has been renamed"),this.doExecute(e,t)}},{key:"actionDo",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=arguments.length>3?arguments[3]:void 0;null!==(n=i.action_call)&&void 0!==n||(i.action_call="".concat(this.id,"_").concat(e||"action","_").concat(LiteGraph.uuidv4())),LiteGraph.ensureNodeSingleAction&&this.graph.nodes_actioning&&this.graph.nodes_actioning[this.id]==i.action_call?LiteGraph.log_debug("lgraphnode","actionDo","already actioning! Prevent! "+this.id+":"+this.order+" :: "+i.action_call):(LiteGraph.log_debug("CheckActioned ? "+this.id+":"+this.order+" :: "+this.action_call),LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&i&&i.action_call&&this.graph.nodes_executedAction[this.id]==i.action_call?LiteGraph.log_debug("lgraphnode","actionDo","!! NODE already ACTION THIS STEP !! "+i.action_call):(this.graph.nodes_actioning[this.id]=e||"actioning",this.processCallbackHandlers("onAction",{def_cb:this.onAction},e,t,i,o),this.graph.nodes_actioning[this.id]=!1,i&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call),this.action_triggered=2,this.processCallbackHandlers("onAfterActionedNode",{def_cb:this.onAfterActionedNode},t,i)))}},{key:"trigger",value:function(e,t,n){var i=this;if(this.outputs&&0!==this.outputs.length){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());var o=0;this.outputs.forEach((function(a,r){!a||a.type!==LiteGraph.EVENT||e&&a.name!==e?LiteGraph.log_verbose("lgraphnode","trigger","skip slot",a):(LiteGraph.log_verbose("lgraphnode","trigger","triggering slot",r,t,n),i.triggerSlot(r,t,null,n),o++)})),o||LiteGraph.log_debug.apply(LiteGraph,["lgraphnode","trigger","nothing found"].concat(Array.prototype.slice.call(arguments)))}}},{key:"triggerSlot",value:function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(this.outputs)if(null!==e){e.constructor!==Number&&(e=this.getOutputSlot(e));var o=this.outputs[e];if(o){var a=o.links;if(a&&a.length&&!(this.mode===LiteGraph.NEVER||this.graph&&this.graph.ancestorsCall)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var r=0;r<a.length;++r){var s,l=a[r];if(null==n||n==l){var h=this.graph.links[a[r]];if(h){h._last_time=LiteGraph.getTime();var u=this.graph.getNodeById(h.target_id);if(u){var c=u.inputs[h.target_slot];if(u.mode===LiteGraph.ON_TRIGGER||"onTrigger"===(null===(s=c)||void 0===s?void 0:s.name))i.action_call||(i.action_call="".concat(this.id,"_trigg_").concat(LiteGraph.uuidv4())),LiteGraph.refreshAncestorsOnTriggers&&u.refreshAncestors({action:"trigger",param:t,options:i}),u.onExecute&&u.doExecute(t,i);else if(u.onAction){i.action_call||(i.action_call="".concat(this.id,"_act_").concat(LiteGraph.uuidv4()));var p,d,_=u.inputs[h.target_slot];if(LiteGraph.refreshAncestorsOnActions&&u.refreshAncestors({action:_.name,param:t,options:i}),LiteGraph.use_deferred_actions&&u.onExecute)null!==(d=(p=u)._waiting_actions)&&void 0!==d||(p._waiting_actions=[]),u._waiting_actions.push([_.name,t,i,h.target_slot]),LiteGraph.log_debug("lgraphnode","triggerSlot","push to deferred",_.name,t,i,h.target_slot);else LiteGraph.log_debug("lgraphnode","triggerSlot","call actionDo",u,_.name,t,i,h.target_slot),u.actionDo(_.name,t,i,h.target_slot)}else LiteGraph.log_debug("lgraphnode","triggerSlot","not executing node, what to do with this Node Mode on slot triggered?",u.mode,this)}}}}}}}else LiteGraph.log_error("lgraphnode","triggerSlot","wrong slot",e)}},{key:"clearTriggeredSlot",value:function(e,t){var n=this;this.outputs&&this.outputs[e]&&this.outputs[e].links&&this.outputs[e].links.forEach((function(e){if(null===t||t===e){var i=n.graph.links[e];i&&(i._last_time=0)}}))}},{key:"doUpdateBindedInputProperties",value:function(){var e=this,t=this;this.inputs.forEach((function(n){if(n.param_bind)if(LiteGraph.log_verbose("lgraphnode","doUpdateBindedInputProperties","has bind",n,t),t.properties&&void 0!==t.properties[n.name]){var i=t.getInputData(n.name);null!==i&&(LiteGraph.log_verbose("lgraphnode","doUpdateBindedInputProperties","update value",n.name,i,t),e.setProperty(n.name,i))}else LiteGraph.log_warn("lgraphnode","doUpdateBindedInputProperties","inexisting property",n.name,t)}))}},{key:"doUpdateBindedOutputProperties",value:function(){var e=this,t=this;this.outputs.forEach((function(n){if(n.param_bind)if(LiteGraph.log_verbose("lgraphnode","doUpdateBindedOutputProperties","has bind",n,t),t.properties&&void 0!==t.properties[n.name]){var i=e.properties[n.name];LiteGraph.log_verbose("lgraphnode","doUpdateBindedOutputProperties","update value",n.name,i,t),e.setOutputData(n.name,i)}else LiteGraph.log_warn("lgraphnode","doUpdateBindedOutputProperties","inexisting property",n.name,outputData,t)}))}},{key:"autoSize",value:function(e){var t=this.computeSize(),n=e&&this.size?[Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])]:t;this.setSize(n)}},{key:"setSize",value:function(e){this.size=e,this.processCallbackHandlers("onResize",{def_cb:this.onResize},this.size)}},{key:"addProperty",value:function(e,t,n,i){var o,a,r,s;null!==(o=t)&&void 0!==o||(t=null),null!==(a=n)&&void 0!==a||(n=null);var l=_objectSpread2({name:e,type:n,default_value:t},i);return this.properties_info=null!==(r=this.properties_info)&&void 0!==r?r:[],this.properties_info.push(l),this.properties=null!==(s=this.properties)&&void 0!==s?s:{},this.properties[e]=t,l}},{key:"addInput",value:function(e,t,n){return this.addSlot(e,t,n,!0)}},{key:"addOutput",value:function(e,t,n){return this.addSlot(e,t,n,!1)}},{key:"addSlot",value:function(e,t,n,i){var o,a,r=_objectSpread2(i?{name:e,type:t,link:null}:{name:e,type:t,links:null},n);i?(this.inputs=null!==(o=this.inputs)&&void 0!==o?o:[],this.inputs.push(r),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},r),LiteGraph.registerNodeAndSlotType(this,t)):(this.outputs=null!==(a=this.outputs)&&void 0!==a?a:[],this.outputs.push(r),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},r),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0));return this.autoSize(!0),this.setDirtyCanvas(!0,!0),r}},{key:"addInputs",value:function(e){this.addSlots(e,!0)}},{key:"addOutputs",value:function(e){this.addSlots(e,!1)}},{key:"addSlots",value:function(e,t){var n=this;"string"==typeof e&&(e=[e]),e.forEach((function(e){var i,o,a,r,s=t?_objectSpread2({name:e[0],type:e[1],link:null},null!==(i=e[2])&&void 0!==i?i:{}):_objectSpread2({name:e[0],type:e[1],links:null},null!==(o=e[2])&&void 0!==o?o:{});t?(n.inputs=null!==(a=n.inputs)&&void 0!==a?a:[],n.inputs.push(s),n.processCallbackHandlers("onInputAdded",{def_cb:n.onInputAdded},s),LiteGraph.registerNodeAndSlotType(n,e[1])):(n.outputs=null!==(r=n.outputs)&&void 0!==r?r:[],n.outputs.push(s),n.processCallbackHandlers("onOutputAdded",{def_cb:n.onOutputAdded},s),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(n,e[1],!0))})),this.autoSize(),this.setDirtyCanvas(!0,!0)}},{key:"removeInput",value:function(e){var t=this;this.disconnectInput(e);var n=this.inputs.splice(e,1)[0];this.inputs.slice(e).filter((function(e){return!!e})).forEach((function(e){var n=t.graph.links[e.link];(null==n?void 0:n.target_slot)&&n.target_slot--})),this.autoSize(),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},e,n),this.setDirtyCanvas(!0,!0)}},{key:"removeOutput",value:function(e){var t=this;this.disconnectOutput(e),this.outputs=this.outputs.filter((function(t,n){return n!==e})),this.outputs.slice(e).forEach((function(e){e&&e.links&&e.links.forEach((function(e){var n=t.graph.links[e];n&&(n.origin_slot-=1)}))})),this.autoSize(),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},e),this.setDirtyCanvas(!0,!0)}},{key:"addConnection",value:function(e,t,n,i){var o={name:e,type:t,pos:n,direction:i,links:null};return this.connections.push(o),o}},{key:"getDefaultCanvas",value:function(){return!!this.graph&&(!(!this.graph.list_of_graphcanvas||!this.graph.list_of_graphcanvas.length)&&this.graph.list_of_graphcanvas[0])}},{key:"computeSize",value:function(e){if(this.constructor.size)return this.constructor.size.concat();var t=this,n=e||new Float32Array([0,0]),i=LiteGraph.NODE_TEXT_SIZE,o=function(e,n){if(!e)return 0;var o=t.getDefaultCanvas();if(o&&o.canvas&&o.ctx){var a;o.ctx.font=n?o.title_text_font:o.inner_text_font;var r=null===(a=o.ctx)||void 0===a?void 0:a.measureText(e);if(r)return r.width}return i*e.length*.423},a=t.title;try{a=this.getTitle()}catch(e){}var r=40+o(a,!0),s=0,l=0;this.inputs&&(s=this.inputs.reduce((function(e,t){var n=t.label||t.name||"",i=o(n);return Math.max(e,i)}),0)),this.outputs&&(l=this.outputs.reduce((function(e,t){var n=t.label||t.name||"",i=o(n);return Math.max(e,i)}),0)),this.horizontal?(n[0]=Math.max(n[0],r),n[1]=this.outputs.length?Math.max(n[1],LiteGraph.NODE_SLOT_HEIGHT+10):n[1]):(n[0]=Math.max(s+l+40+10,r),n[1]=this.getSlotsHeight()),n[0]=Math.max(n[0],LiteGraph.NODE_MIN_WIDTH),n[0]=Math.max(n[0],LiteGraph.NODE_MIN_SIZE[0]),n[1]=Math.max(n[1],LiteGraph.NODE_MIN_SIZE[1]);var h=0;if(this.widgets&&this.widgets.length){n[0]=Math.max(n[0],1.5*LiteGraph.NODE_MIN_WIDTH);for(var u=0,c=this.widgets.length;u<c;++u)if(this.widgets[u].computeSize){var p=this.widgets[u].computeSize(n[0]);h+=p[1]+4,n[0]=Math.max(n[0],p[0])}else h+=LiteGraph.NODE_WIDGET_HEIGHT+4,n[0]=Math.max(n[0],LiteGraph.NODE_WIDTH);h+=8}return this.widgets_up?n[1]=Math.max(n[1],h):null!=this.widgets_start_y?n[1]=Math.max(n[1],h+this.widgets_start_y):n[1]+=h,this.constructor.min_height&&(n[1]=Math.max(n[1],this.constructor.min_height)),n}},{key:"getSlotsHeight",value:function(){return Math.max(this.inputs?this.inputs.length:1,this.outputs?this.outputs.length:1,1)*LiteGraph.NODE_SLOT_HEIGHT+10+(this.constructor.slot_start_y||0)}},{key:"getPropertyInfo",value:function(e){var t=null;if(this.properties_info)for(var n=0;n<this.properties_info.length;++n)if(this.properties_info[n].name==e){t=this.properties_info[n];break}if(this.constructor["@".concat(e)]&&(t=this.constructor["@".concat(e)]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t){var i=this.processCallbackHandlers("onGetPropertyInfo",{def_cb:this.onGetPropertyInfo},e);null!==i&&"object"==_typeof(i)&&null!==i.return_value&&(t=i.return_value)}return t||(t={}),t.type||(t.type=_typeof(this.properties[e])),"combo"==t.widget&&(t.type="enum"),t}},{key:"addWidget",value:function(e,t,n,i,o){var a,r;(null!==(a=this.widgets)&&void 0!==a||(this.widgets=[]),!o&&i&&i.constructor===Object&&(o=i,i=null),o&&o.constructor===String&&(o={property:o}),i&&i.constructor===String)&&(null!==(r=o)&&void 0!==r||(o={}),o.property=i,i=null);i&&i.constructor!==Function&&(LiteGraph.log_warn("lgraphnode","addWidget","callback must be a function",i),i=null);var s={type:e.toLowerCase(),name:t,value:n,callback:i,options:o||{}};if(void 0!==s.options.y&&(s.y=s.options.y),!i&&!s.options.callback&&s.options.property,"combo"!=e||s.options.values)return this.widgets.push(s),this.setSize(this.computeSize()),s;LiteGraph.log_warn("lgraphnode","addWidget","combo requires to pass values in options eg: { values:['red','blue'] }")}},{key:"addCustomWidget",value:function(e){var t;return null!==(t=this.widgets)&&void 0!==t||(this.widgets=[]),this.widgets.push(e),e}},{key:"getBounding",value:function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Float32Array(4),n=arguments.length>1?arguments[1]:void 0,i=this.pos,o=null===(e=this.flags)||void 0===e?void 0:e.collapsed,a=this.size,r=0,s=1,l=0,h=0;return n&&(s=6+(r=4),h=5+(l=4)),t[0]=i[0]-r,t[1]=i[1]-LiteGraph.NODE_TITLE_HEIGHT-l,t[2]=o?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+s:a[0]+s,t[3]=o?LiteGraph.NODE_TITLE_HEIGHT+h:a[1]+LiteGraph.NODE_TITLE_HEIGHT+h,this.processCallbackHandlers("onBounding",{def_cb:this.onBounding},t),t}},{key:"isPointInside",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(i&&(o=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(e,t,this.pos[0]-n,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-n,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*n,LiteGraph.NODE_TITLE_HEIGHT+2*n))return!0}else if(this.pos[0]-4-n<e&&this.pos[0]+this.size[0]+4+n>e&&this.pos[1]-o-n<t&&this.pos[1]+this.size[1]+n>t)return!0;return!1}},{key:"getSlotInPosition",value:function(e,t){var n=new Float32Array(2);if(this.inputs)for(var i=0,o=this.inputs.length;i<o;++i){var a=this.inputs[i];if(this.getConnectionPos(!0,i,n),LiteGraph.isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{input:a,slot:i,link_pos:n}}if(this.outputs)for(var r=0,s=this.outputs.length;r<s;++r){var l=this.outputs[r];if(this.getConnectionPos(!1,r,n),LiteGraph.isInsideRectangle(e,t,n[0]-10,n[1]-5,20,10))return{output:l,slot:r,link_pos:n}}return null}},{key:"findInputSlot",value:function(e,t){if(!this.inputs)return-1;for(var n=0,i=this.inputs.length;n<i;++n)if(e==this.inputs[n].name)return t?this.inputs[n]:n;return-1}},{key:"findOutputSlot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!this.outputs)return-1;for(var n=0,i=this.outputs.length;n<i;++n)if(e==this.outputs[n].name)return t?this.outputs[n]:n;return-1}},{key:"getSlot",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return e&&e!==LiteGraph.OUTPUT?"undefined"!==this.inputs[t]?n?this.inputs[t]:t:this.findOutputSlot(t,n):"undefined"!==this.outputs[t]?n?this.outputs[t]:t:this.findInputSlot(t,n)}},{key:"getOutputSlot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.getSlot(!1,e,t)}},{key:"getInputSlot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.getSlot(!0,e,t)}},{key:"findInputSlotFree",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.inputs)return-1;for(var n=0,i=this.inputs.length;n<i;++n)if(!(this.inputs[n].link&&null!=this.inputs[n].link||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.inputs[n].type)))return t.returnObj?this.inputs[n]:n;return-1}},{key:"findOutputSlotFree",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.outputs)return-1;for(var n=0,i=this.outputs.length;n<i;++n)if(!(this.outputs[n].links&&null!=this.outputs[n].links||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.outputs[n].type)))return t.returnObj?this.outputs[n]:n;return-1}},{key:"findInputSlotByType",value:function(e,t,n,i){return this.findSlotByType(!0,e,t,n,i)}},{key:"findOutputSlotByType",value:function(e,t,n,i){return this.findSlotByType(!1,e,t,n,i)}},{key:"findSlotByType",value:function(){var e=arguments.length>1?arguments[1]:void 0,t=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],o=arguments.length>0&&void 0!==arguments[0]&&arguments[0]?this.inputs:this.outputs;if(!o)return-1;e&&""!=e&&"*"!=e||(e=0);for(var a=0,r=o.length;a<r;++a){var s=(e+"").toLowerCase().split(","),l="0"==o[a].type||"*"==o[a].type?0:o[a].type;l=(l+"").toLowerCase().split(",");for(var h=0;h<s.length;h++)for(var u=0;u<l.length;u++){if("_event_"==s[h]&&(s[h]=LiteGraph.EVENT),"_event_"==l[h]&&(l[h]=LiteGraph.EVENT),"*"==s[h]&&(s[h]=0),"*"==l[h]&&(l[h]=0),s[h]==l[u]){if(n&&(o[a].link&&null!==o[a].link||o[a].links&&null!==o[a].links)){LiteGraph.log_verbose("lgraphnode","findSlotByType","preferFreeSlot but has link",s[h],l[u],"from types",e,"checked types",o[a].type);continue}return LiteGraph.log_verbose("lgraphnode","findSlotByType","found right type",a,o[a],"from types",e,"checked types",o[a].type),t?o[a]:a}LiteGraph.log_verbose("lgraphnode","findSlotByType","slot not right type",s[h],l[u],"from types",e,"checked types",o[a].type)}}if(n&&!i)for(var c=0,p=o.length;c<p;++c){var d=(e+"").toLowerCase().split(","),_="0"==o[c].type||"*"==o[c].type?"0":o[c].type;_=(_+"").toLowerCase().split(",");for(var g=0;g<d.length;g++)for(var v=0;v<_.length;v++)if("*"==d[g]&&(d[g]=0),"*"==_[g]&&(_[g]=0),d[g]==_[v])return t?o[c]:c}return-1}},{key:"connectByType",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"*",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0,preferFreeSlot:!1},i);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var a=t.findInputSlotByType(n,!1,!0);return a>=0&&null!==a?(LiteGraph.log_debug("lgraphnode","connectByType","type "+n+" for "+a),this.connect(e,t,a)):o.createEventInCase&&n==LiteGraph.EVENT?(LiteGraph.log_debug("lgraphnode","connectByType","connect WILL CREATE THE onTrigger "+n+" to "+t),this.connect(e,t,-1)):o.generalTypeInCase&&(a=t.findInputSlotByType(0,!1,!0,!0),LiteGraph.log_debug("lgraphnode","connectByType","connect TO a general type (*, 0), if not found the specific type ",n," to ",t,"RES_SLOT:",a),a>=0)||o.firstFreeIfOutputGeneralInCase&&(0==n||"*"==n||""==n)&&(a=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}),LiteGraph.log_debug("lgraphnode","connectByType","connect TO TheFirstFREE ",n," to ",t,"RES_SLOT:",a),a>=0)?this.connect(e,t,a):(LiteGraph.log_debug("lgraphnode","connectByType","no way to connect type: ",n," to targetNODE ",t),null)}},{key:"connectByTypeOutput",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"*",i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},o=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},i);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var a=t.findOutputSlotByType(n,!1,!0);return a>=0&&null!==a?(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","type "+n+" for "+a),t.connect(a,this,e)):o.generalTypeInCase&&(a=t.findOutputSlotByType(0,!1,!0,!0))>=0?t.connect(a,this,e):o.createEventInCase&&n==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(a=t.addOnExecutedOutput(),t.connect(a,this,e)):o.firstFreeIfInputGeneralInCase&&(0==n||"*"==n||""==n||"undefined"==n)&&(a=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))>=0?t.connect(a,this,e):(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","no way to connect (not found or not free?) byOUT type: ",n," to sourceNODE ",t),null)}},{key:"connect",value:function(e,t){var n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!this.graph)return LiteGraph.log_warn("lgraphnode","connect","Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them.",this),null;var o=null;if(-1==(e=this.getOutputSlot(e)))return LiteGraph.log_warn("lgraphnode","connect","Slot not found",this,e),null;if(t&&t.constructor===Number&&(LiteGraph.log_debug("lgraphnode","connect","Target node constructor is number",t),t=this.graph.getNodeById(t),LiteGraph.log_debug("lgraphnode","connect","Target node number constructor, looked for node by ID",t)),t){if(t==this)return null;if(i===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;t.changeMode(LiteGraph.ON_TRIGGER),i=t.findInputSlot("onTrigger"),LiteGraph.log_debug("lgraphnode","connect","Created onTrigger slot",i)}else i=t.getInputSlot(i);if(!t.inputs||-1==i)return LiteGraph.log_warn("lgraphnode","connect","Target slot not found",i,t.inputs),null;var a,r=!1,s=t.inputs[i],l=null,h=this.outputs[e];if(!this.outputs[e])return LiteGraph.log_warn("lgraphnode","connect","Invalid processed output slot: ",e,this.outputs),null;if(null!==(o=t.processCallbackHandlers("onBeforeConnectInput",{def_cb:t.onBeforeConnectInput},t))&&"object"==_typeof(o)&&null!==o.return_value&&(LiteGraph.log_debug("lgraphnode","connect","Node onBeforeConnectInput changing target_slot",i,o.return_value),i=o.return_value),null!==(o=this.processCallbackHandlers("onConnectOutput",{def_cb:this.onConnectOutput},e,s.type,s,t,i))&&(!1===o||"object"==_typeof(o)&&!1===o.return_value))return LiteGraph.log_debug("lgraphnode","connect","Node onConnectOutput stopping connection",o.return_value),null;if(!1===i||null===i||!LiteGraph.isValidConnection(h.type,s.type))return LiteGraph.log_warn("lgraphnode","connect","target_slot is NOT valid",i,h.type,s.type),this.setDirtyCanvas(!1,!0),r&&this.graph.connectionChange(this,l),null;if(LiteGraph.log_debug("lgraphnode","connect","target_slot is valid",i),null!==(o=t.processCallbackHandlers("onConnectInput",{def_cb:t.onConnectInput},i,h.type,h,this,e))&&(!1===o||"object"==_typeof(o)&&!1===o.return_value))return LiteGraph.log_debug("lgraphnode","connect","targetNode onConnectInput stopping connection",o.return_value),null;if(t.inputs[i]&&null!=t.inputs[i].link&&(this.graph.beforeChange(),t.disconnectInput(i,{doProcessChange:!1}),r=!0),null!==(n=h.links)&&void 0!==n&&n.length&&h.type===LiteGraph.EVENT)LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),r=!0);return a=LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,l=new LiteGraph.LLink(a,s.type||h.type,this.id,e,t.id,i),this.graph.links[l.id]=l,null==h.links&&(h.links=[]),h.links.push(l.id),void 0===t.inputs[i]&&LiteGraph.log_warn("lgraphnode","connect","FIXME error, target_slot does not exists on target_node",t,i),t.inputs[i].link=l.id,this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!0,l,h),t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,i,!0,l,s),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,i,this,e),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,i)),this.graph.onGraphChanged({action:"connect"}),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,l),l}LiteGraph.log_warn("lgraphnode","connect","Target node null",t)}},{key:"disconnectOutput",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=Object.assign({doProcessChange:!0},n);e=this.getOutputSlot(e);var o=this.outputs[e];if(!o||!o.links||0==o.links.length)return LiteGraph.log_warn("lgraphnode","disconnectOutput","Error, invalid slot or not linked",e,o),!1;if(t){if(t.constructor===Number&&(LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node constructor is number",t),t=this.graph.getNodeById(t),LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node number constructor, looked for node by ID",t)),!t)return LiteGraph.log_warn("lgraphnode","disconnectOutput","target node not found",t),!1;for(var a=0,r=o.links.length;a<r;a++){var s=o.links[a],l=this.graph.links[s];if(l.target_id==t.id){var h;o.links.splice(a,1);var u=t.inputs[l.target_slot];u.link=null,delete this.graph.links[s],null===(h=this.graph)||void 0===h||h.onGraphChanged({action:"disconnectOutput",doSave:i.doProcessChange}),t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,l.target_slot,!1,l,u),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!1,l,o),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,l.target_slot),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,l.target_slot,this,e));break}}}else{for(var c=0,p=o.links.length;c<p;c++){var d,_=o.links[c],g=this.graph.links[_];g?(t=this.graph.getNodeById(g.target_id),u=null,null===(d=this.graph)||void 0===d||d.onGraphChanged({action:"disconnectOutput",doSave:i.doProcessChange}),t&&((u=t.inputs[g.target_slot]).link=null,t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,g.target_slot,!1,g,u),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,g.target_slot,this)),delete this.graph.links[_],this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!1,g,o),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,g.target_slot)):LiteGraph.log_warn("lgraphnode","disconnectOutput","A link is invalid",_,this,o)}o.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}},{key:"disconnectInput",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=Object.assign({doProcessChange:!0},t);e=this.getInputSlot(e);var i=this.inputs[e];if(!i)return!1;var o=this.inputs[e].link;if(null!=o){this.inputs[e].link=null;var a=this.graph.links[o];if(a){var r,s=this.graph.getNodeById(a.origin_id);if(!s)return!1;var l=s.outputs[a.origin_slot];if(!l||!l.links||0==l.links.length)return!1;for(var h=0,u=l.links.length;h<u;h++)if(l.links[h]==o){l.links.splice(h,1);break}delete this.graph.links[o],null===(r=this.graph)||void 0===r||r.onGraphChanged({action:"disconnectInput",doSave:n.doProcessChange}),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.INPUT,e,!1,a,i),s.processCallbackHandlers("onConnectionsChange",{def_cb:s.onConnectionsChange},LiteGraph.OUTPUT,h,!1,a,l),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,s,h),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}},{key:"getConnectionPos",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Float32Array(2),i=0;e&&this.inputs&&(i=this.inputs.length),!e&&this.outputs&&(i=this.outputs.length);var o=.5*LiteGraph.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var a=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(n[0]=this.pos[0]+.5*a,n[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(n[0]=e?this.pos[0]:this.pos[0]+a,n[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT),n}return e&&-1==t?(LiteGraph.log_debug("lgraphnode","getConnectionPos","asking for connection slot -1"),n[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,n[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT,n):e&&i>t&&this.inputs[t].pos?(n[0]=this.pos[0]+this.inputs[t].pos[0],n[1]=this.pos[1]+this.inputs[t].pos[1],n):!e&&i>t&&this.outputs[t].pos?(n[0]=this.pos[0]+this.outputs[t].pos[0],n[1]=this.pos[1]+this.outputs[t].pos[1],n):this.horizontal?(n[0]=this.pos[0]+(t+.5)*(this.size[0]/i),n[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],n):(n[0]=e?this.pos[0]+o:this.pos[0]+this.size[0]+1-o,n[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0),n)}},{key:"alignToGrid",value:function(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}},{key:"trace",value:function(t){var n,i,o,a;(this.console||(this.console=[]),null===(n=(i=this.console).push)||void 0===n||n.call(i,t),this.console.length>e.MAX_CONSOLE)&&(null===(o=(a=this.console).shift)||void 0===o||o.call(a));this.graph.processCallbackHandlers("onNodeTrace",{def_cb:this.graph.onNodeTrace},this,t)}},{key:"setDirtyCanvas",value:function(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])}},{key:"loadImage",value:function(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var n=this;return t.onload=function(){this.ready=!0,n.setDirtyCanvas(!0)},t}},{key:"captureInput",value:function(e){if(this.graph&&this.graph.list_of_graphcanvas)for(var t=this.graph.list_of_graphcanvas,n=0;n<t.length;++n){var i=t[n];(e||i.node_capturing_input==this)&&(i.node_capturing_input=e?this:null)}}},{key:"collapse",value:function(e){this.graph.onGraphChanged({action:"collapse"}),(!1!==this.constructor.collapsable||e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}},{key:"pin",value:function(e){this.graph.onGraphChanged({action:"pin"}),this.flags.pinned=void 0===e?!this.flags.pinned:e}},{key:"localToScreen",value:function(e,t,n){return[(e+this.pos[0])*n.scale+n.offset[0],(t+this.pos[1])*n.scale+n.offset[1]]}},{key:"refreshAncestors",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object.assign({action:"",param:null,options:null,passParam:!0},e);if(this.inputs){if(!(LiteGraph.preventAncestorRecalculation&&this.graph.node_ancestorsCalculated&&this.graph.node_ancestorsCalculated[this.id])){t.action&&""!=t.action||(t.action=this.id+"_ancestors"),t.param&&""!=t.param||(t.param=this.id+"_ancestors"),t.options||(t.options={}),t.options=Object.assign({action_call:t.action},t.options),LiteGraph.log_verbose("lgraphnode","refreshAncestors","ancestors processing",this.id+":"+this.order+" "+t.options.action_call,this),this.graph.ancestorsCall=!0;var n={modesSkip:[LiteGraph.NEVER,LiteGraph.ON_EVENT,LiteGraph.ON_TRIGGER],modesOnly:[LiteGraph.ALWAYS,LiteGraph.ON_REQUEST],typesSkip:[LiteGraph.ACTION],typesOnly:[]},i=this.graph.getAncestors(this,n);for(var o in i)LiteGraph.log_verbose("lgraphnode","refreshAncestors","doExecute ancestor",o,i[o],t.param,t.options),i[o].doExecute(t.param,t.options),this.graph.node_ancestorsCalculated[i[o].id]=!0;return this.graph.ancestorsCall=!1,this.graph.node_ancestorsCalculated[this.id]=!0,!0}LiteGraph.log_verbose("lgraphnode","refreshAncestors","already calculated subtree! Prevent! "+this.id+":"+this.order,this)}}},{key:"syncObjectByProperty",value:function(e,t,n,i){var o=Object.assign({},{only_in_source:"append",fallback_checks:[{name:"type"}]},i);null!==e&&e||(e=[]),null!==t&&t||(t=[]);var a=[],r={},s=t.filter((function(t){return!e.some((function(e){return e[n]===t[n]}))})),l=[],h=[];t.forEach((function(t,i){var o=!1;e.forEach((function(e,s){o||(l.includes(s)?LiteGraph.log_verbose("syncObjectByProperty","skip used",e,s):e[n]===t[n]&&(o=!0,l.push(s),a[i]=LiteGraph.cloneObject(e),i!=s?(LiteGraph.log_debug("syncObjectByProperty","push SHIFTED",t[n],t,s,i),r[s]=i):LiteGraph.log_verbose("syncObjectByProperty","found ok, same index",t[n],e,i)))})),o||h.push({ob:t,index:i})})),h.length&&(o.fallback_checks.length?h.forEach((function(t,i){var s=t.ob,h=t.index,u=!1;o.fallback_checks.forEach((function(t,n){u||e.forEach((function(e,n){u||(l.includes(n)?LiteGraph.log_verbose("syncObjectByProperty","aNotFoundInSource skip used slot",e,n):e[t.name]===s[t.name]&&(u=!0,l.push(n),a[h]=LiteGraph.cloneObject(e),LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource",t,"push SHIFTED",s[t],s,n,h),r[n]=h))}))})),u||(LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource, push !foundInSource",t.ob[n],t),a[t.index]=LiteGraph.cloneObject(t.ob))})):h.forEach((function(e,t){LiteGraph.log_debug("syncObjectByProperty","!using fallback checks","push !foundInSource",e.ob[n],e),a[e.index]=LiteGraph.cloneObject(e.ob)})));var u=[],c=[];return e.forEach((function(e,i){var o=!1;l.includes(i)||(t.forEach((function(t,a){o||(u.includes(a)?LiteGraph.log_verbose("syncObjectByProperty","only_in_source","skip checked slot",e,i):e[n]===t[n]&&(u.push(a),o=!0))})),o||(LiteGraph.log_debug("syncObjectByProperty","push only_in_source",e[n],e),a.push(LiteGraph.cloneObject(e)),r[i]=a.length-1,c.push(e)))})),LiteGraph.log_info("lgraphnode","syncByProperty",{only_in_source:c,only_in_target:s,ob_from:e,ob_dest:t,new_dest:a,keys_remap:r}),{ob_dest:a,keys_remap:r,only_in_source:c,only_in_target:s}}}])}(),LGraphGroup=function(){function e(){var t,n,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Group";_classCallCheck(this,e),_defineProperty(this,"getBounding",(function(){var e;(e=LiteGraph.LGraphNode.prototype.getBounding).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))})),_defineProperty(this,"isPointInside",LiteGraph.LGraphNode.prototype.isPointInside),_defineProperty(this,"setDirtyCanvas",LiteGraph.LGraphNode.prototype.setDirtyCanvas),this.title=i,this.font_size=24,this.color=null!==(t=null===(n=LiteGraph.LGraphCanvas.node_colors.pale_blue)||void 0===n?void 0:n.groupcolor)&&void 0!==t?t:"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this._groups=[],this.graph=null,this.callbackhandler_setup()}return _createClass(e,[{key:"callbackhandler_setup",value:function(){this.cb_handler=new CallbackHandler(this)}},{key:"registerCallbackHandler",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)}},{key:"unregisterCallbackHandler",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)}},{key:"processCallbackHandlers",value:function(){var e;return this.cb_handler||this.callbackhandler_setup(),(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)}},{key:"pos",get:function(){return this._pos},set:function(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])}},{key:"size",get:function(){return this._size},set:function(e){!e||e.length<2||(this._size[0]=Math.max(140,e[0]),this._size[1]=Math.max(80,e[1]))}},{key:"configure",value:function(e){this.title=e.title,this._bounding=LiteGraph.cloneObject(e.bounding,this._bounding),this.color=e.color,e.font_size&&(this.font_size=e.font_size)}},{key:"serialize",value:function(){var e=this._bounding;return{title:this.title,bounding:e.map((function(e){return Math.round(e)})),color:this.color,font_size:this.font_size}}},{key:"move",value:function(e,t,n){var i,o,a,r;isNaN(e)&&(null===(i=(o=console).error)||void 0===i||i.call(o,"LGraphGroup.move() deltax NaN")),isNaN(t)&&(null===(a=(r=console).error)||void 0===a||a.call(r,"LGraphGroup.move() deltay NaN")),this._pos[0]+=e,this._pos[1]+=t,n||(this._nodes.forEach((function(n){n.pos[0]+=e,n.pos[1]+=t})),this._groups.forEach((function(n){n.pos[0]+=e,n.pos[1]+=t})))}},{key:"recomputeInsideNodes",value:function(){var t=this;this._nodes.length=0;var n=this.graph._nodes,i=new Float32Array(4);this._nodes=n.filter((function(n){return n.getBounding(i),LiteGraph.overlapBounding(t._bounding,i,-e.opts.inclusion_distance)})),this.recomputeInsideGroups()}},{key:"recomputeInsideGroups",value:function(){var e=this;this._groups.length=0;var t=this.graph._groups,n=new Float32Array(4);this._groups=t.filter((function(t){return t.getBounding(n),LiteGraph.isBoundingInsideRectangle.apply(LiteGraph,[n].concat(_toConsumableArray(e._bounding)))}))}}])}();_defineProperty(LGraphGroup,"opts",{inclusion_distance:36});var Subgraph=function(){return _createClass((function e(){_classCallCheck(this,e),this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new LiteGraph.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}),[{key:"onGetInputs",value:function(){return[["enabled","boolean"]]}},{key:"onDblClick",value:function(e,t,n){var i=this;setTimeout((function(){n.openSubgraph(i.subgraph)}),10)}},{key:"onAction",value:function(e,t){LiteGraph.log_debug.apply(LiteGraph,["subgraph","onAction"].concat(Array.prototype.slice.call(arguments))),this.subgraph.onAction(e,t)}},{key:"onExecute",value:function(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(var e=0;e<this.inputs.length;e++){var t=this.inputs[e],n=this.getInputData(e);this.subgraph.setInputData(t.name,n)}if(LiteGraph.log_verbose("subgraph","onExecute","subgraph runStep",this.subgraph),this.subgraph.runStep(),this.outputs)for(var i=0;i<this.outputs.length;i++){var o=this.outputs[i],a=this.subgraph.getOutputData(o.name);LiteGraph.log_verbose("subgraph","onExecute","outputDataSet",i,a),this.setOutputData(i,a)}}}},{key:"sendEventToAllNodes",value:function(e,t,n){this.enabled&&(LiteGraph.log_debug.apply(LiteGraph,["subgraph","sendEventToAllNodes"].concat(Array.prototype.slice.call(arguments))),this.subgraph.sendEventToAllNodes(e,t,n))}},{key:"onDrawBackground",value:function(e,t,n,i){if(!this.flags.collapsed){var o=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,a=LiteGraph.isInsideRectangle(i[0],i[1],this.pos[0],this.pos[1]+o,this.size[0],LiteGraph.NODE_TITLE_HEIGHT),r=LiteGraph.isInsideRectangle(i[0],i[1],this.pos[0],this.pos[1]+o,this.size[0]/2,LiteGraph.NODE_TITLE_HEIGHT);e.fillStyle=a?"#555":"#222",e.beginPath(),this._shape==LiteGraph.BOX_SHAPE?r?e.rect(0,o,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):e.rect(this.size[0]/2,o,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):r?e.roundRect(0,o,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]):e.roundRect(this.size[0]/2,o,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]),a?e.fill():e.fillRect(0,o,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT),e.textAlign="center",e.font="24px Arial",e.fillStyle=a?"#DDD":"#999",e.fillText("+",.25*this.size[0],o+24),e.fillText("+",.75*this.size[0],o+24)}}},{key:"onMouseDown",value:function(e,t,n){var i,o,a,r,s,l,h=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;(null===(i=(o=console).log)||void 0===i||i.call(o,0),t[1]>h)&&(t[0]<this.size[0]/2?(null===(a=(r=console).log)||void 0===a||a.call(r,1),n.showSubgraphPropertiesDialog(this)):(null===(s=(l=console).log)||void 0===s||s.call(l,2),n.showSubgraphPropertiesDialogRight(this)))}},{key:"computeSize",value:function(){var e=this.inputs?this.inputs.length:0,t=this.outputs?this.outputs.length:0;return[200,Math.max(e,t)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT]}},{key:"onSubgraphTrigger",value:function(e){LiteGraph.log_debug.apply(LiteGraph,["subgraph","onSubgraphTrigger"].concat(Array.prototype.slice.call(arguments)));var t=this.findOutputSlot(e);-1!=t&&this.triggerSlot(t)}},{key:"onSubgraphNewInput",value:function(e,t){-1==this.findInputSlot(e)&&this.addInput(e,t)}},{key:"onSubgraphRenamedInput",value:function(e,t){var n=this.findInputSlot(e);-1!=n&&(this.getInputInfo(n).name=t)}},{key:"onSubgraphTypeChangeInput",value:function(e,t){var n=this.findInputSlot(e);-1!=n&&(this.getInputInfo(n).type=t)}},{key:"onSubgraphRemovedInput",value:function(e){var t=this.findInputSlot(e);-1!=t&&this.removeInput(t)}},{key:"onSubgraphNewOutput",value:function(e,t){-1==this.findOutputSlot(e)&&this.addOutput(e,t)}},{key:"onSubgraphRenamedOutput",value:function(e,t){var n=this.findOutputSlot(e);-1!=n&&(this.getOutputInfo(n).name=t)}},{key:"onSubgraphTypeChangeOutput",value:function(e,t){var n=this.findOutputSlot(e);-1!=n&&(this.getOutputInfo(n).type=t)}},{key:"onSubgraphRemovedOutput",value:function(e){var t=this.findOutputSlot(e);-1!=t&&this.removeOutput(t)}},{key:"getExtraMenuOptions",value:function(e){var t=this;return[{content:"Open",callback:function(){e.openSubgraph(t.subgraph)}}]}},{key:"onResize",value:function(e){e[1]+=20}},{key:"serialize",value:function(){var e=LiteGraph.LGraphNode.prototype.serialize.call(this);return e.subgraph=this.subgraph.serialize(),e}},{key:"reassignSubgraphUUIDs",value:function(e){var t,n={nodeIDs:{},linkIDs:{}},i=_createForOfIteratorHelper(e.nodes);try{for(i.s();!(t=i.n()).done;){var o=t.value,a=o.id,r=LiteGraph.uuidv4();if(o.id=r,n.nodeIDs[a]||n.nodeIDs[r])throw new Error("New/old node UUID wasn't unique in changed map! ".concat(a," ").concat(r));n.nodeIDs[a]=r,n.nodeIDs[r]=a}}catch(e){i.e(e)}finally{i.f()}var s,l=_createForOfIteratorHelper(e.links);try{for(l.s();!(s=l.n()).done;){var h=s.value,u=h[0],c=LiteGraph.uuidv4();if(h[0]=c,n.linkIDs[u]||n.linkIDs[c])throw new Error("New/old link UUID wasn't unique in changed map! ".concat(u," ").concat(c));n.linkIDs[u]=c,n.linkIDs[c]=u;var p=h[1],d=h[3];if(!n.nodeIDs[p])throw new Error("Old node UUID not found in mapping! ".concat(p));if(h[1]=n.nodeIDs[p],!n.nodeIDs[d])throw new Error("Old node UUID not found in mapping! ".concat(d));h[3]=n.nodeIDs[d]}}catch(e){l.e(e)}finally{l.f()}var _,g=_createForOfIteratorHelper(e.nodes);try{for(g.s();!(_=g.n()).done;){var v=_.value;if(v.inputs){var f,y=_createForOfIteratorHelper(v.inputs);try{for(y.s();!(f=y.n()).done;){var b=f.value;b.link&&(b.link=n.linkIDs[b.link])}}catch(e){y.e(e)}finally{y.f()}}if(v.outputs){var k,L=_createForOfIteratorHelper(v.outputs);try{for(L.s();!(k=L.n()).done;){var m=k.value;m.links&&(m.links=m.links.map((function(e){return n.linkIDs[e]})))}}catch(e){L.e(e)}finally{L.f()}}}}catch(e){g.e(e)}finally{g.f()}var G,C=_createForOfIteratorHelper(e.nodes);try{for(C.s();!(G=C.n()).done;){var w=G.value;if("graph/subgraph"===w.type){var E=reassignGraphUUIDs(w.subgraph);n.nodeIDs.assign(E.nodeIDs),n.linkIDs.assign(E.linkIDs)}}}catch(e){C.e(e)}finally{C.f()}}},{key:"clone",value:function(){var e=LiteGraph.createNode(this.type),t=this.serialize();if(LiteGraph.use_uuids){var n=LiteGraph.cloneObject(t.subgraph);this.reassignSubgraphUUIDs(n),t.subgraph=n}return delete t.id,delete t.inputs,delete t.outputs,e.configure(t),e}},{key:"buildFromNodes",value:function(e){for(var t={},n=0;n<e.length;++n)t[node.id]=e[n];for(var i=0;i<e.length;++i){var o=e[i];if(o.inputs)for(var a=0;a<o.inputs.length;++a){var r=o.inputs[a];if(r&&r.link){var s=o.graph.links[r.link];s&&(t[s.origin_id]||this.subgraph.addInput(r.name,s.type))}}if(o.outputs)for(var l=0;l<o.outputs.length;++l){var h=o.outputs[l];if(h&&h.links&&h.links.length)for(var u=0;u<h.links.length;++u){var c=o.graph.links[h.links[u]];if(c&&!t[c.target_id])break}}}}}])}();_defineProperty(Subgraph,"title","Subgraph"),_defineProperty(Subgraph,"desc","Graph inside a node"),_defineProperty(Subgraph,"title_color","#334");var GraphInput=function(){return _createClass((function e(){_classCallCheck(this,e),this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var t=this;this.name_widget=this.addWidget("text","Name",this.properties.name,(function(e){e&&t.setProperty("name",e)})),this.type_widget=this.addWidget("text","Type",this.properties.type,(function(e){t.setProperty("type",e)})),this.value_widget=this.addWidget("number","Value",this.properties.value,(function(e){t.setProperty("value",e)})),this.widgets_up=!0,this.size=[180,90]}),[{key:"onConfigure",value:function(){this.updateType()}},{key:"updateType",value:function(){var e=this.properties.type;this.type_widget.value=e,"action"!=e&&"event"!=e||(e=LiteGraph.EVENT),this.outputs[0].type!==e&&(LiteGraph.isValidConnection(this.outputs[0].type,e)||this.disconnectOutput(0),this.outputs[0].type=e),this.properties.type=e,"number"==e?(this.value_widget.type="number",this.value_widget.value=Number()):"boolean"==e?(this.value_widget.type="toggle",this.value_widget.value=!(!this.value_widget.value||"false"===(this.value_widget.value+"").toLocaleLowerCase()||""===this.value_widget.value)):"string"==e?(this.value_widget.type="text",this.value_widget.value=this.value_widget.value+""):this.value_widget.type=null,this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,e)}},{key:"onPropertyChanged",value:function(e,t){if("name"==e){if(""==t||t==this.name_in_graph||"enabled"==t)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,t):this.graph.addInput(t,this.properties.type)),this.name_widget.value=t,this.name_in_graph=t}else"type"==e&&this.updateType()}},{key:"getTitle",value:function(){return this.flags.collapsed?this.properties.name:this.title}},{key:"onAction",value:function(e,t){this.properties.type==LiteGraph.EVENT?(LiteGraph.log_debug("GraphInput","onAction","triggering slot",e,t),this.triggerSlot(0,t)):LiteGraph.log_debug.apply(LiteGraph,["GraphInput","onAction","NOT eventAction TYPE","this",this,"arugments"].concat(Array.prototype.slice.call(arguments)))}},{key:"onExecute",value:function(){var e=this.properties.name,t=this.graph.inputs[e];t?this.setOutputData(0,void 0!==t.value?t.value:this.properties.value):this.setOutputData(0,this.properties.value)}},{key:"onRemoved",value:function(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}])}();_defineProperty(GraphInput,"title","Input"),_defineProperty(GraphInput,"desc","Input of the graph");var GraphOutput=function(){return _createClass((function e(){_classCallCheck(this,e),this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}),[{key:"onPropertyChanged",value:function(e,t){if("name"==e){if(""==t||t==this.name_in_graph||"enabled"==t)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,t):this.graph.addOutput(t,this.properties.type)),this.name_widget.value=t,this.name_in_graph=t}else"type"==e&&this.updateType()}},{key:"updateType",value:function(){var e=this.properties.type;this.type_widget&&(this.type_widget.value=e),"action"!=e&&"event"!=e||(e=LiteGraph.EVENT),this.inputs[0].type!==e&&(LiteGraph.isValidConnection(this.inputs[0].type,e)||this.disconnectInput(0),this.inputs[0].type=e),this.properties.type=e,this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,e)}},{key:"onExecute",value:function(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}},{key:"onAction",value:function(e,t){this.properties.type==LiteGraph.ACTION?(LiteGraph.log_debug.apply(LiteGraph,["GraphOutput","onAction"].concat(Array.prototype.slice.call(arguments))),LiteGraph.log_debug("GraphOutput","onAction","graphTrigger",this.properties.name,t),this.triggerSlot(this.properties.name,t),this.graph.trigger(this.properties.name,t)):LiteGraph.log_debug("GraphOutput","onAction","skipping not ACTION type",this.properties.type,this.properties)}},{key:"onRemoved",value:function(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}},{key:"getTitle",value:function(){return this.flags.collapsed?this.properties.name:this.title}}])}();_defineProperty(GraphOutput,"title","Output"),_defineProperty(GraphOutput,"desc","Output of the graph");var NodeFunction=function(e){function t(){var e;return _classCallCheck(this,t),(e=_callSuper(this,t,arguments))._subgraph=null,e._linking=!1,e.addWidget("button","subgraph_link",null,(function(e,t,n,i,o){var a;(a=console).debug.apply(a,["SUBGRAPHLINK"].concat(Array.prototype.slice.call(arguments))),n._linking?(n._linking=!1,e.name="subgraph_link"):(n._linking=!0,e.name="click on subgraph")})),e.addWidget("button","refresh",null,e.refreshFunctions_byEvent),e.addWidget("button","CALL",null,e.onBtnExecute),e._wCombo=e.addWidget("combo","functions",e.functionChange,{values:[]}),e._subMap=[],e._subGFuncNode=null,e.properties={func_subgraph_id:null},e}return _inherits(t,e),_createClass(t,[{key:"onBtnExecute",value:function(e,t,n,i,o,a){var r;(r=console).error.apply(r,["SELFEXECUTE",this].concat(Array.prototype.slice.call(arguments))),n.doExecute()}},{key:"functionChange",value:function(e,t,n,i,o,a){var r;console.error("FUNCTIONCHANGE","this",this),(r=console).error.apply(r,["FUNCTIONCHANGE","arguments"].concat(Array.prototype.slice.call(arguments))),console.error("FUNCTIONCHANGE","node",n),n.btnSetFunction(null,t,n,i,o)}},{key:"onConfigure",value:function(){this.ensureSubFunction()}},{key:"onExecute",value:function(){this.ensureSubFunction()}},{key:"onAdded",value:function(){null!==this.properties.func_subgraph_id&&void 0!==this.properties.func_subgraph_id&&(this._wCombo.value=this.properties.func_subgraph_id),this.refreshFunctions()}},{key:"refreshFunctions_byEvent",value:function(e,t,n,i,o){n.refreshFunctions.bind(n)}},{key:"refreshFunctions",value:function(){var e,t=this,n=null===(e=this.graph)||void 0===e?void 0:e.findNodesByClass(Subgraph);console.debug("NODEFUNCTION refreshFunctions",this,n,this._wCombo),this._wCombo.options.values={},this._subMap=[],n&&n.length&&n.forEach((function(e){t._wCombo.options.values[e.id]=e.title,t._subMap.push(e.id),t.properties.func_subgraph_id===e.id&&(t._wCombo.value=e.id)}))}},{key:"ensureSubFunction",value:function(){this._subGFuncNode||null!==this.properties.func_subgraph_id&&void 0!==this.properties.func_subgraph_id&&(this.lookForFuncNodeById(this.properties.func_subgraph_id),this.refreshFunctions())}},{key:"lookForFuncNodeById",value:function(e){var t=this.graph.getNodeById(e);t?(console.error("NODEFUNCTION CALL","this?",this),this.updateSubFunction(t)):(console.error("NODEFUNCTION CALL","nodeNotFound",e),this.updateSubFunction(!1))}},{key:"btnSetFunction",value:function(e,t,n,i,o){console.debug("NODEFUNCTION CALL",n,n._wCombo.value),this.lookForFuncNodeById(n._wCombo.value)}},{key:"updateSubFunction",value:function(e){var t=this;this._subGFuncNode=e,console.debug("REFRESHSLOTS",this),null!=e&&e?(this.properties.func_subgraph_id=e.id,e.inputs.forEach((function(e,n){void 0!==t.inputs[n]&&t.inputs[n].type==e.type||(t.inputs[n]={name:e.name,type:e.type})})),e.outputs.forEach((function(e,n){void 0!==t.outputs[n]&&t.outputs[n].type==e.type||(t.outputs[n]={name:e.name,type:e.type})})),this.autoSize()):(this.properties.func_subgraph_id=null,this.inputs=[],this.outputs=[]),this.bindEvents()}},{key:"bindEvents",value:function(){var e=this._subGFuncNode;console.debug("BINDEVENTS",this),this.onExecute=null!=e&&e?function(){var t=this;console.debug("NODEFUNCTION executing",this),this.inputs.forEach((function(n,i){var o=t.getInputData(i);e.inputs[i].hard_coded_value=o,console.debug("read and set input data",i,o)})),console.debug("execute function node",e),e.doExecute(),this.outputs.forEach((function(n,i){var o=e.getOutputData(i);t.setOutputData(i,o),console.debug("read and set output node data",i,o)})),this.inputs.forEach((function(t,n){delete e.inputs[n].hard_coded_value,console.debug("clean hard coded input data",n)}))}:function(){console.debug("NODEFUNCTION has no functionset",this)}}}])}(LGraphNode);function getGlobalObject(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to determine global object")}function setGlobalVariable(e,t){getGlobalObject()[e]=t}function getGlobalVariable(e){return getGlobalObject()[e]}_defineProperty(NodeFunction,"title","NodeFunction"),_defineProperty(NodeFunction,"desc","Subgraph as function");var LiteGraphClass=function(){return _createClass((function e(){_classCallCheck(this,e),_defineProperty(this,"VERSION","a0.11.0"),_defineProperty(this,"LLink",null),_defineProperty(this,"LGraph",null),_defineProperty(this,"LGraphNode",null),_defineProperty(this,"LGraphGroup",null),_defineProperty(this,"LGraphCanvas",null),_defineProperty(this,"Subgraph",null),_defineProperty(this,"GraphInput",null),_defineProperty(this,"GraphOutput",null),_defineProperty(this,"DragAndScale",null),_defineProperty(this,"ContextMenuClass",null),_defineProperty(this,"ContextMenu",null),_defineProperty(this,"CallbackHandler",null),_defineProperty(this,"CANVAS_GRID_SIZE",10),_defineProperty(this,"NODE_TITLE_HEIGHT",30),_defineProperty(this,"NODE_TITLE_TEXT_Y",20),_defineProperty(this,"NODE_SLOT_HEIGHT",20),_defineProperty(this,"NODE_WIDGET_HEIGHT",20),_defineProperty(this,"NODE_WIDTH",140),_defineProperty(this,"NODE_MIN_WIDTH",50),_defineProperty(this,"NODE_MIN_SIZE",[50,0]),_defineProperty(this,"NODE_COLLAPSED_RADIUS",10),_defineProperty(this,"NODE_COLLAPSED_WIDTH",80),_defineProperty(this,"NODE_TITLE_COLOR","#999"),_defineProperty(this,"NODE_SELECTED_TITLE_COLOR","#FFF"),_defineProperty(this,"NODE_TEXT_SIZE",14),_defineProperty(this,"NODE_TEXT_COLOR","#AAA"),_defineProperty(this,"NODE_SUBTEXT_SIZE",12),_defineProperty(this,"NODE_DEFAULT_COLOR","#333"),_defineProperty(this,"NODE_DEFAULT_BGCOLOR","#353535"),_defineProperty(this,"NODE_DEFAULT_BOXCOLOR","#666"),_defineProperty(this,"NODE_DEFAULT_SHAPE","box"),_defineProperty(this,"NODE_BOX_OUTLINE_COLOR","#FFF"),_defineProperty(this,"DEFAULT_SHADOW_COLOR","rgba(0,0,0,0.5)"),_defineProperty(this,"DEFAULT_GROUP_FONT",24),_defineProperty(this,"WIDGET_BGCOLOR","#222"),_defineProperty(this,"WIDGET_OUTLINE_COLOR","#666"),_defineProperty(this,"WIDGET_TEXT_COLOR","#DDD"),_defineProperty(this,"WIDGET_SECONDARY_TEXT_COLOR","#999"),_defineProperty(this,"LINK_COLOR","#9A9"),_defineProperty(this,"EVENT_LINK_COLOR","#A86"),_defineProperty(this,"CONNECTING_LINK_COLOR","#AFA"),_defineProperty(this,"MAX_NUMBER_OF_NODES",1e3),_defineProperty(this,"DEFAULT_POSITION",[100,100]),_defineProperty(this,"VALID_SHAPES",["default","box","round","card"]),_defineProperty(this,"BOX_SHAPE",1),_defineProperty(this,"ROUND_SHAPE",2),_defineProperty(this,"CIRCLE_SHAPE",3),_defineProperty(this,"CARD_SHAPE",4),_defineProperty(this,"ARROW_SHAPE",5),_defineProperty(this,"GRID_SHAPE",6),_defineProperty(this,"INPUT",1),_defineProperty(this,"OUTPUT",2),_defineProperty(this,"EVENT",-1),_defineProperty(this,"ACTION",-1),_defineProperty(this,"NODE_MODES",["Always","On Event","Never","On Trigger","On Request"]),_defineProperty(this,"NODE_MODES_COLORS",["#666","#422","#333","#224","#626"]),_defineProperty(this,"ALWAYS",0),_defineProperty(this,"ON_EVENT",1),_defineProperty(this,"NEVER",2),_defineProperty(this,"ON_TRIGGER",3),_defineProperty(this,"ON_REQUEST",4),_defineProperty(this,"UP",1),_defineProperty(this,"DOWN",2),_defineProperty(this,"LEFT",3),_defineProperty(this,"RIGHT",4),_defineProperty(this,"CENTER",5),_defineProperty(this,"LINK_RENDER_MODES",["Straight","Linear","Spline"]),_defineProperty(this,"STRAIGHT_LINK",0),_defineProperty(this,"LINEAR_LINK",1),_defineProperty(this,"SPLINE_LINK",2),_defineProperty(this,"NORMAL_TITLE",0),_defineProperty(this,"NO_TITLE",1),_defineProperty(this,"TRANSPARENT_TITLE",2),_defineProperty(this,"AUTOHIDE_TITLE",3),_defineProperty(this,"VERTICAL_LAYOUT","vertical"),_defineProperty(this,"proxy",null),_defineProperty(this,"node_images_path",""),_defineProperty(this,"catch_exceptions",!0),_defineProperty(this,"throw_errors",!0),_defineProperty(this,"allow_scripts",!1),_defineProperty(this,"use_deferred_actions",!0),_defineProperty(this,"registered_node_types",{}),_defineProperty(this,"node_types_by_file_extension",{}),_defineProperty(this,"Nodes",{}),_defineProperty(this,"Globals",{}),_defineProperty(this,"searchbox_extras",{}),_defineProperty(this,"auto_sort_node_types",!1),_defineProperty(this,"node_box_coloured_when_on",!1),_defineProperty(this,"node_box_coloured_by_mode",!1),_defineProperty(this,"dialog_close_on_mouse_leave",!0),_defineProperty(this,"dialog_close_on_mouse_leave_delay",500),_defineProperty(this,"shift_click_do_break_link_from",!0),_defineProperty(this,"click_do_break_link_to",!1),_defineProperty(this,"search_filter_enabled",!1),_defineProperty(this,"search_hide_on_mouse_leave",!0),_defineProperty(this,"search_hide_on_mouse_leave_time",1200),_defineProperty(this,"search_show_all_on_open",!0),_defineProperty(this,"show_node_tooltip",!1),_defineProperty(this,"show_node_tooltip_use_descr_property",!1),_defineProperty(this,"auto_load_slot_types",!1),_defineProperty(this,"registered_slot_in_types",{}),_defineProperty(this,"registered_slot_out_types",{}),_defineProperty(this,"slot_types_in",[]),_defineProperty(this,"slot_types_out",[]),_defineProperty(this,"slot_types_default_in",[]),_defineProperty(this,"slot_types_default_out",[]),_defineProperty(this,"graphDefaultConfig",{align_to_grid:!0,links_ontop:!1}),_defineProperty(this,"alt_drag_do_clone_nodes",!1),_defineProperty(this,"alt_shift_drag_connect_clone_with_input",!0),_defineProperty(this,"do_add_triggers_slots",!1),_defineProperty(this,"allow_multi_output_for_events",!0),_defineProperty(this,"middle_click_slot_add_default_node",!1),_defineProperty(this,"release_link_on_empty_shows_menu",!1),_defineProperty(this,"two_fingers_opens_menu",!1),_defineProperty(this,"backspace_delete",!0),_defineProperty(this,"ctrl_shift_v_paste_connect_unselected_outputs",!1),_defineProperty(this,"actionHistory_enabled",!1),_defineProperty(this,"actionHistoryMaxSave",300),_defineProperty(this,"refreshAncestorsOnTriggers",!1),_defineProperty(this,"refreshAncestorsOnActions",!1),_defineProperty(this,"ensureUniqueExecutionAndActionCall",!1),_defineProperty(this,"use_uuids",!1),_defineProperty(this,"context_menu_filter_enabled",!1),_defineProperty(this,"canRemoveSlots",!0),_defineProperty(this,"canRemoveSlots_onlyOptional",!0),_defineProperty(this,"canRenameSlots",!0),_defineProperty(this,"canRenameSlots_onlyOptional",!0),_defineProperty(this,"ensureNodeSingleExecution",!1),_defineProperty(this,"ensureNodeSingleAction",!1),_defineProperty(this,"preventAncestorRecalculation",!1),_defineProperty(this,"allowMultiOutputForEvents",!1),_defineProperty(this,"reprocess_slot_while_node_configure",!1),_defineProperty(this,"properties_allow_input_binding",!1),_defineProperty(this,"properties_allow_output_binding",!1),_defineProperty(this,"log_methods",["error","warn","info","log","debug"]),_defineProperty(this,"cb_handler",!1),_defineProperty(this,"debug",!0),_defineProperty(this,"debug_level",2),_defineProperty(this,"extendClass",(function(e,t){for(var n in t)e.hasOwnProperty(n)||(e[n]=t[n]);if(t.prototype)for(var i in t.prototype)t.prototype.hasOwnProperty(i)&&(e.prototype.hasOwnProperty(i)||(t.prototype.__lookupGetter__(i)?e.prototype.__defineGetter__(i,t.prototype.__lookupGetter__(i)):e.prototype[i]=t.prototype[i],t.prototype.__lookupSetter__(i)&&e.prototype.__defineSetter__(i,t.prototype.__lookupSetter__(i))))})),_defineProperty(this,"getParameterNames",(function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)})),_defineProperty(this,"clamp",(function(e,t,n){return t>e?t:n<e?n:e})),_defineProperty(this,"closeAllContextMenus",(function(){LiteGraph.log_verbose("LiteGraph.closeAllContextMenus is deprecated in favor of ContextMenu.closeAll()"),ContextMenu.closeAll()}))}),[{key:"initialize",value:function(){this.callbackhandler_setup(),this.LLink=LLink,this.LGraph=LGraph,this.LGraphNode=LGraphNode,this.LGraphGroup=LGraphGroup,this.LGraphCanvas=LGraphCanvas,this.Subgraph=Subgraph,this.GraphInput=GraphInput,this.GraphOutput=GraphOutput,this.DragAndScale=DragAndScale,this.ContextMenuClass=ContextMenu,this.ContextMenu=function(){return _construct(ContextMenu,Array.prototype.slice.call(arguments))},this.CallbackHandler=CallbackHandler,this.includeBasicNodes()}},{key:"includeBasicNodes",value:function(){this.registerNodeType("graph/subgraph",Subgraph),this.registerNodeType("graph/input",GraphInput),this.registerNodeType("graph/output",GraphOutput),this.registerNodeType("graph/function",NodeFunction)}},{key:"callbackhandler_setup",value:function(){this.cb_handler||(this.cb_handler=new CallbackHandler(this),this.registerCallbackHandler=function(){var e;return(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)},this.unregisterCallbackHandler=function(){var e;return(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)},this.processCallbackHandlers=function(){var e;return(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)})}},{key:"registerCallbackHandler",value:function(){var e;this.callbackhandler_setup(),(e=this.cb_handler).registerCallbackHandler.apply(e,arguments)}},{key:"unregisterCallbackHandler",value:function(){var e;this.callbackhandler_setup(),(e=this.cb_handler).unregisterCallbackHandler.apply(e,arguments)}},{key:"processCallbackHandlers",value:function(){var e;this.callbackhandler_setup(),(e=this.cb_handler).processCallbackHandlers.apply(e,arguments)}},{key:"logging_set_level",value:function(e){this.debug_level=Number(e)}},{key:"logging",value:function(e){var t;if(!this.debug&&this.debug_level>0&&(this.debug_level=0),!(e>this.debug_level)){var n="debug";if(e>=0&&e<=4&&(n=["error","warn","info","log","debug"][e]),"function"!=typeof console[n])throw console.warn("[LG-log] invalid console method",n,i(arguments)),new RangeError;(t=console)[n].apply(t,["[LG]"].concat(_toConsumableArray(i(arguments))))}function i(t){var n=[];(e<0||e>4)&&n.push("loglvl:"+e);for(var i=1;i<t.length;i++)void 0!==t[i]&&n.push(t[i]);return n}}},{key:"log_error",value:function(){this.logging.apply(this,[0].concat(Array.prototype.slice.call(arguments)))}},{key:"log_warn",value:function(){this.logging.apply(this,[1].concat(Array.prototype.slice.call(arguments)))}},{key:"log_info",value:function(){this.logging.apply(this,[2].concat(Array.prototype.slice.call(arguments)))}},{key:"log_log",value:function(){this.logging.apply(this,[3].concat(Array.prototype.slice.call(arguments)))}},{key:"log_debug",value:function(){this.logging.apply(this,[4].concat(Array.prototype.slice.call(arguments)))}},{key:"log_verbose",value:function(){this.logging.apply(this,[5].concat(Array.prototype.slice.call(arguments)))}},{key:"registerNodeType",value:function(e,t){if(!t.prototype)throw new Error("Cannot register a simple object, it must be a class with a prototype");t.type=e,this.log_debug("registerNodeType","start",e);var n=t.name,i=e.lastIndexOf("/");t.category=e.substring(0,i),t.title||(t.title=n);var o=Object.getOwnPropertyDescriptors(LGraphNode.prototype);Object.keys(o).forEach((function(e){t.prototype.hasOwnProperty(e)||Object.defineProperty(t.prototype,e,o[e])}));var a,r=this.registered_node_types[e];if(r&&this.log_debug("registerNodeType","replacing node type",e,r),!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(e){switch(e){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=e}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(var s in t.supported_extensions){var l=t.supported_extensions[s];l&&l.constructor===String&&(this.node_types_by_file_extension[l.toLowerCase()]=t)}if(this.registered_node_types[e]=t,t.constructor.name&&(this.Nodes[n]=t),this.processCallbackHandlers("onNodeTypeRegistered",{def_cb:this.onNodeTypeRegistered},e,t),r&&this.processCallbackHandlers("onNodeTypeReplaced",{def_cb:this.onNodeTypeReplaced},e,t,r),t.prototype.onPropertyChange&&LiteGraph.log_warn("LiteGraph node class "+e+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),t.supported_extensions)for(var h=0;h<t.supported_extensions.length;h++){var u=t.supported_extensions[h];u&&u.constructor===String&&(this.node_types_by_file_extension[u.toLowerCase()]=t)}(this.log_debug("registerNodeType","type registered",e),this.auto_load_slot_types)&&(this.log_debug("registerNodeType","auto_load_slot_types, create empy tmp node",e),new t(null!==(a=t.title)&&void 0!==a?a:"tmpnode").post_constructor())}},{key:"unregisterNodeType",value:function(e){var t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw new Error("node type not found to unregister: "+e);delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]}},{key:"registerNodeAndSlotType",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=(e.constructor===String&&"anonymous"!==this.registered_node_types[e]?this.registered_node_types[e]:e).constructor.type,o=[];o="string"==typeof t?t.split(","):t==this.EVENT||t==this.ACTION?["_event_"]:["*"];for(var a=0;a<o.length;++a){var r=o[a];""===r&&(r="*");var s=n?"registered_slot_out_types":"registered_slot_in_types";void 0===this[s][r]&&(this[s][r]={nodes:[]}),this[s][r].nodes.includes(i)||this[s][r].nodes.push(i),n?this.slot_types_out.includes(r.toLowerCase())||(this.slot_types_out.push(r.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(r.toLowerCase())||(this.slot_types_in.push(r.toLowerCase()),this.slot_types_in.sort())}}},{key:"buildNodeClassFromObject",value:function(e,t){var n="";if(t.inputs)for(var i=0;i<t.inputs.length;++i){var o=t.inputs[i][0],a=t.inputs[i][1];a&&a.constructor===String&&(a='"'+a+'"'),n+="this.addInput('"+o+"',"+a+");\n"}if(t.outputs)for(var r=0;r<t.outputs.length;++r){var s=t.outputs[r][0],l=t.outputs[r][1];l&&l.constructor===String&&(l='"'+l+'"'),n+="this.addOutput('"+s+"',"+l+");\n"}if(t.properties)for(var h in t.properties){var u=t.properties[h];u&&u.constructor===String&&(u='"'+u+'"'),n+="this.addProperty('"+h+"',"+u+");\n"}n+="if(this.onCreate)this.onCreate()";var c=Function(n);for(var p in t)"inputs"!=p&&"outputs"!=p&&"properties"!=p&&(c.prototype[p]=t[p]);return c.title=t.title||e.split("/").pop(),c.desc=t.desc||"Generated from object",this.registerNodeType(e,c),c}},{key:"wrapFunctionAsNode",value:function(e,t,n,i,o){var a=LiteGraph.getParameterNames(t),r=a.map((function(e,t){var i=null!=n&&n[t]?"'".concat(n[t],"'"):"0";return"this.addInput('".concat(e,"', ").concat(i,");")})).join("\n"),s=i?"'".concat(i,"'"):0,l=o?"this.properties = ".concat(JSON.stringify(o),";"):"",h=new Function("\n            ".concat(r,"\n            this.addOutput('out', ").concat(s,");\n            ").concat(l,"\n        "));return h.title=e.split("/").pop(),h.desc="Generated from ".concat(t.name),h.prototype.onExecute=function(){var e=this,n=a.map((function(t,n){return e.getInputData(n)})),i=t.apply(this,n);this.setOutputData(0,i)},this.registerNodeType(e,h),h}},{key:"wrapObjectAsNodeCollection",value:function(e,t){var n=this;if("object"===_typeof(e)){var i=Object.getOwnPropertyDescriptors(e);Object.keys(i).forEach((function(i){if(console.debug("cyclingProps",t,i,e,_typeof(e[i])),"function"==typeof e[i]){try{console.info("**",e[i].arguments)}catch(e){}n.wrapFunctionAsNode(t+"/"+i,e[i])}}))}}},{key:"clearRegisteredTypes",value:function(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}},{key:"addNodeMethod",value:function(e,t){for(var n in LGraphNode.prototype[e]=t,this.registered_node_types){var i=this.registered_node_types[n];i.prototype[e]&&(i.prototype["_"+e]=i.prototype[e]),i.prototype[e]=t}}},{key:"createNode",value:function(e,t){var n,i,o,a,r,s,l,h,u,c,p,d,_,g,v,f,y,b=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},k=null!==(n=this.registered_node_types[e])&&void 0!==n?n:null;if(!k)return this.log_debug('GraphNode type "'.concat(e,'" not registered.')),null;LiteGraph.log_verbose("createNode",e,t,b,k),t=null!==(i=null!==(o=t)&&void 0!==o?o:k.title)&&void 0!==i?i:e;var L=null;if(LiteGraph.catch_exceptions)try{L=new k(t)}catch(e){return this.log_error("createNode",e),null}else L=new k(t);return L.post_constructor(),L.size_basic=L.size,L.type=e,null!==(r=(a=L).title)&&void 0!==r||(a.title=t),null!==(l=(s=L).properties)&&void 0!==l||(s.properties={}),null!==(u=(h=L).properties_info)&&void 0!==u||(h.properties_info=[]),null!==(p=(c=L).flags)&&void 0!==p||(c.flags={}),null!==(_=(d=L).size)&&void 0!==_||(d.size=L.computeSize()),null!==(v=(g=L).pos)&&void 0!==v||(g.pos=LiteGraph.DEFAULT_POSITION.concat()),null!==(y=(f=L).mode)&&void 0!==y||(f.mode=LiteGraph.ALWAYS),Object.assign(L,b),LiteGraph.log_verbose("createNode","created",L,L.processCallbackHandlers),L.processCallbackHandlers("onNodeCreated",{def_cb:L.onNodeCreated}),L}},{key:"getNodeType",value:function(e){return this.registered_node_types[e]}},{key:"getNodeTypesInCategory",value:function(e,t){var n=Object.values(this.registered_node_types).filter((function(n){return n.filter===t&&(""===e?null===n.category:n.category===e)}));return this.auto_sort_node_types&&n.sort((function(e,t){return e.title.localeCompare(t.title)})),n}},{key:"getNodeTypesCategories",value:function(e){var t={"":1};Object.values(this.registered_node_types).forEach((function(n){n.category&&!n.skip_list&&n.filter===e&&(t[n.category]=1)}));var n=Object.keys(t);return this.auto_sort_node_types?n.sort():n}},{key:"reloadNodes",value:function(e){for(var t=document.getElementsByTagName("script"),n=[],i=0;i<t.length;i++)n.push(t[i]);var o=document.getElementsByTagName("head")[0];e=document.location.href+e;for(var a=0;a<n.length;a++){var r=n[a].src;if(r&&r.substr(0,e.length)==e)try{this.log_debug("Reloading: "+r);var s=document.createElement("script");s.type="text/javascript",s.src=r,o.appendChild(s),o.removeChild(n[a])}catch(e){if(LiteGraph.throw_errors)throw e;this.log_debug("Error while reloading "+r)}}this.log_debug("Nodes reloaded")}},{key:"parseStringifyObject",value:function(e,t){return this.cloneObject(e,t)}},{key:"cloneObject",value:function(e,t){if(null==e)return null;var n=JSON.parse(JSON.stringify(e));if(!t)return n;for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(t[i]=n[i]);return t}},{key:"uuidv4",value:function(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(function(e){return(e^16*Math.random()>>e/4).toString(16)}))}},{key:"isValidConnection",value:function(e,t){if(""!==e&&"*"!==e||(e=0),""!==t&&"*"!==t||(t=0),!e||!t||e===t||e===LiteGraph.EVENT&&t===LiteGraph.ACTION)return!0;if(e=String(e).toLowerCase(),t=String(t).toLowerCase(),!e.includes(",")&&!t.includes(","))return e===t;var n,i=e.split(","),o=t.split(","),a=_createForOfIteratorHelper(i);try{for(a.s();!(n=a.n()).done;){var r,s=n.value,l=_createForOfIteratorHelper(o);try{for(l.s();!(r=l.n()).done;){var h=r.value;if(this.isValidConnection(s,h))return!0}}catch(e){l.e(e)}finally{l.f()}}}catch(e){a.e(e)}finally{a.f()}return!1}},{key:"registerSearchboxExtra",value:function(e,t,n){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:n}}},{key:"fetchFile",value:function(e,t,n,i){var o=this;if(!e)return null;if(t=t||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then((function(e){if(!e.ok)throw new Error("File not found");return"arraybuffer"==t?e.arrayBuffer():"text"==t||"string"==t?e.text():"json"==t?e.json():"blob"==t?e.blob():void 0})).then((function(e){n&&n(e)})).catch((function(t){o.log_error("error fetching file:",e),i&&i(t)}));if(e.constructor===File||e.constructor===Blob){var a=new FileReader;if(a.onload=function(e){var i=e.target.result;"json"==t&&(i=JSON.parse(i)),n&&n(i)},"arraybuffer"==t)return a.readAsArrayBuffer(e);if("text"==t||"json"==t)return a.readAsText(e);if("blob"==t)return a.readAsBinaryString(e)}return null}},{key:"compareObjects",value:function(e,t){var n=Object.keys(e);return n.length===Object.keys(t).length&&n.every((function(n){return e[n]===t[n]}))}},{key:"distance",value:function(e,t){var n=_slicedToArray(e,2),i=n[0],o=n[1],a=_slicedToArray(t,2),r=a[0],s=a[1];return Math.sqrt(Math.pow(r-i,2)+Math.pow(s-o,2))}},{key:"colorToString",value:function(e){return"rgba("+Math.round(255*e[0]).toFixed()+","+Math.round(255*e[1]).toFixed()+","+Math.round(255*e[2]).toFixed()+","+(4==e.length?e[3].toFixed(2):"1.0")+")"}},{key:"textCalculateMaxWidth",value:function(e){}},{key:"canvasFillTextMultiline",value:function(e,t,n,i,o,a){var r=(t+"").trim().split(" "),s="",l={lines:[],maxW:0,height:0};if(r.length>1)for(var h=0;h<r.length;h++){var u=s+r[h]+" ",c=e.measureText(u).width;c>o&&h>0?(e.fillText(s,n,i+a*l.lines.length),s=r[h]+" ",l.max=c,l.lines.push(s)):s=u}else s=r[0];return e.fillText(s,n,i+a*l.lines.length),l.lines.push(s),l.height=a*l.lines.length||a,l}},{key:"isInsideRectangle",value:function(e,t,n,i,o,a){return e>n&&e<n+o&&t>i&&t<i+a}},{key:"isBoundingInsideRectangle",value:function(e,t,n,i,o){var a=e[0],r=e[1];return a>t&&a<t+i&&r>n&&r<n+o&&(a=e[0]+e[2],r=e[1]+e[3],a>t&&a<t+i&&r>n&&r<n+o)}},{key:"growBounding",value:function(e,t,n){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),n<e[1]?e[1]=n:n>e[3]&&(e[3]=n)}},{key:"isInsideBounding",value:function(e,t){return e[0]>=t[0][0]&&e[1]>=t[0][1]&&e[0]<=t[1][0]&&e[1]<=t[1][1]}},{key:"overlapBounding",value:function(e,t,n){n=n||0;var i=e[0]+e[2]+n,o=e[1]+e[3]+n,a=t[0]+t[2]+n,r=t[1]+t[3]+n;return!(e[0]>a||e[1]>r||i<t[0]||o<t[1])}},{key:"hex2num",value:function(e){"#"==e.charAt(0)&&(e=e.slice(1)),e=e.toUpperCase();for(var t,n,i="0123456789ABCDEF",o=new Array(3),a=0,r=0;r<6;r+=2)t=i.indexOf(e.charAt(r)),n=i.indexOf(e.charAt(r+1)),o[a]=16*t+n,a++;return o}},{key:"num2hex",value:function(e){for(var t,n,i="0123456789ABCDEF",o="#",a=0;a<3;a++)t=e[a]/16,n=e[a]%16,o+=i.charAt(t)+i.charAt(n);return o}},{key:"getTime",value:function(){if("undefined"!=typeof performance)return performance.now();if("undefined"==typeof Date||!Date.now){if("undefined"!=typeof process){var e=process.hrtime();return.001*e[0]+1e-6*e[1]}return(new Date).getTime()}}},{key:"formatNumber",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return NaN===(e=Number(e))?"":e.toFixed(t).replace(/(\.\d*[1-9])0+$|\.0*$/,"$1")}}])}();if("undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}),getGlobalObject(),!getGlobalVariable("LiteGraph")){setGlobalVariable("LiteGraph",new LiteGraphClass);var LGInst=getGlobalVariable("LiteGraph");LGInst.log_info("LiteGraph instantiated",LGInst.getTime())}var LiteGraph=getGlobalVariable("LiteGraph");exports.CallbackHandler=CallbackHandler,exports.ContextMenu=ContextMenu,exports.DragAndScale=DragAndScale,exports.GraphInput=GraphInput,exports.GraphOutput=GraphOutput,exports.LGraph=LGraph,exports.LGraphCanvas=LGraphCanvas,exports.LGraphGroup=LGraphGroup,exports.LGraphNode=LGraphNode,exports.LLink=LLink,exports.LiteGraph=LiteGraph,exports.NodeFunction=NodeFunction,exports.Subgraph=Subgraph,exports.getGlobalObject=getGlobalObject,exports.getGlobalVariable=getGlobalVariable,exports.setGlobalVariable=setGlobalVariable,Object.defineProperty(exports,"__esModule",{value:!0})}));
