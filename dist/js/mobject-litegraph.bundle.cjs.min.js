/**
 * MIT License
 *
 * Copyright (c) 2024 benhar-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 *
 * Third Party Licenses
 * --------------------
 *
 * MIT License
 * 
 * Copyright (C) 2013 by Javi Agenjo
 * Copyright (C) 2022 by atlasan
 * Copyright (C) 2024 by Daniel Lewis
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class LLink{constructor(e,t,i,s,n,o){this.id=e,this.type=t,this.origin_id=i,this.origin_slot=s,this.target_id=n,this.target_slot=o,this._data=null,this._pos=new Float32Array(2)}configure(e){e.constructor===Array?(this.id=e[0],this.origin_id=e[1],this.origin_slot=e[2],this.target_id=e[3],this.target_slot=e[4],this.type=e[5]):(this.id=e.id,this.type=e.type,this.origin_id=e.origin_id,this.origin_slot=e.origin_slot,this.target_id=e.target_id,this.target_slot=e.target_slot)}serialize(){return[this.id,this.origin_id,this.origin_slot,this.target_id,this.target_slot,this.type]}}class CallbackHandler{debug=!1;constructor(e){this.callbacks_handlers={},this.ob_ref=e,"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("CallbackHandler Initialize callbacks",e)}registerCallbackHandler=function(e,t,i){i&&"object"==typeof i||(i={});if(i=Object.assign({priority:0,is_default:!1,call_once:!1},i),"function"!=typeof t)return"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_error("registerCallbackHandler","Invalid callback"),!1;void 0===this.callbacks_handlers[e]&&(this.callbacks_handlers[e]={last_id:0,handlers:[]});const s=this.callbacks_handlers[e].last_id++;return"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("registerCallbackHandler","new callback handler",e,s),this.callbacks_handlers[e].handlers.push({id:s,priority:i.priority,callback:t,data:i}),this.callbacks_handlers[e].handlers.sort(((e,t)=>t.priority-e.priority)),s};unregisterCallbackHandler(e,t){if(void 0!==this.callbacks_handlers[e]){const i=this.callbacks_handlers[e].handlers.length;if(this.callbacks_handlers[e].handlers=this.callbacks_handlers[e].handlers.filter((function(i){return i.id===t&&LiteGraph.log_info("unregisterCallbackHandler",e,t),i.id!==t})),this.callbacks_handlers[e].handlers.length<i)return!0}return LiteGraph.log_warn("unregisterCallbackHandler","no handlers for",e,t),!1}processCallbackHandlers(e,t){t&&"object"==typeof t||(t={});t=Object.assign({def_cb:!1},t);var i=this;"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("**processCallbackHandlers**",...arguments),void 0===this.callbacks_handlers[e]&&(this.callbacks_handlers[e]={last_id:0,handlers:[]});var s=[].slice.call(arguments).slice(2),n=null,o=null,a=[],r={},l=!1,h=!1,p=!1,c=function(){h||"function"!=typeof t.def_cb?"function"==typeof t.def_cb&&i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","preventing default passed",t.def_cb):(i.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("Calling DEFAULT w Args",...s),n=t.def_cb.call(i.ob_ref,...s),i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","default callback executed",n),d()),l=!0},d=function(){if(a.push(n),i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stepRet check",n),"object"==typeof n){if(i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result is object",n),void 0!==n.prevent_default&&n.prevent_default&&(h=!0),void 0!==n.return_value?(i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result from object",n,r),o=n):(i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","set result, not object",n,r),o=n),void 0!==n.stop_replication&&n.stop_replication)return i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","stop_replication",r),void(p=!0)}else i.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","checkStepRet","result NOT object",n),null!=n&&(o=n)};for(let t of this.callbacks_handlers[e].handlers)if(h&&t.is_default)"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","preventing default registered",t);else{if(t.priority<0&&!l&&("object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_verbose("processCallbackHandlers","process default passed","nextCb:",t),c(),p))break;if(r={name:e,id:t.id,current_return_value:o,data:t.data,results_chain:a},n=t.callback.call(this.ob_ref,r,...s),"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","callback executed",n,r),d(),"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","result checked","cbRet",o,"aResChain",a,"cbResPriority",0,"defCbChecked",l,"preventDefCb",h,"breakCycle",p),p)break;t.data.call_once&&(this.unregisterCallbackHandler(e,t.id),"object"==typeof this&&void 0!==this.debug&&this.debug&&void 0!==LiteGraph&&LiteGraph.log_debug("processCallbackHandlers","unregistered call_once",r))}return l||c(),o}}class DragAndScale{constructor(e,t){this.offset=new Float32Array([0,0]),this.scale=1,this.max_scale=10,this.min_scale=.1,this.onredraw=null,this.enabled=!0,this.last_mouse=[0,0],this.element=null,this.visible_area=new Float32Array(4),e&&(this.element=e,t||this.bindEvents(e))}bindEvents(e){this.last_mouse=new Float32Array(2),e.addEventListener("pointerdown",this.onMouseDown),e.addEventListener("wheel",this.onWheel)}onMouseDown=e=>{if(!this.enabled)return;const t=this.element.getBoundingClientRect();var i=e.clientX-t.left,s=e.clientY-t.top;e.canvasx=i,e.canvasy=s,e.dragging=this.dragging,(!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3])&&(this.dragging=!0,this.abortController=new AbortController,document.addEventListener("pointermove",this.onMouseMove,{signal:this.abortController.signal}),document.addEventListener("pointerup",this.onMouseUp,{signal:this.abortController.signal})),this.last_mouse[0]=i,this.last_mouse[1]=s};onMouseMove=e=>{if(!this.enabled)return;const t=this.element.getBoundingClientRect();var i=e.clientX-t.left,s=e.clientY-t.top;e.canvasx=i,e.canvasy=s,e.dragging=this.dragging;var n=i-this.last_mouse[0],o=s-this.last_mouse[1];this.dragging&&this.mouseDrag(n,o),this.last_mouse[0]=i,this.last_mouse[1]=s};onMouseUp=e=>{this.dragging=!1,this.abortController?.abort()};onWheel=e=>{e.wheel=-e.deltaY,e.delta=e.wheelDelta?e.wheelDelta/40:e.deltaY?-e.deltaY/3:0,this.changeDeltaScale(1+.05*e.delta)};computeVisibleArea(e){if(!this.element)return void this.visible_area.set([0,0,0,0]);let t=this.element.width,i=this.element.height,s=-this.offset[0],n=-this.offset[1];if(e){s+=e[0]/this.scale,n+=e[1]/this.scale;const[o,a]=e.slice(2);t=o,i=a}const o=[s,n,s+t/this.scale-s,n+i/this.scale-n];return this.visible_area.set(o),o}toCanvasContext(e){e.scale(this.scale,this.scale),e.translate(this.offset[0],this.offset[1])}convertOffsetToCanvas(e){return[(e[0]+this.offset[0])*this.scale,(e[1]+this.offset[1])*this.scale]}convertCanvasToOffset(e,t=[0,0]){return t[0]=e[0]/this.scale-this.offset[0],t[1]=e[1]/this.scale-this.offset[1],t}mouseDrag(e,t){this.offset[0]+=e/this.scale,this.offset[1]+=t/this.scale,this.onredraw?.(this)}changeScale(e,t){if(LiteGraph.log_debug("dragandscale","changeScale",e,t),(e=LiteGraph.clamp(e,this.min_scale,this.max_scale))==this.scale||!this.element)return;const i=this.element.getBoundingClientRect();if(i){t=t||[.5*i.width,.5*i.height];var s=this.convertCanvasToOffset(t);LiteGraph.log_debug("dragandscale","changeScale","center",s),this.scale=e,Math.abs(this.scale-1)<.01&&(this.scale=1);var n=this.convertCanvasToOffset(t);LiteGraph.log_debug("dragandscale","changeScale","new center",n);var o=[n[0]-s[0],n[1]-s[1]];LiteGraph.log_debug("dragandscale","changeScale",e,t),this.offset[0]+=o[0],this.offset[1]+=o[1],this.onredraw?.(this)}}changeDeltaScale(e,t){this.changeScale(this.scale*e,t)}reset(){this.scale=1,this.offset[0]=0,this.offset[1]=0}}class ContextMenu{constructor(e,t={}){this.options=t,t.scroll_speed??=.1,t.filter_enabled??=!0,this.menu_elements=[],this.#e(),this.#t(),this.#i(),this.#s(),this.setTitle(this.options.title),this.addItems(e),this.#n(),this.#o(),LiteGraph.context_menu_filter_enabled&&t.filter_enabled&&this.createFilter(e,t)}#i(){const e=this.root=document.createElement("div");return this.options.className&&(e.className=this.options.className),e.classList.add("litegraph","litecontextmenu","litemenubar-panel"),e.style.minWidth="80px",e.style.minHeight="10px",e}#s(){const e=this.root;LiteGraph.log_info("**contextmenu**","binding events on root",e,this),e.style.pointerEvents="none",setTimeout((()=>{e.style.pointerEvents="auto"}),100),e.addEventListener("pointerup",(e=>(e.preventDefault(),!0))),e.addEventListener("contextmenu",(e=>(2!=e.button||e.preventDefault(),!1))),e.addEventListener("pointerdown",(e=>{if(2==e.button)return this.close(),e.preventDefault(),!0})),e.addEventListener("wheel",(t=>{var i=parseInt(e.style.top);return e.style.top=(i+t.deltaY*this.options.scroll_speed).toFixed()+"px",t.preventDefault(),!0})),e.addEventListener("pointerenter",(t=>{e.closing_timer&&clearTimeout(e.closing_timer)}))}#e(){const e=this.options.parentMenu;if(e){if(e.constructor!==this.constructor)return LiteGraph.log_error("contextmenu","linkToParent","parentMenu must be of class ContextMenu, ignoring it"),void(this.options.parentMenu=null);this.parentMenu=e,this.parentMenu.lock=!0,this.parentMenu.current_submenu=this}}#t(){if(!this.options.event)return;if(this.options.isCustomEvent)return void LiteGraph.log_verbose("contextmenu","linkToParent","Custom event for ContextMenu.",this.options.event);const e=this.options.event.constructor.name;"MouseEvent"!==e&&"CustomEvent"!==e&&"PointerEvent"!==e&&LiteGraph.log_warn(`Event passed to ContextMenu is not of type MouseEvent or CustomEvent. Was originally ignoring it. (${e})`)}createFilter(e,t){if(!e||!e.length||1==e.length)return;const i=document.createElement("input");i.classList.add("context-menu-filter"),i.placeholder="Filter list",this.root.prepend(i);const s=Array.from(this.root.querySelectorAll(".litemenu-entry"));let n=[...s],o=n.length;console.info(t),requestAnimationFrame((()=>{const a=t.extra,r=a?.widgets?.filter((t=>"combo"===t.type&&t.options.values.length===e.length)).find((t=>t.options.values.every(((t,i)=>t===e[i]))))?.value;let l=r?e.findIndex((e=>e===r)):0;l<0&&(l=0);let h=n[l];function p(){h?.style.setProperty("background-color",""),h?.style.setProperty("color",""),h=n[l],h?.style.setProperty("background-color","#ccc","important"),h?.style.setProperty("color","#000","important")}p();const c=()=>{if(this.root.getBoundingClientRect().top<0){const e=1-this.root.getBoundingClientRect().height/this.root.clientHeight,t=this.root.clientHeight*e/2;this.root.style.top=-t+"px"}};i.addEventListener("keydown",(e=>{switch(e.key){case"ArrowUp":e.preventDefault(),0===l?l=o-1:l--,p();break;case"ArrowRight":case"Enter":h?.do_click(e);break;case"ArrowDown":e.preventDefault(),l===o-1?l=0:l++,p();break;case"ArrowLeft":const t=this.parentMenu;if(this.close(e,!0),t){const e=Array.from(t.root.querySelectorAll(".context-menu-filter"));e&&e.length&&(e[0].style.display="block",e[0].focus())}break;case"Escape":this.close()}})),i.addEventListener("input",(()=>{const e=i.value.toLocaleLowerCase();if(n=s.filter((t=>{const i=!e||t.textContent.toLocaleLowerCase().includes(e);return t.style.display=i?"block":"none",i})),l=0,n.includes(h)&&(l=n.findIndex((e=>e===h))),o=n.length,p(),t.event){let e=t.event.clientY-10;const i=document.body.getBoundingClientRect(),s=this.root.getBoundingClientRect();i.height&&e>i.height-s.height-10&&(e=Math.max(0,i.height-s.height-10)),this.root.style.top=e+"px",c()}})),requestAnimationFrame((()=>{i.focus(),c()}))}))}setTitle(e){if(!e)return;this.titleElement??=document.createElement("div");const t=this.titleElement;t.className="litemenu-title",t.innerHTML=e,this.root.parentElement||this.root.appendChild(t)}addItems(e){for(let t=0;t<e.length;t++){let i=e[t];"string"!=typeof i&&(i=i&&void 0!==i.content?String(i.content):String(i));let s=e[t];this.addItem(i,s,this.options)}}#n(){const e=this.options.event?.target.ownerDocument??document,t=e.fullscreenElement??e.body;this.root,t.appendChild(this.root)}#o(){const e=this.options,t=this.root;let i=e.left||0,s=e.top||0;if(this.top_original=s,e.event){if(i=e.event.clientX-10,s=e.event.clientY-10,e.title&&(s-=20),this.top_original=s,e.parentMenu){const t=e.parentMenu.root.getBoundingClientRect();i=t.left+t.width}const n=document.body.getBoundingClientRect(),o=t.getBoundingClientRect();0===n.height&&LiteGraph.log_error("document.body height is 0. That is dangerous, set html,body { height: 100%; }"),n.width&&i>n.width-o.width-10&&(i=n.width-o.width-10),n.height&&s>n.height-o.height-10&&(s=n.height-o.height-10)}else LiteGraph.log_debug("contextmenu","calculateBestPosition","has no event");t.style.left=`${i}px`,t.style.top=`${s}px`,e.scale&&(t.style.transform=`scale(${e.scale})`)}addItem(e,t,i={}){LiteGraph.log_verbose("contextmenu","addItem",...arguments);const s=document.createElement("div");s.className="litemenu-entry submenu";let n=!1;var o=s;if(null===t)s.classList.add("separator");else if(s.innerHTML=t?.title??e,s.value=t,t&&(t.disabled&&(n=!0,s.classList.add("disabled")),(t.submenu||t.has_submenu)&&s.classList.add("has_submenu")),"function"==typeof t?(s.dataset.value=e,s.onclick_callback=t):s.dataset.value=t,t.className&&(s.className+=" "+t.className),void 0!==t.callbacks_on_element_created){"function"==typeof t.callbacks_on_element_created&&(t.callbacks_on_element_created=[t.callbacks_on_element_created]);var a=this;t.callbacks_on_element_created.forEach((e=>{"function"==typeof e&&(LiteGraph.log_debug("contextmenu","addItem","callbacks_on_element_created",s,e),e(s,a))}))}this.root.appendChild(s),n||(s.addEventListener("click",l),s.do_click=function(e,t){e?e.clientX?LiteGraph.log_verbose("contextmenu","addItem","do_click","has clientX",e):LiteGraph.log_warn("contextmenu","addItem","do_click","event has no clientX info",e):LiteGraph.log_warn("contextmenu","addItem","do_click","has no event",...arguments),l.call(o,e,t)}),!n&&i.autoopen&&s.addEventListener("pointerenter",(e=>{const t=this.value;t&&t.has_submenu&&l.call(this,e)}));var r=this;function l(e){const t=this.value;let s=!0;LiteGraph.log_debug("contextmenu","handleMenuItemClick","process",t,e,i,s,this.current_submenu,this),r.current_submenu?.close(e);const n=Array.from(r.root.querySelectorAll(".context-menu-filter"));if(n&&n.length&&(n[0].style.display="none"),i.callback){LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback",this,t,i,e,r,i.node);const n=i.callback.call(this,t,i,e,r,i.node);!0===n?(LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, dont close parent?",n),s=!1):LiteGraph.log_debug("contextmenu","handleMenuItemClick","global callback processed, will close parent",n)}if(t){if(t.callback&&!i.ignore_item_callbacks&&!0!==t.disabled){LiteGraph.log_debug("contextmenu","handleMenuItemClick","using value callback and !ignore_item_callbacks",this,t,i,e,r,i.node);!0===t.callback.call(this,t,i,e,r,i.extra)&&(s=!1)}if(t.submenu){if(LiteGraph.log_debug("contextmenu","handleMenuItemClick","SUBMENU",this,t,t.submenu.options,e,r,i),!t.submenu.options)return void LiteGraph.log_warn("contextmenu","handleMenuItemClick","SUBMENU","submenu needs options");new r.constructor(t.submenu.options,{callback:t.submenu.callback,event:e,parentMenu:r,ignore_item_callbacks:t.submenu.ignore_item_callbacks,title:t.submenu.title,extra:t.submenu.extra,autoopen:i.autoopen}),s=!1}}s&&!r.lock&&r.close()}return this.menu_elements.push(s),s}close(e,t){this.parentMenu&&!t&&(this.parentMenu.lock=!1,this.parentMenu.current_submenu=null,void 0===e?this.parentMenu.close():e&&!ContextMenu.isCursorOverElement(e,this.parentMenu.root)&&ContextMenu.trigger(this.parentMenu.root,"pointerleave",e)),this.current_submenu?.close(e,!0),this.root.closing_timer&&clearTimeout(this.root.closing_timer),this.root.parentNode&&this.root.parentNode.removeChild(this.root)}static closeAll=(e=window)=>{const t=e?.document?.querySelectorAll(".litecontextmenu");t&&t.length&&t.forEach((e=>{e.close?e.close():e.parentNode?.removeChild(e)}))};static trigger(e,t,i,s){const n=new CustomEvent(t,{bubbles:!0,cancelable:!0,detail:i});return Object.defineProperty(n,"target",{value:s}),e.dispatchEvent?e.dispatchEvent(n):e.__events&&e.__events.dispatchEvent(n),n}getTopMenu(){return this.options.parentMenu?.getTopMenu()??this}getFirstEvent(){return this.options.parentMenu?.getFirstEvent()??this.options.event}static isCursorOverElement(e,t){return LiteGraph.isInsideRectangle(e.clientX,e.clientY,t.left,t.top,t.width,t.height)}}class LGraphCanvas{constructor(e,t,i){i??={skip_render:!1,autoresize:!1,clip_all_nodes:!1,free_resize:!0,groups_alpha:.21,groups_border_alpha:.45,groups_triangle_handler_size:15,groups_title_font:"Arial",groups_title_alignment:"left",groups_title_font_size:24,groups_title_wrap:!0,groups_add_around_selected:!0,groups_add_default_spacing:15,hide_widget_label_when_small:150},this.options=i,this.callbackhandler_setup(),this.background_image=LGraphCanvas.DEFAULT_BACKGROUND_IMAGE,e&&e.constructor===String&&(e=document.querySelector(e)),this.ds=new DragAndScale,this.zoom_modify_alpha=!0,this.title_text_font=`${LiteGraph.NODE_TEXT_SIZE}px Arial`,this.inner_text_font=`normal ${LiteGraph.NODE_SUBTEXT_SIZE}px Arial`,this.node_title_color=LiteGraph.NODE_TITLE_COLOR,this.default_link_color=LiteGraph.LINK_COLOR,this.default_connection_color={input_off:"#778",input_on:"#7F7",output_off:"#778",output_on:"#7F7"},this.default_connection_color_byType={},this.default_connection_color_byTypeOff={},this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.highquality_render=!0,this.use_gradients=!1,this.editor_alpha=1,this.pause_rendering=!1,this.clear_background=!0,this.clear_background_color="#222",this.read_only=!1,this.live_mode=!1,this.show_info=!0,this.allow_dragcanvas=!0,this.allow_dragnodes=!0,this.allow_interaction=!0,this.multi_select=!1,this.allow_searchbox=!0,this.move_destination_link_without_shift=!1,this.align_to_grid=!1,this.drag_mode=!1,this.dragging_rectangle=null,this.filter=null,this.set_canvas_dirty_on_mouse_event=!0,this.always_render_background=!1,this.render_shadows=!0,this.render_canvas_border=!0,this.render_connections_shadows=!1,this.render_connections_border=!0,this.render_curved_connections=!0,this.render_connection_arrows=!1,this.render_collapsed_slots=!0,this.render_execution_order=!1,this.render_title_colored=!0,this.render_link_tooltip=!0,this.links_render_mode=LiteGraph.SPLINE_LINK,this.autoresize=i.autoresize,this.skip_render=i.skip_render,this.clip_all_nodes=i.clip_all_nodes,this.free_resize=i.free_resize,this.mouse=[0,0],this.graph_mouse=[0,0],this.canvas_mouse=this.graph_mouse,this.onSearchBox=null,this.onSearchBoxSelection=null,this.onMouse=null,this.onDrawBackground=null,this.onDrawForeground=null,this.onDrawOverlay=null,this.onDrawLinkTooltip=null,this.onNodeMoved=null,this.onSelectionChange=null,this.onConnectingChange=null,this.onBeforeChange=null,this.onAfterChange=null,this.connections_width=3,this.round_radius=8,this.current_node=null,this.node_widget=null,this.over_widget=null,this.over_node=null,this.over_link_center=null,this.last_mouse_position=[0,0],this.visible_area=this.ds.visible_area,this.visible_links=[],this.viewport=i.viewport||null,this.low_quality_rendering_threshold=5,t?.attachCanvas(this),this.setCanvas(e,i.skip_events),this.clear(),this.skip_render||i.skip_render||this.startRendering(),this.callbackhandler_setup(),LiteGraph.processCallbackHandlers("on_lgraphcanvas_construct",{def_cb:LiteGraph.on_lgraphcanvas_construct},this)}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler.processCallbackHandlers(...arguments)}clear(){this.frame=0,this.last_draw_time=0,this.render_time=0,this.fps=0,this.low_quality_rendering_counter=0,this.dragging_rectangle=null,this.selected_nodes={},this.selected_group=null,this.visible_nodes=[],this.node_dragged=null,this.node_over=null,this.node_capturing_input=null,this.connecting_node=null,this.connecting=!1,this.highlighted_links={},this.dragging_canvas=!1,this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.dirty_area=null,this.node_in_panel=null,this.node_widget=null,this.last_mouse=[0,0],this.last_mouseclick=0,this.pointer_is_down=!1,this.pointer_is_double=!1,this.visible_area.set([0,0,0,0]),this.processCallbackHandlers("onClear",{def_cb:this.onClear})}setGraph(e,t){this.graph!=e&&(t||this.clear(),e?(e.attachCanvas(this),LiteGraph.log_debug("lgraphcanvas","setGraph",e,this),this._graph_stack&&=null,this.setDirty(!0,!0)):this.graph?.detachCanvas(this))}getTopGraph(){return this._graph_stack.length?this._graph_stack[0]:this.graph}openSubgraph(e){if(!e)throw new Error("graph cannot be null");if(this.graph==e)throw new Error("graph cannot be the same");this.clear(),this.graph&&(this._graph_stack||=[],this._graph_stack.push(this.graph));var t=this.graph;this.processCallbackHandlers("onOpenSubgraph",{def_cb:this.onOpenSubgraph},e,t),e.attachCanvas(this),this.checkPanels(),this.setDirty(!0,!0)}closeSubgraph(){if(this._graph_stack&&0!=this._graph_stack.length){var e=this.graph._subgraph_node,t=this.graph,i=this._graph_stack.pop();this.selected_nodes={},this.highlighted_links={},this.processCallbackHandlers("onCloseSubgraph",{def_cb:this.onCloseSubgraph},i,t,e),i.attachCanvas(this),this.setDirty(!0,!0),e&&(this.centerOnNode(e),this.selectNodes([e])),this.ds.offset=[0,0],this.ds.scale=1}}getCurrentGraph(){return this.graph}setCanvas(e,t){if(e&&e.constructor===String&&!(e=document.getElementById(e)))throw new Error("Error creating LiteGraph canvas: Canvas not found");if(e!==this.canvas&&(!e&&this.canvas&&(t||this.unbindEvents()),this.canvas=e,this.ds.element=e,e)){if(e.className+=" lgraphcanvas",e.data=this,e.tabindex="1",this.bgcanvas=document.createElement("canvas"),this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,null==e.getContext){if("canvas"!=e.localName)throw new Error("Element supplied for LGraphCanvas must be a <canvas> element, you passed a "+e.localName);throw new Error("This browser doesn't support Canvas")}null==(this.ctx=e.getContext("2d"))&&(e.webgl_enabled||LiteGraph.log_info("This canvas seems to be WebGL, enabling WebGL renderer"),this.enableWebGL()),t||this.bindEvents()}}_doNothing(e){return LiteGraph.log_verbose("pointerevents: _doNothing "+e.type),e.preventDefault(),!1}_doReturnTrue(e){return e.preventDefault(),!0}bindEvents(){if(this._events_binded)LiteGraph.log_warn("LGraphCanvas: events already binded");else{this._events_binded=!0;var e=this.canvas,t=this.getCanvasWindow().document;LiteGraph.log_info("[lgraphcanvas]","BINDing events",e,t),this._mousedown_callback=this.processMouseDown.bind(this),this._mousemove_callback=this.processMouseMove.bind(this),this._mouseup_callback=this.processMouseUp.bind(this),e.addEventListener("pointerdown",this._mousedown_callback),e.addEventListener("pointermove",this._mousemove_callback),e.addEventListener("pointerup",this._mouseup_callback),e.addEventListener("contextmenu",this._doNothing),e.addEventListener("wheel",this.processMouseWheel),e.addEventListener("keydown",this.processKey),t.addEventListener("keyup",this.processKey),e.addEventListener("dragover",this._doNothing,!1),e.addEventListener("dragend",this._doNothing,!1),e.addEventListener("drop",this.processDrop),e.addEventListener("dragenter",this._doReturnTrue,!1)}}unbindEvents(){if(this._events_binded){this._events_binded=!1;var e=this.canvas,t=this.getCanvasWindow().document;LiteGraph.log_info("[lgraphcanvas]","UNbinding events",e,t),e.removeEventListener("pointerdown",this._mousedown_callback),e.removeEventListener("pointermove",this._mousemove_callback),e.removeEventListener("pointerup",this._mouseup_callback),e.removeEventListener("contextmenu",this._doNothing),e.removeEventListener("wheel",this.processMouseWheel),e.removeEventListener("keydown",this.processKey),t.removeEventListener("keyup",this.processKey),e.removeEventListener("dragover",this._doNothing,!1),e.removeEventListener("dragend",this._doNothing,!1),e.removeEventListener("drop",this.processDrop),e.removeEventListener("dragenter",this._doReturnTrue,!1),this._mousedown_callback=null}else LiteGraph.log_warn("LGraphCanvas: no events binded")}static getFileExtension(e){return(e=e?e+"":"").slice(2+(e.lastIndexOf(".")-1>>>0)).toLowerCase()}enableWebGL(){if("undefined"==typeof GL)throw new Error("litegl.js must be included to use a WebGL canvas");if("undefined"==typeof enableWebGLCanvas)throw new Error("webglCanvas.js must be included to use this feature");this.gl=this.ctx=enableWebGLCanvas(this.canvas),this.ctx.webgl=!0,this.bgcanvas=this.canvas,this.bgctx=this.gl,this.canvas.webgl_enabled=!0}setDirty(e,t){e&&(this.dirty_canvas=!0),t&&(this.dirty_bgcanvas=!0)}getCanvasWindow(){if(!this.canvas)return window;var e=this.canvas.ownerDocument;return e.defaultView??e.parentWindow}startRendering(){this.is_rendering||(this.is_rendering=!0,function e(){this.pause_rendering||this.draw();var t=this.getCanvasWindow();this.is_rendering&&t.requestAnimationFrame(e.bind(this))}.call(this))}stopRendering(){this.is_rendering=!1}blockClick(){this.block_click=!0,this.last_mouseclick=0}processUserInputDown(e){if(this.pointer_is_down&&void 0!==e.isPrimary&&!e.isPrimary?this.userInput_isNotPrimary=!0:this.userInput_isNotPrimary=!1,this.userInput_type=!!e.pointerType&&e.pointerType,this.userInput_id=!!e.pointerId&&e.pointerId,e.pointerType)switch(e.pointerType){case"mouse":case"pen":case"touch":break;default:LiteGraph.log_debug("pointerType unknown "+ev.pointerType)}return void 0!==e.button&&(this.userInput_button=e.button,LiteGraph.log_verbose("input button ",e.button),e.button),void 0!==e.buttons&&(this.userInput_button_s=e.buttons,LiteGraph.log_verbose("input button_S ",e.buttons)),this.userInput_touches=void 0!==e.changedTouches&&void 0!==e.changedTouches.length&&e.changedTouches,this.userInput_touches&&this.userInput_touches.length&&LiteGraph.log_debug("check multiTouches",e.changedTouches),this.processMouseDown(e)}processMouseDown(e){if(this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){this.adjustMouseEvent(e);var t=this.getCanvasWindow();LGraphCanvas.active_canvas=this;var i=e.clientX,s=e.clientY;LiteGraph.log_debug("lgraphcanvas","processMouseDown","pointerId:"+e.pointerId+" which:"+e.which+" isPrimary:"+e.isPrimary+" :: x y "+i+" "+s,"previousClick",this.last_mouseclick,"diffTimeClick",this.last_mouseclick?LiteGraph.getTime()-this.last_mouseclick:"notlast"),LiteGraph.log_verbose("coordinates",i,s,this.viewport,"canvas coordinates",e.canvasX,e.canvasY),this.ds.viewport=this.viewport;var n=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(this.options.skip_events||(this.canvas.removeEventListener("pointermove",this._mousemove_callback),t.document.addEventListener("pointermove",this._mousemove_callback,!0),t.document.addEventListener("pointerup",this._mouseup_callback,!0)),n){var o=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes,5),a=!1,r=LiteGraph.getTime(),l=void 0===e.isPrimary||e.isPrimary,h=r-this.last_mouseclick<300&&l;this.mouse[0]=e.clientX,this.mouse[1]=e.clientY,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.last_click_position=[this.mouse[0],this.mouse[1]],this.pointer_is_down&&l?(this.pointer_is_double=!0,LiteGraph.log_verbose("pointerevents: pointer_is_double start")):this.pointer_is_double=!1,this.pointer_is_down=!0,this.canvas.focus(),LiteGraph.ContextMenuClass.closeAll(t);var p=this.processCallbackHandlers("onClear",{def_cb:this.onMouse},e);if(null==p||!1!==p&&("object"!=typeof p||!1!==p.return_value)){if(1!=e.which||this.userInput_isNotPrimary)if(2==e.which)if(LiteGraph.middle_click_slot_add_default_node){if(o&&this.allow_interaction&&!a&&!this.read_only&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode){var c=!1,d=!1,u=!1;if(o.outputs)for(let t=0,i=o.outputs.length;t<i;++t){var g=o.outputs[t];let i=o.getConnectionPos(!1,t);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,i[0]-15,i[1]-10,30,20)){c=g,d=t,u=!0;break}}if(o.inputs)for(let t=0,i=o.inputs.length;t<i;++t){let i=o.inputs[t],s=o.getConnectionPos(!0,t);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,s[0]-15,s[1]-10,30,20)){c=i,d=t,u=!1;break}}if(LiteGraph.log_verbose("middleClickSlots? "+c+" & "+(!1!==d)),c&&!1!==d){var _=.5-(d+1)/(u?o.outputs.length:o.inputs.length),v=o.getBounding(),f=[u?v[0]+v[2]:v[0],e.canvasY-80];this.createDefaultNodeForSlot({nodeFrom:u?o:null,slotFrom:u?d:null,nodeTo:u?null:o,slotTo:u?null:d,position:f,nodeType:"AUTO",posAdd:[u?30:-30,130*-_],posSizeFix:[u?0:-1,0]})}}}else!a&&this.allow_dragcanvas&&(LiteGraph.log_verbose("pointerevents: dragging_canvas start from middle button"),this.dragging_canvas=!0);else(3==e.which||LiteGraph.two_fingers_opens_menu&&this.userInput_isNotPrimary)&&(!this.allow_interaction||a||this.read_only||(o&&(Object.keys(this.selected_nodes).length&&(this.selected_nodes[o.id]||e.shiftKey||e.ctrlKey||e.metaKey)?this.selected_nodes[o.id]||this.selectNodes([o],!0):this.selectNodes([o])),this.processContextMenu(o,e)));else{if(e.ctrlKey&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","starting box selection"),this.dragging_rectangle=new Float32Array(4),this.dragging_rectangle[0]=e.canvasX,this.dragging_rectangle[1]=e.canvasY,this.dragging_rectangle[2]=1,this.dragging_rectangle[3]=1,a=!0),LiteGraph.alt_drag_do_clone_nodes&&e.altKey&&o&&this.allow_interaction&&!a&&!this.read_only){LiteGraph.log_debug("lgraphcanvas","processMouseDown","cloning node");let t=o,i=o.clone();if(i){if(i.pos[0]+=5,i.pos[1]+=5,this.graph.add(i,!1,{doCalcSize:!1}),o=i,LiteGraph.alt_shift_drag_connect_clone_with_input&&e.shiftKey&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","altCloned",t,o),t.inputs&&t.inputs.length))for(var b=0;b<t.inputs.length;++b){var y=t.inputs[b];if(y&&null!=y.link){var L=this.graph.links[y.link];if(L)if(L.type!==LiteGraph.EVENT){var m;L.origin_id&&(m=this.graph.getNodeById(L.origin_id));var G=o;m&&G&&(LiteGraph.log_verbose("lgraphcanvas","processMouseDown","alt drag cloning","connect newly created",m,G,L),m.connect(L.origin_slot,G,L.target_slot))}else LiteGraph.log_info("lgraphcanvas","processMouseDown","alt drag cloning","skip moving events",y);else LiteGraph.log_warn("lgraphcanvas","processMouseDown","not graph link info for input",y,t)}}a=!0,I||(this.allow_dragnodes&&(this.graph.beforeChange(),this.node_dragged=o),this.selected_nodes[o.id]||this.processNodeSelected(o,e))}}var C=!1;if(!o||!this.allow_interaction&&!o.flags.allow_interaction||a||this.read_only){if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked outside nodes"),!a){if(!this.read_only)for(let t=0;t<this.visible_links.length;++t){var k=this.visible_links[t],w=k._pos;if(!(!w||e.canvasX<w[0]-4||e.canvasX>w[0]+4||e.canvasY<w[1]-4||e.canvasY>w[1]+4)){LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on link",k),this.showLinkMenu(k,e),this.over_link_center=null;break}}if(this.selected_group=this.graph.getGroupOnPos(e.canvasX,e.canvasY),this.selected_group_resizing=!1,this.selected_group&&!this.read_only)LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on group",k),e.ctrlKey&&(this.dragging_rectangle=null),LiteGraph.distance([e.canvasX,e.canvasY],[this.selected_group.pos[0]+this.selected_group.size[0],this.selected_group.pos[1]+this.selected_group.size[1]])*this.ds.scale<this.options.groups_triangle_handler_size?this.selected_group_resizing=!0:this.selected_group.recomputeInsideNodes();h&&!this.read_only&&this.allow_searchbox&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","showing search box"),this.showSearchBox(e),e.preventDefault(),e.stopPropagation()),LiteGraph.log_debug("DEBUG canvas click is_double_click,this.allow_searchbox",h,this.allow_searchbox),C=!0}}else{if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicking on node"),this.live_mode||o.flags.pinned||this.bringToFront(o),this.allow_interaction&&!this.connecting_node&&!o.flags.collapsed&&!this.live_mode)if(!a&&!1!==o.resizable&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,o.pos[0]+o.size[0]-9,o.pos[1]+o.size[1]-9,18,18))LiteGraph.log_debug("lgraphcanvas","processMouseDown","start resizing node"),this.graph.beforeChange(),this.resizing_node=o,this.canvas.style.cursor="se-resize",a=!0;else{if(o.outputs)for(let t=0,i=o.outputs.length;t<i;++t){let i=o.outputs[t],s=o.getConnectionPos(!1,t);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,s[0]-15,s[1]-10,30,20)){if(this.connecting_node=o,this.connecting_output=i,this.connecting_output.slot_index=t,this.connecting_pos=o.getConnectionPos(!1,t),this.connecting_slot=t,LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on output slot",o,i),LiteGraph.shift_click_do_break_link_from)e.shiftKey&&o.disconnectOutput(t);else if(e.shiftKey){LiteGraph.log_debug("lgraphcanvas","processMouseDown","will move link source slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos);var E=[],T=[],O=[],N=[];if(null!==i.links&&i.links.length)for(let e in i.links){let t=!1,s=this.graph.links[i.links[e]];s&&this.graph._nodes_by_id[s.target_id]&&(t=this.graph._nodes_by_id[s.target_id],t&&(E.push(s),T.push(t),O.push(s.target_slot),N.push({node:t,slot:s.target_slot,link:s})))}if(E.length){o.disconnectOutput(t),this.connecting_output=!1,this.connecting={inputs:N},LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving links source slot",this.connecting);let e=E[0];this.connecting_node=this.graph._nodes_by_id[e.target_id],this.connecting_slot=e.target_slot,this.connecting_input=this.connecting_node.inputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!0,this.connecting_slot),this.dirty_bgcanvas=!0,a=!0}}h?o.processCallbackHandlers("onOutputDblClick",{def_cb:o.onOutputDblClick},t,e):o.processCallbackHandlers("onOutputClick",{def_cb:o.onOutputClick},t,e),a=!0;break}}if(o.inputs)for(let t=0,i=o.inputs.length;t<i;++t){let i=o.inputs[t],s=o.getConnectionPos(!0,t);if(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,s[0]-15,s[1]-10,30,20)){if(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on input slot",o,i),h?o.processCallbackHandlers("onInputDblClick",{def_cb:o.onInputDblClick},t,e):o.processCallbackHandlers("onInputClick",{def_cb:o.onInputDblClick},t,e),null!==i.link){var S=this.graph.links[i.link];LiteGraph.click_do_break_link_to&&(o.disconnectInput(t),this.dirty_bgcanvas=!0,a=!0),e.shiftKey&&(LiteGraph.click_do_break_link_to||o.disconnectInput(t),this.connecting_node=this.graph._nodes_by_id[S.origin_id],this.connecting_slot=S.origin_slot,this.connecting_output=this.connecting_node.outputs[this.connecting_slot],this.connecting_pos=this.connecting_node.getConnectionPos(!1,this.connecting_slot),LiteGraph.log_debug("lgraphcanvas","processMouseDown","moving link destination slot",this.connecting_node,this.connecting_slot,this.connecting_output,this.connecting_pos),this.dirty_bgcanvas=!0,a=!0)}a||(this.connecting_node=o,this.connecting_input=i,this.connecting_input.slot_index=t,this.connecting_pos=o.getConnectionPos(!0,t),this.connecting_slot=t,this.dirty_bgcanvas=!0,a=!0)}}}if(!a){LiteGraph.log_debug("lgraphcanvas","processMouseDown","check clicked on node",o);var I=!1,A=[e.canvasX-o.pos[0],e.canvasY-o.pos[1]],x=this.processNodeWidgets(o,this.graph_mouse,e);x&&(I=!0,this.node_widget=[o,x]);let t=null;this.allow_interaction&&h&&this.selected_nodes[o.id]&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","double clicked on node",o),t=o.processCallbackHandlers("onDblClick",{def_cb:o.onDblClick},e,A,this),null!==t&&(!0===t||"object"==typeof t&&t.return_value)?LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onDblClick",t):this.processNodeDblClicked(o),I=!0),t=o.processCallbackHandlers("onMouseDown",{def_cb:o.onMouseDown},e,A,this),null!==t&&(!0===t||"object"==typeof t&&t.return_value)?(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging blocked by onMouseDownCbRet",t),I=!0):(o.subgraph&&!o.skip_subgraph_button&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","clicked on subgraph"),!o.flags.collapsed&&A[0]>o.size[0]-LiteGraph.NODE_TITLE_HEIGHT&&A[1]<0&&setTimeout((()=>{this.openSubgraph(o.subgraph)}),10)),this.live_mode&&(C=!0,I=!0)),I?o.is_selected||(LiteGraph.log_debug("lgraphcanvas","processMouseDown","node selected",o),this.processNodeSelected(o,e)):(this.allow_dragnodes&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","started dragging",o),this.graph.beforeChange(),this.node_dragged=o),this.processNodeSelected(o,e)),this.dirty_canvas=!0}}!a&&C&&this.allow_dragcanvas&&(LiteGraph.log_debug("lgraphcanvas","processMouseDown","dragging_canvas start"),this.dragging_canvas=!0)}return this.last_mouse[0]=e.clientX,this.last_mouse[1]=e.clientY,this.last_mouseclick=LiteGraph.getTime(),this.last_mouse_dragging=!0,this.graph.change(),(!t.document.activeElement||"input"!=t.document.activeElement.nodeName.toLowerCase()&&"textarea"!=t.document.activeElement.nodeName.toLowerCase())&&e.preventDefault(),e.stopPropagation(),this.processCallbackHandlers("onMouseDown",{def_cb:this.onMouseDown},e),!1}LiteGraph.log_info("lgraphcanvas","processMouseDown","callback prevents continue")}}}processMouseMove(e){if(this.autoresize&&this.resize(),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){LGraphCanvas.active_canvas=this,this.adjustMouseEvent(e);var t=[e.clientX,e.clientY];this.mouse[0]=t[0],this.mouse[1]=t[1];var i=[t[0]-this.last_mouse[0],t[1]-this.last_mouse[1]];if(this.last_mouse=t,this.graph_mouse[0]=e.canvasX,this.graph_mouse[1]=e.canvasY,this.block_click)return LiteGraph.log_verbose("lgraphcanvas","processMouseMove","block_click"),e.preventDefault(),!1;this.over_widget=!1,e.dragging=this.last_mouse_dragging,this.node_widget&&(this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.dirty_canvas=!0);var s=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.over_node=s,this.dragging_rectangle)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","making rectangle"),this.dragging_rectangle[2]=e.canvasX-this.dragging_rectangle[0],this.dragging_rectangle[3]=e.canvasY-this.dragging_rectangle[1],this.dirty_canvas=!0;else if(this.selected_group&&!this.read_only){if(this.selected_group_resizing)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","resizing group"),this.selected_group.size=[e.canvasX-this.selected_group.pos[0],e.canvasY-this.selected_group.pos[1]];else{LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging group");var n=i[0]/this.ds.scale,o=i[1]/this.ds.scale;this.selected_group.move(n,o,e.ctrlKey),this.selected_group._nodes.length&&(this.dirty_canvas=!0),(n||o)&&this.processCallbackHandlers("onGroupMoving",{def_cb:this.onGroupMoving},this.selected_group,n,o)}this.dirty_bgcanvas=!0}else if(this.dragging_canvas)LiteGraph.log_verbose("lgraphcanvas","processMouseMove","dragging_canvas"),this.ds.offset[0]+=i[0]/this.ds.scale,this.ds.offset[1]+=i[1]/this.ds.scale,this.dirty_canvas=!0,this.dirty_bgcanvas=!0;else if((this.allow_interaction||s&&s.flags.allow_interaction)&&!this.read_only){this.connecting_node&&(this.dirty_canvas=!0);for(let t=0,i=this.graph._nodes.length;t<i;++t)this.graph._nodes[t].mouseOver&&s!=this.graph._nodes[t]&&(this.graph._nodes[t].mouseOver=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseLeave",{def_cb:this.node_over.onMouseLeave},e),this.node_over=null,this.dirty_canvas=!0);if(s){s.redraw_on_mouse&&(this.dirty_canvas=!0),s.mouseOver||(s.mouseOver=!0,this.node_over=s,this.dirty_canvas=!0,s.processCallbackHandlers("onMouseEnter",{def_cb:s.onMouseEnter},e)),s.processCallbackHandlers("onMouseMove",{def_cb:s.onMouseMove},e,[e.canvasX-s.pos[0],e.canvasY-s.pos[1]],this);var a=this.processNodeWidgets(s,this.graph_mouse);if(a&&(this.over_widget=a),this.connecting_node){let t;if(this.connecting_output){if(t=this._highlight_input||[0,0],!this.isOverNodeBox(s,e.canvasX,e.canvasY)){let i=this.isOverNodeInput(s,e.canvasX,e.canvasY,t);if(-1!=i&&s.inputs[i]){let e=s.inputs[i].type;LiteGraph.isValidConnection(this.connecting_output.type,e)&&(this._highlight_input=t,this._highlight_input_slot=s.inputs[i])}else this._highlight_input=null,this._highlight_input_slot=null}}else if(this.connecting_input&&(t=this._highlight_output||[0,0],this.isOverNodeBox(s,e.canvasX,e.canvasY))){let i=this.isOverNodeOutput(s,e.canvasX,e.canvasY,t);if(-1!=i&&s.outputs[i]){let e=s.outputs[i].type;LiteGraph.isValidConnection(this.connecting_input.type,e)&&(this._highlight_output=t)}else this._highlight_output=null}}this.canvas&&(LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,s.pos[0]+s.size[0]-5,s.pos[1]+s.size[1]-5,5,5)?this.canvas.style.cursor="se-resize":this.canvas.style.cursor="crosshair")}else{var r=null;for(let t=0;t<this.visible_links.length;++t){var l=this.visible_links[t],h=l._pos;if(!(!h||e.canvasX<h[0]-4||e.canvasX>h[0]+4||e.canvasY<h[1]-4||e.canvasY>h[1]+4)){r=l;break}}r!=this.over_link_center&&(this.over_link_center=r,this.dirty_canvas=!0),this.canvas&&(this.canvas.style.cursor="")}if(this.node_capturing_input&&this.node_capturing_input!=s&&this.node_capturing_input.processCallbackHandlers("onMouseMove",{def_cb:this.node_capturing_input.onMouseMove},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]],this),this.node_dragged&&!this.live_mode){LiteGraph.log_verbose("lgraphcanvas","processMouseMove","draggin!",this.selected_nodes);for(let t in this.selected_nodes){let s=this.selected_nodes[t],n=[i[0]/this.ds.scale,i[1]/this.ds.scale];s.pos[0]+=n[0],s.pos[1]+=n[1],s.is_selected||this.processNodeSelected(s,e),s.processCallbackHandlers("onDrag",{def_cb:s.onDrag},n)}this.dirty_canvas=!0,this.dirty_bgcanvas=!0}if(this.resizing_node&&!this.live_mode){var p=[e.canvasX-this.resizing_node.pos[0],e.canvasY-this.resizing_node.pos[1]],c=this.free_resize?LiteGraph.NODE_MIN_SIZE:this.resizing_node.computeSize();p[0]=Math.max(c[0],p[0]),p[1]=Math.max(c[1],p[1]),this.resizing_node.setSize(p),this.canvas.style.cursor="se-resize",this.dirty_canvas=!0,this.dirty_bgcanvas=!0}}else this.read_only?LiteGraph.log_verbose("lgraphcanvas","processMouseMove","canvas is read only",this):LiteGraph.log_verbose("lgraphcanvas","processMouseMove","interaction not allowed (nor canvas and node)",this.allow_interaction,s.flags);return e.preventDefault(),!1}LiteGraph.log_warn("lgraphcanvas","processMouseMove","no canvas ref")}processMouseUp(e){var t=void 0===e.isPrimary||e.isPrimary;if(!t)return LiteGraph.log_verbose("pointerevents: processMouseUp pointerN_stop "+e.pointerId+" "+e.isPrimary),!1;if(LiteGraph.log_verbose("pointerevents: processMouseUp "+e.pointerId+" "+e.isPrimary+" :: "+e.clientX+" "+e.clientY),this.set_canvas_dirty_on_mouse_event&&(this.dirty_canvas=!0),this.graph){var i=this.getCanvasWindow().document;LGraphCanvas.active_canvas=this,this.options.skip_events||(LiteGraph.log_verbose("pointerevents: processMouseUp restoreEventListener"),i.removeEventListener("pointermove",this._mousemove_callback,!0),this.canvas.addEventListener("pointermove",this._mousemove_callback),i.removeEventListener("pointerup",this._mouseup_callback,!0)),this.adjustMouseEvent(e);var s=LiteGraph.getTime();if(e.click_time=s-this.last_mouseclick,this.last_mouse_dragging=!1,this.last_click_position=null,this.block_click&&(LiteGraph.log_verbose("pointerevents: processMouseUp block_clicks"),this.block_click=!1),LiteGraph.log_debug("pointerevents: processMouseUp which: "+e.which),1==e.which){if(this.node_widget&&this.processNodeWidgets(this.node_widget[0],this.graph_mouse,e,this.node_widget[1]),this.node_widget=null,this.selected_group){var n=this.selected_group.pos[0]-Math.round(this.selected_group.pos[0]),o=this.selected_group.pos[1]-Math.round(this.selected_group.pos[1]);this.selected_group.move(n,o,e.ctrlKey),this.selected_group.pos[0]=Math.round(this.selected_group.pos[0]),this.selected_group.pos[1]=Math.round(this.selected_group.pos[1]),this.selected_group._nodes.length&&(this.dirty_canvas=!0),this.selected_group.recomputeInsideNodes(),this.selected_group_resizing?(this.processCallbackHandlers("onGroupResized",{def_cb:this.onGroupResized},this.selected_group),this.graph.onGraphChanged({action:"groupResize",doSave:!0}),this.graph.afterChange()):(n||o)&&(this.processCallbackHandlers("onGroupMoved",{def_cb:this.onGroupMoved},this.selected_group),this.graph.onGraphChanged({action:"groupMove",doSave:!0}),this.graph.afterChange()),this.selected_group=null}this.selected_group_resizing=!1;var a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes);if(this.dragging_rectangle){if(this.graph){var r=this.graph._nodes,l=new Float32Array(4),h=Math.abs(this.dragging_rectangle[2]),p=Math.abs(this.dragging_rectangle[3]),c=this.dragging_rectangle[2]<0?this.dragging_rectangle[0]-h:this.dragging_rectangle[0],d=this.dragging_rectangle[3]<0?this.dragging_rectangle[1]-p:this.dragging_rectangle[1];if(this.dragging_rectangle[0]=c,this.dragging_rectangle[1]=d,this.dragging_rectangle[2]=h,this.dragging_rectangle[3]=p,!a||h>10&&p>10){LiteGraph.log_debug("lgraphcanvas","processMouseUp","computing box selection for nodes",this.dragging_rectangle);var u=[];for(let e=0;e<r.length;++e){var g=r[e];g.getBounding(l),LiteGraph.overlapBounding(this.dragging_rectangle,l)&&u.push(g)}u.length&&(LiteGraph.log_debug("lgraphcanvas","processMouseUp","selecting nodes",u),this.selectNodes(u,e.shiftKey))}else this.selectNodes([a],e.shiftKey||e.ctrlKey)}this.dragging_rectangle=null}else if(this.connecting_node){this.dirty_canvas=!0,this.dirty_bgcanvas=!0;var _=(this.connecting_output||this.connecting_input).type;if(a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes)){let t;if(this.connecting_output)LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_output",this.connecting_output,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),t=this.isOverNodeInput(a,e.canvasX,e.canvasY),-1!=t?this.connecting_node.connect(this.connecting_slot,a,t):this.connecting_node.connectByType(this.connecting_slot,a,_);else if(this.connecting_input)if(LiteGraph.log_debug("lgraphcanvas","processMouseUp","connecting_input",this.connecting_input,"connecting_node",this.connecting_node,"connecting_slot",this.connecting_slot),t=this.isOverNodeOutput(a,e.canvasX,e.canvasY),-1!=t)if(this.connecting&&this.connecting.inputs)for(let e in this.connecting.inputs)a.connect(t,this.connecting.inputs[e].node,this.connecting.inputs[e].slot);else a.connect(t,this.connecting_node,this.connecting_slot);else this.connecting_node.connectByTypeOutput(this.connecting_slot,a,_)}else LiteGraph.release_link_on_empty_shows_menu&&(e.shiftKey&&this.allow_searchbox?this.connecting_output?this.showSearchBox(e,{node_from:this.connecting_node,slot_from:this.connecting_output,type_filter_in:this.connecting_output.type}):this.connecting_input&&this.showSearchBox(e,{node_to:this.connecting_node,slot_from:this.connecting_input,type_filter_out:this.connecting_input.type}):this.connecting_output?this.showConnectionMenu({nodeFrom:this.connecting_node,slotFrom:this.connecting_output,e:e}):this.connecting_input&&this.showConnectionMenu({nodeTo:this.connecting_node,slotTo:this.connecting_input,e:e}));this.connecting_output=null,this.connecting_input=null,this.connecting_pos=null,this.connecting_node=null,this.connecting_slot=-1,this.connecting=!1}else if(this.resizing_node)this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.graph.afterChange(this.resizing_node),this.resizing_node=null;else if(this.node_dragged){(a=this.node_dragged)&&e.click_time<300&&LiteGraph.isInsideRectangle(e.canvasX,e.canvasY,a.pos[0],a.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT)&&a.collapse(),this.dirty_canvas=!0,this.dirty_bgcanvas=!0,this.node_dragged.pos[0]=Math.round(this.node_dragged.pos[0]),this.node_dragged.pos[1]=Math.round(this.node_dragged.pos[1]),(this.graph.config.align_to_grid||this.align_to_grid)&&this.node_dragged.alignToGrid(),this.processCallbackHandlers("onNodeMoved",{def_cb:this.onNodeMoved},this.node_dragged,this.selected_nodes);for(let e in this.selected_nodes){let t=this.selected_nodes[e];t.processCallbackHandlers("onMoved",{def_cb:t.onMoved},this.node_dragged,this.selected_nodes)}this.graph.onGraphChanged({action:"nodeDrag",doSave:!0}),this.graph.afterChange(this.node_dragged),this.node_dragged=null}else!(a=this.graph.getNodeOnPos(e.canvasX,e.canvasY,this.visible_nodes))&&e.click_time<300&&this.deselectAllNodes(),this.dirty_canvas=!0,this.dragging_canvas=!1,this.node_over&&this.node_over.processCallbackHandlers("onMouseUp",{def_cb:this.node_over.onMouseUp},e,[e.canvasX-this.node_over.pos[0],e.canvasY-this.node_over.pos[1]],this),this.node_capturing_input&&this.node_capturing_input.processCallbackHandlers("onMouseUp",{def_cb:this.node_capturing_input.onMouseUp},e,[e.canvasX-this.node_capturing_input.pos[0],e.canvasY-this.node_capturing_input.pos[1]])}else(2==e.which||3==e.which)&&(this.dirty_canvas=!0,this.dragging_canvas=!1);return t&&(this.pointer_is_down=!1,this.pointer_is_double=!1),this.graph.change(),LiteGraph.log_verbose("pointerevents: processMouseUp stopPropagation"),e.stopPropagation(),e.preventDefault(),!1}LiteGraph.log_warn("lgraphcanvas","processMouseUp","has not graph",this)}processMouseWheel=e=>{if(this.graph&&this.allow_dragcanvas){var t=null!=e.wheelDeltaY?e.wheelDeltaY:-60*e.detail;this.adjustMouseEvent(e);var i=e.clientX,s=e.clientY;if(!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]){var n=this.ds.scale;t>0?n*=1.1:t<0&&(n*=1/1.1);var o=e.target.getBoundingClientRect();return this.setZoom(n,[e.clientX-o.left,e.clientY-o.top]),this.graph.change(),e.preventDefault(),!1}}};isOverNodeBox(e,t,i){var s=LiteGraph.NODE_TITLE_HEIGHT;return!!LiteGraph.isInsideRectangle(t,i,e.pos[0]+2,e.pos[1]+2-s,s-4,s-4)}isOverNodeInput(e,t,i,s){if(e.inputs)for(let o=0,a=e.inputs.length;o<a;++o){var n=e.getConnectionPos(!0,o);if(e.horizontal?LiteGraph.isInsideRectangle(t,i,n[0]-5,n[1]-10,10,20):LiteGraph.isInsideRectangle(t,i,n[0]-10,n[1]-5,40,10))return s&&(s[0]=n[0],s[1]=n[1]),o}return-1}isOverNodeOutput(e,t,i,s){if(e.outputs)for(let o=0,a=e.outputs.length;o<a;++o){var n=e.getConnectionPos(!1,o);if(e.horizontal?LiteGraph.isInsideRectangle(t,i,n[0]-5,n[1]-10,10,20):LiteGraph.isInsideRectangle(t,i,n[0]-10,n[1]-5,40,10))return s&&(s[0]=n[0],s[1]=n[1]),o}return-1}processKey=e=>{if(!this.graph)return;var t=!1;let i=null;if(LiteGraph.log_verbose("lgraphcanvas","processKey",e),"input"!=e.target.localName){if("keydown"==e.type){if(32==e.keyCode&&(this.dragging_canvas=!0,t=!0),27==e.keyCode&&(this.node_panel&&this.node_panel.close(),t=!0),65==e.keyCode&&e.ctrlKey&&(this.selectNodes(),t=!0),67!==e.keyCode||!e.metaKey&&!e.ctrlKey||e.shiftKey||this.selected_nodes&&(this.copyToClipboard(),t=!0),86===e.keyCode&&(e.metaKey||e.ctrlKey)&&this.pasteFromClipboard(e.shiftKey),(46==e.keyCode||LiteGraph.backspace_delete&&8==e.keyCode)&&"input"!=e.target.localName&&"textarea"!=e.target.localName&&(this.deleteSelectedNodes(),t=!0),LiteGraph.actionHistory_enabled&&(89==e.keyCode&&e.ctrlKey||90==e.keyCode&&e.ctrlKey&&e.shiftKey?this.graph.actionHistoryForward():90==e.keyCode&&e.ctrlKey&&this.graph.actionHistoryBack()),Object.keys(this.selected_nodes).length)for(let s in this.selected_nodes)i=this.selected_nodes[s].processCallbackHandlers("onKeyDown",{def_cb:this.selected_nodes[s].onKeyDown},e),null!==i&&(!0===i||"object"==typeof i&&!0===i.return_value)&&(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),t=!0);i=this.processCallbackHandlers("onKeyDown",{def_cb:this.onKeyDown},e),null!==i&&(!0===i||"object"==typeof i&&!0===i.return_value)?(LiteGraph.log_debug("lgraphcanvas","processKey","onKeyDown has been processed with result true, prevent event bubbling"),t=!0):LiteGraph.log_verbose("lgraphcanvas","processKey","onKeyDown processed by CB handlers",i)}else if("keyup"==e.type&&(32==e.keyCode&&(this.dragging_canvas=!1),this.selected_nodes))for(let t in this.selected_nodes)this.selected_nodes[t].processCallbackHandlers("onKeyUp",{def_cb:this.selected_nodes[t].onKeyUp},e);return this.graph.change(),t?(e.preventDefault(),e.stopImmediatePropagation(),!1):void 0}};copyToClipboard(){var e={nodes:[],links:[]},t=0,i=[];for(let e in this.selected_nodes){let s=this.selected_nodes[e];!1!==s.clonable&&(s._relative_id=t,i.push(s),t+=1)}for(let t=0;t<i.length;++t){let l=i[t];if(!1!==l.clonable){var s=l.clone();if(s){if(e.nodes.push(s.serialize()),l.inputs&&l.inputs.length)for(var n=0;n<l.inputs.length;++n){var o=l.inputs[n];if(o&&null!=o.link){var a=this.graph.links[o.link];if(a){var r=this.graph.getNodeById(a.origin_id);r&&e.links.push([r._relative_id,a.origin_slot,l._relative_id,a.target_slot,r.id])}}}}else LiteGraph.log_warn("node type not found: "+l.type)}}LiteGraph.log_verbose("copyToClipboard",e),localStorage.setItem("litegrapheditor_clipboard",JSON.stringify(e))}pasteFromClipboard(e=!1){if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs||!e){var t=localStorage.getItem("litegrapheditor_clipboard");if(t){this.graph.beforeChange();var i=JSON.parse(t),s=!1,n=!1;for(let e=0;e<i.nodes.length;++e)s?(s[0]>i.nodes[e].pos[0]&&(s[0]=i.nodes[e].pos[0],n[0]=e),s[1]>i.nodes[e].pos[1]&&(s[1]=i.nodes[e].pos[1],n[1]=e)):(s=[i.nodes[e].pos[0],i.nodes[e].pos[1]],n=[e,e]);var o=[];for(let e=0;e<i.nodes.length;++e){var a=i.nodes[e],r=LiteGraph.createNode(a.type);r&&(r.configure(a),r.pos[0]+=this.graph_mouse[0]-s[0],r.pos[1]+=this.graph_mouse[1]-s[1],this.graph.add(r,{doProcessChange:!1}),o.push(r))}for(let t=0;t<i.links.length;++t){var l=i.links[t],h=void 0,p=l[0];if(null!=p)h=o[p];else if(LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs&&e){var c=l[4];c&&(h=this.graph.getNodeById(c))}var d=o[l[2]];h&&d?h.connect(l[1],d,l[3]):LiteGraph.log_warn("Warning, nodes missing on pasting")}this.selectNodes(o),this.graph.onGraphChanged({action:"paste",doSave:!0}),this.graph.afterChange()}}}processDrop=e=>{e.preventDefault(),this.adjustMouseEvent(e);let t=null;var i=e.clientX,s=e.clientY,n=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3];if(n){if(i=e.localX,s=e.localY,n=!this.viewport||this.viewport&&i>=this.viewport[0]&&i<this.viewport[0]+this.viewport[2]&&s>=this.viewport[1]&&s<this.viewport[1]+this.viewport[3]){var o=[e.canvasX,e.canvasY],a=this.graph?this.graph.getNodeOnPos(o[0],o[1]):null;if(LiteGraph.log_verbose("graphcanvas processDrop","going to process",o,a),a){var r=e.dataTransfer.files;if(r&&r.length)for(let i=0;i<r.length;i++){var l=e.dataTransfer.files[0],h=l.name;if(LiteGraph.log_debug("lgraphcanvas","processDrop","file on node",l),t=a.processCallbackHandlers("onDropFile",{def_cb:a.onDropFile},l),!t||"object"==typeof t&&!t.return_value){var p=new FileReader;p.onload=function(e){var t=e.target.result;LiteGraph.log_debug("lgraphcanvas","processDrop","data on node",t,h,l),a.processCallbackHandlers("onDropData",{def_cb:a.onDropData},t,h,l)};var c=l.type.split("/")[0];"text"==c||""==c?p.readAsText(l):"image"==c?p.readAsDataURL(l):p.readAsArrayBuffer(l)}}return t=a.processCallbackHandlers("onDropItem",{def_cb:a.onDropItem},e),null!=t&&(!0===t||"object"==typeof t&&t.return_value)?!0:(t=this.processCallbackHandlers("onDropItem",{def_cb:this.onDropItem},e),!(null==t||!(!0===t||"object"==typeof t&&t.return_value))||(LiteGraph.log_info("lgraphcanvas","processDrop","neither node and canvas has processed the drop"),!1))}return LiteGraph.log_verbose("lgraphcanvas","processDrop","look for drop implemetation in CANVAS",e),t=this.processCallbackHandlers("onDropItem",{def_cb:this.onDropItem},e),null===t||!t||"object"==typeof t&&!t.return_value?(LiteGraph.log_verbose("lgraphcanvas","processDrop","running default implementation",e),this.checkDropItem(e),null===t?t:"object"==typeof t?t.return_value:t):t}LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (local)",i,s)}else LiteGraph.log_debug("graphcanvas processDrop","Outside viewport (client)",i,s)};checkDropItem(e){if(e.dataTransfer.files.length){var t=e.dataTransfer.files[0],i=LGraphCanvas.getFileExtension(t.name),s=LiteGraph.node_types_by_file_extension[i];if(s){this.graph.beforeChange();var n=LiteGraph.createNode(s.type);if(!n)return void console.log(s.type,"is not available to handle",i);n.pos=[e.canvasX,e.canvasY],this.graph.add(n,!1,{doProcessChange:!0}),n.processCallbackHandlers("onDropFile",{def_cb:n.onDropFile},t,s.widgetName||null),this.graph.onGraphChanged({action:"fileDrop",doSave:!0}),this.graph.afterChange()}}}processNodeDblClicked(e){let t=this.processCallbackHandlers("onShowNodePanel",{def_cb:this.onShowNodePanel},e);null!==t&&("object"!=typeof t||null!==t.return_value&&t.return_value)||this.showShowNodePanel(e),this.processCallbackHandlers("onNodeDblClicked",{def_cb:this.onNodeDblClicked},e),this.setDirty(!0)}processNodeSelected(e,t){this.selectNode(e,t&&(t.shiftKey||t.ctrlKey||this.multi_select)),this.processCallbackHandlers("onNodeSelected",{def_cb:this.onNodeSelected},e)}selectNode(e,t){null==e?this.deselectAllNodes():this.selectNodes([e],t)}selectNodes(e,t){t||this.deselectAllNodes(),"string"==typeof(e=e||this.graph._nodes)?e=[e]:Array.isArray(e)||"object"!=typeof e||(e=Object.values(e)),Object.values(e).forEach((e=>{e.is_selected?this.deselectNode(e):(e.is_selected=!0,this.selected_nodes[e.id]=e,e.processCallbackHandlers("onSelected",{def_cb:e.onSelected}),e.inputs?.forEach((e=>{this.highlighted_links[e.link]=!0})),e.outputs?.forEach((e=>{e.links?.forEach((e=>{this.highlighted_links[e]=!0}))})))})),this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0)}deselectNode(e){e.is_selected&&(e.processCallbackHandlers("onDeselected",{def_cb:e.onDeselected}),e.is_selected=!1,this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},e),e.inputs?.forEach((e=>{delete this.highlighted_links?.[e.link]})),e.outputs?.forEach((e=>{e.links?.forEach((e=>delete this.highlighted_links?.[e]))})))}deselectAllNodes(){this.graph&&(this.graph._nodes?.forEach((e=>{e.is_selected&&(e.processCallbackHandlers("onDeselected",{def_cb:e.onDeselected}),e.is_selected=!1,this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},e))})),this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.processCallbackHandlers("onSelectionChange",{def_cb:this.onSelectionChange},this.selected_nodes),this.setDirty(!0))}deleteSelectedNodes(){this.graph.beforeChange();for(let o in this.selected_nodes){var e=this.selected_nodes[o];if(!e.block_delete){if(e.inputs&&e.inputs.length&&e.outputs&&e.outputs.length&&LiteGraph.isValidConnection(e.inputs[0].type,e.outputs[0].type)&&e.inputs[0].link&&e.outputs[0].links&&e.outputs[0].links.length){var t=e.graph.links[e.inputs[0].link],i=e.graph.links[e.outputs[0].links[0]],s=e.getInputNode(0),n=e.getOutputNodes(0)[0];s&&n&&s.connect(t.origin_slot,n,i.target_slot)}this.graph.remove(e),this.processCallbackHandlers("onNodeDeselected",{def_cb:this.onNodeDeselected},e)}}this.selected_nodes={},this.current_node=null,this.highlighted_links={},this.setDirty(!0),this.graph.afterChange()}centerOnNode(e){this.ds.offset[0]=-e.pos[0]-.5*e.size[0]+.5*this.canvas.width/this.ds.scale,this.ds.offset[1]=-e.pos[1]-.5*e.size[1]+.5*this.canvas.height/this.ds.scale,this.setDirty(!0,!0)}recenter(){this.ds.offset[0]=0,this.ds.offset[1]=0,this.setDirty(!0,!0)}getMouseCoordinates(){return this.graph_mouse}adjustMouseEvent(e){let t=0,i=0,s=0,n=0;if(e.clientX)i=e.clientX,n=e.clientY;else{const t=this.getMouseCoordinates(),s=this.convertOffsetToEditorArea(t);try{e.clientX=s[0],e.clientY=s[1]}catch(t){LiteGraph.log_debug("lgraphcanvas","adjustMouseEvent","failed set custom prop on event",e)}i=s[0],n=s[1]}if(this.canvas){var o=this.canvas.getBoundingClientRect();t=i-o.left,s=n-o.top}else t=i,s=n;this.last_mouse_position[0]=t,this.last_mouse_position[1]=s,e.canvasX=t/this.ds.scale-this.ds.offset[0],e.canvasY=s/this.ds.scale-this.ds.offset[1]}setZoom(e,t){this.ds.changeScale(e,t),this.dirty_canvas=!0,this.dirty_bgcanvas=!0}convertOffsetToCanvas(e,t){return this.ds.convertOffsetToCanvas(e,t)}convertCanvasToOffset(e,t){return this.ds.convertCanvasToOffset(e,t)}convertOffsetToEditorArea(e){const t=this.canvas.getBoundingClientRect(),i=this.convertOffsetToCanvas(e);return[i[0]+t.left,i[1]+t.top]}convertEventToCanvasOffset(e){const t=this.canvas.getBoundingClientRect();return this.convertCanvasToOffset([e.clientX-t.left,e.clientY-t.top])}cumulativeOffset(e){var t=0,i=0;do{t+=e.offsetTop||0,i+=e.offsetLeft||0,e=e.offsetParent}while(e);return[i,t]}bringToFront(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.push(e))}sendToBack(e){var t=this.graph._nodes.indexOf(e);-1!=t&&(this.graph._nodes.splice(t,1),this.graph._nodes.unshift(e))}computeVisibleNodes(e,t){var i=t||[];i.length=0;for(var s=0,n=(e=e||this.graph._nodes).length;s<n;++s){var o=e[s];(!this.live_mode||o.onDrawBackground||o.onDrawForeground)&&(LiteGraph.overlapBounding(this.visible_area,o.getBounding(temp,!0))&&i.push(o))}return i}draw(e,t){if(this.canvas&&0!=this.canvas.width&&0!=this.canvas.height){var i=LiteGraph.getTime();this.render_time=.001*(i-this.last_draw_time),this.last_draw_time=i,this.graph&&this.ds.computeVisibleArea(this.viewport),(this.dirty_bgcanvas||t||this.always_render_background||this.graph&&this.graph._last_trigger_time&&i-this.graph._last_trigger_time<1e3)&&this.drawBackCanvas();var s=this.dirty_canvas||e;if(s&&this.drawFrontCanvas(),this.fps=this.render_time?1/this.render_time:0,this.frame+=1,this.ds.scale<.7){if(s){var n=this.low_quality_rendering_threshold;const e=45;this.fps<e?(this.low_quality_rendering_counter+=e/this.fps,this.low_quality_rendering_counter=Math.min(this.low_quality_rendering_counter,2*n)):(this.low_quality_rendering_counter-=this.fps/e*.01,this.low_quality_rendering_counter=Math.max(this.low_quality_rendering_counter,0))}}else this.low_quality_rendering_counter=0}}drawFrontCanvas(){this.dirty_canvas=!1,this.ctx||(this.ctx=this.bgcanvas.getContext("2d"));var e=this.ctx;if(e){var t=this.canvas;e.start2D&&!this.viewport&&(e.start2D(),e.restore(),e.setTransform(1,0,0,1,0,0));var i=this.viewport||this.dirty_area;if(i&&(e.save(),e.beginPath(),e.rect(i[0],i[1],i[2],i[3]),e.clip()),this.clear_background&&(i?e.clearRect(i[0],i[1],i[2],i[3]):e.clearRect(0,0,t.width,t.height)),this.bgcanvas==this.canvas?this.drawBackCanvas():e.drawImage(this.bgcanvas,0,0),this.processCallbackHandlers("onRender",{def_cb:this.onRender},t,e),this.show_info&&this.renderInfo(e,i?i[0]:0,i?i[1]:0),this.graph){e.save(),this.ds.toCanvasContext(e);var s=this.computeVisibleNodes(null,this.visible_nodes);for(let t=0;t<s.length;++t){let i=s[t];e.save(),e.translate(i.pos[0],i.pos[1]),this.drawNode(i,e),e.restore()}if(this.render_execution_order&&this.drawExecutionOrder(e),this.graph.config.links_ontop&&(this.live_mode||this.drawConnections(e)),null!=this.connecting_pos){e.lineWidth=this.connections_width;var n=null,o=this.connecting_output||this.connecting_input,a=o.type,r=o.dir;null==r&&(r=this.connecting_output?this.connecting_node.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT:this.connecting_node.horizontal?LiteGraph.UP:LiteGraph.LEFT);var l=o.shape;switch(a){case LiteGraph.EVENT:case LiteGraph.ACTION:n=LiteGraph.EVENT_LINK_COLOR;break;default:n=LiteGraph.CONNECTING_LINK_COLOR}if(this.renderLink(e,this.connecting_pos,[this.graph_mouse[0],this.graph_mouse[1]],null,!1,null,n,r,LiteGraph.CENTER),e.beginPath(),a===LiteGraph.EVENT||a===LiteGraph.ACTION||l===LiteGraph.BOX_SHAPE?(e.rect(this.connecting_pos[0]-6+.5,this.connecting_pos[1]-5+.5,14,10),e.fill(),e.beginPath(),e.rect(this.graph_mouse[0]-6+.5,this.graph_mouse[1]-5+.5,14,10)):l===LiteGraph.ARROW_SHAPE?(e.moveTo(this.connecting_pos[0]+8,this.connecting_pos[1]+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]+6+.5),e.lineTo(this.connecting_pos[0]-4,this.connecting_pos[1]-6+.5),e.closePath()):(e.arc(this.connecting_pos[0],this.connecting_pos[1],4,0,2*Math.PI),e.fill(),e.beginPath(),e.arc(this.graph_mouse[0],this.graph_mouse[1],4,0,2*Math.PI)),e.fill(),e.fillStyle="#ffcc00",this._highlight_input){e.beginPath();var h=this._highlight_input_slot.shape;h===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_input[0]+8,this._highlight_input[1]+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]+6+.5),e.lineTo(this._highlight_input[0]-4,this._highlight_input[1]-6+.5),e.closePath()):e.arc(this._highlight_input[0],this._highlight_input[1],6,0,2*Math.PI),e.fill()}this._highlight_output&&(e.beginPath(),h===LiteGraph.ARROW_SHAPE?(e.moveTo(this._highlight_output[0]+8,this._highlight_output[1]+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]+6+.5),e.lineTo(this._highlight_output[0]-4,this._highlight_output[1]-6+.5),e.closePath()):e.arc(this._highlight_output[0],this._highlight_output[1],6,0,2*Math.PI),e.fill())}this.dragging_rectangle&&(e.strokeStyle="#FFF",e.strokeRect(this.dragging_rectangle[0],this.dragging_rectangle[1],this.dragging_rectangle[2],this.dragging_rectangle[3])),this.over_link_center&&this.render_link_tooltip?this.drawLinkTooltip(e,this.over_link_center):this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},e,null),this.processCallbackHandlers("onDrawForeground",{def_cb:this.onDrawForeground},e,this.visible_rect),e.restore()}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no graph",this);this._graph_stack&&this._graph_stack.length&&this.drawSubgraphPanel(e),this.processCallbackHandlers("onDrawOverlay",{def_cb:this.onDrawOverlay},e),i&&e.restore(),e.finish2D?.()}else LiteGraph.log_warn("lgraphcanvas","drawFrontCanvas","no ctx",this)}drawSubgraphPanel(e){var t=this.graph;if(t){var i=t._subgraph_node;i?(this.drawSubgraphPanelLeft(t,i,e),this.drawSubgraphPanelRight(t,i,e)):LiteGraph.log_warn("subgraph without subnode")}}drawSubgraphPanelLeft(e,t,i){var s=t.inputs?t.inputs.length:0,n=200,o=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);if(i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(10,10,n,(s+1)*o+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left",i.fillText("Graph Inputs",20,34),this.drawButton(180,20,20,20,"X","#151515"))this.closeSubgraph();else{var a=50;if(i.font="14px Arial",t.inputs)for(var r=0;r<t.inputs.length;++r){var l=t.inputs[r];if(!l.not_subgraph_input){if(this.drawButton(20,a+2,180,o-2)){var h=t.constructor.input_node_type||"graph/input";this.graph.beforeChange();var p=LiteGraph.createNode(h);p?(e.add(p,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([p]),this.node_dragged=p,this.dragging_canvas=!1,p.setProperty("name",l.name),p.setProperty("type",l.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",h)}i.fillStyle="#9C9",i.beginPath(),i.arc(184,a+.5*o,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(l.name,30,a+.75*o),i.fillStyle="#777",i.fillText(l.type,130,a+.75*o),a+=o}}this.drawButton(20,a+2,180,o-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialog(t)}}drawSubgraphPanelRight(e,t,i){var s=t.outputs?t.outputs.length:0,n=this.bgcanvas.width,o=200,a=Math.floor(1.6*LiteGraph.NODE_SLOT_HEIGHT);i.fillStyle="#111",i.globalAlpha=.8,i.beginPath(),i.roundRect(n-o-10,10,o,(s+1)*a+50,[8]),i.fill(),i.globalAlpha=1,i.fillStyle="#888",i.font="14px Arial",i.textAlign="left";const r="Graph Outputs";var l=i.measureText(r).width;if(i.fillText(r,n-l-20,34),this.drawButton(n-o,20,20,20,"X","#151515"))this.closeSubgraph();else{var h=50;if(i.font="14px Arial",t.outputs)for(var p=0;p<t.outputs.length;++p){var c=t.outputs[p];if(!c.not_subgraph_input){if(this.drawButton(n-o,h+2,180,a-2)){var d=t.constructor.output_node_type||"graph/output";this.graph.beforeChange();var u=LiteGraph.createNode(d);u?(e.add(u,!1,{doProcessChange:!1}),this.block_click=!1,this.last_click_position=null,this.selectNodes([u]),this.node_dragged=u,this.dragging_canvas=!1,u.setProperty("name",c.name),u.setProperty("type",c.type),this.node_dragged.pos[0]=this.graph_mouse[0]-5,this.node_dragged.pos[1]=this.graph_mouse[1]-5,this.graph.afterChange()):LiteGraph.log_error("graph input node not found:",d)}i.fillStyle="#9C9",i.beginPath(),i.arc(n-o+16,h+.5*a,5,0,2*Math.PI),i.fill(),i.fillStyle="#AAA",i.fillText(c.name,n-o+30,h+.75*a),i.fillStyle="#777",i.fillText(c.type,n-o+130,h+.75*a),h+=a}}this.drawButton(n-o,h+2,180,a-2,"+","#151515","#222")&&this.showSubgraphPropertiesDialogRight(t)}}drawButton(e,t,i,s,n,o,a,r){var l=this.ctx;o=o||LiteGraph.NODE_DEFAULT_COLOR,a=a||"#555",r=r||LiteGraph.NODE_TEXT_COLOR;var h=this.ds.convertOffsetToCanvas(this.graph_mouse),p=LiteGraph.isInsideRectangle(h[0],h[1],e,t,i,s);if(h=this.last_click_position?[this.last_click_position[0],this.last_click_position[1]]:null){var c=this.canvas.getBoundingClientRect();h[0]-=c.left,h[1]-=c.top}var d=h&&LiteGraph.isInsideRectangle(h[0],h[1],e,t,i,s);l.fillStyle=p?a:o,d&&(l.fillStyle="#AAA"),l.beginPath(),l.roundRect(e,t,i,s,[4]),l.fill(),null!=n&&n.constructor==String&&(l.fillStyle=r,l.textAlign="center",l.font=(.65*s|0)+"px Arial",l.fillText(n,e+.5*i,t+.75*s),l.textAlign="left");var u=d&&!this.block_click;return d&&this.blockClick(),u}isAreaClicked(e,t,i,s,n){var o=this.last_click_position,a=o&&LiteGraph.isInsideRectangle(o[0],o[1],e,t,i,s),r=a&&!this.block_click;return a&&n&&this.blockClick(),r}renderInfo(e,t,i){t=t||10,i=i||this.canvas.height-80,e.save(),e.translate(t,i),e.font="10px Arial",e.fillStyle="#888",e.textAlign="left",this.graph?(e.fillText("T: "+this.graph.globaltime.toFixed(2)+"s",5,13),e.fillText("I: "+this.graph.iteration,5,26),e.fillText("N: "+this.graph._nodes.length+" ["+this.visible_nodes.length+"]",5,39),e.fillText("V: "+this.graph._version,5,52),e.fillText("FPS:"+this.fps.toFixed(2),5,65)):e.fillText("No graph selected",5,13),e.restore()}drawBackCanvas(){var e=this.bgcanvas;this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.bgctx||(this.bgctx=this.bgcanvas.getContext("2d"));var t=this.bgctx;t.start&&t.start();var i=this.viewport||[0,0,t.canvas.width,t.canvas.height];if(this.clear_background&&t.clearRect(i[0],i[1],i[2],i[3]),this._graph_stack&&this._graph_stack.length){t.save();var s=this.graph._subgraph_node;t.strokeStyle=s.bgcolor,t.lineWidth=10,t.strokeRect(1,1,e.width-2,e.height-2),t.lineWidth=1,t.font="40px Arial",t.textAlign="center",t.fillStyle=s.bgcolor||"#AAA";let i="";this._graph_stack.slice(1).forEach(((e,t)=>{i+=`${e._subgraph_node.getTitle()} ${t<this._graph_stack.length-2?">> ":""}`})),t.fillText(i+s.getTitle(),.5*e.width,40),t.restore()}var n=!1;let o=this.processCallbackHandlers("onRenderBackground",{def_cb:this.onRenderBackground},e,t);if(null!==o&&(!0===o||"object"==typeof o&&!0===o.return_value)&&(n=!0),this.viewport||(t.restore(),t.setTransform(1,0,0,1,0,0)),this.visible_links.length=0,this.graph){if(t.save(),this.ds.toCanvasContext(t),this.ds.scale<1.5&&!n&&this.clear_background_color&&(t.fillStyle=this.clear_background_color,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3])),this.background_image&&this.ds.scale>.5&&!n){if(this.zoom_modify_alpha?t.globalAlpha=(1-.5/this.ds.scale)*this.editor_alpha:t.globalAlpha=this.editor_alpha,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!1,!this._bg_img||this._bg_img.name!=this.background_image){this._bg_img=new Image,this._bg_img.name=this.background_image,this._bg_img.src=this.background_image;var a=this;this._bg_img.onload=function(){a.draw(!0,!0)}}var r=null;null==this._pattern&&this._bg_img.width>0?(r=t.createPattern(this._bg_img,"repeat"),this._pattern_img=this._bg_img,this._pattern=r):r=this._pattern,r&&(t.fillStyle=r,t.fillRect(this.visible_area[0],this.visible_area[1],this.visible_area[2],this.visible_area[3]),t.fillStyle="transparent"),t.globalAlpha=1,t.imageSmoothingEnabled=t.imageSmoothingEnabled=!0}this.graph._groups.length&&!this.live_mode&&this.drawGroups(e,t),this.processCallbackHandlers("onDrawBackground",{def_cb:this.onDrawBackground},t,this.visible_area),this.onBackgroundRender&&(LiteGraph.log_error("WARNING! onBackgroundRender deprecated, now is named onDrawBackground "),this.onBackgroundRender=null),this.render_canvas_border&&(t.strokeStyle="#235",t.strokeRect(0,0,e.width,e.height)),this.render_connections_shadows?(t.shadowColor="#000",t.shadowOffsetX=0,t.shadowOffsetY=0,t.shadowBlur=6):t.shadowColor="rgba(0,0,0,0)",this.live_mode||this.drawConnections(t),t.shadowColor="rgba(0,0,0,0)",t.restore()}t.finish?.(),this.dirty_bgcanvas=!1,this.dirty_canvas=!0}drawNode(e,t){this.current_node=e;var i=e.color||e.constructor.color||LiteGraph.NODE_DEFAULT_COLOR,s=e.bgcolor||e.constructor.bgcolor||LiteGraph.NODE_DEFAULT_BGCOLOR,n=this.ds.scale<.6;if(this.live_mode)e.flags.collapsed||(t.shadowColor="transparent",e.processCallbackHandlers("onDrawForeground",{def_cb:e.onDrawForeground},t,this,this.canvas));else{var o=this.editor_alpha;if(t.globalAlpha=o,this.render_shadows&&!n?(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR,t.shadowOffsetX=2*this.ds.scale,t.shadowOffsetY=2*this.ds.scale,t.shadowBlur=3*this.ds.scale):t.shadowColor="transparent",e.flags.collapsed){let i=e.processCallbackHandlers("onDrawCollapsed",{def_cb:e.onDrawCollapsed},t,this);if(null!==i&&(!0===i||"object"==typeof i&&!0===i.return_value))return}var a=e._shape||LiteGraph.BOX_SHAPE,r=temp_vec2;temp_vec2.set(e.size);var l=e.horizontal;if(e.flags.collapsed){t.font=this.title_text_font;var h=e.getTitle?e.getTitle():e.title;null!=h&&(e._collapsed_width=Math.min(e.size[0],t.measureText(h).width+2*LiteGraph.NODE_TITLE_HEIGHT),r[0]=e._collapsed_width,r[1]=0)}(e.clip_area||this.clip_all_nodes)&&(t.save(),t.beginPath(),a==LiteGraph.BOX_SHAPE?t.rect(0,0,r[0],r[1]):a==LiteGraph.ROUND_SHAPE?t.roundRect(0,0,r[0],r[1],[10]):a==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*r[0],.5*r[1],.5*r[0],0,2*Math.PI),t.clip()),e.has_errors&&(s="red"),this.drawNodeShape(e,t,r,i,s,e.is_selected,e.mouseOver),t.shadowColor="transparent",e.processCallbackHandlers("onDrawForeground",{def_cb:e.onDrawForeground},t,this,this.canvas),LiteGraph.show_node_tooltip&&e.mouseOver&&e.is_selected&&(!this.selected_nodes||Object.keys(this.selected_nodes).length<=1)&&this.drawNodeTooltip(t,e),t.textAlign=l?"center":"left",t.font=this.inner_text_font;var p=!this.lowQualityRenderingRequired(.6),c=this.connecting_output,d=this.connecting_input;t.lineWidth=1;var u,g=0,_=new Float32Array(2);if(e.flags.collapsed){if(this.render_collapsed_slots){var v=null,f=null;if(e.inputs)for(let t=0;t<e.inputs.length;t++){var b=e.inputs[t];if(null!=b.link){v=b;break}}if(e.outputs)for(let t=0;t<e.outputs.length;t++){var y=e.outputs[t];y.links&&y.links.length&&(f=y)}if(v){let i=0,s=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(i=.5*e._collapsed_width,s=-LiteGraph.NODE_TITLE_HEIGHT),t.fillStyle="#686",t.beginPath(),v.type===LiteGraph.EVENT||v.type===LiteGraph.ACTION||v.shape===LiteGraph.BOX_SHAPE?t.rect(i-7+.5,s-4,14,8):v.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(i+8,s),t.lineTo(i+-4,s-4),t.lineTo(i+-4,s+4),t.closePath()):t.arc(i,s,4,0,2*Math.PI),t.fill()}if(f){let i=e._collapsed_width,s=-.5*LiteGraph.NODE_TITLE_HEIGHT;l&&(i=.5*e._collapsed_width,s=0),t.fillStyle="#686",t.strokeStyle="black",t.beginPath(),f.type===LiteGraph.EVENT||f.type===LiteGraph.ACTION||f.shape===LiteGraph.BOX_SHAPE?t.rect(i-7+.5,s-4,14,8):f.shape===LiteGraph.ARROW_SHAPE?(t.moveTo(i+6,s),t.lineTo(i-6,s-4),t.lineTo(i-6,s+4),t.closePath()):t.arc(i,s,4,0,2*Math.PI),t.fill()}}}else{if(e.inputs)for(let i=0;i<e.inputs.length;i++){let s=e.inputs[i];if(s.widget_name)continue;let a=s.type,r=s.shape;t.globalAlpha=o,this.connecting_output&&!LiteGraph.isValidConnection(s.type,c.type)&&(t.globalAlpha=.4*o),t.fillStyle=null!=s.link?s.color_on||this.default_connection_color_byType[a]||this.default_connection_color.input_on:s.color_off||this.default_connection_color_byTypeOff[a]||this.default_connection_color_byType[a]||this.default_connection_color.input_off;let h=e.getConnectionPos(!0,i,_);if(h[0]-=e.pos[0],h[1]-=e.pos[1],g<h[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=h[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.beginPath(),"array"==a?r=LiteGraph.GRID_SHAPE:"onTrigger"==s.name||"onExecuted"==s.name?r=LiteGraph.ARROW_SHAPE:a!==LiteGraph.EVENT&&a!==LiteGraph.ACTION||(r=LiteGraph.BOX_SHAPE),u=!0,r===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):r===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):r===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),u=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,2*Math.PI),t.fill(),p&&"onTrigger"!=s.name&&"onExecuted"!=s.name){let e=null!=s.label?s.label:s.name;e&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||s.dir==LiteGraph.UP?t.fillText(e,h[0],h[1]-10):t.fillText(e,h[0]+10,h[1]+5))}}if(t.textAlign=l?"center":"right",t.strokeStyle="black",e.outputs)for(let i=0;i<e.outputs.length;i++){let s=e.outputs[i],a=s.type,r=s.shape;this.connecting_input&&!LiteGraph.isValidConnection(a,d.type)&&(t.globalAlpha=.4*o);let h=e.getConnectionPos(!1,i,_);if(h[0]-=e.pos[0],h[1]-=e.pos[1],g<h[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(g=h[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.fillStyle=s.links&&s.links.length?s.color_on||this.default_connection_color_byType[a]||this.default_connection_color.output_on:s.color_off||this.default_connection_color_byTypeOff[a]||this.default_connection_color_byType[a]||this.default_connection_color.output_off,t.beginPath(),"array"==a?r=LiteGraph.GRID_SHAPE:"onTrigger"==s.name||"onExecuted"==s.name?r=LiteGraph.ARROW_SHAPE:a!==LiteGraph.EVENT&&a!==LiteGraph.ACTION||(r=LiteGraph.BOX_SHAPE),u=!0,r===LiteGraph.BOX_SHAPE?l?t.rect(h[0]-5+.5,h[1]-8+.5,10,14):t.rect(h[0]-6+.5,h[1]-5+.5,14,10):r===LiteGraph.ARROW_SHAPE?(t.moveTo(h[0]+8,h[1]+.5),t.lineTo(h[0]-4,h[1]+6+.5),t.lineTo(h[0]-4,h[1]-6+.5),t.closePath()):r===LiteGraph.GRID_SHAPE?(t.rect(h[0]-4,h[1]-4,2,2),t.rect(h[0]-1,h[1]-4,2,2),t.rect(h[0]+2,h[1]-4,2,2),t.rect(h[0]-4,h[1]-1,2,2),t.rect(h[0]-1,h[1]-1,2,2),t.rect(h[0]+2,h[1]-1,2,2),t.rect(h[0]-4,h[1]+2,2,2),t.rect(h[0]-1,h[1]+2,2,2),t.rect(h[0]+2,h[1]+2,2,2),u=!1):n?t.rect(h[0]-4,h[1]-4,8,8):t.arc(h[0],h[1],4,0,2*Math.PI),t.fill(),!n&&u&&t.stroke(),p&&"onTrigger"!=s.name&&"onExecuted"!=s.name){let e=null!=s.label?s.label:s.name;e&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,l||s.dir==LiteGraph.DOWN?t.fillText(e,h[0],h[1]-8):t.fillText(e,h[0]-10,h[1]+5))}}if(t.textAlign="left",t.globalAlpha=1,e.widgets){var L=g;(l||e.widgets_up)&&(L=2),null!=e.widgets_start_y&&(L=e.widgets_start_y),this.drawNodeWidgets(e,L,t,this.node_widget&&this.node_widget[0]==e?this.node_widget[1]:null),g=this.drawNodeWidgetInputs(e,t,g)}}(e.clip_area||this.clip_all_nodes)&&t.restore(),t.globalAlpha=1}}drawNodeWidgetInputs(e,t,i){var s=this.editor_alpha,n=this.connecting_output,o=this.ds.scale<.6,a=!this.lowQualityRenderingRequired(.6),r=e.horizontal,l=new Float32Array(2);if(e.inputs)for(let h=0;h<e.inputs.length;h++){let p=e.inputs[h];if(!p.widget_name)continue;let c=p.type,d=p.shape;t.globalAlpha=s,this.connecting_output&&!LiteGraph.isValidConnection(p.type,n.type)&&(t.globalAlpha=.4*s),t.fillStyle=null!=p.link?p.color_on||this.default_connection_color_byType[c]||this.default_connection_color.input_on:p.color_off||this.default_connection_color_byTypeOff[c]||this.default_connection_color_byType[c]||this.default_connection_color.input_off;let u=e.getConnectionPos(!0,h,l);if(u[0]-=e.pos[0],u[1]-=e.pos[1],i<u[1]+.5*LiteGraph.NODE_SLOT_HEIGHT&&(i=u[1]+.5*LiteGraph.NODE_SLOT_HEIGHT),t.beginPath(),"array"==c?d=LiteGraph.GRID_SHAPE:"onTrigger"==p.name||"onExecuted"==p.name?d=LiteGraph.ARROW_SHAPE:c!==LiteGraph.EVENT&&c!==LiteGraph.ACTION||(d=LiteGraph.BOX_SHAPE),d===LiteGraph.BOX_SHAPE?r?t.rect(u[0]-5+.5,u[1]-8+.5,10,14):t.rect(u[0]-6+.5,u[1]-5+.5,14,10):d===LiteGraph.ARROW_SHAPE?(t.moveTo(u[0]+8,u[1]+.5),t.lineTo(u[0]-4,u[1]+6+.5),t.lineTo(u[0]-4,u[1]-6+.5),t.closePath()):d===LiteGraph.GRID_SHAPE?(t.rect(u[0]-4,u[1]-4,2,2),t.rect(u[0]-1,u[1]-4,2,2),t.rect(u[0]+2,u[1]-4,2,2),t.rect(u[0]-4,u[1]-1,2,2),t.rect(u[0]-1,u[1]-1,2,2),t.rect(u[0]+2,u[1]-1,2,2),t.rect(u[0]-4,u[1]+2,2,2),t.rect(u[0]-1,u[1]+2,2,2),t.rect(u[0]+2,u[1]+2,2,2)):o?t.rect(u[0]-4,u[1]-4,8,8):t.arc(u[0],u[1],4,0,2*Math.PI),t.fill(),p.link&&a&&"onTrigger"!=p.name&&"onExecuted"!=p.name){let e=null!=p.label?p.label:p.name;e&&(t.fillStyle=LiteGraph.NODE_TEXT_COLOR,r||p.dir==LiteGraph.UP?t.fillText(e,u[0],u[1]-10):t.fillText(e,u[0]+10,u[1]+5))}}return i}drawNodeTooltip(e,t){if(!t||!e)return void LiteGraph.log_warn("drawNodeTooltip: invalid node or ctx",t,e);var i=null!=t.properties.tooltip?t.properties.tooltip:"";if(i&&""!=i||LiteGraph.show_node_tooltip_use_descr_property&&t.constructor.desc&&(i=t.constructor.desc),!(i=(i+"").trim())||""==i)return;var s=[0,-LiteGraph.NODE_TITLE_HEIGHT],n=t.flags.collapsed?[LiteGraph.NODE_COLLAPSED_WIDTH,LiteGraph.NODE_TITLE_HEIGHT]:t.size;e.font="14px Courier New";var o=Math.max(t.size[0],160)+20,a=t.ttip_oTMultiRet?t.ttip_oTMultiRet.height+15:21;e.globalAlpha=.7*this.editor_alpha,e.shadowColor=t.ttip_oTMultiRet?"black":"transparent",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle=t.ttip_oTMultiRet?"#454":"transparent",e.beginPath(),e.roundRect(s[0]-.5*o+n[0]/2,s[1]-15-a,o,a,[3]),e.moveTo(s[0]-10+n[0]/2,s[1]-15),e.lineTo(s[0]+10+n[0]/2,s[1]-15),e.lineTo(s[0]+n[0]/2,s[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle=t.ttip_oTMultiRet?"#CEC":"transparent",e.globalAlpha=this.editor_alpha;const r=LiteGraph.canvasFillTextMultiline(e,i,s[0]+n[0]/2,s[1]-a,o,14);t.ttip_oTMultiRet=r,e.closePath()}drawLinkTooltip(e,t){var i=t._pos;if(e.fillStyle="black",e.beginPath(),e.arc(i[0],i[1],3,0,2*Math.PI),e.fill(),null==t.data)return;let s=this.processCallbackHandlers("onDrawLinkTooltip",{def_cb:this.onDrawLinkTooltip},e,t,this);if(null===s||!0!==s&&("object"!=typeof s||!0!==s.return_value)){var n=t.data,o=null;if(n.constructor===Number)o=n.toFixed(2);else if(n.constructor===String)o='"'+n+'"';else if(n.constructor===Boolean)o=String(n);else if(n.toToolTip)o=n.toToolTip();else try{o="["+n.constructor.name+"]"}catch(e){o="["+typeof n+"]"}if(null!=o){o=o.substr(0,30),e.font="14px Courier New";var a=e.measureText(o).width+20;e.shadowColor="black",e.shadowOffsetX=2,e.shadowOffsetY=2,e.shadowBlur=3,e.fillStyle="#454",e.beginPath(),e.roundRect(i[0]-.5*a,i[1]-15-24,a,24,[3]),e.moveTo(i[0]-10,i[1]-15),e.lineTo(i[0]+10,i[1]-15),e.lineTo(i[0],i[1]-5),e.fill(),e.shadowColor="transparent",e.textAlign="center",e.fillStyle="#CEC",e.fillText(o,i[0],i[1]-15-24*.3)}}}drawNodeShape(e,t,i,s,n,o,a){t.strokeStyle=s,t.fillStyle=n;let r=null;var l=LiteGraph.NODE_TITLE_HEIGHT,h=this.lowQualityRenderingRequired(.5),p=e._shape||e.constructor.shape||LiteGraph.ROUND_SHAPE,c=e.constructor.title_mode,d=!0;c==LiteGraph.TRANSPARENT_TITLE||c==LiteGraph.NO_TITLE?d=!1:c==LiteGraph.AUTOHIDE_TITLE&&a&&(d=!0);var u=tmp_area;u[0]=0,u[1]=d?-l:0,u[2]=i[0]+1,u[3]=d?i[1]+l:i[1];var g=t.globalAlpha;if(t.beginPath(),p==LiteGraph.BOX_SHAPE||h?t.fillRect(u[0],u[1],u[2],u[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE?t.roundRect(u[0],u[1],u[2],u[3],p==LiteGraph.CARD_SHAPE?[this.round_radius,this.round_radius,0,0]:[this.round_radius]):p==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*i[0],.5*i[1],.5*i[0],0,2*Math.PI),t.fill(),!e.flags.collapsed&&d&&(t.shadowColor="transparent",t.fillStyle="rgba(0,0,0,0.2)",t.fillRect(0,-1,u[2],2)),t.shadowColor="transparent",e.processCallbackHandlers("onDrawBackground",{def_cb:e.onDrawBackground},t,this,this.canvas,this.graph_mouse),d||c==LiteGraph.TRANSPARENT_TITLE){if(r=e.processCallbackHandlers("onDrawTitleBar",{def_cb:e.onDrawTitleBar},t,l,i,this.ds.scale,s),null!==r&&(!0===r||"object"==typeof r&&!0===r.return_value));else if(c!=LiteGraph.TRANSPARENT_TITLE&&(e.constructor.title_color||this.render_title_colored)){var _=e.constructor.title_color||s;if(e.flags.collapsed&&(t.shadowColor=LiteGraph.DEFAULT_SHADOW_COLOR),this.use_gradients){var v=LGraphCanvas.gradients[_];v||((v=LGraphCanvas.gradients[_]=t.createLinearGradient(0,0,400,0)).addColorStop(0,_),v.addColorStop(1,"#000")),t.fillStyle=v}else t.fillStyle=_;t.beginPath(),p==LiteGraph.BOX_SHAPE||h?t.rect(0,-l,i[0]+1,l):p!=LiteGraph.ROUND_SHAPE&&p!=LiteGraph.CARD_SHAPE||t.roundRect(0,-l,i[0]+1,l,e.flags.collapsed?[this.round_radius]:[this.round_radius,this.round_radius,0,0]),t.fill(),t.shadowColor="transparent"}let n=!1;LiteGraph.node_box_coloured_by_mode&&LiteGraph.NODE_MODES_COLORS[e.mode]&&(n=LiteGraph.NODE_MODES_COLORS[e.mode]),LiteGraph.node_box_coloured_when_on&&(n=e.action_triggered?"#FFF":e.execute_triggered?"#AAA":n);var f=10;if(r=e.processCallbackHandlers("onDrawTitleBox",{def_cb:e.onDrawTitleBox},t,l,i,this.ds.scale),null!==r&&(!0===r||"object"==typeof r&&!0===r.return_value)||(p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CIRCLE_SHAPE||p==LiteGraph.CARD_SHAPE?(h&&(t.fillStyle="black",t.beginPath(),t.arc(.5*l,-.5*l,6,0,2*Math.PI),t.fill()),t.fillStyle=e.boxcolor||n||LiteGraph.NODE_DEFAULT_BOXCOLOR,h?t.fillRect(.5*l-5,-.5*l-5,f,f):(t.beginPath(),t.arc(.5*l,-.5*l,5,0,2*Math.PI),t.fill())):(h&&(t.fillStyle="black",t.fillRect(.5*(l-f)-1,-.5*(l+f)-1,12,12)),t.fillStyle=e.boxcolor||n||LiteGraph.NODE_DEFAULT_BOXCOLOR,t.fillRect(.5*(l-f),-.5*(l+f),f,f))),t.globalAlpha=g,e.processCallbackHandlers("onDrawTitleText",{def_cb:e.onDrawTitleText},t,l,i,this.ds.scale,this.title_text_font,o),!h){t.font=this.title_text_font;var b=String(e.getTitle());b&&(t.fillStyle=o?LiteGraph.NODE_SELECTED_TITLE_COLOR:e.constructor.title_text_color||this.node_title_color,e.flags.collapsed?(t.textAlign="left",t.fillText(b,l,LiteGraph.NODE_TITLE_TEXT_Y-l),t.textAlign="left"):(t.textAlign="left",t.fillText(b,l,LiteGraph.NODE_TITLE_TEXT_Y-l)))}if(!e.flags.collapsed&&e.subgraph&&!e.skip_subgraph_button){var y=LiteGraph.NODE_TITLE_HEIGHT,L=e.size[0]-y,m=LiteGraph.isInsideRectangle(this.graph_mouse[0]-e.pos[0],this.graph_mouse[1]-e.pos[1],L+2,2-y,y-4,y-4);t.fillStyle=m?"#888":"#555",p==LiteGraph.BOX_SHAPE||h?t.fillRect(L+2,2-y,y-4,y-4):(t.beginPath(),t.roundRect(L+2,2-y,y-4,y-4,[4]),t.fill()),t.fillStyle="#333",t.beginPath(),t.moveTo(L+.2*y,.6*-y),t.lineTo(L+.8*y,.6*-y),t.lineTo(L+.5*y,.3*-y),t.fill()}e.processCallbackHandlers("onDrawTitle",{def_cb:e.onDrawTitle},t)}o&&(e.processCallbackHandlers("onBounding",{def_cb:e.onBounding},u),c==LiteGraph.TRANSPARENT_TITLE&&(u[1]-=l,u[3]+=l),t.lineWidth=1,t.globalAlpha=.8,t.beginPath(),p==LiteGraph.BOX_SHAPE?t.rect(-6+u[0],-6+u[1],12+u[2],12+u[3]):p==LiteGraph.ROUND_SHAPE||p==LiteGraph.CARD_SHAPE&&e.flags.collapsed?t.roundRect(-6+u[0],-6+u[1],12+u[2],12+u[3],[2*this.round_radius]):p==LiteGraph.CARD_SHAPE?t.roundRect(-6+u[0],-6+u[1],12+u[2],12+u[3],[2*this.round_radius,2,2*this.round_radius,2]):p==LiteGraph.CIRCLE_SHAPE&&t.arc(.5*i[0],.5*i[1],.5*i[0]+6,0,2*Math.PI),t.strokeStyle=LiteGraph.NODE_BOX_OUTLINE_COLOR,t.stroke(),t.strokeStyle=s,t.globalAlpha=1),e.execute_triggered>0&&e.execute_triggered--,e.action_triggered>0&&e.action_triggered--}drawConnections(e){var t=LiteGraph.getTime(),i=this.visible_area;margin_area[0]=i[0]-20,margin_area[1]=i[1]-20,margin_area[2]=i[2]+40,margin_area[3]=i[3]+40,e.lineWidth=this.connections_width,e.fillStyle="#AAA",e.strokeStyle="#AAA",e.globalAlpha=this.editor_alpha;for(var s=this.graph._nodes,n=0,o=s.length;n<o;++n){var a=s[n];if(a.inputs&&a.inputs.length)for(let i=0;i<a.inputs.length;++i){var r=a.inputs[i];if(r&&null!=r.link){var l=r.link,h=this.graph.links[l];if(h){var p=this.graph.getNodeById(h.origin_id);if(null!=p){var c=h.origin_slot,d=null;d=-1==c?[p.pos[0]+10,p.pos[1]+10]:p.getConnectionPos(!1,c,tempA);var u=a.getConnectionPos(!0,i,tempB);if(link_bounding[0]=d[0],link_bounding[1]=d[1],link_bounding[2]=u[0]-d[0],link_bounding[3]=u[1]-d[1],link_bounding[2]<0&&(link_bounding[0]+=link_bounding[2],link_bounding[2]=Math.abs(link_bounding[2])),link_bounding[3]<0&&(link_bounding[1]+=link_bounding[3],link_bounding[3]=Math.abs(link_bounding[3])),LiteGraph.overlapBounding(link_bounding,margin_area)){var g=p.outputs[c],_=a.inputs[i];if(g&&_){var v=g.dir||(p.horizontal?LiteGraph.DOWN:LiteGraph.RIGHT),f=_.dir||(a.horizontal?LiteGraph.UP:LiteGraph.LEFT);if(this.renderLink(e,d,u,h,!1,0,null,v,f),h&&h._last_time&&t-h._last_time<1e3){var b=2-.002*(t-h._last_time),y=e.globalAlpha;e.globalAlpha=y*b,this.renderLink(e,d,u,h,!0,b,"white",v,f),e.globalAlpha=y}}}}}}}}e.globalAlpha=1}renderLink(e,t,i,s,n,o,a,r,l,h){s&&this.visible_links.push(s),!a&&s&&(a=s.color||LGraphCanvas.link_type_colors[s.type]),a||(a=this.default_link_color),null!=s&&this.highlighted_links[s.id]&&(a="#FFF"),r=r||LiteGraph.RIGHT,l=l||LiteGraph.LEFT;var p=LiteGraph.distance(t,i);this.render_connections_border&&this.ds.scale>.6&&(e.lineWidth=this.connections_width+4),e.lineJoin="round",(h=h||1)>1&&(e.lineWidth=.5),e.beginPath();for(let s=0;s<h;s+=1){var c=5*(s-.5*(h-1));if(this.links_render_mode==LiteGraph.SPLINE_LINK){e.moveTo(t[0],t[1]+c);let s=0,n=0,o=0,a=0;switch(r){case LiteGraph.LEFT:s=-.25*p;break;case LiteGraph.RIGHT:s=.25*p;break;case LiteGraph.UP:n=-.25*p;break;case LiteGraph.DOWN:n=.25*p}switch(l){case LiteGraph.LEFT:o=-.25*p;break;case LiteGraph.RIGHT:o=.25*p;break;case LiteGraph.UP:a=-.25*p;break;case LiteGraph.DOWN:a=.25*p}e.bezierCurveTo(t[0]+s,t[1]+n+c,i[0]+o,i[1]+a+c,i[0],i[1]+c)}else if(this.links_render_mode==LiteGraph.LINEAR_LINK){e.moveTo(t[0],t[1]+c);let s=0,n=0,o=0,a=0;switch(r){case LiteGraph.LEFT:s=-1;break;case LiteGraph.RIGHT:s=1;break;case LiteGraph.UP:n=-1;break;case LiteGraph.DOWN:n=1}switch(l){case LiteGraph.LEFT:o=-1;break;case LiteGraph.RIGHT:o=1;break;case LiteGraph.UP:a=-1;break;case LiteGraph.DOWN:a=1}e.lineTo(t[0]+15*s,t[1]+15*n+c),e.lineTo(i[0]+15*o,i[1]+15*a+c),e.lineTo(i[0],i[1]+c)}else{if(this.links_render_mode!=LiteGraph.STRAIGHT_LINK)return;e.moveTo(t[0],t[1]);var d=t[0],u=t[1],g=i[0],_=i[1];r==LiteGraph.RIGHT?d+=10:u+=10,l==LiteGraph.LEFT?g-=10:_-=10,e.lineTo(d,u),e.lineTo(.5*(d+g),u),e.lineTo(.5*(d+g),_),e.lineTo(g,_),e.lineTo(i[0],i[1])}}this.render_connections_border&&this.ds.scale>.6&&!n&&(e.strokeStyle="rgba(0,0,0,0.5)",e.stroke()),e.lineWidth=this.connections_width,e.fillStyle=e.strokeStyle=a,e.stroke();var v=this.computeConnectionPoint(t,i,.5,r,l);if(s&&s._pos&&(s._pos[0]=v[0],s._pos[1]=v[1]),this.ds.scale>=.6&&this.highquality_render&&l!=LiteGraph.CENTER){if(this.render_connection_arrows){var f=this.computeConnectionPoint(t,i,.25,r,l),b=this.computeConnectionPoint(t,i,.26,r,l),y=this.computeConnectionPoint(t,i,.75,r,l),L=this.computeConnectionPoint(t,i,.76,r,l),m=0,G=0;this.render_curved_connections?(m=-Math.atan2(b[0]-f[0],b[1]-f[1]),G=-Math.atan2(L[0]-y[0],L[1]-y[1])):G=m=i[1]>t[1]?0:Math.PI,e.save(),e.translate(f[0],f[1]),e.rotate(m),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore(),e.save(),e.translate(y[0],y[1]),e.rotate(G),e.beginPath(),e.moveTo(-5,-3),e.lineTo(0,7),e.lineTo(5,-3),e.fill(),e.restore()}e.beginPath(),e.arc(v[0],v[1],5,0,2*Math.PI),e.fill()}if(o){e.fillStyle=a;for(let s=0;s<5;++s){var C=(.001*LiteGraph.getTime()+.2*s)%1;v=this.computeConnectionPoint(t,i,C,r,l),e.beginPath(),e.arc(v[0],v[1],5,0,2*Math.PI),e.fill()}}}computeConnectionPoint(e,t,i,s,n){s=s||LiteGraph.RIGHT,n=n||LiteGraph.LEFT;var o=LiteGraph.distance(e,t),a=e,r=[e[0],e[1]],l=[t[0],t[1]],h=t;switch(s){case LiteGraph.LEFT:r[0]+=-.25*o;break;case LiteGraph.RIGHT:r[0]+=.25*o;break;case LiteGraph.UP:r[1]+=-.25*o;break;case LiteGraph.DOWN:r[1]+=.25*o}switch(n){case LiteGraph.LEFT:l[0]+=-.25*o;break;case LiteGraph.RIGHT:l[0]+=.25*o;break;case LiteGraph.UP:l[1]+=-.25*o;break;case LiteGraph.DOWN:l[1]+=.25*o}var p=(1-i)*(1-i)*(1-i),c=(1-i)*(1-i)*3*i,d=3*(1-i)*(i*i),u=i*i*i;return[p*a[0]+c*r[0]+d*l[0]+u*h[0],p*a[1]+c*r[1]+d*l[1]+u*h[1]]}drawExecutionOrder(e){e.shadowColor="transparent",e.globalAlpha=.25,e.textAlign="center",e.strokeStyle="white",e.globalAlpha=.75;var t=this.visible_nodes;for(let s=0;s<t.length;++s){var i=t[s];e.fillStyle="black",e.fillRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),0==i.order&&e.strokeRect(i.pos[0]-LiteGraph.NODE_TITLE_HEIGHT+.5,i.pos[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,LiteGraph.NODE_TITLE_HEIGHT,LiteGraph.NODE_TITLE_HEIGHT),e.fillStyle="#FFF",e.fillText(i.order,i.pos[0]+-.5*LiteGraph.NODE_TITLE_HEIGHT,i.pos[1]-6)}e.globalAlpha=1}drawNodeWidgets(e,t,i,s){if(!e.widgets||!e.widgets.length)return 0;var n=e.size[0],o=e.widgets;t+=2;var a=LiteGraph.NODE_WIDGET_HEIGHT,r=!this.lowQualityRenderingRequired(.5);i.save(),i.globalAlpha=this.editor_alpha;var l=LiteGraph.WIDGET_OUTLINE_COLOR,h=LiteGraph.WIDGET_BGCOLOR,p=LiteGraph.WIDGET_TEXT_COLOR,c=LiteGraph.WIDGET_SECONDARY_TEXT_COLOR,d=15,u=!1;for(let G=0;G<o.length;++G){var g=o[G],_=t;g.y&&(_=g.y),g.last_y=_,i.strokeStyle=l,i.fillStyle="#222",i.textAlign="left",g.disabled&&(i.globalAlpha*=.5);var v=g.width||n;switch(u=this.over_widget==g,g.type){case"button":g.clicked&&(i.fillStyle="#AAA",g.clicked=!1,this.dirty_canvas=!0),i.fillRect(d,_,v-30,a),r&&!g.disabled&&i.strokeRect(d,_,v-30,a),r&&(i.textAlign="center",i.fillStyle=p,(u||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<n)&&i.fillText(g.label||g.name,.5*v,_+.7*a));break;case"toggle":if(i.textAlign="left",i.strokeStyle=l,i.fillStyle=h,i.beginPath(),r?i.roundRect(d,_,v-30,a,[.5*a]):i.rect(d,_,v-30,a),i.fill(),r&&!g.disabled&&i.stroke(),i.fillStyle=g.value?"#89A":"#333",i.beginPath(),i.arc(v-30,_+.5*a,.36*a,0,2*Math.PI),i.fill(),r){i.fillStyle=c;const e=g.label||g.name;null!=e&&(u||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<n)&&i.fillText(e,30,_+.7*a),i.fillStyle=g.value?p:c,i.textAlign="right",i.fillText(g.value?g.options.on||"on":g.options.off||"off",v-40,_+.7*a)}break;case"slider":i.fillStyle=h,i.fillRect(d,_,v-30,a);var f=g.options.max-g.options.min,b=(g.value-g.options.min)/f;if(b<0&&(b=0),b>1&&(b=1),i.fillStyle=g.options.hasOwnProperty("slider_color")?g.options.slider_color:s==g?"#89A":"#678",i.fillRect(d,_,b*(v-30),a),r&&!g.disabled&&i.strokeRect(d,_,v-30,a),g.marker){var y=(g.marker-g.options.min)/f;y<0&&(y=0),y>1&&(y=1),i.fillStyle=g.options.hasOwnProperty("marker_color")?g.options.marker_color:"#AA9",i.fillRect(d+y*(v-30),_,2,a)}r&&(i.textAlign="center",i.fillStyle=p,(u||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<n)&&i.fillText(g.label||g.name+"  "+LiteGraph.formatNumber(g.value,null!=g.options.precision?g.options.precision:3),.5*v,_+.7*a));break;case"number":case"combo":if(i.textAlign="left",i.strokeStyle=l,i.fillStyle=h,i.beginPath(),r?i.roundRect(d,_,v-30,a,[.5*a]):i.rect(d,_,v-30,a),i.fill(),r)if(g.disabled||i.stroke(),i.fillStyle=p,g.disabled||(i.beginPath(),i.moveTo(31,_+5),i.lineTo(21,_+.5*a),i.lineTo(31,_+a-5),i.fill(),i.beginPath(),i.moveTo(v-d-16,_+5),i.lineTo(v-d-6,_+.5*a),i.lineTo(v-d-16,_+a-5),i.fill()),i.fillStyle=c,(u||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<n)&&i.fillText(g.label||g.name,35,_+.7*a),i.fillStyle=p,i.textAlign="right","number"==g.type)i.fillText(LiteGraph.formatNumber(g.value,void 0!==g.options.precision?g.options.precision:3),v-30-20,_+.7*a);else{var L=g.value;if(g.options.values){var m=g.options.values;m.constructor===Function&&(m=m()),m&&m.constructor!==Array&&(L=m[g.value])}i.fillText(L,v-30-20,_+.7*a)}break;case"string":case"text":if(i.textAlign="left",i.strokeStyle=l,i.fillStyle=h,i.beginPath(),r?i.roundRect(d,_,v-30,a,[.5*a]):i.rect(d,_,v-30,a),i.fill(),r){g.disabled||i.stroke(),i.save(),i.beginPath(),i.rect(d,_,v-30,a),i.clip(),i.fillStyle=c;const e=g.label||g.name;null!=e&&(u||!0===this.options.hide_widget_label_when_small||this.options.hide_widget_label_when_small<n)&&i.fillText(e,30,_+.7*a),i.fillStyle=p,i.textAlign="right",i.fillText(String(g.value).substr(0,30),v-30,_+.7*a),i.restore()}break;default:g.draw&&(!g.port_name||g.port_name&&!e.inputs.find((e=>e.name===g.port_name)).link)&&g.draw(i,e,v,_,a)}t+=(g.computeSize?g.computeSize(v)[1]:a)+4,i.globalAlpha=this.editor_alpha}i.restore(),i.textAlign="left"}processNodeWidgets(node,pos,event,active_widget){if(!node.widgets||!node.widgets.length||!this.allow_interaction&&!node.flags.allow_interaction)return node.widgets&&node.widgets.length||LiteGraph.log_verbose("graph processNodeWidgets","no widgets for node",node),this.allow_interaction||node.flags.allow_interaction||LiteGraph.log_verbose("graph processNodeWidgets","interaction not allowed on graph and not overridden on node",node),null;var x=pos[0]-node.pos[0],y=pos[1]-node.pos[1],width=node.size[0],height=LiteGraph.NODE_WIDGET_HEIGHT,deltaX=event?.deltaX||event?.deltax||0,that=this,ref_window=this.getCanvasWindow(),widget_width=width,widget_height=height;for(let i=0;i<node.widgets.length;++i){var w=node.widgets[i];if(w&&!w.disabled){if("function"==typeof w.computeSize){const e=w.computeSize(node.size[0],node.size[1]);widget_width=e[0],widget_height=e[1]}else widget_width=w.width||width,widget_height=w.height||height;if(w==active_widget||!(x<6||x>widget_width-12||y<w.last_y||y>w.last_y+widget_height||void 0===w.last_y)){var old_value=w.value;if(LiteGraph.log_verbose("graph processNodeWidgets","has widget",w),event)switch(w.type){case"button":"pointerdown"===event.type?(w.callback?(LiteGraph.log_debug("graph processNodeWidgets","button, calling callback",w.callback),setTimeout((function(){w.callback(w,that,node,pos,event)}),20)):LiteGraph.log_verbose("graph processNodeWidgets","button, has not callback",w),w.clicked=!0,this.dirty_canvas=!0):LiteGraph.log_verbose("graph processNodeWidgets","button, event is not pointer down",event);break;case"slider":var nvalue=LiteGraph.clamp((x-15)/(widget_width-30),0,1);if(w.options.read_only)break;w.value=w.options.min+(w.options.max-w.options.min)*nvalue,old_value!=w.value&&setTimeout((function(){inner_value_change(w,w.value,old_value)}),20),this.dirty_canvas=!0;break;case"number":case"combo":case"enum":if("pointermove"==event.type&&"number"==w.type)deltaX&&(w.value+=.1*deltaX*(w.options.step||1)),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if("pointerdown"==event.type){var values=w.options.values;values&&values.constructor===Function&&(values=w.options.values(w,node));var values_list=null;"number"!=w.type&&(values_list=values.constructor===Array?values:Object.keys(values));let e=x<40?-1:x>widget_width-40?1:0;if("number"==w.type)w.value+=e*(w.options.step||1),null!=w.options.min&&w.value<w.options.min&&(w.value=w.options.min),null!=w.options.max&&w.value>w.options.max&&(w.value=w.options.max);else if(e){var index=-1;this.last_mouseclick=0,index=values.constructor===Object?values_list.indexOf(String(w.value))+e:values_list.indexOf(w.value)+e,index>=values_list.length&&(index=values_list.length-1),index<0&&(index=0),values.constructor===Array?w.value=values[index]:(console.debug("ARROW_ComboOrOtherWidget","clickCHECK",w,index,values),w.value=values!=values_list?Object.keys(values)[index]:index)}else{var entries=[];values!=values_list?Object.keys(values).forEach((e=>{entries.push({value:e,content:values[e]})})):entries=values,console.debug("ComboOrOtherWidget","filling from",values,"to",entries);let e=function(e,t,i,s,n,o){return console.debug("ComboOrOtherWidget","inner_clicked",...arguments),console.debug("ComboOrOtherWidget","inner_clicked",e,entries,values,values_list,"old_value",old_value),"object"==typeof e&&void 0!==e.value?(console.debug("ComboOrOtherWidget","inner_clicked","using object key value",e),this.value=e.value,inner_value_change(this,e.value,old_value)):(console.debug("ComboOrOtherWidget","inner_clicked","using simple",e),this.value=e,inner_value_change(this,e,old_value)),that.dirty_canvas=!0,!1};LiteGraph.ContextMenu(entries,{scale:Math.max(1,this.ds.scale),event:event,className:"dark",callback:e.bind(w)},ref_window)}}else if("pointerup"==event.type&&"number"==w.type){let delta=x<40?-1:x>widget_width-40?1:0;event.click_time<200&&0==delta&&this.prompt("Value",w.value,function(v){if(/^[0-9+\-*/()\s]+|\d+\.\d+$/.test(v))try{v=eval(v)}catch(e){LiteGraph.log_warn(e)}this.value=Number(v),inner_value_change(this,this.value,old_value)}.bind(w),event)}old_value!=w.value&&setTimeout(function(){inner_value_change(this,this.value,old_value)}.bind(w),20),this.dirty_canvas=!0;break;case"boolean":case"toggle":"pointerdown"==event.type&&(w.value=!w.value,setTimeout((function(){inner_value_change(w,w.value)}),20));break;case"string":case"text":"pointerdown"==event.type&&this.prompt("Value",w.value,function(e){inner_value_change(this,e)}.bind(w),event,!!w.options&&w.options.multiline);break;default:w.mouse&&(this.dirty_canvas=w.mouse(event,[x,y],node))}return w}}}function inner_value_change(e,t,i){LiteGraph.log_debug("inner_value_change for processNodeWidgets",e,t);const s=t;i!=w.value&&(node.processCallbackHandlers("onWidgetChanged",{def_cb:node.onWidgetChanged},w.name,w.value,i,w),node.graph.onGraphChanged({action:"widgetChanged",doSave:!0})),"number"==e.type&&(t=Number(t)),e.value=t,e.options&&e.options.property&&void 0!==node.properties[e.options.property]&&node.setProperty(e.options.property,t),e.callback&&e.callback(e.value,that,node,pos,event,s)}return null}drawGroups(e,t){if(this.graph){var i=this.graph._groups;t.save();for(let e=0;e<i.length;++e){var s=i[e];if(LiteGraph.overlapBounding(this.visible_area,s._bounding)){t.fillStyle=s.color||"#335",t.strokeStyle=s.color||"#335",this.options.groups_border_alpha>=0&&t.setStrokeColor&&t.setStrokeColor(t.strokeStyle,this.options.groups_border_alpha);var n=s._pos,o=s._size;t.globalAlpha=this.options.groups_alpha*this.editor_alpha,t.beginPath(),t.rect(n[0]+.5,n[1]+.5,o[0],o[1]),t.fill(),t.globalAlpha=this.editor_alpha,t.stroke(),t.beginPath(),t.moveTo(n[0]+o[0],n[1]+o[1]),t.lineTo(n[0]+o[0]-this.options.groups_triangle_handler_size,n[1]+o[1]),t.lineTo(n[0]+o[0],n[1]+o[1]-this.options.groups_triangle_handler_size),t.fill();var a=s.font_size||this.options.groups_title_font_size||LiteGraph.DEFAULT_GROUP_FONT_SIZE;t.font=a+"px "+this.options.groups_title_font,t.textAlign=this.options.groups_title_alignment,this.options.groups_title_wrap?LiteGraph.canvasFillTextMultiline(t,s.title,n[0]+4,n[1]+a,o[0],a):t.fillText(s.title,n[0]+4,n[1]+a)}}t.restore()}}adjustNodesSize(){var e=this.graph._nodes;for(let t=0;t<e.length;++t)e[t].size=e[t].computeSize();this.setDirty(!0,!0)}resize(e,t){if(e||t)LiteGraph.log_debug("lgraphcanvas","resize","passed",e,t,i);else{var i=this.canvas.parentNode;e=i.offsetWidth,t=i.offsetHeight,LiteGraph.log_debug("lgraphcanvas","resize","not passed: AUTO",i,e,t)}this.canvas.width==e&&this.canvas.height==t||(this.canvas.width=e,this.canvas.height=t,this.bgcanvas.width=this.canvas.width,this.bgcanvas.height=this.canvas.height,this.setDirty(!0,!0))}switchLiveMode(e){if(!e)return this.live_mode=!this.live_mode,this.dirty_canvas=!0,void(this.dirty_bgcanvas=!0);var t=this,i=this.live_mode?1.1:.9;this.live_mode&&(this.live_mode=!1,this.editor_alpha=.1);var s=setInterval((function(){t.editor_alpha*=i,t.dirty_canvas=!0,t.dirty_bgcanvas=!0,i<1&&t.editor_alpha<.01&&(clearInterval(s),i<1&&(t.live_mode=!0)),i>1&&t.editor_alpha>.99&&(clearInterval(s),t.editor_alpha=1)}),1)}static onGroupAdd(e,t,i){const s=LGraphCanvas.active_canvas;var n=new LiteGraph.LGraphGroup;if(s.options.groups_add_around_selected&&Object.keys(s.selected_nodes).length){const e=s.getBoundaryForSelection();if(e){const t=s.options.groups_add_default_spacing,i=1.5*s.options.groups_title_font_size;n.pos=[e[0]-t,e[1]-i-t],n.size=[e[2]+2*t,e[3]+i+2*t],LiteGraph.log_debug("lgraphcanvas","onGroupAdd","groups_add_around_selected",e,n)}else n.pos=s.convertEventToCanvasOffset(i)}else n.pos=s.convertEventToCanvasOffset(i);s.graph.add(n)}static getBoundaryNodes(e){let t=null,i=null,s=null,n=null;for(const o in e){const a=e[o],[r,l]=a.pos,[h,p]=a.size;(null===t||l<t.pos[1])&&(t=a),(null===i||r+h>i.pos[0]+i.size[0])&&(i=a),(null===s||l+p>s.pos[1]+s.size[1])&&(s=a),(null===n||r<n.pos[0])&&(n=a)}return{top:t,right:i,bottom:s,left:n}}boundaryNodesForSelection(){return LGraphCanvas.getBoundaryNodes(Object.values(this.selected_nodes))}getBoundaryForSelection(){const e=this.boundaryNodesForSelection();if(!e||null===e.left)return!1;const t=e.left.getBounding(),i=e.top.getBounding(),s=e.right.getBounding(),n=e.bottom.getBounding();return[t[0],i[1],s[0]+s[2]-t[0],n[1]+n[3]-i[1]]}getCoordinateCenter(e){return[e[0]+e[2]/2,e[1]+e[3]/2]}static alignNodes(e,t,i){if(!e)return;const s=LGraphCanvas.active_canvas;let n=[];n=void 0===i?LGraphCanvas.getBoundaryNodes(e):{top:i,right:i,bottom:i,left:i};for(const[e,i]of Object.entries(s.selected_nodes))switch(t){case"right":i.pos[0]=n.right.pos[0]+n.right.size[0]-i.size[0];break;case"left":i.pos[0]=n.left.pos[0];break;case"top":i.pos[1]=n.top.pos[1];break;case"bottom":i.pos[1]=n.bottom.pos[1]+n.bottom.size[1]-i.size[1]}s.dirty_canvas=!0,s.dirty_bgcanvas=!0}static onNodeAlign(e,t,i,s,n){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase(),n)},parentMenu:s})}static onGroupAlign(e,t,i,s){LiteGraph.ContextMenu(["Top","Bottom","Left","Right"],{event:i,callback:function(e){LGraphCanvas.alignNodes(LGraphCanvas.active_canvas.selected_nodes,e.toLowerCase())},parentMenu:s})}static onMenuAdd(e,t,i,s,n){var o=LGraphCanvas.active_canvas,a=o.getCanvasWindow(),r=o.graph;if(r)return function e(s,l){var h=LiteGraph.getNodeTypesCategories(o.filter||r.filter).filter((function(e){return e.startsWith(s)})),p=[];h.map((function(t){if(t){var i=new RegExp("^("+s+")"),n=t.replace(i,"").split("/")[0],o=""===s?n+"/":s+n+"/",a=n;-1!=a.indexOf("::")&&(a=a.split("::")[1]),-1===p.findIndex((function(e){return e.value===o}))&&p.push({value:o,content:a,has_submenu:!0,callback:function(t,i,s,n){LiteGraph.log_debug("onMenuAdd","inner_onMenuAdded","categories callback",...arguments),e(t.value,n)}})}})),LiteGraph.getNodeTypesInCategory(s.slice(0,-1),o.filter||r.filter).map((function(e){if(!e.skip_list){var t={value:e.type,content:e.title,has_submenu:!1,callback:function(e,t,i,s){var a=s.getFirstEvent();o.graph.beforeChange();var r=LiteGraph.createNode(e.value);LiteGraph.log_debug("onMenuAdd","inner_onMenuAdded","node entry callback",a,...arguments),r&&(r.pos=o.convertEventToCanvasOffset(a),o.graph.add(r)),n&&n(r),o.graph.afterChange()}};p.push(t)}}));const c=i||t.event;LiteGraph.log_debug("lgraphcanvas","onMenuAdd","inner_onMenuAdded","opening ContextMenu",p,{event:c,parentMenu:l},a),LiteGraph.ContextMenu(p,{event:c,parentMenu:l},a)}("",s),!1}static onMenuCollapseAll(){}static onMenuNodeEdit(){}static showMenuNodeOptionalInputs(e,t,i,s,n){if(!n)return;var o=this;let a=null;var r=LGraphCanvas.active_canvas.getCanvasWindow();t=n.optional_inputs,a=n.processCallbackHandlers("onGetInputs",{def_cb:n.onGetInputs}),null!==a&&"object"==typeof a&&("object"==typeof a.return_value?t=a.return_value:void 0!==a.length&&(t=a));var l=[];if(t)for(let e=0;e<t.length;e++){var h=t[e];if(h){var p=h[0];h[2]||(h[2]={}),h[2].label&&(p=h[2].label),h[2].removable=!0,h[2].optional=!0;var c={content:p,value:h};h[1]==LiteGraph.ACTION&&(c.className="event"),l.push(c)}else l.push(null)}if(a=n.processCallbackHandlers("onMenuNodeInputs",{def_cb:n.onMenuNodeInputs},l),null!==a&&"object"==typeof a&&"object"==typeof a.return_value&&(l=a.return_value),LiteGraph.do_add_triggers_slots&&-1==n.findInputSlot("onTrigger")&&l.push({content:"On Trigger",value:["onTrigger",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),l.length)return LiteGraph.ContextMenu(l,{event:i,callback:function(e,t,i){if(!n)return;e.callback&&e.callback.call(o,n,e,t,i);if(e.value){n.graph.beforeChange();var s={};e.value[2]&&(s=Object.assign(s,e.value[2])),n.addInput(e.value[0],e.value[1],s),n.processCallbackHandlers("onNodeInputAdd",{def_cb:n.onNodeInputAdd},e.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()}},parentMenu:s,node:n},r),!1;LiteGraph.log_debug("lgraphcanvas","showMenuNodeOptionalInputs","no input entries")}static showMenuNodeOptionalOutputs(e,t,i,s,n){if(!n)return;var o=this,a=LGraphCanvas.active_canvas.getCanvasWindow();t=n.optional_outputs;let r=n.processCallbackHandlers("onGetOutputs",{def_cb:n.onGetOutputs});null!==r&&"object"==typeof r&&("object"==typeof r.return_value?t=r.return_value:void 0!==r.length&&(t=r));var l=[];if(t)for(let e=0;e<t.length;e++){var h=t[e];if(h){if(!n.flags||!n.flags.skip_repeated_outputs||-1==n.findOutputSlot(h[0])){var p=h[0];h[2]||(h[2]={}),h[2].label&&(p=h[2].label),h[2].removable=!0,h[2].optional=!0;var c={content:p,value:h};h[1]==LiteGraph.EVENT&&(c.className="event"),l.push(c)}}else l.push(null)}if(r=n.processCallbackHandlers("onMenuNodeOutputs",{def_cb:n.onMenuNodeOutputs},l),null!==r&&"object"==typeof r&&"object"==typeof r.return_value&&(l=r.return_value),LiteGraph.do_add_triggers_slots&&-1==n.findOutputSlot("onExecuted")&&l.push({content:"On Executed",value:["onExecuted",LiteGraph.EVENT,{nameLocked:!0,removable:!0,optional:!0}],className:"event"}),l.length)return LiteGraph.ContextMenu(l,{event:i,callback:function e(t,i,a){if(!n)return;t.callback&&t.callback.call(o,n,t,i,a);if(!t.value)return;var r=t.value[1];if(r&&(r.constructor===Object||r.constructor===Array)){var l=[];for(let e in r)l.push({content:e,value:r[e]});return LiteGraph.ContextMenu(l,{event:i,callback:e,parentMenu:s,node:n}),!1}n.graph.beforeChange();var h={};t.value[2]&&(h=Object.assign(h,t.value[2])),n.addOutput(t.value[0],t.value[1],h),n.processCallbackHandlers("onNodeOutputAdd",{def_cb:n.onNodeOutputAdd},t.value),n.setDirtyCanvas(!0,!0),n.graph.afterChange()},parentMenu:s,node:n},a),!1}doShowMenuNodeProperties(e,t,i,s,n){LGraphCanvas.onShowMenuNodeProperties(e,t,i,s,n)}static onShowMenuNodeProperties(e,t,i,s,n){if(!n||!n.properties)return;var o=LGraphCanvas.active_canvas,a=o.getCanvasWindow();let r=[];for(let e in n.properties){let t=void 0!==n.properties[e]?n.properties[e]:" ";"object"==typeof t&&(t=JSON.stringify(t));let i=n.getPropertyInfo(e),s=i&&null!==i?i.type:"string",o=!(!i||null===i)&&!!i.readonly,a=!(!i||null===i)&&!!i.prevent_input_bind,l=!(!i||null===i)&&!!i.prevent_output_bind,h=i&&null!==i&&i.label?i.label:e;"enum"!=s&&"combo"!=s||(t=LGraphCanvas.getPropertyPrintableValue(t,i.values)),t=LGraphCanvas.decodeHTML(t);let p="<span class='property_name'>"+h+"</span><span class='property_value'>"+t+"</span>",c=[];if(!a&&!o&&LiteGraph.properties_allow_input_binding){let e=n.findInputSlot(h,!0),t=-1!==e,i=!!t&&e.param_bind;p+="<span class='property_input_bind'>"+(i?"<span class='property_input_binded'>linked</span>":t?"<span class='property_input_exist'><input type='button' class='btn_bind_in btn_bind_property_to_input' value='link input' /></span>":"<span class=''><input type='button' class='btn_bind_in btn_bind_property_to_input' value='create input' /></span>")+"</span>",c.push((function(o,a){LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","calling callback_on_element_created",h,o,i,e);let r=o.querySelector(".btn_bind_in");r?(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_bind_in binding!",r,h),r.addEventListener("click",(function(o){e=n.findInputSlot(h,!0),t=-1!==e,i=!!t&&e.param_bind,i?LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Property already binded",e,h):(t||(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","CREATING NEW INPUT ON NODE",e,h),n.addInput(h,s,{removable:!0,nameLocked:!0}),e=n.findInputSlot(h,!0)),LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","callback_on_element_created","properties_allow_input_binding","btnConfirm","Linking property to input",e),e.param_bind=!0,a.close?.(o,!0)),o.preventDefault(),o.stopPropagation()}))):(o.disabled="disabled",LiteGraph.log_warn("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties",".btn_bind_in not found",h,o))}))}if(!l&&LiteGraph.properties_allow_output_binding){let e=n.findOutputSlot(h,!0),t=-1!==e,i=!!t&&e.param_bind;p+="<span class='property_output_bind'>"+(i?"<span class='property_output_binded'>linked</span>":t?"<span class='property_output_exist'><input type='button' class='btn_bind_out btn_bind_property_to_output' value='link output' /></span>":"<span class=''><input type='button' class='btn_bind_out btn_bind_property_to_output' value='create output' /></span>")+"</span>",c.push((function(o,a){LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output calling callback_on_element_created",h,o,i,e);let r=o.querySelector(".btn_bind_out");r?(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output .btn_bind_out binding!",r,h),r.addEventListener("click",(function(o){e=n.findOutputSlot(h,!0),t=-1!==e,i=!!t&&e.param_bind,i?LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","Property already binded",e,h):(t||(LiteGraph.log_info("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","CREATING NEW OUTPUT ON NODE",e,h),n.addOutput(h,s,{removable:!0,nameLocked:!0}),e=n.findOutputSlot(h,!0)),LiteGraph.log_debug("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output callback_on_element_created","properties_allow_output_binding","btnConfirm","Linking property to output",e),e.param_bind=!0,a.close?.(o,!0)),o.preventDefault(),o.stopPropagation()}))):(o.disabled="disabled",LiteGraph.log_warn("lgraphcanvas","showLinkMenu","onShowMenuNodeProperties","output .btn_bind_out not found",h,o))}))}LiteGraph.properties_allow_widget_binding&&n.widgets?.find((e=>e&&e.options?.property===h)),r.push({content:p,value:e,callbacks_on_element_created:c,readonly:o})}if(r.length)return LiteGraph.ContextMenu(r,{event:i,callback:function(e,t,i,s,a){if(LiteGraph.log_debug("lgraphcanvas","onShowMenuNodeProperties","inner_clicked",this,...arguments),!n)return;if(!(console.warn("**showeditproperty**",e,t),this.disabled||e.disabled||e.readonly)){var r=this.getBoundingClientRect();o.showEditPropertyValue(n,e.value,{position:[r.left,r.top]})}},parentMenu:s,allow_html:!0,node:n},a),!1}static decodeHTML(e){var t=document.createElement("div");return t.innerText=e,t.innerHTML}static onMenuResizeNode(e,t,i,s,n){if(!n)return;var o=LGraphCanvas.active_canvas;o.getCanvasWindow();var a=o.graph;a?.onGraphChanged({action:"resize",doSave:!0});const r=e=>{e.size=e.computeSize(),e.processCallbackHandlers("onResize",{def_cb:e.onResize},e.size)};var l=LGraphCanvas.active_canvas;if(!l.selected_nodes||Object.keys(l.selected_nodes).length<=1)r(n);else for(let e in l.selected_nodes)r(l.selected_nodes[e]);n.setDirtyCanvas(!0,!0)}showLinkMenu(e,t){var i=this;LiteGraph.log_verbose(e);var s=i.graph.getNodeById(e.origin_id),n=i.graph.getNodeById(e.target_id),o=!1;s&&s.outputs&&s.outputs[e.origin_slot]&&(o=s.outputs[e.origin_slot].type);var a=!1;n&&n.outputs&&n.outputs[e.target_slot]&&(a=n.inputs[e.target_slot].type);var r=LiteGraph.ContextMenu(["Add Node",null,"Delete",null],{event:t,title:null!=e.data?e.data.constructor.name:null,callback:function(t,l,h){switch(t){case"Add Node":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","calling onMenuAdd"),LGraphCanvas.onMenuAdd(null,null,h,r,(function(t){t.inputs&&t.inputs.length&&t.outputs&&t.outputs.length&&(LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","node autoconnect on add node on link"),s.connectByType(e.origin_slot,t,o)&&(t.connectByType(e.target_slot,n,a),t.pos[0]-=.5*t.size[0]))}));break;case"Delete":LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","remove link"),i.graph.removeLink(e.id);break;default:LiteGraph.log_debug("lgraphcanvas","showLinkMenu","inner_clicked","node in the middle or other operation",...arguments)}}});return!1}createDefaultNodeForSlot(e={}){var t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,position:[],nodeType:null,posAdd:[0,0],posSizeFix:[0,0]},e),i=t.nodeFrom&&null!==t.slotFrom,s=!i&&t.nodeTo&&null!==t.slotTo;if(!i&&!s)return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No data passed "+t.nodeFrom+" "+t.slotFrom+" "+t.nodeTo+" "+t.slotTo),!1;if(!t.nodeType)return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","No type"),!1;var n=i?t.nodeFrom:t.nodeTo,o=i?t.slotFrom:t.slotTo,a=!1;switch(typeof o){case"string":a=i?n.findOutputSlot(o,!1):n.findInputSlot(o,!1),o=i?n.outputs[o]:n.inputs[o];break;case"object":a=i?n.findOutputSlot(o.name):n.findInputSlot(o.name);break;case"number":a=o,o=i?n.outputs[o]:n.inputs[o];break;default:return LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","Cant get slot information "+o),!1}!1!==o&&!1!==a||LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","bad slotX "+o+" "+a);var r=o.type==LiteGraph.EVENT?"_event_":o.type,l=i?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(l&&l[r]){o.link;var h=!1;if("object"==typeof l[r]){for(var p in l[r])if(t.nodeType==l[r][p]||"AUTO"==t.nodeType){h=l[r][p],LiteGraph.log_verbose("lgraphcanvas","createDefaultNodeForSlot","opts.nodeType == slotTypesDefault[fromSlotType][typeX] :: "+t.nodeType);break}}else t.nodeType!=l[r]&&"AUTO"!=t.nodeType||(h=l[r]);if(h){var c=!1;"object"==typeof h&&h.node&&(c=h,h=h.node);var d=LiteGraph.createNode(h);if(d){if(c){if(c.properties)for(const[e,t]of Object.entries(c.properties))d.addProperty(e,t);c.inputs&&(d.inputs=[],Object.values(c.inputs).forEach((e=>{d.addOutput(e[0],e[1])}))),c.outputs&&(d.outputs=[],Object.values(c.outputs).forEach((e=>{d.addOutput(e[0],e[1])}))),c.title&&(d.title=c.title),c.json&&d.configure(c.json)}return this.graph.add(d),d.pos=[t.position[0]+t.posAdd[0]+(t.posSizeFix[0]?t.posSizeFix[0]*d.size[0]:0),t.position[1]+t.posAdd[1]+(t.posSizeFix[1]?t.posSizeFix[1]*d.size[1]:0)],i?t.nodeFrom.connectByType(a,d,r):t.nodeTo.connectByTypeOutput(a,d,r),!0}LiteGraph.log_warn("lgraphcanvas","createDefaultNodeForSlot","failed creating "+h)}}return!1}showConnectionMenu(e={}){var t=Object.assign({nodeFrom:null,slotFrom:null,nodeTo:null,slotTo:null,e:null,isCustomEvent:!1},e),i=this,s=t.nodeFrom&&t.slotFrom,n=!s&&t.nodeTo&&t.slotTo;if(!s&&!n)return LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","No data passed to showConnectionMenu"),!1;var o=s?t.nodeFrom:t.nodeTo,a=s?t.slotFrom:t.slotTo,r=!1;switch(typeof a){case"string":r=s?o.findOutputSlot(a,!1):o.findInputSlot(a,!1),a=s?o.outputs[a]:o.inputs[a];break;case"object":r=s?o.findOutputSlot(a.name):o.findInputSlot(a.name);break;case"number":r=a,a=s?o.outputs[a]:o.inputs[a];break;default:return LiteGraph.log_warn("lgraphcanvas","showConnectionMenu","Cant get slot information "+a),!1}var l=["Add Node",null];i.allow_searchbox&&(l.push("Search"),l.push(null));const h=a.type===LiteGraph.EVENT?"_event_":a.type,p=s?LiteGraph.slot_types_default_out:LiteGraph.slot_types_default_in;if(p&&p[h]){const e=p[h];Array.isArray(e)||"object"==typeof e?Object.values(e).forEach((e=>{l.push(e)})):l.push(e)}var c=LiteGraph.ContextMenu(l,{event:t.e,isCustomEvent:t.isCustomEvent,title:(a&&""!=a.name?a.name+(h?" | ":""):"")+(a&&h?h:""),callback:(e,n,o)=>{const l={"Add Node":()=>{LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","Add Node calling onMenuAdd",e,n,o),LGraphCanvas.onMenuAdd(null,null,o,c,(e=>{s?t.nodeFrom.connectByType(r,e,h):t.nodeTo.connectByTypeOutput(r,e,h)}))},Search:()=>{s?i.showSearchBox(o,{node_from:t.nodeFrom,slot_from:a,type_filter_in:h}):i.showSearchBox(o,{node_to:t.nodeTo,slot_from:a,type_filter_out:h})},default:()=>{LiteGraph.log_debug("lgraphcanvas","showConnectionMenu","callback","createDefaultNodeForSlot",e,n,o);const s=[t.e.canvasX,t.e.canvasY];i.createDefaultNodeForSlot(Object.assign(t,{position:s,nodeType:e}))}};(l[e]||l.default)()}});return!1}doShowNodeInfoEditor(e,t,i,s){LGraphCanvas.onShowNodeInfoEditor(t,s,i,null,e)}static onShowNodeInfoEditor(e,t,i,s,n){var o=e.property||"title",a=n[o],r=document.createElement("div");r.is_modified=!1,r.className="graphdialog",r.innerHTML="<span class='name'></span><input autofocus type='text' class='value'/><button>OK</button>",r.close=()=>{r.parentNode?.removeChild(r)},r.querySelector(".name").innerText=o;var l=r.querySelector(".value");const h=()=>{l&&_(l.value)};l&&(l.value=a,l.addEventListener("blur",(function(e){this.focus()})),l.addEventListener("keydown",(function(e){if(r.is_modified=!0,27==e.keyCode)r.close();else if(13==e.keyCode)h();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})));var p=LGraphCanvas.active_canvas.canvas,c=p.getBoundingClientRect(),d=-20,u=-20;c&&(d-=c.left,u-=c.top),event?(r.style.left=event.clientX+d+"px",r.style.top=event.clientY+u+"px"):(r.style.left=.5*p.width+d+"px",r.style.top=.5*p.height+u+"px"),r.querySelector("button").addEventListener("click",h),p.parentNode.appendChild(r),l&&l.focus();let g=null;r.addEventListener("pointerleave",(e=>{LiteGraph.dialog_close_on_mouse_leave&&!r.is_modified&&(g=setTimeout(r.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),r.addEventListener("pointerenter",(e=>{LiteGraph.dialog_close_on_mouse_leave&&g&&clearTimeout(g)}));const _=t=>{switch(e.type){case"Number":t=Number(t);break;case"Boolean":t=Boolean(t)}n[o]=t,r.parentNode?.removeChild(r),n.setDirtyCanvas(!0,!0)}}prompt(e="",t,i,s,n){var o=document.createElement("div");o.is_modified=!1,o.className="graphdialog rounded",o.innerHTML=n?"<span class='name'></span> <textarea autofocus class='value'></textarea><button class='rounded'>OK</button>":"<span class='name'></span> <input autofocus type='text' class='value'/><button class='rounded'>OK</button>",o.close=()=>{this.prompt_box=null,o.parentNode?.removeChild(o)};var a=LGraphCanvas.active_canvas.canvas;a.parentNode.appendChild(o),this.ds.scale>1&&(o.style.transform=`scale(${this.ds.scale})`);var r=null;o.addEventListener("pointerleave",(e=>{LiteGraph.dialog_close_on_mouse_leave&&!o.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(r=setTimeout(o.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),o.addEventListener("pointerenter",(e=>{LiteGraph.dialog_close_on_mouse_leave&&r&&clearTimeout(r)}));const l=o.querySelectorAll("select");l&&l.forEach((e=>{e.addEventListener("click",(e=>{})),e.addEventListener("blur",(e=>{})),e.addEventListener("change",(e=>{}))})),this.prompt_box?.close(),this.prompt_box=o,o.querySelector(".name").innerText=e;var h=o.querySelector(".value");h.value=t;const p=h;p.addEventListener("keydown",(e=>{switch(o.is_modified=!0,e.keyCode){case 27:o.close();break;case 13:"textarea"!==e.target.localName&&"function"==typeof i&&(i(p.value),this.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 ENTER",p.value,e.target.localName,i),o.close();break;default:return}e.preventDefault(),e.stopPropagation()}));o.querySelector("button").addEventListener("click",(e=>{"function"==typeof i&&(i(p.value),this.setDirty(!0)),LiteGraph.log_debug("lgraphcanvas","prompt","prompt v2 OK",p.value,i),o.close()}));var c=a.getBoundingClientRect(),d=-20,u=-20;return c&&(d-=c.left,u-=c.top),s?(o.style.left=s.clientX+d+"px",o.style.top=s.clientY+u+"px"):(o.style.left=.5*a.width+d+"px",o.style.top=.5*a.height+u+"px"),setTimeout((function(){p.focus()}),10),o}showSearchBox(e,t){var i={slot_from:null,node_from:null,node_to:null,do_type_filter:LiteGraph.search_filter_enabled,type_filter_in:!1,type_filter_out:!1,show_general_if_none_on_typefilter:!0,show_general_after_typefiltered:!0,hide_on_mouse_leave:LiteGraph.search_hide_on_mouse_leave,hide_on_mouse_leave_time:LiteGraph.search_hide_on_mouse_leave_time,show_all_if_empty:!0,show_all_on_open:LiteGraph.search_show_all_on_open};if(t=Object.assign(i,t||{}),"object"==typeof e&&void 0!==e.target||void 0!==t.event&&(LiteGraph.log_debug("lgraphcanvas","showSearchBox","event not passed directly, using event from options",t.event,"first par was:",e),e=t.event),LiteGraph.log_debug("lgraphcanvas","showSearchBox",e,t),void 0===s)var s=this;else LiteGraph.log_debug("lgraphcanvas","showSearchBox","using already present graphcanvas reference",s,"this is other?",this);var n=LGraphCanvas.active_canvas,o=n.canvas,a=o.ownerDocument||document,r=document.createElement("div");if(r.className="litegraph litesearchbox graphdialog rounded",r.innerHTML="<span class='name'>Search</span> <input autofocus type='text' class='value rounded'/>",t.do_type_filter&&(r.innerHTML+="<select class='slot_in_type_filter'><option value=''></option></select>",r.innerHTML+="<select class='slot_out_type_filter'><option value=''></option></select>"),t.show_close_button&&(r.innerHTML+="<button class='close_searchbox close'>X</button>"),r.innerHTML+="<div class='helper'></div>",a.fullscreenElement?a.fullscreenElement.appendChild(r):(a.body.appendChild(r),a.body.style.overflow="hidden"),t.do_type_filter)var l=r.querySelector(".slot_in_type_filter"),h=r.querySelector(".slot_out_type_filter");if(r.close=function(){s.search_box=null,this.blur(),o.focus(),a.body.style.overflow="",setTimeout((function(){s.canvas?.focus(),s.canvas||LiteGraph.log_debug("lgraphcanvas","showSearchBox","dont have reference to canvas",s,"this is other?",this)}),20),r.parentNode&&r.parentNode.removeChild(r)},void 0!==s.ds?s.ds.scale>1&&(r.style.transform=`scale(${s.ds.scale})`):LiteGraph.log_debug("lgraphcanvas","showSearchBox","ds reference not found, is this graphcanvas or what","that",s,"this",this),t.hide_on_mouse_leave){var p=!1,c=null;r.addEventListener("pointerenter",(function(e){c&&(clearTimeout(c),c=null)})),r.addEventListener("pointerleave",(function(e){p||(c=setTimeout((function(){r.close()}),t.hide_on_mouse_leave_time))})),t.do_type_filter&&(l.addEventListener("click",(function(e){p++})),l.addEventListener("blur",(function(e){p=0})),l.addEventListener("change",(function(e){p=-1})),h.addEventListener("click",(function(e){p++})),h.addEventListener("blur",(function(e){p=0})),h.addEventListener("change",(function(e){p=-1})))}s.search_box&&s.search_box.close(),s.search_box=r;var d=r.querySelector(".helper"),u=null,g=null,_=null,v=r.querySelector("input");if(v&&(v.addEventListener("blur",(function(e){s.search_box&&this.focus()})),v.addEventListener("keydown",(function(e){if(38==e.keyCode)m(!1);else if(40==e.keyCode)m(!0);else if(27==e.keyCode)r.close();else{if(13!=e.keyCode)return g&&clearInterval(g),void(g=setTimeout(G,250));G(),_?L(_.innerHTML):u?L(u):r.close()}return e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),!0}))),t.do_type_filter){if(l){let e=LiteGraph.slot_types_in,i=e.length;t.type_filter_in!=LiteGraph.EVENT&&t.type_filter_in!=LiteGraph.ACTION||(t.type_filter_in="_event_");for(let s=0;s<i;s++){let i=document.createElement("option");i.value=e[s],i.innerHTML=e[s],l.appendChild(i),!1!==t.type_filter_in&&(t.type_filter_in+"").toLowerCase()==(e[s]+"").toLowerCase()&&(i.selected=!0)}l.addEventListener("change",(function(){G()}))}if(h){let e=LiteGraph.slot_types_out,i=e.length;t.type_filter_out!=LiteGraph.EVENT&&t.type_filter_out!=LiteGraph.ACTION||(t.type_filter_out="_event_");for(let s=0;s<i;s++){let i=document.createElement("option");i.value=e[s],i.innerHTML=e[s],h.appendChild(i),!1!==t.type_filter_out&&(t.type_filter_out+"").toLowerCase()==(e[s]+"").toLowerCase()&&(i.selected=!0)}h.addEventListener("change",(function(){G()}))}}t.show_close_button&&r.querySelector(".close").addEventListener("click",r.close);var f=o.getBoundingClientRect(),b=(e?e.clientX:f.left+.5*f.width)-80,y=(e?e.clientY:f.top+.5*f.height)-20;function L(i){if(i){if(!s||"object"!=typeof s||void 0===s.processCallbackHandlers)return void LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","that reference is wrong",s,r,this,t);let l=s.processCallbackHandlers("onSearchBoxSelection",{def_cb:s.onSearchBoxSelection},i,e,n);if(null!==l&&(!0===l||"object"==typeof l&&!0===l.return_value));else{var o=LiteGraph.searchbox_extras[i.toLowerCase()];o&&(i=o.type),n.graph.beforeChange();var a=LiteGraph.createNode(i);if(!a)return LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","failed creating the node",a),r.close(),!1;if(a.pos=n.convertEventToCanvasOffset(e),n.graph.add(a,!1,{doProcessChange:!1}),o&&o.data){if(o.data.properties)for(let e in o.data.properties)a.addProperty(e,o.data.properties[e]);if(o.data.inputs){a.inputs=[];for(let e in o.data.inputs)a.addOutput(o.data.inputs[e][0],o.data.inputs[e][1])}if(o.data.outputs){a.outputs=[];for(let e in o.data.outputs)a.addOutput(o.data.outputs[e][0],o.data.outputs[e][1])}o.data.title&&(a.title=o.data.title),o.data.json&&a.configure(o.data.json)}let s;if(t.node_from){switch(s=!1,typeof t.slot_from){case"string":s=t.node_from.findOutputSlot(t.slot_from);break;case"object":s=t.slot_from.name?t.node_from.findOutputSlot(t.slot_from.name):-1,-1==s&&void 0!==t.slot_from.slot_index&&(s=t.slot_from.slot_index);break;case"number":s=t.slot_from;break;default:s=0}void 0!==t.node_from.outputs[s]?!1!==s&&s>-1&&t.node_from.connectByType(s,a,t.node_from.outputs[s].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_from to join using from slot type",t.slot_from,t.node_from.outputs)}if(t.node_to){switch(s=!1,typeof t.slot_from){case"string":s=t.node_to.findInputSlot(t.slot_from);break;case"object":s=t.slot_from.name?t.node_to.findInputSlot(t.slot_from.name):-1,-1==s&&void 0!==t.slot_from.slot_index&&(s=t.slot_from.slot_index);break;case"number":s=t.slot_from;break;default:s=0}void 0!==t.node_to.inputs[s]?!1!==s&&s>-1&&t.node_to.connectByTypeOutput(s,a,t.node_to.inputs[s].type):LiteGraph.log_warn("lgraphcanvas","showSearchBox","select","cant find slot node_to to join using from slot type",t.slot_from,t.node_to.inputs)}n.graph.afterChange()}}r.close()}function m(e){var t=_;_&&_.classList.remove("selected"),_?(_=e?_.nextSibling:_.previousSibling)||(_=t):_=e?d.childNodes[0]:d.childNodes[d.childNodes.length],_&&(_.classList.add("selected"),_.scrollIntoView({block:"end",behavior:"smooth"}))}function G(){g=null;var e=v.value;if(u=null,d.innerHTML="",e||t.show_all_if_empty)if(s.onSearchBox){var i=s.onSearchBox(d,e,n);if(i)for(let c=0;c<i.length;++c)p(i[c])}else{var o=0;e=e.toLowerCase();var a=n.filter||n.graph.filter;let _,f;t.do_type_filter&&s.search_box?(_=s.search_box.querySelector(".slot_in_type_filter"),f=s.search_box.querySelector(".slot_out_type_filter")):(_=!1,f=!1);for(let y in LiteGraph.searchbox_extras){var r=LiteGraph.searchbox_extras[y];let m=r.desc.toLowerCase(),G=r.title?r.title.toLowerCase():"",C=e.toLowerCase().split(" "),k=!0;for(let w of C)if(""!==w.trim()&&-1==m.indexOf(w)&&-1==G.indexOf(w)){k=!1;break}if(t.show_all_if_empty&&!e||k){var l=LiteGraph.registered_node_types[r.type];if((!l||l.filter==a)&&b(r.type)&&(p(r.desc,"searchbox_extra"),-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit))break}}var h=null;if(Array.prototype.filter){h=Object.keys(LiteGraph.registered_node_types).filter(b)}else{h=[];for(let E in LiteGraph.registered_node_types)b(E)&&h.push(E)}for(let T=0;T<h.length&&(p(h[T]),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));T++);if(t.show_general_after_typefiltered&&(_.value||f.value)){let O=[];for(let N in LiteGraph.registered_node_types)b(N,{inTypeOverride:!(!_||!_.value)&&"*",outTypeOverride:!(!f||!f.value)&&"*"})&&O.push(N);for(let S=0;S<O.length&&(p(O[S],"generic_type"),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));S++);}if((_.value||f.value)&&0==d.childNodes.length&&t.show_general_if_none_on_typefilter){let I=[];for(let A in LiteGraph.registered_node_types)b(A,{skipFilter:!0})&&I.push(A);for(let x=0;x<I.length&&(p(I[x],"not_in_filter"),!(-1!==LGraphCanvas.search_limit&&o++>LGraphCanvas.search_limit));x++);}function b(i,s={}){var n=Object.assign({skipFilter:!1,inTypeOverride:!1,outTypeOverride:!1},s),o=LiteGraph.registered_node_types[i];if(a&&o.filter!=a)return!1;let r=i.toLowerCase(),l=e.toLowerCase().split(" "),h=!0;for(let e of l)if(LiteGraph.log_verbose("search","check",e,r),""!==e.trim()&&-1==r.indexOf(e)){h=!1,LiteGraph.log_verbose("search","do not pass",e,r);break}if((!t.show_all_if_empty||e)&&!h)return!1;if(t.do_type_filter&&!n.skipFilter){var p=i;let e;var c=_.value;if(!1!==n.inTypeOverride&&(c=n.inTypeOverride),_&&c&&LiteGraph.registered_slot_in_types[c]&&LiteGraph.registered_slot_in_types[c].nodes&&(e=LiteGraph.registered_slot_in_types[c].nodes.includes(p),!1===e))return!1;if(c=f.value,!1!==n.outTypeOverride&&(c=n.outTypeOverride),f&&c&&LiteGraph.registered_slot_out_types[c]&&LiteGraph.registered_slot_out_types[c].nodes&&(e=LiteGraph.registered_slot_out_types[c].nodes.includes(p),!1===e))return!1}return!0}}function p(e,t){var i=document.createElement("div");u||(u=e),i.innerText=e,i.dataset.type=escape(e),i.className="litegraph lite-search-item",t&&(i.className+=" "+t),i.addEventListener("click",(function(e){L(unescape(this.dataset.type))})),d.appendChild(i)}}return f.width-b<470&&(b=f.width-470),f.height-y<220&&(y=f.height-220),b<f.left+20&&(b=f.left+20),y<f.top+20&&(y=f.top+20),r.style.left=b+"px",r.style.top=y+"px",v.focus(),t.show_all_on_open&&G(),r}showEditPropertyValue(e,t,i){if(!e||void 0===e.properties[t])return;i=i||{};var s=e.getPropertyInfo(t);let n,o=s&&null!==s?s.type:"string";if("string"==o||"number"==o||"array"==o||"object"==o||"code"==o)n="<input autofocus type='text' class='value'/>";else if("enum"!=o&&"combo"!=o||!s.values){if("boolean"!=o&&"toggle"!=o)return void LiteGraph.log_warn("lgraphcanvas","showEditPropertyValue","unknown type",o);n="<input autofocus type='checkbox' class='value' "+(e.properties[t]?"checked":"")+"/>"}else{LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","CREATING ENUM COMBO",l,o,r),n="<select autofocus type='text' class='value'>";for(let i in s.values){var a=i;s.values.constructor===Array&&(a=s.values[i]),n+="<option value='"+a+"' "+(a==e.properties[t]?"selected":"")+">"+s.values[i]+"</option>"}n+="</select>"}var r=this.createDialog("<span class='name'>"+(s.label?s.label:t)+"</span>"+n+"<button>OK</button>",i),l=!1;function h(){p(l.value)}function p(n){s&&s.values&&s.values.constructor===Object&&null!=s.values[n]&&(n=s.values[n]),"number"==typeof e.properties[t]&&(n=Number(n)),"array"!=o&&"object"!=o||(n=JSON.parse(n));const a=e.properties[t];e.properties[t]=n,e.graph?.onGraphChanged({action:"propertyChanged",doSave:!0});let l=e.processCallbackHandlers("onPropertyChanged",{def_cb:e.onPropertyChanged},t,n,a);(!1===l||null!==l&&"object"==typeof l&&!1===l.return_value)&&(e.properties[t]=a,LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","setValue","prevent property set by cbHandler",t,n,a,l)),i.onclose&&i.onclose(),r.close(),e.setDirtyCanvas(!0,!0)}return"enum"!=o&&"combo"!=o||!s.values?"boolean"==o||"toggle"==o?(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","TOGGLE",l,o,r),(l=r.querySelector("input"))&&l.addEventListener("click",(function(e){r.modified(),p(!!l.checked)}))):(l=r.querySelector("input"),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue",l,o,r),l&&(l.addEventListener("blur",(function(e){this.focus()})),a=void 0!==e.properties[t]?e.properties[t]:"","string"!==o&&(a=JSON.stringify(a)),l.value=a,l.addEventListener("keydown",(function(e){if(27==e.keyCode)r.close();else if(13==e.keyCode)h();else if(13!=e.keyCode)return void r.modified();e.preventDefault(),e.stopPropagation()})))):(LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","showEditPropertyValue ENUM COMBO",l,o,r),(l=r.querySelector("select")).addEventListener("change",(function(e){r.modified(),LiteGraph.log_debug("lgraphcanvas","showEditPropertyValue","Enum change",l,s,e.target),p(e.target.value)}))),l&&l.focus(),r.querySelector("button").addEventListener("click",h),r}createDialog(e,t){t=Object.assign({checkForInput:!1,closeOnLeave:!0,closeOnLeave_checkModified:!0},t||{});var i=document.createElement("div");i.className="graphdialog",i.innerHTML=e,i.is_modified=!1;var s=this.canvas.getBoundingClientRect(),n=-20,o=-20;if(s&&(n-=s.left,o-=s.top),t.position?(n+=t.position[0],o+=t.position[1]):t.event?(n+=t.event.clientX,o+=t.event.clientY):(n+=.5*this.canvas.width,o+=.5*this.canvas.height),i.style.left=n+"px",i.style.top=o+"px",this.canvas.parentNode.appendChild(i),t.checkForInput){var a=[];(a=i.querySelectorAll("input"))&&a.forEach((function(e){e.addEventListener("keydown",(function(e){if(i.modified(),27==e.keyCode)i.close();else if(13!=e.keyCode)return;e.preventDefault(),e.stopPropagation()})),e.focus()}))}i.modified=function(){i.is_modified=!0},i.close=function(){i.parentNode&&i.parentNode.removeChild(i)};var r=null,l=!1;i.addEventListener("pointerleave",(function(e){l||(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&!i.is_modified&&LiteGraph.dialog_close_on_mouse_leave&&(r=setTimeout(i.close,LiteGraph.dialog_close_on_mouse_leave_delay))})),i.addEventListener("pointerenter",(function(e){(t.closeOnLeave||LiteGraph.dialog_close_on_mouse_leave)&&r&&clearTimeout(r)}));var h=i.querySelectorAll("select");return h&&h.forEach((function(e){e.addEventListener("click",(function(e){l++})),e.addEventListener("blur",(function(e){l=0})),e.addEventListener("change",(function(e){l=-1}))})),i}createPanel(e,t){var i=(t=t||{}).window||window,s=document.createElement("div");if(s.className="litegraph dialog",s.innerHTML="<div class='dialog-header'><span class='dialog-title'></span></div><div class='dialog-content'></div><div style='display:none;' class='dialog-alt-content'></div><div class='dialog-footer'></div>",s.header=s.querySelector(".dialog-header"),t.width&&(s.style.width=t.width+(t.width.constructor===Number?"px":"")),t.height&&(s.style.height=t.height+(t.height.constructor===Number?"px":"")),t.closable){var n=document.createElement("span");n.innerHTML="&#10005;",n.classList.add("close"),n.addEventListener("click",(function(){s.close()})),s.header.appendChild(n)}return s.title_element=s.querySelector(".dialog-title"),s.title_element.innerText=e,s.content=s.querySelector(".dialog-content"),s.alt_content=s.querySelector(".dialog-alt-content"),s.footer=s.querySelector(".dialog-footer"),s.close=function(){s.onClose&&"function"==typeof s.onClose&&s.onClose(),s.parentNode&&s.parentNode.removeChild(s),this.parentNode&&this.parentNode.removeChild(this)},s.toggleAltContent=function(e){let t,i;void 0!==e?(t=e?"block":"none",i=e?"none":"block"):(t="block"!=s.alt_content.style.display?"block":"none",i="block"!=s.alt_content.style.display?"none":"block"),s.alt_content.style.display=t,s.content.style.display=i},s.toggleFooterVisibility=function(e){let t;t=void 0!==e?e?"block":"none":"block"!=s.footer.style.display?"block":"none",s.footer.style.display=t},s.clear=function(){this.content.innerHTML=""},s.addHTML=function(e,t,i){var n=document.createElement("div");return t&&(n.className=t),n.innerHTML=e,i?s.footer.appendChild(n):s.content.appendChild(n),n},s.addButton=function(e,t,i){var n=document.createElement("button");return n.innerText=e,n.options=i,n.classList.add("btn"),n.addEventListener("click",t),s.footer.appendChild(n),n},s.addSeparator=function(){var e=document.createElement("div");e.className="separator",s.content.appendChild(e)},s.addWidget=function(e,t,n,o,a){o=o||{};var r=String(n);"number"==(e=e.toLowerCase())&&(r=LiteGraph.formatNumber(n,3));var l=document.createElement("div");l.className="property",l.innerHTML="<span class='property_name'></span><span class='property_value'></span>",l.querySelector(".property_name").innerText=o.label||t;var h=l.querySelector(".property_value");function p(e,t){LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","innerChange",e,t,o),o.callback&&o.callback(e,t,o),a&&a(e,t,o)}return h.innerText=r,l.dataset.property=t,l.dataset.type=o.type||e,l.options=o,l.value=n,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget",e,n,h,o),"code"==e?l.addEventListener("click",(function(e){s.inner_showCodePad(this.dataset.property)})):"boolean"==e?(l.classList.add("boolean"),n&&l.classList.add("bool-on"),l.addEventListener("click",(function(){var e=this.dataset.property;this.value=!this.value,this.classList.toggle("bool-on"),this.querySelector(".property_value").innerText=this.value?"on":"off",p(e,this.value)}))):"string"==e||"number"==e?(h.setAttribute("contenteditable",!0),h.addEventListener("keydown",(function(t){"Enter"!=t.code||"string"==e&&t.shiftKey||(t.preventDefault(),this.blur())})),h.addEventListener("blur",(function(){var e=this.innerText,t=this.parentNode.dataset.property;"number"==this.parentNode.dataset.type&&(e=Number(e)),p(t,e)}))):"enum"!=e&&"combo"!=e||(r=LGraphCanvas.getPropertyPrintableValue(n,o.values),h.innerText=r,LiteGraph.log_debug("lgraphcanvas","createPanel","addWidget","ENUM COMBO",e,r,h,o),h.addEventListener("click",(function(e){var t=o.values||[],s=this.parentNode.dataset.property,n=this;LiteGraph.ContextMenu(t,{event:e,className:"dark",callback:function(e){return n.innerText=e,p(s,e),!1}},i)}))),s.content.appendChild(l),l},s.onOpen&&"function"==typeof s.onOpen&&s.onOpen(),s}static getPropertyPrintableValue(e,t){if(!t)return String(e);if(t.constructor===Array)return String(e);if(t.constructor===Object){var i="";for(var s in t)if(t[s]==e){i=s;break}return String(e)+" ("+i+")"}}showShowGraphOptionsPanel(e,t){let i;if(this.constructor&&"HTMLDivElement"==this.constructor.name){if(!t?.event?.target?.lgraphcanvas)return LiteGraph.log_warn("lgraphcanvas","showShowGraphOptionsPanel","References not found to add optionPanel",e,t),void LiteGraph.log_debug("lgraphcanvas","showShowGraphOptionsPanel","!obEv || !obEv.event || !obEv.event.target || !obEv.event.target.lgraphcanvas",t,t.event,t.event.target,t.event.target.lgraphcanvas);i=t.event.target.lgraphcanvas}else i=this;i.closePanels();var s=i.getCanvasWindow();panel=i.createPanel("Options",{closable:!0,window:s,onOpen:function(){i.OPTIONPANEL_IS_OPEN=!0},onClose:function(){i.OPTIONPANEL_IS_OPEN=!1,i.options_panel=null}}),i.options_panel=panel,panel.id="option-panel",panel.classList.add("settings"),function(){panel.content.innerHTML="";const e=(e,t,s)=>{LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","want to update graph options: "+e+": "+t),s&&s.key&&(e=s.key),s.values&&(t=Object.values(s.values).indexOf(t)),LiteGraph.log_verbose("lgraphcanvas","showShowGraphOptionsPanel","update graph option: "+e+": "+t),i[e]=t};var t=LiteGraph.availableCanvasOptions;for(var s in t.sort(),t){var n=t[s];panel.addWidget("boolean",n,i[n],{key:n,on:"on",off:"off"},e)}panel.addWidget("combo","Render mode",LiteGraph.LINK_RENDER_MODES[i.links_render_mode],{key:"links_render_mode",values:LiteGraph.LINK_RENDER_MODES},e),panel.addSeparator(),panel.footer.innerHTML=""}(),i.canvas.parentNode.appendChild(panel)}showShowNodePanel(e){this.SELECTED_NODE=e,this.closePanels();var t=this.getCanvasWindow(),i=this,s=this.createPanel(e.title||"",{closable:!0,window:t,onOpen:function(){i.NODEPANEL_IS_OPEN=!0},onClose:function(){i.NODEPANEL_IS_OPEN=!1,i.node_panel=null}});function n(){s.content.innerHTML="",s.addHTML("<span class='node_type'>"+e.type+"</span><span class='node_desc'>"+(e.constructor.desc||"")+"</span><span class='separator'></span>"),s.addHTML("<h3>Properties</h3>");const t=(t,s)=>{switch(i.graph.beforeChange(e),t){case"Title":e.title=s;break;case"Mode":var n=Object.values(LiteGraph.NODE_MODES).indexOf(s);n>=0&&LiteGraph.NODE_MODES[n]?e.changeMode(n):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected mode",s,n);break;case"Color":LGraphCanvas.node_colors[s]?(e.color=LGraphCanvas.node_colors[s].color,e.bgcolor=LGraphCanvas.node_colors[s].bgcolor):LiteGraph.log_warn("lgraphcanvas","showShowNodePanel","unexpected color",s);break;default:e.setProperty(t,s)}i.graph.afterChange(),i.dirty_canvas=!0};s.addWidget("string","Title",e.title,{},t),s.addWidget("combo","Mode",LiteGraph.NODE_MODES[e.mode],{values:LiteGraph.NODE_MODES},t);var n="";for(var o in void 0!==e.color&&(n=Object.keys(LGraphCanvas.node_colors).filter((function(t){return LGraphCanvas.node_colors[t].color==e.color}))),s.addWidget("combo","Color",n,{values:Object.keys(LGraphCanvas.node_colors)},t),e.properties){var a=e.properties[o],r=e.getPropertyInfo(o);let i=r&&null!==r?r.type:"string";e.onAddPropertyToPanel&&e.onAddPropertyToPanel(o,s,a,r,t)||s.addWidget(r.widget||i,o,a,r,t)}s.addSeparator(),e.onShowCustomPanelInfo&&e.onShowCustomPanelInfo(s),s.footer.innerHTML="",s.addButton("Delete",(function(){e.block_delete||(e.graph.remove(e),s.close())})).classList.add("delete")}i.node_panel=s,s.id="node-panel",s.node=e,s.classList.add("settings"),s.inner_showCodePad=function(t){s.classList.remove("settings"),s.classList.add("centered"),s.alt_content.innerHTML="<textarea class='code'></textarea>";var i=s.alt_content.querySelector("textarea"),o=()=>{s.toggleAltContent(!1),s.toggleFooterVisibility(!0),i.parentNode.removeChild(i),s.classList.add("settings"),s.classList.remove("centered"),n()};i.value=e.properties[t],i.addEventListener("keydown",(function(s){"Enter"==s.code&&s.ctrlKey&&(e.setProperty(t,i.value),o())})),s.toggleAltContent(!0),s.toggleFooterVisibility(!1),i.style.height="calc(100% - 40px)";var a=s.addButton("Assign",(function(){e.setProperty(t,i.value),o()}));s.alt_content.appendChild(a);var r=s.addButton("Close",o);r.style.float="right",s.alt_content.appendChild(r)},n(),this.canvas.parentNode.appendChild(s)}showSubgraphPropertiesDialog(e){LiteGraph.log_debug("lgraphcanvas","showSubgraphPropertiesDialog","showing subgraph properties dialog");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var i=this.createPanel("Subgraph Inputs",{closable:!0,width:500});function s(){if(i.clear(),e.inputs)for(let o=0;o<e.inputs.length;++o){var t=e.inputs[o];if(!t.not_subgraph_input){var n=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");n.dataset.name=t.name,n.dataset.slot=o,n.querySelector(".name").innerText=t.name,n.querySelector(".type").innerText=t.type,n.querySelector("button").addEventListener("click",(function(t){e.removeInput(Number(this.parentNode.dataset.slot)),s()}))}}}i.node=e,i.classList.add("subgraph_dialog");return i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0).querySelector("button").addEventListener("click",(function(t){var i=this.parentNode,n=i.querySelector(".name").value,o=i.querySelector(".type").value;n&&-1==e.findInputSlot(n)&&(["event","action"].indexOf(o)>-1&&(o=LiteGraph.EVENT),e.addInput(n,o),i.querySelector(".name").value="",i.querySelector(".type").value="",s())})),s(),this.canvas.parentNode.appendChild(i),i}showSubgraphPropertiesDialogRight(e){LiteGraph.log_verbose("lgraphcanvas","showSubgraphPropertiesDialogRight","showing subgraph properties dialog RIGHT");var t=this.canvas.parentNode.querySelector(".subgraph_dialog");t&&t.close();var i=this.createPanel("Subgraph Outputs",{closable:!0,width:500});function s(){if(i.clear(),e.outputs)for(let o=0;o<e.outputs.length;++o){var t=e.outputs[o];if(!t.not_subgraph_output){var n=i.addHTML("<button>&#10005;</button> <span class='bullet_icon'></span><span class='name'></span><span class='type'></span>","subgraph_property");n.dataset.name=t.name,n.dataset.slot=o,n.querySelector(".name").innerText=t.name,n.querySelector(".type").innerText=t.type,n.querySelector("button").addEventListener("click",(function(t){e.removeOutput(Number(this.parentNode.dataset.slot)),s()}))}}}i.node=e,i.classList.add("subgraph_dialog");var n=i.addHTML(" + <span class='label'>Name</span><input class='name'/><span class='label'>Type</span><input class='type'></input><button>+</button>","subgraph_property extra",!0);function o(){var t=this.parentNode,i=t.querySelector(".name").value,n=t.querySelector(".type").value;i&&-1==e.findOutputSlot(i)&&(["event","action"].indexOf(n)>-1&&(n=LiteGraph.EVENT),e.addOutput(i,n),t.querySelector(".name").value="",t.querySelector(".type").value="",s())}return n.querySelector(".name").addEventListener("keydown",(function(e){13==e.keyCode&&o.apply(this)})),n.querySelector("button").addEventListener("click",(function(e){o.apply(this)})),s(),this.canvas.parentNode.appendChild(i),i}closePanels(){var e=document.querySelector("#node-panel");e&&e.close(),(e=document.querySelector("#option-panel"))&&e.close()}checkPanels(){if(this.canvas){var e=this.canvas.parentNode.querySelectorAll(".litegraph.dialog");for(let i=0;i<e.length;++i){var t=e[i];t.node&&(t.node.graph&&t.graph==this.graph||t.close())}}}static onMenuNodeCollapse(e,t,i,s,n){n.graph.beforeChange();var o=function(e){e.collapse()},a=LGraphCanvas.active_canvas;if(!a.selected_nodes||Object.keys(a.selected_nodes).length<=1)o(n);else for(let e in a.selected_nodes)o(a.selected_nodes[e]);n.graph.afterChange()}static onMenuNodePin(e,t,i,s,n){n.pin()}static onMenuNodeMode(e,t,i,s,n){return LiteGraph.ContextMenu(LiteGraph.NODE_MODES,{event:i,callback:function(e){if(!n)return;var t=Object.values(LiteGraph.NODE_MODES).indexOf(e);const i=i=>{t>=0&&LiteGraph.NODE_MODES[t]?i.changeMode(t):(LiteGraph.log_warn("lgraphcanvas","onMenuNodeMode","unexpected mode",e,t),i.changeMode(LiteGraph.ALWAYS))};var s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)i(n);else for(let e in s.selected_nodes)i(s.selected_nodes[e])},parentMenu:s,node:n}),!1}static onMenuNodeColors(e,t,i,s,n){if(n){var o=[];o.push({value:null,content:"<span style='display: block; padding-left: 4px;'>No color</span>"});for(let t in LGraphCanvas.node_colors){let i=LGraphCanvas.node_colors[t];e={value:t,content:"<span style='display: block; color: #999; padding-left: 4px; border-left: 8px solid "+i.color+"; background-color:"+i.bgcolor+"'>"+t+"</span>"},o.push(e)}return LiteGraph.ContextMenu(o,{event:i,callback:function(e){if(!n)return void LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","inner_clicked","no node");let t=e.value?LGraphCanvas.node_colors[e.value]:null;const i=e=>{t?e.constructor===LiteGraph.LGraphGroup?e.color=t.groupcolor:(e.color=t.color,e.bgcolor=t.bgcolor):(delete e.color,delete e.bgcolor)};var s=LGraphCanvas.active_canvas;if(!s.selected_nodes||Object.keys(s.selected_nodes).length<=1)i(n);else for(let e in s.selected_nodes)i(s.selected_nodes[e]);n.setDirtyCanvas(!0,!0)},parentMenu:s,node:n}),!1}LiteGraph.log_warn("lgraphcanvas","onMenuNodeColors","invalid node")}static onMenuNodeShapes(e,t,i,s,n){if(n)return LiteGraph.ContextMenu(LiteGraph.VALID_SHAPES,{event:i,callback:function(e){if(!n)return void LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","inner_clicked","no node");n.graph.beforeChange();const t=t=>{t.shape=e};var i=LGraphCanvas.active_canvas;if(!i.selected_nodes||Object.keys(i.selected_nodes).length<=1)t(n);else for(let e in i.selected_nodes)t(i.selected_nodes[e]);n.graph.afterChange(),n.setDirtyCanvas(!0)},parentMenu:s,node:n}),!1;LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node")}static onMenuNodeRemove(e,t,i,s,n){if(!n)return void LiteGraph.log_warn("lgraphcanvas","onMenuNodeShapes","invalid node");var o=n.graph;o.beforeChange();const a=e=>{!1!==e.removable&&o.remove(e)};var r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)a(n);else for(let e in r.selected_nodes)a(r.selected_nodes[e]);o.afterChange(),n.setDirtyCanvas(!0,!0)}static onMenuNodeToSubgraph(e,t,i,s,n){var o=n.graph,a=LGraphCanvas.active_canvas;if(a){var r=Object.values(a.selected_nodes||{});r.length||(r=[n]);var l=LiteGraph.createNode("graph/subgraph");l.pos=n.pos.concat(),o.add(l),l.buildFromNodes(r),a.deselectAllNodes(),n.setDirtyCanvas(!0,!0)}else LiteGraph.log_warn("lgraphcanvas","onMenuNodeToSubgraph","graphcanvas invalid")}static onMenuNodeClone(e,t,i,s,n){n.graph.beforeChange();var o={};const a=e=>{if(!1!==e.clonable){var t=e.clone();t&&(t.pos=[e.pos[0]+5,e.pos[1]+5],e.graph.add(t),o[t.id]=t)}};var r=LGraphCanvas.active_canvas;if(!r.selected_nodes||Object.keys(r.selected_nodes).length<=1)a(n);else for(let e in r.selected_nodes)a(r.selected_nodes[e]);Object.keys(o).length&&r.selectNodes(o),n.graph.afterChange(),n.setDirtyCanvas(!0,!0)}getCanvasMenuOptions(){var e=null;let t=this.processCallbackHandlers("getMenuOptions",{def_cb:this.getMenuOptions});return null!==t&&(!0===t||"object"==typeof t&&!0===t.return_value)||(e=[{content:"Add Node",has_submenu:!0,callback:LGraphCanvas.onMenuAdd},{content:"Search",has_submenu:!1,callback:this.showSearchBox},{content:"Add Group",callback:LGraphCanvas.onGroupAdd}],Object.keys(this.selected_nodes).length>1&&e.push({content:"Align",has_submenu:!0,callback:LGraphCanvas.onGroupAlign}),this._graph_stack&&this._graph_stack.length>0&&e.push(null,{content:"Close subgraph",callback:this.closeSubgraph.bind(this)})),t=this.processCallbackHandlers("getExtraMenuOptions",{def_cb:this.getExtraMenuOptions},this,e),null!==t&&"object"==typeof t&&"object"==typeof t.return_value&&(e=e.concat(t.return_value)),e}getNodeMenuOptions(e){var t=null;let i=e.processCallbackHandlers("getMenuOptions",{def_cb:e.getMenuOptions},this);return null!==i&&"object"==typeof i&&"object"==typeof i.return_value&&(t=i.return_value),null===t&&(t=[{content:"Inputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalInputs},{content:"Outputs",has_submenu:!0,callback:LGraphCanvas.showMenuNodeOptionalOutputs},null,{content:"Properties",has_submenu:!0,callback:LGraphCanvas.onShowMenuNodeProperties},null,{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Mode",has_submenu:!0,callback:LGraphCanvas.onMenuNodeMode}],!1!==e.resizable&&t.push({content:"Resize",callback:LGraphCanvas.onMenuResizeNode}),t.push({content:"Collapse",callback:LGraphCanvas.onMenuNodeCollapse},{content:"Pin",callback:LGraphCanvas.onMenuNodePin},{content:"Colors",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Shapes",has_submenu:!0,callback:LGraphCanvas.onMenuNodeShapes},null)),LiteGraph.do_add_triggers_slots&&(t[1].disabled=!1),i=e.processCallbackHandlers("getExtraMenuOptions",{def_cb:e.getExtraMenuOptions},this,t),null!==i&&"object"==typeof i&&"object"==typeof i.return_value&&void 0!==i.return_value.length&&i.return_value.length&&(extra.push(null),t=extra.concat(i.return_value)),!1!==e.clonable&&t.push({content:"Clone",callback:LGraphCanvas.onMenuNodeClone}),Object.keys(this.selected_nodes).length>1&&t.push({content:"Align Selected To",has_submenu:!0,callback:LGraphCanvas.onNodeAlign}),t.push(null,{content:"Remove",disabled:!(!1!==e.removable&&!e.block_delete),callback:LGraphCanvas.onMenuNodeRemove}),e.graph&&e.graph.processCallbackHandlers("onGetNodeMenuOptions",{def_cb:e.graph.onGetNodeMenuOptions},t,e),t}getGroupMenuOptions(){return[{content:"Title",callback:LGraphCanvas.onShowNodeInfoEditor},{content:"Color",has_submenu:!0,callback:LGraphCanvas.onMenuNodeColors},{content:"Font size",property:"font_size",type:"Number",callback:LGraphCanvas.onShowNodeInfoEditor},null,{content:"Remove",callback:LGraphCanvas.onMenuNodeRemove}]}processContextMenu(e,t){var i=this,s=LGraphCanvas.active_canvas.getCanvasWindow(),n=null,o={event:t,callback:function(t,s){if(!t)return;let n;if("Remove Slot"==t.content)return n=t.slot,e.graph.beforeChange(),n.input?e.removeInput(n.slot):n.output&&e.removeOutput(n.slot),void e.graph.afterChange();if("Disconnect Links"==t.content)return n=t.slot,e.graph.beforeChange(),n.output?e.disconnectOutput(n.slot):n.input&&e.disconnectInput(n.slot),void e.graph.afterChange();if("Rename Slot"==t.content){n=t.slot;var o=n.input?e.getInputInfo(n.slot):e.getOutputInfo(n.slot),a=i.createDialog("<span class='name'>Name</span><input autofocus type='text'/><button>OK</button>",s),r=a.querySelector("input");r&&o&&(r.value=o.label||"");var l=function(){e.graph.beforeChange(),r.value&&(o&&(o.label=r.value),i.setDirty(!0)),a.close(),e.graph.afterChange()};a.querySelector("button").addEventListener("click",l),r.addEventListener("keydown",(function(e){if(a.is_modified=!0,27==e.keyCode)a.close();else if(13==e.keyCode)l();else if(13!=e.keyCode&&"textarea"!=e.target.localName)return;e.preventDefault(),e.stopPropagation()})),r.focus()}},extra:e};e&&(o.title=e.type);var a=null;if(e&&(a=e.getSlotInPosition(t.canvasX,t.canvasY),LGraphCanvas.active_node=e),a){n=[];let t=e.processCallbackHandlers("getSlotMenuOptions",{def_cb:e.getSlotMenuOptions},a);if(null!==t&&"object"==typeof t&&"object"==typeof t.return_value)n=t.return_value;else{(a?.output?.links?.length||a.input?.link)&&n.push({content:"Disconnect Links",slot:a});var r=a.input||a.output;r.removable&&LiteGraph.canRemoveSlots&&n.push(r.locked?"Cannot remove":{content:"Remove Slot",slot:a}),!r.nameLocked&&LiteGraph.canRenameSlots&&n.push({content:"Rename Slot",slot:a})}var l=a.input||a.output;o.title=l.type||"*",l.type==LiteGraph.ACTION?o.title="Action":l.type==LiteGraph.EVENT&&(o.title="Event")}else if(e)n=this.getNodeMenuOptions(e);else{n=this.getCanvasMenuOptions();var h=this.graph.getGroupOnPos(t.canvasX,t.canvasY);o.filter_enabled=!1,h&&(n.push(null,{content:"Edit Group",has_submenu:!0,submenu:{title:"Group",extra:h,options:this.getGroupMenuOptions(h)}}),n.push(null,{content:"Select nodes",canvas:this,group:h,callback:function(e,t,i,s){console.warn(e),e.canvas.selectNodes(e.group._nodes)}}))}n&&LiteGraph.ContextMenu(n,o,s)}static DEFAULT_BACKGROUND_IMAGE="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAABkCAIAAAD/gAIDAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQBJREFUeNrs1rEKwjAUhlETUkj3vP9rdmr1Ysammk2w5wdxuLgcMHyptfawuZX4pJSWZTnfnu/lnIe/jNNxHHGNn//HNbbv+4dr6V+11uF527arU7+u63qfa/bnmh8sWLBgwYJlqRf8MEptXPBXJXa37BSl3ixYsGDBMliwFLyCV/DeLIMFCxYsWLBMwSt4Be/NggXLYMGCBUvBK3iNruC9WbBgwYJlsGApeAWv4L1ZBgsWLFiwYJmCV/AK3psFC5bBggULloJX8BpdwXuzYMGCBctgwVLwCl7Be7MMFixYsGDBsu8FH1FaSmExVfAxBa/gvVmwYMGCZbBg/W4vAQYA5tRF9QYlv/QAAAAASUVORK5CYII=";static link_type_colors={"-1":"#A86",number:"#AAA",node:"#DCA",string:"#77F",boolean:"#F77"};static gradients={};static search_limit=-1;static node_colors={red:{color:"#322",bgcolor:"#533",groupcolor:"#A88"},brown:{color:"#332922",bgcolor:"#593930",groupcolor:"#b06634"},green:{color:"#232",bgcolor:"#353",groupcolor:"#8A8"},blue:{color:"#223",bgcolor:"#335",groupcolor:"#88A"},pale_blue:{color:"#2a363b",bgcolor:"#3f5159",groupcolor:"#3f789e"},cyan:{color:"#233",bgcolor:"#355",groupcolor:"#8AA"},purple:{color:"#323",bgcolor:"#535",groupcolor:"#a1309b"},yellow:{color:"#432",bgcolor:"#653",groupcolor:"#b58b2a"},black:{color:"#222",bgcolor:"#000",groupcolor:"#444"}};lowQualityRenderingRequired(e){return this.ds.scale<e&&this.low_quality_rendering_counter>this.low_quality_rendering_threshold}updateBackground(e,t){this._bg_img=new Image,this._bg_img.name=e,this._bg_img.src=e,this._bg_img.onload=()=>{this.draw(!0,!0)},this.background_image=e,this.clear_background=!0,this.clear_background_color=t,this._pattern=null}}var temp=new Float32Array(4),temp_vec2=new Float32Array(2),tmp_area=new Float32Array(4),margin_area=new Float32Array(4),link_bounding=new Float32Array(4),tempA=new Float32Array(2),tempB=new Float32Array(2);class LGraph{static supported_types=["number","string","boolean"];static STATUS_STOPPED=1;static STATUS_RUNNING=2;constructor(e){LiteGraph.log_debug("Graph created",e),this.list_of_graphcanvas=null,this.callbackhandler_setup(),this.clear(),e&&this.configure(e),LiteGraph.processCallbackHandlers("on_lgraph_construct",{def_cb:LiteGraph.on_lgraph_construct},this)}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler.processCallbackHandlers(...arguments)}getSupportedTypes(){return this.supported_types??LGraph.supported_types}clear(){this.stop(),this.status=LGraph.STATUS_STOPPED,this.last_node_id=0,this.last_link_id=0,this._version=-1,this._nodes?.forEach((e=>{e.processCallbackHandlers("onRemoved",{def_cb:e.onRemoved})})),this._nodes=[],this._nodes_by_id={},this._nodes_in_order=[],this._nodes_executable=null,this._groups=[],this.links={},this.iteration=0,this.config={},this.configApplyDefaults(),this.vars={},this.extra={},this.globaltime=0,this.runningtime=0,this.fixedtime=0,this.fixedtime_lapse=.01,this.elapsed_time=.01,this.last_update_time=0,this.starttime=0,this.catch_errors=!0,this.history={actionHistory:[],actionHistoryVersions:[],actionHistoryPtr:0},this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[],this.inputs={},this.outputs={},this.change(),this.sendActionToCanvas("clear")}configApply(e){this.config=Object.assign(this.config,e)}configApplyDefaults(){var e=LiteGraph.graphDefaultConfig;this.configApply(e)}attachCanvas(e){if(!(e instanceof LGraphCanvas))throw new Error("attachCanvas expects a LiteGraph.LGraphCanvas instance");e.graph&&e.graph!=this&&(LiteGraph.log_debug("lgraph","attachCanvas","detaching previous"),e.graph.detachCanvas(e)),e.graph=this,this.list_of_graphcanvas??=[],-1==this.list_of_graphcanvas.indexOf(e)?(LiteGraph.log_debug("lgraph","attachCanvas","attaching canvas"),this.list_of_graphcanvas.push(e)):LiteGraph.log_debug("lgraph","attachCanvas","canvas was already attached")}detachCanvas(e){if(this.list_of_graphcanvas){var t=this.list_of_graphcanvas.indexOf(e);-1!=t&&(LiteGraph.log_debug("lgraph","detachCanvas",t,this.list_of_graphcanvas,this),this.list_of_graphcanvas.splice(t,1))}}getCanvas(){if(this.list_of_graphcanvas)return this.list_of_graphcanvas[0]}start(e=0){if(this.status===LGraph.STATUS_RUNNING)return;this.status=LGraph.STATUS_RUNNING,this.processCallbackHandlers("onPlayEvent",{def_cb:this.onPlayEvent}),this.sendEventToAllNodes("onStart"),this.starttime=LiteGraph.getTime(),this.last_update_time=this.starttime;const t=()=>{-1===this.execution_timer_id&&(window.requestAnimationFrame(t),this.processCallbackHandlers("onBeforeStep",{def_cb:this.onBeforeStep}),this.runStep(1,!this.catch_errors),this.processCallbackHandlers("onAfterStep",{def_cb:this.onAfterStep}))};0===e&&"object"==typeof window&&window.requestAnimationFrame?(this.execution_timer_id=-1,t()):this.execution_timer_id=setInterval((()=>{this.processCallbackHandlers("onBeforeStep",{def_cb:this.onBeforeStep}),this.runStep(1,!this.catch_errors),this.processCallbackHandlers("onAfterStep",{def_cb:this.onAfterStep})}),e)}stop(){this.status!=LGraph.STATUS_STOPPED&&(this.status=LGraph.STATUS_STOPPED,this.processCallbackHandlers("onStopEvent",{def_cb:this.onStopEvent}),null!=this.execution_timer_id&&(-1!=this.execution_timer_id&&clearInterval(this.execution_timer_id),this.execution_timer_id=null),this.sendEventToAllNodes("onStop"))}runStep(e=1,t,i){var s=LiteGraph.getTime();this.globaltime=.001*(s-this.starttime);var n=this._nodes_executable??this._nodes;if(n){if(i||=n.length,t){for(let t=0;t<e;t++)n.forEach((e=>{LiteGraph.use_deferred_actions&&e._waiting_actions?.length&&e.executePendingActions(),e.mode===LiteGraph.ALWAYS&&e.doExecute?.()})),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute})}else try{for(let t=0;t<e;t++)n.forEach((e=>{LiteGraph.use_deferred_actions&&e._waiting_actions?.length&&e.executePendingActions(),e.mode===LiteGraph.ALWAYS&&e.doExecute?.()})),this.fixedtime+=this.fixedtime_lapse,this.processCallbackHandlers("onExecuteStep",{def_cb:this.onExecuteStep});this.processCallbackHandlers("onAfterExecute",{def_cb:this.onAfterExecute}),this.errors_in_execution=!1}catch(e){if(this.errors_in_execution=!0,LiteGraph.throw_errors)throw e;LiteGraph.log_warn("lgraph","Error during execution",e),this.stop()}var o=LiteGraph.getTime(),a=o-s;0==a&&(a=1),this.execution_time=.001*a,this.globaltime+=.001*a,this.iteration+=1,this.elapsed_time=.001*(o-this.last_update_time),this.last_update_time=o,this.nodes_executing=[],this.nodes_actioning=[],this.node_ancestorsCalculated=[],this.nodes_executedAction=[]}}updateExecutionOrder(){this._nodes_in_order=this.computeExecutionOrder(!1),this._nodes_executable=[];for(var e=0;e<this._nodes_in_order.length;++e)this._nodes_in_order[e].onExecute&&this._nodes_executable.push(this._nodes_in_order[e])}computeExecutionOrder(e,t){var i=[],s=[],n={},o={},a={};for(let i=0,o=this._nodes.length;i<o;++i){let o=this._nodes[i];if(!e||o.onExecute){n[o.id]=o;var r=0;if(o.inputs)for(var l=0,h=o.inputs.length;l<h;l++)o.inputs[l]&&null!=o.inputs[l].link&&(r+=1);0==r?(s.push(o),t&&(o._level=1)):(t&&(o._level=0),a[o.id]=r)}}for(;0!=s.length;){var p=s.shift();if(i.push(p),delete n[p.id],p.outputs)for(let e=0;e<p.outputs.length;e++){let i=p.outputs[e];if(null!=i&&null!=i.links&&0!=i.links.length)for(let e=0;e<i.links.length;e++){let n=i.links[e],r=this.links[n];if(!r)continue;if(o[r.id])continue;let l=this.getNodeById(r.target_id);null!=l?(t&&(!l._level||l._level<=p._level)&&(l._level=p._level+1),o[r.id]=!0,a[l.id]-=1,0==a[l.id]&&s.push(l)):o[r.id]=!0}}}for(let e in n)i.push(n[e]);i.length!=this._nodes.length&&LiteGraph.debug&&LiteGraph.log_warn("lgraph","computeExecutionOrder","something went wrong, nodes missing");var c=i.length;for(let e=0;e<c;++e)i[e].order=e;i=i.sort(((e,t)=>{let i=e.constructor.priority||e.priority||0,s=t.constructor.priority||t.priority||0;return i==s?e.order-t.order:i-s}));for(let e=0;e<c;++e)i[e].order=e;return i}getAncestors(e,t={}){for(var i=Object.assign({modesSkip:[],modesOnly:[],typesSkip:[],typesOnly:[]},t),s=[],n=[],o=[e],a={};o.length;){var r=o.shift();if(r&&!a[r.id]){if(a[r.id]=!0,r.id!=e.id){if(i.modesSkip&&i.modesSkip.length&&-1!=i.modesSkip.indexOf(r.mode))continue;if(i.modesOnly&&i.modesOnly.length&&-1==i.modesOnly.indexOf(r.mode))continue;-1==n.indexOf(r.id)&&(s.push(r),n.push(r.id))}if(r.inputs)for(var l=0;l<r.inputs.length;++l){var h=r.getInputNode(l);if(h){var p=r.inputs[l].type;i.typesSkip&&i.typesSkip.length&&-1!=i.typesSkip.indexOf(p)||i.typesOnly&&i.typesOnly.length&&-1==i.typesOnly.indexOf(h.mode)||-1==n.indexOf(h.id)&&(a[h.id]||o.push(h))}}}}return s.sort(((e,t)=>e.order-t.order)),s}arrange(e=100,t){const i=this.computeExecutionOrder(!1,!0),s=[];for(let e=0;e<i.length;++e){const t=i[e],n=t._level||1;s[n]??=[],s[n].push(t)}let n=e;for(let i=0;i<s.length;++i){const o=s[i];if(!o)continue;let a=100,r=e+LiteGraph.NODE_TITLE_HEIGHT;for(let i=0;i<o.length;++i){const s=o[i];s.pos[0]=t==LiteGraph.VERTICAL_LAYOUT?r:n,s.pos[1]=t==LiteGraph.VERTICAL_LAYOUT?n:r;const l=t==LiteGraph.VERTICAL_LAYOUT?1:0;s.size[l]>a&&(a=s.size[l]);const h=t==LiteGraph.VERTICAL_LAYOUT?0:1;r+=s.size[h]+e+LiteGraph.NODE_TITLE_HEIGHT}n+=a+e}this.setDirtyCanvas(!0,!0)}getTime(){return this.globaltime}getFixedTime(){return this.fixedtime}getElapsedTime(){return this.elapsed_time}sendEventToAllNodes(e,t,i=LiteGraph.ALWAYS){var s=this._nodes_in_order?this._nodes_in_order:this._nodes;if(s)for(let n=0,o=s.length;n<o;++n){const o=s[n];o.constructor!==LiteGraph.Subgraph||"onExecute"===e?"function"==typeof o[e]&&o.mode===i&&(void 0===t?o[e]():Array.isArray(t)?o[e].apply(o,t):o[e](t)):o.mode==i&&o.sendEventToAllNodes(e,t,i)}}sendActionToCanvas(e,t){if(this.list_of_graphcanvas)for(const i of this.list_of_graphcanvas)"function"==typeof i[e]&&i[e]&&t&&i[e](...t)}add(e,t,i={}){var s=Object.assign({doProcessChange:!0,doCalcSize:!0},i);if(e){if(e.constructor===LiteGraph.LGraphGroup)return this._groups.push(e),this.setDirtyCanvas(!0),this.change(),e.graph=this,void this.onGraphChanged({action:"groupAdd",doSave:s.doProcessChange});if(-1!=e.id&&null!=this._nodes_by_id[e.id]&&(LiteGraph.log_debug("lgraph","add","there is already a node with this ID, changing it",e),LiteGraph.use_uuids?e.id=LiteGraph.uuidv4():e.id=++this.last_node_id),!(LiteGraph.MAX_NUMBER_OF_NODES>0&&this._nodes.length>=LiteGraph.MAX_NUMBER_OF_NODES))return LiteGraph.use_uuids?null!=e.id&&-1!=e.id||(e.id=LiteGraph.uuidv4()):null==e.id||-1==e.id?e.id=++this.last_node_id:this.last_node_id<e.id&&(this.last_node_id=e.id),e.graph=this,this.onGraphChanged({action:"nodeAdd",doSave:s.doProcessChange}),this._nodes.push(e),this._nodes_by_id[e.id]=e,e.processCallbackHandlers("onAdded",{def_cb:e.onAdded},this),this.config.align_to_grid&&e.alignToGrid(),t||this.updateExecutionOrder(),this.processCallbackHandlers("onNodeAdded",{def_cb:this.onNodeAdded},e),s.doCalcSize&&e.setSize(e.computeSize()),this.setDirtyCanvas(!0),this.change(),e;LiteGraph.log_error("lgraph","add","max number of nodes in a graph reached",LiteGraph.MAX_NUMBER_OF_NODES)}}remove(e){if(e.constructor===LiteGraph.LGraphGroup){var t=this._groups.indexOf(e);return-1!=t&&this._groups.splice(t,1),e.graph=null,this.onGraphChanged({action:"groupRemove"}),this.setDirtyCanvas(!0,!0),void this.change()}if(null!=this._nodes_by_id[e.id]&&!e.ignore_remove){if(e.inputs)for(let t=0;t<e.inputs.length;t++){null!=e.inputs[t].link&&e.disconnectInput(t,{doProcessChange:!1})}if(e.outputs)for(let t=0;t<e.outputs.length;t++){let i=e.outputs[t];null!=i.links&&i.links.length&&e.disconnectOutput(t,!1,{doProcessChange:!1})}if(e.processCallbackHandlers("onRemoved",{def_cb:e.onRemoved},this),e.graph=null,this.list_of_graphcanvas)for(let t=0;t<this.list_of_graphcanvas.length;++t){let i=this.list_of_graphcanvas[t];i.selected_nodes[e.id]&&delete i.selected_nodes[e.id],i.node_dragged==e&&(i.node_dragged=null)}var i=this._nodes.indexOf(e);-1!=i&&this._nodes.splice(i,1),delete this._nodes_by_id[e.id],this.processCallbackHandlers("onNodeRemoved",{def_cb:this.onNodeRemoved},e),this.onGraphChanged({action:"nodeRemove"}),this.sendActionToCanvas("checkPanels"),this.setDirtyCanvas(!0,!0),this.change(),this.updateExecutionOrder()}}getNodeById(e){return null==e?null:this._nodes_by_id[e]}findNodesByClass(e,t=[]){return this._nodes.filter((t=>t.constructor===e))}findNodesByType(e,t=[]){const i=e.toLowerCase();return this._nodes.filter((e=>e.type.toLowerCase()===i))}findNodeByTitle(e){return this._nodes.find((t=>t.title===e))??null}findNodesByTitle(e){return this._nodes.filter((t=>t.title===e))}getNodeOnPos(e,t,i=this._nodes,s=0){return i.reverse().find((i=>i.isPointInside(e,t,s)))??null}getGroupOnPos(e,t){let i=this._groups.filter(((i,s)=>i.isPointInside(e,t,2,!0)));if(!i.length)return null;LiteGraph.log_verbose("lgraph","getGroupOnPos","matching groups by x,y",e,t,i);let s=i.sort(((e,i)=>Math.abs(e._pos[1]-t)>Math.abs(i._pos[1]-t)));return LiteGraph.log_verbose("lgraph","getGroupOnPos","sorted groups y distance",s),s[0]}checkNodeTypes(){for(var e=0;e<this._nodes.length;e++){var t=this._nodes[e],i=LiteGraph.registered_node_types[t.type];if(t.constructor!=i){LiteGraph.log_debug("lgraph","checkNodeTypes","node being replaced by newer version",t.type);var s=LiteGraph.createNode(t.type);this._nodes[e]=s,s.configure(t.serialize()),s.graph=this,this._nodes_by_id[s.id]=s,t.inputs&&(s.inputs=t.inputs.concat()),t.outputs&&(s.outputs=t.outputs.concat())}}this.updateExecutionOrder()}onAction(e,t,i){this._input_nodes=this.findNodesByClass(LiteGraph.GraphInput,this._input_nodes),LiteGraph.log_debug("lgraph","onAction","will trigger actionDo on input nodes",this._input_nodes,"with name(?!)",...arguments);for(var s=0;s<this._input_nodes.length;++s){var n=this._input_nodes[s];if(n.properties.name==e){LiteGraph.log_debug("lgraph","onAction",n,"node actionDo",...arguments),n.actionDo(e,t,i);break}}}trigger(e,t){LiteGraph.log_debug("lgraph","trigger",e,t),this.processCallbackHandlers("onTrigger",{def_cb:this.onTrigger},e,t)}addInput(e,t,i){this.inputs[e]||(this.beforeChange(),this.inputs[e]={name:e,type:t,value:i},this.onGraphChanged({action:"addInput"}),this.afterChange(),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}setInputData(e,t){var i=this.inputs[e];i&&(i.value=t)}getInputData(e){var t=this.inputs[e];return t?t.value:null}renameInput(e,t){if(t!=e){if(!this.inputs[e])return!1;if(this.inputs[t])return LiteGraph.log_error("lgraph","renameInut","there is already one input with that name"),!1;this.inputs[t]=this.inputs[e],delete this.inputs[e],this.onGraphChanged({action:"renameInput"}),this.processCallbackHandlers("onInputRenamed",{def_cb:this.onInputRenamed},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})}}changeInputType(e,t){if(!this.inputs[e])return!1;this.inputs[e].type&&String(this.inputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.inputs[e].type=t,this.onGraphChanged({action:"changeInputType"}),this.processCallbackHandlers("onInputTypeChanged",{def_cb:this.onInputTypeChanged},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}removeInput(e){return!!this.inputs[e]&&(delete this.inputs[e],this.onGraphChanged({action:"graphRemoveInput"}),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},e),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}addOutput(e,t,i){this.outputs[e]={name:e,type:t,value:i},this.onGraphChanged({action:"addOutput"}),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})}setOutputData(e,t){var i=this.outputs[e];i&&(i.value=t)}getOutputData(e){var t=this.outputs[e];return t?t.value:null}renameOutput(e,t){return!!this.outputs[e]&&(this.outputs[t]?(LiteGraph.log_error("lgraph","renameOutput","there is already one output with that name"),!1):(this.outputs[t]=this.outputs[e],delete this.outputs[e],this._version++,this.processCallbackHandlers("onOutputRenamed",{def_cb:this.onOutputRenamed},e,t),void this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange})))}changeOutputType(e,t){if(!this.outputs[e])return!1;this.outputs[e].type&&String(this.outputs[e].type).toLowerCase()==String(t).toLowerCase()||(this.outputs[e].type=t,this.onGraphChanged({action:"changeOutputType"}),this.processCallbackHandlers("onOutputTypeChanged",{def_cb:this.onOutputTypeChanged},e,t),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}))}removeOutput(e){return!!this.outputs[e]&&(delete this.outputs[e],this.onGraphChanged({action:"removeOutput"}),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},e),this.processCallbackHandlers("onInputsOutputsChange",{def_cb:this.onInputsOutputsChange}),!0)}triggerInput(e,t){for(var i=this.findNodesByTitle(e),s=0;s<i.length;++s)i[s].onTrigger(t)}setCallback(e,t){for(var i=this.findNodesByTitle(e),s=0;s<i.length;++s)i[s].setTrigger(t)}beforeChange(e){this.processCallbackHandlers("onBeforeChange",{def_cb:this.onBeforeChange},this,e),this.sendActionToCanvas("onBeforeChange",this)}afterChange(e){this.processCallbackHandlers("onAfterChange",{def_cb:this.onAfterChange},this,e),this.sendActionToCanvas("onAfterChange",this)}connectionChange(e){this.updateExecutionOrder(),this.processCallbackHandlers("onConnectionChange",{def_cb:this.onConnectionChange},e),this.onGraphChanged({action:"connectionChange",doSave:!1}),this.sendActionToCanvas("onConnectionChange")}isLive(){if(!this.list_of_graphcanvas)return!1;for(var e=0;e<this.list_of_graphcanvas.length;++e){if(this.list_of_graphcanvas[e].live_mode)return!0}return!1}clearTriggeredSlots(){for(var e in this.links){var t=this.links[e];t&&(t._last_time&&=0)}}change(){LiteGraph.log_verbose("lgraph","change","Graph visually changed"),this.sendActionToCanvas("setDirty",[!0,!0]),this.processCallbackHandlers("on_change",{def_cb:this.on_change},this)}setDirtyCanvas(e,t){this.sendActionToCanvas("setDirty",[e,t])}removeLink(e){var t=this.links[e];if(t){var i=this.getNodeById(t.target_id);i&&(this.beforeChange(),i.disconnectInput(t.target_slot),this.afterChange())}}serialize(){const e=this._nodes.map((e=>e.serialize()));var t=[];for(var i in this.links){var s=this.links[i];if(!s.serialize){LiteGraph.log_warn("lgraph","serialize","weird LLink bug, link info is not a LLink but a regular object");var n=new LLink;for(var o in s)n[o]=s[o];this.links[i]=n,s=n}t.push(s.serialize())}const a=this._groups.map((e=>e.serialize()));var r={last_node_id:this.last_node_id,last_link_id:this.last_link_id,nodes:e,links:t,groups:a,config:this.config,extra:this.extra,version:LiteGraph.VERSION};return this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},r),LiteGraph.log_verbose("lgraph","serialize",r),r}configure(e,t){if(e){t||this.clear();var i=e.nodes;if(e.links&&e.links.constructor===Array){for(var s=[],n=0;n<e.links.length;++n){var o=e.links[n];if(o){var a=new LLink;a.configure(o),s[a.id]=a}else LiteGraph.log_warn("lgraph","configure","serialized graph link data contains errors, skipping.",o,n,e.links)}e.links=s}for(let t in e)["nodes","groups"].includes(t)||(this[t]=e[t]);var r=!1;if(this._nodes=[],i){for(let e=0,t=i.length;e<t;++e){var l=i[e],h=LiteGraph.createNode(l.type,l.title);h||(LiteGraph.log_warn("lgraph","configure","Node not found or has errors",l.type,l),(h=new LiteGraph.LGraphNode).last_serialization=l,h.has_errors=!0,r=!0),h.id=l.id,this.add(h,!0,{doProcessChange:!1})}i.forEach((e=>{const t=this.getNodeById(e.id);t?.configure(e)}))}return this._groups.length=0,e.groups&&e.groups.forEach((e=>{const t=new LiteGraph.LGraphGroup;t.configure(e),this.add(t,!0,{doProcessChange:!1})})),this.updateExecutionOrder(),this.extra=e.extra??{},this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},e),e._version?LiteGraph.log_debug("lgraph","configure","skip onGraphChanged when configure passing version too!"):this.onGraphChanged({action:"graphConfigure",doSave:!1}),this.setDirtyCanvas(!0,!0),r}}load(e,t){var i=this;if(e.constructor===File||e.constructor===Blob){var s=new FileReader;return s.addEventListener("load",(e=>{var s=JSON.parse(e.target.result);i.configure(s),t?.()})),void s.readAsText(e)}var n=new XMLHttpRequest;n.open("GET",e,!0),n.send(null),n.onload=e=>{if(200===n.status){var s=JSON.parse(n.response);i.configure(s),t?.()}else LiteGraph.log_error("Error loading graph:",n.status,n.response)},n.onerror=e=>{LiteGraph.log_error("Error loading graph:",e)}}onGraphSaved(e={}){var t=Object.assign({},e);LiteGraph.log_debug("onGraphSaved",t),this.savedVersion=this._version}onGraphLoaded(e={}){var t=Object.assign({},e);LiteGraph.log_debug("onGraphLoaded",t),this.savedVersion=this._version}onGraphChanged(e={}){var t=Object.assign({action:"",doSave:!0,doSaveGraph:!0},e);if(this._version++,t.action?LiteGraph.log_debug("Graph change",t.action):LiteGraph.log_debug("Graph change, no action",t),t.doSave&&LiteGraph.actionHistory_enabled){LiteGraph.log_debug("LG_history","onGraphChanged SAVE :: "+t.action);var i={actionName:t.action};t.doSaveGraph&&(i=Object.assign(i,{graphSave:this.serialize()}));for(var s=this.history;s.actionHistoryPtr<s.actionHistoryVersions.length-1;)LiteGraph.log_debug("LG_history","popping: gone back? "+s.actionHistoryPtr+" < "+(s.actionHistoryVersions.length-1)),s.actionHistoryVersions.pop();if(s.actionHistoryVersions.length>=LiteGraph.actionHistoryMaxSave){var n=s.actionHistoryVersions.shift();LiteGraph.log_debug("LG_history","maximum saves reached: "+s.actionHistoryVersions.length+", remove older: "+n),s.actionHistory[n]=!1}s.actionHistoryPtr=s.actionHistoryVersions.length,s.actionHistoryVersions.push(s.actionHistoryPtr),s.actionHistory[s.actionHistoryPtr]=i,this.onGraphSaved({iVersion:s.actionHistoryPtr}),LiteGraph.log_debug("LG_history","saved: "+s.actionHistoryPtr,i.actionName)}}actionHistoryBack(e={}){var t=Object.assign({steps:1},e),i=this.history;return null!=i.actionHistoryPtr&&i.actionHistoryPtr>=0?(i.actionHistoryPtr-=t.steps,LiteGraph.log_debug("LG_history","step back: "+i.actionHistoryPtr),this.actionHistoryLoad({iVersion:i.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded back: "+i.actionHistoryPtr),LiteGraph.log_debug(this.history),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+i.actionHistoryPtr),i.actionHistoryPtr+=t.steps,!1)):(LiteGraph.log_debug("LG_history","is already at older state"),!1)}actionHistoryForward(e={}){var t=Object.assign({steps:1},e),i=this.history;return i.actionHistoryPtr<i.actionHistoryVersions.length?(i.actionHistoryPtr+=t.steps,LiteGraph.log_debug("LG_history","step forward: "+i.actionHistoryPtr),this.actionHistoryLoad({iVersion:i.actionHistoryPtr})?(LiteGraph.log_debug("LG_history","loaded forward: "+i.actionHistoryPtr),!0):(LiteGraph.log_warn("LG_history","Load failed, restore pointer? "+i.actionHistoryPtr),i.actionHistoryPtr-=t.steps,!1)):(LiteGraph.log_debug("LG_history","is already at newer state"),!1)}actionHistoryLoad(e={}){var t=Object.assign({iVersion:!1,backStep:!1},e),i=this.history;if(i.actionHistory[t.iVersion]&&i.actionHistory[t.iVersion].graphSave){var s=JSON.stringify(this.history);return this.configure(i.actionHistory[t.iVersion].graphSave),this.history=JSON.parse(s),LiteGraph.log_debug("history loaded: "+t.iVersion,i.actionHistory[t.iVersion].actionName),this.onGraphLoaded({iVersion:t.iVersion}),!0}return!1}autoConnectNodes(e,t,i={}){var s=Object.assign({keep_alredy_connected:!0},i);if(!(e&&t&&e.outputs&&e.outputs.length&&t.inputs&&t.inputs.length))return!1;for(let i=0;i<e.outputs.length;i++){let n=e.outputs[i];!s.keep_alredy_connected&&null!==n.links&&n.links.length>0||e.connectByType(i,t,n.type,{preferFreeSlot:!0})}}updateNodeLinks(e,t,i,s){for(var n in LiteGraph.log_debug("lgraph","updateNodeLinks","looking for links",e.id,t,i,s),this.links){var o=this.links[n];null!==o&&o&&(t?o.target_id==e.id&&o.target_slot==i&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link input",this.links[n],e,t,i,s),this.links[n].target_slot=s):o.origin_id==e.id&&o.origin_slot==i&&(LiteGraph.log_debug("lgraph","updateNodeLinks","updating link output",this.links[n],e,t,i,s),this.links[n].origin_slot=s))}}}class LGraphNode{cb_handler=!1;constructor(e=""){LiteGraph.log_verbose("lgraphNODE","ORIGINAL constructor",this,e),this.title=e,this.post_constructor(...arguments)}post_constructor(){this.size??=LiteGraph.NODE_MIN_SIZE,this.size_basic??=this.size,this.graph??=null,this._pos??=new Float32Array(10,10),LiteGraph.use_uuids?this.id??=LiteGraph.uuidv4():this.id??=-1,this.type??=null,this.inputs??=[],this.outputs??=[],this.connections??=[],this.properties??={},this.properties_info??=[],this.flags??={},this.callbackhandler_setup(),this.processCallbackHandlers("onPostConstruct",{def_cb:this.onPostConstruct}),LiteGraph.processCallbackHandlers("on_lgraphnode_construct",{def_cb:LiteGraph.on_lgraphnode_construct},this)}callbackhandler_setup(){this.cb_handler||(this.cb_handler=new CallbackHandler(this))}registerCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}set pos(e){!e||e.length<2||(this._pos??=new Float32Array(10,10),this._pos[0]=e[0],this._pos[1]=e[1])}get pos(){return this._pos}configure(e){LiteGraph.log_debug("lgraphnode","configure",this,e),this.graph&&this.graph.onGraphChanged({action:"nodeBeforeConfigure",doSave:!1}),Object.entries(e).forEach((([t,i])=>{if("properties"!==t)if(!LiteGraph.reprocess_slot_while_node_configure||"inputs"!==t&&"outputs"!==t)null!==i?"object"==typeof i?this[t]&&"function"==typeof this[t].configure?(this[t].configure(i),LiteGraph.log_verbose("lgraphnode","configure","use var internal configure method",t,i)):(LiteGraph.log_verbose("lgraphnode","configure","set ob var key",t,i,this[t]),this[t]=LiteGraph.cloneObject(i,this[t])):(LiteGraph.log_verbose("lgraphnode","configure","set node var",t,i),this[t]=i):LiteGraph.log_verbose("lgraphnode","configure","should copy null value key? probably should",t,this[t]);else{LiteGraph.log_debug("lgraphnode","syncObjectByProperty",t,e[t],this[t]);const i=this.syncObjectByProperty(e[t],this[t],"name");if(this[t]=i.ob_dest,i.keys_remap&&Object.keys(i.keys_remap).length&&this.graph)for(let e in i.keys_remap){let s=i.keys_remap[e];this.graph.updateNodeLinks(this,"inputs"===t,e,s)}}else for(var s in i)this.properties[s]=i[s],this.processCallbackHandlers("onPropertyChanged",{def_cb:this.onPropertyChanged},s,i[s])})),e.title||(this.title=this.constructor.title),this.inputs?.forEach(((e,t)=>{if(!e.link)return;const i=this.graph?this.graph.links[e.link]:null;this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.INPUT,t,!0,i,e),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},e)})),this.outputs?.forEach(((e,t)=>{e.links&&(e.links.forEach(((t,i)=>{const s=this.graph?.links[t]||null;LiteGraph.log_verbose("lgraphnode","configure","cycle outputlinks",t,i,s),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,i,!0,s,e)})),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},e))})),this.widgets&&(this.widgets.forEach((e=>{e&&e.options&&e.options.property&&void 0!==this.properties[e.options.property]&&(e.value=JSON.parse(JSON.stringify(this.properties[e.options.property])))})),e.widgets_values?.forEach(((e,t)=>{this.widgets[t]&&(this.widgets[t].value=e)}))),this.processCallbackHandlers("onConfigure",{def_cb:this.onConfigure},e),this.graph?.onGraphChanged({action:"nodeConfigure",doSave:!1}),LiteGraph.log_debug("lgraphnode","configure complete",this)}serialize(){var e={id:this.id,type:this.type,pos:this.pos,size:this.size,flags:LiteGraph.cloneObject(this.flags),order:this.order,mode:this.mode};if(this.constructor===LGraphNode&&this.last_serialization)return this.last_serialization;this.inputs&&(e.inputs=LiteGraph.cloneObject(this.inputs)),this.outputs&&(this.outputs.forEach((e=>{delete e._data})),e.outputs=LiteGraph.cloneObject(this.outputs)),this.title&&this.title!=this.constructor.title&&(e.title=this.title),this.properties&&(e.properties=LiteGraph.cloneObject(this.properties)),this.widgets&&this.serialize_widgets&&(e.widgets_values=this.widgets.map((e=>e?.value??null))),e.type??=this.constructor.type,this.color&&(e.color=this.color),this.bgcolor&&(e.bgcolor=this.bgcolor),this.boxcolor&&(e.boxcolor=this.boxcolor),this.shape&&(e.shape=this.shape);let t=this.processCallbackHandlers("onSerialize",{def_cb:this.onSerialize},e);return null!==t&&"object"==typeof t&&null!==t.return_value&&LiteGraph.log_warn("lgraphnode","onSerialize shouldnt return anything, data should be stored in the object pass in the first parameter"),e}clone(){var e=LiteGraph.createNode(this.type);if(!e)return null;var t=LiteGraph.cloneObject(this.serialize());return t.inputs?.forEach((e=>{e.link=null})),t.outputs?.forEach((e=>{e.links&&(e.links.length=0)})),delete t.id,LiteGraph.use_uuids&&(t.id=LiteGraph.uuidv4()),e.configure(t),e}toString(){return JSON.stringify(this.serialize())}getTitle(){return this.title??this.constructor.title}setProperty(e,t){if(this.properties||={},t===this.properties[e])return;const i=this.properties[e];this.properties[e]=t;let s=this.processCallbackHandlers("onPropertyChanged",{def_cb:this.onPropertyChanged},e,t,i);(!1===s||null!==s&&"object"==typeof s&&!1===s.return_value)&&(this.properties[e]=i,LiteGraph.log_debug("lgraphnode","setProperty","prevent property set by cbHandler",e,t,i,s));const n=this.widgets?.find((t=>t&&t.options?.property===e));n&&(n.value=t)}setOutputData(e,t){if(this.outputs&&(e?.constructor===String&&(e=this.findOutputSlot(e)),!(-1==e||e>=this.outputs.length))){e=this.getOutputSlot(e);var i=this.outputs[e];i&&(i._data=t,this.outputs[e].links?.forEach((e=>{const i=this.graph.links[e];i&&(i.data=t)})))}}setOutputDataType(e,t){if(this.outputs&&(e?.constructor===String&&(e=this.findOutputSlot(e)),!(-1==e||e>=this.outputs.length))){var i=this.outputs[e];i&&(i.type=t,this.outputs[e]?.links?.forEach((e=>{this.graph.links[e]&&(this.graph.links[e].type=t)})))}}getInputData(e,t,i){if(!this.inputs)return;if(e?.constructor===String&&(e=this.findInputSlot(e)),-1==e||e>=this.inputs.length)return;if(this.inputs[e].type==LiteGraph.ACTION)return;let s=this.inputs[e];if(void 0!==s.hard_coded_value)return console.debug("HARD_CODED_INPUT",this,s,s.hard_coded_value),s.hard_coded_value;let n=s.link,o=this.graph?.links[n];if(!o)return null;if(!t)return o.data;let a=this.graph.getNodeById(o.origin_id);if(!a)return LiteGraph.log_debug("lgraphnode","getInputData","No origin node, return the link data",o.data,o,e,this),o.data;if(i){LiteGraph.log_warn("CHECK THIS","lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",o,e,this),LiteGraph.log_debug("lgraphnode","getInputData","Refreshing ancestors tree by ForcedUpdateSlotData",o,e,this);let t=this.id+"_getInputData_forced_"+LiteGraph.uuidv4(),i={action:t,options:{action_call:t}};this.refreshAncestors(i)}return a.updateOutputData?a.updateOutputData(o.origin_slot):a.doExecute(),o.data}getInputDataType(e){if(!this.inputs)return null;if(e?.constructor===String&&(e=this.findInputSlot(e)),e>=this.inputs.length||null==this.inputs[e].link)return null;if(this.inputs[e].type!=LiteGraph.ACTION){var t=this.inputs[e].link,i=this.graph.links[t];if(!i)return LiteGraph.log_warn("lgraphnode","getInputDataType","No link",t,e,this),null;var s=this.graph.getNodeById(i.origin_id);if(!s)return i.type;var n=s.outputs[i.origin_slot];return n?n.type:null}}getInputDataByName(e,t){var i=this.findInputSlot(e);return-1==i?null:this.getInputData(i,t)}isInputConnected(e){return!!this.inputs&&(e<this.inputs.length&&null!=this.inputs[e].link)}getInputInfo(e){return this.inputs&&e<this.inputs.length?this.inputs[e]:null}getInputLink(e){if(!this.inputs)return null;if(e<this.inputs.length){var t=this.inputs[e];return this.graph.links[t.link]}return null}getInputNode(e){if(!this.inputs)return null;if(e>=this.inputs.length)return null;var t=this.inputs[e];if(!t||null===t.link)return null;var i=this.graph.links[t.link];return i?this.graph.getNodeById(i.origin_id):null}getInputOrProperty(e){if(this.inputs)for(var t=0,i=this.inputs.length;t<i;++t){var s=this.inputs[t];if(e==s.name&&null!=s.link){var n=this.graph.links[s.link];if(n)return n.data}}return this.properties?this.properties[e]:null}getOutputData(e){return this.outputs?e>=this.outputs.length?null:this.outputs[e]._data:null}getOutputInfo(e){return this.outputs&&e<this.outputs.length?this.outputs[e]:null}isOutputConnected(e){return!!this.outputs&&(e<this.outputs.length&&this.outputs[e].links&&this.outputs[e].links.length)}isAnyOutputConnected(){return!!this.outputs&&this.outputs.some((e=>e.links&&e.links.length))}getOutputNodes(e){if(!this.outputs||e>=this.outputs.length)return null;const t=this.outputs[e];return t.links&&0!==t.links.length?t.links.map((e=>this.graph.links[e])).filter((e=>e)).map((e=>this.graph.getNodeById(e.target_id))).filter((e=>e)):null}addOnTriggerInput(){var e=this.findInputSlot("onTrigger");return-1==e?(this.addInput("onTrigger",LiteGraph.EVENT,{removable:!0,nameLocked:!0}),this.findInputSlot("onTrigger")):e}addOnExecutedOutput(){var e=this.findOutputSlot("onExecuted");return-1==e?(this.addOutput("onExecuted",LiteGraph.ACTION,{removable:!0,nameLocked:!0}),this.findOutputSlot("onExecuted")):e}onAfterExecuteNode(e,t){var i=this.findOutputSlot("onExecuted");-1!=i&&(LiteGraph.log_verbose("lgraphnode","onAfterExecuteNode",this.id+":"+this.order+" triggering slot onAfterExecute",e,t),this.triggerSlot(i,e,null,t))}onAfterActionedNode(e,t){var i=this.findOutputSlot("onExecuted");-1!=i&&(LiteGraph.log_verbose("lgraphnode","onAfterActionedNode",this.id+":"+this.order+" triggering slot onAfterActionedNode",this,i,e,t),this.triggerSlot(i,e,null,t))}onResize(e){}changeMode(e){switch(e){case LiteGraph.ON_TRIGGER:this.addOnTriggerInput(),this.addOnExecutedOutput();break;case LiteGraph.ON_EVENT:case LiteGraph.NEVER:case LiteGraph.ALWAYS:case LiteGraph.ON_REQUEST:break;default:return!1}return this.mode=e,!0}executePendingActions(){this._waiting_actions&&this._waiting_actions.length&&(this._waiting_actions.forEach((e=>{this.onAction(e[0],e[1],e[2],e[3],e[4])})),this._waiting_actions.length=0)}doExecute(e,t={}){this.mode!==LiteGraph.NEVER?(t.action_call??=`${this.id}_exec_${LiteGraph.uuidv4()}`,this.graph?.nodes_executing&&this.graph?.nodes_executing[this.id]?LiteGraph.log_debug("lgraphNODE","doExecute","already executing! Prevent! "+this.id+":"+this.order):LiteGraph.ensureNodeSingleExecution&&this.exec_version&&this.exec_version>=this.graph.iteration&&void 0!==this.exec_version?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already EXECUTED THIS STEP !! "+this.exec_version):LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&t&&t.action_call&&this.graph.nodes_executedAction[this.id]==t.action_call?LiteGraph.log_debug("lgraphNODE","doExecute","!! NODE already ACTION THIS STEP !! "+t.action_call):(this.graph.nodes_executing[this.id]=!0,LiteGraph.properties_allow_input_binding&&this.doUpdateBindedInputProperties(),this.processCallbackHandlers("onExecute",{def_cb:this.onExecute},e,t),this.graph.nodes_executing[this.id]=!1,this.exec_version=this.graph.iteration,t&&t.action_call&&(this.action_call=t.action_call,this.graph.nodes_executedAction[this.id]=t.action_call),LiteGraph.properties_allow_output_binding&&this.doUpdateBindedOutputProperties(),this.execute_triggered=2,this.processCallbackHandlers("onAfterExecuteNode",{def_cb:this.onAfterExecuteNode},e,t))):LiteGraph.log_verbose("lgraphNODE","doExecute","prevent execution in mode NEVER",this.id)}execute(e,t={}){return LiteGraph.log_debug("lgraphnode","execute","You should replace .execute with .doExecute, has been renamed"),this.doExecute(e,t)}actionDo(e,t,i={},s){i.action_call??=`${this.id}_${e||"action"}_${LiteGraph.uuidv4()}`,LiteGraph.ensureNodeSingleAction&&this.graph.nodes_actioning&&this.graph.nodes_actioning[this.id]==i.action_call?LiteGraph.log_debug("lgraphnode","actionDo","already actioning! Prevent! "+this.id+":"+this.order+" :: "+i.action_call):(LiteGraph.log_debug("CheckActioned ? "+this.id+":"+this.order+" :: "+this.action_call),LiteGraph.ensureUniqueExecutionAndActionCall&&this.graph.nodes_executedAction[this.id]&&i&&i.action_call&&this.graph.nodes_executedAction[this.id]==i.action_call?LiteGraph.log_debug("lgraphnode","actionDo","!! NODE already ACTION THIS STEP !! "+i.action_call):(this.graph.nodes_actioning[this.id]=e||"actioning",this.processCallbackHandlers("onAction",{def_cb:this.onAction},e,t,i,s),this.graph.nodes_actioning[this.id]=!1,i&&i.action_call&&(this.action_call=i.action_call,this.graph.nodes_executedAction[this.id]=i.action_call),this.action_triggered=2,this.processCallbackHandlers("onAfterActionedNode",{def_cb:this.onAfterActionedNode},t,i)))}trigger(e,t,i){if(!this.outputs||0===this.outputs.length)return;this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());let s=0;this.outputs.forEach(((n,o)=>{!n||n.type!==LiteGraph.EVENT||e&&n.name!==e?LiteGraph.log_verbose("lgraphnode","trigger","skip slot",n):(LiteGraph.log_verbose("lgraphnode","trigger","triggering slot",o,t,i),this.triggerSlot(o,t,null,i),s++)})),s||LiteGraph.log_debug("lgraphnode","trigger","nothing found",...arguments)}triggerSlot(e,t,i,s={}){if(this.outputs)if(null!==e){e.constructor!==Number&&(e=this.getOutputSlot(e));var n=this.outputs[e];if(n){var o=n.links;if(o&&o.length&&!(this.mode===LiteGraph.NEVER||this.graph&&this.graph.ancestorsCall)){this.graph&&(this.graph._last_trigger_time=LiteGraph.getTime());for(var a=0;a<o.length;++a){var r=o[a];if(null==i||i==r){var l=this.graph.links[o[a]];if(l){l._last_time=LiteGraph.getTime();var h=this.graph.getNodeById(l.target_id);if(h){var p=h.inputs[l.target_slot];if(h.mode===LiteGraph.ON_TRIGGER||"onTrigger"===p?.name)s.action_call||(s.action_call=`${this.id}_trigg_${LiteGraph.uuidv4()}`),LiteGraph.refreshAncestorsOnTriggers&&h.refreshAncestors({action:"trigger",param:t,options:s}),h.onExecute&&h.doExecute(t,s);else if(h.onAction){s.action_call||(s.action_call=`${this.id}_act_${LiteGraph.uuidv4()}`);let e=h.inputs[l.target_slot];LiteGraph.refreshAncestorsOnActions&&h.refreshAncestors({action:e.name,param:t,options:s}),LiteGraph.use_deferred_actions&&h.onExecute?(h._waiting_actions??=[],h._waiting_actions.push([e.name,t,s,l.target_slot]),LiteGraph.log_debug("lgraphnode","triggerSlot","push to deferred",e.name,t,s,l.target_slot)):(LiteGraph.log_debug("lgraphnode","triggerSlot","call actionDo",h,e.name,t,s,l.target_slot),h.actionDo(e.name,t,s,l.target_slot))}else LiteGraph.log_debug("lgraphnode","triggerSlot","not executing node, what to do with this Node Mode on slot triggered?",h.mode,this)}}}}}}}else LiteGraph.log_error("lgraphnode","triggerSlot","wrong slot",e)}clearTriggeredSlot(e,t){this.outputs&&this.outputs[e]&&this.outputs[e].links&&this.outputs[e].links.forEach((e=>{if(null!==t&&t!==e)return;const i=this.graph.links[e];i&&(i._last_time=0)}))}doUpdateBindedInputProperties(){let e=this;this.inputs.forEach((t=>{if(t.param_bind)if(LiteGraph.log_verbose("lgraphnode","doUpdateBindedInputProperties","has bind",t,e),e.properties&&void 0!==e.properties[t.name]){let i=e.getInputData(t.name);null!==i&&(LiteGraph.log_verbose("lgraphnode","doUpdateBindedInputProperties","update value",t.name,i,e),this.setProperty(t.name,i))}else LiteGraph.log_warn("lgraphnode","doUpdateBindedInputProperties","inexisting property",t.name,e)}))}doUpdateBindedOutputProperties(){let e=this;this.outputs.forEach((t=>{if(t.param_bind)if(LiteGraph.log_verbose("lgraphnode","doUpdateBindedOutputProperties","has bind",t,e),e.properties&&void 0!==e.properties[t.name]){let i=this.properties[t.name];LiteGraph.log_verbose("lgraphnode","doUpdateBindedOutputProperties","update value",t.name,i,e),this.setOutputData(t.name,i)}else LiteGraph.log_warn("lgraphnode","doUpdateBindedOutputProperties","inexisting property",t.name,outputData,e)}))}autoSize(e){let t=this.computeSize(),i=e&&this.size?[Math.max(this.size[0],t[0]),Math.max(this.size[1],t[1])]:t;this.setSize(i)}setSize(e){this.size=e,this.processCallbackHandlers("onResize",{def_cb:this.onResize},this.size)}addProperty(e,t,i,s){t??=null,i??=null;const n={name:e,type:i,default_value:t,...s};return this.properties_info=this.properties_info??[],this.properties_info.push(n),this.properties=this.properties??{},this.properties[e]=t,n}addInput(e,t,i){return this.addSlot(e,t,i,!0)}addOutput(e,t,i){return this.addSlot(e,t,i,!1)}addSlot(e,t,i,s){const n=s?{name:e,type:t,link:null,...i}:{name:e,type:t,links:null,...i};return s?(this.inputs=this.inputs??[],this.inputs.push(n),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},n),LiteGraph.registerNodeAndSlotType(this,t)):(this.outputs=this.outputs??[],this.outputs.push(n),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},n),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,t,!0)),this.autoSize(!0),this.setDirtyCanvas(!0,!0),n}addInputs(e){this.addSlots(e,!0)}addOutputs(e){this.addSlots(e,!1)}addSlots(e,t){"string"==typeof e&&(e=[e]),e.forEach((e=>{const i=t?{name:e[0],type:e[1],link:null,...e[2]??{}}:{name:e[0],type:e[1],links:null,...e[2]??{}};t?(this.inputs=this.inputs??[],this.inputs.push(i),this.processCallbackHandlers("onInputAdded",{def_cb:this.onInputAdded},i),LiteGraph.registerNodeAndSlotType(this,e[1])):(this.outputs=this.outputs??[],this.outputs.push(i),this.processCallbackHandlers("onOutputAdded",{def_cb:this.onOutputAdded},i),LiteGraph.auto_load_slot_types&&LiteGraph.registerNodeAndSlotType(this,e[1],!0))})),this.autoSize(),this.setDirtyCanvas(!0,!0)}removeInput(e){this.disconnectInput(e);const t=this.inputs.splice(e,1)[0];this.inputs.slice(e).filter((e=>!!e)).forEach((e=>{const t=this.graph.links[e.link];t?.target_slot&&t.target_slot--})),this.autoSize(),this.processCallbackHandlers("onInputRemoved",{def_cb:this.onInputRemoved},e,t),this.setDirtyCanvas(!0,!0)}removeOutput(e){this.disconnectOutput(e),this.outputs=this.outputs.filter(((t,i)=>i!==e)),this.outputs.slice(e).forEach((e=>{e&&e.links&&e.links.forEach((e=>{const t=this.graph.links[e];t&&(t.origin_slot-=1)}))})),this.autoSize(),this.processCallbackHandlers("onOutputRemoved",{def_cb:this.onOutputRemoved},e),this.setDirtyCanvas(!0,!0)}addConnection(e,t,i,s){var n={name:e,type:t,pos:i,direction:s,links:null};return this.connections.push(n),n}getDefaultCanvas(){return!!this.graph&&(!(!this.graph.list_of_graphcanvas||!this.graph.list_of_graphcanvas.length)&&this.graph.list_of_graphcanvas[0])}computeSize(e){if(this.constructor.size)return this.constructor.size.concat();var t=this,i=e||new Float32Array([0,0]),s=LiteGraph.NODE_TEXT_SIZE;const n=(e,i)=>{if(!e)return 0;const n=t.getDefaultCanvas();if(n&&n.canvas&&n.ctx){n.ctx.font=i?n.title_text_font:n.inner_text_font;const t=n.ctx?.measureText(e);if(t)return t.width}return s*e.length*.423};var o=t.title;try{o=this.getTitle()}catch(e){}var a=40+n(o,!0),r=0,l=0;this.inputs&&(r=this.inputs.reduce(((e,t)=>{const i=t.label||t.name||"",s=n(i);return Math.max(e,s)}),0)),this.outputs&&(l=this.outputs.reduce(((e,t)=>{const i=t.label||t.name||"",s=n(i);return Math.max(e,s)}),0)),this.horizontal?(i[0]=Math.max(i[0],a),i[1]=this.outputs.length?Math.max(i[1],LiteGraph.NODE_SLOT_HEIGHT+10):i[1]):(i[0]=Math.max(r+l+40+10,a),i[1]=this.getSlotsHeight()),i[0]=Math.max(i[0],LiteGraph.NODE_MIN_WIDTH),i[0]=Math.max(i[0],LiteGraph.NODE_MIN_SIZE[0]),i[1]=Math.max(i[1],LiteGraph.NODE_MIN_SIZE[1]);let h=0;if(this.widgets&&this.widgets.length){i[0]=Math.max(i[0],1.5*LiteGraph.NODE_MIN_WIDTH);for(var p=0,c=this.widgets.length;p<c;++p)if(this.widgets[p].computeSize){const e=this.widgets[p].computeSize(i[0]);h+=e[1]+4,i[0]=Math.max(i[0],e[0])}else h+=LiteGraph.NODE_WIDGET_HEIGHT+4,i[0]=Math.max(i[0],LiteGraph.NODE_WIDTH);h+=8}this.widgets_up?i[1]=Math.max(i[1],h):null!=this.widgets_start_y?i[1]=Math.max(i[1],h+this.widgets_start_y):i[1]+=h,this.constructor.min_height&&(i[1]=Math.max(i[1],this.constructor.min_height));let d=0;if(this.widgets&&this.widgets.length)for(p=0,c=this.widgets.length;p<c;++p){let e=this.widgets[p].computeSize();d=Math.max(d,e[0])}if(i[0]=Math.max(i[0],a,d),this.onComputeSize){var u=this.onComputeSize(i);i[0]=Math.max(i[0],u[0]),i[1]=Math.max(i[1],u[1])}return i}getSlotsHeight(){const e=this.inputs?this.inputs.filter((e=>!e.widget_name)).length:0;return Math.max(e,this.outputs?this.outputs.length:1,1)*LiteGraph.NODE_SLOT_HEIGHT+10+(this.constructor.slot_start_y||0)}getPropertyInfo(e){var t=null;if(this.properties_info)for(var i=0;i<this.properties_info.length;++i)if(this.properties_info[i].name==e){t=this.properties_info[i];break}if(this.constructor[`@${e}`]&&(t=this.constructor[`@${e}`]),this.constructor.widgets_info&&this.constructor.widgets_info[e]&&(t=this.constructor.widgets_info[e]),!t){let i=this.processCallbackHandlers("onGetPropertyInfo",{def_cb:this.onGetPropertyInfo},e);null!==i&&"object"==typeof i&&null!==i.return_value&&(t=i.return_value)}return t||(t={}),t.type||(t.type=typeof this.properties[e]),"combo"==t.widget&&(t.type="enum"),t}addWidget(e,t,i,s,n){this.widgets??=[],!n&&s&&s.constructor===Object&&(n=s,s=null),n&&n.constructor===String&&(n={property:n}),s&&s.constructor===String&&(n??={},n.property=s,s=null),s&&s.constructor!==Function&&(LiteGraph.log_warn("lgraphnode","addWidget","callback must be a function",s),s=null);var o={type:e.toLowerCase(),name:t,value:i,callback:s,options:n||{}};if(void 0!==o.options.y&&(o.y=o.options.y),!s&&!o.options.callback&&o.options.property,"combo"!=e||o.options.values)return this.widgets.push(o),this.setSize(this.computeSize()),o;LiteGraph.log_warn("lgraphnode","addWidget","combo requires to pass values in options eg: { values:['red','blue'] }")}addCustomWidget(e){return this.widgets??=[],this.widgets.push(e),this.setSize(this.computeSize()),e}getBounding(e=new Float32Array(4),t){const i=this.pos,s=this.flags?.collapsed,n=this.size;let o=0,a=1,r=0,l=0;return t&&(o=4,a=6+o,r=4,l=5+r),e[0]=i[0]-o,e[1]=i[1]-LiteGraph.NODE_TITLE_HEIGHT-r,e[2]=s?(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+a:n[0]+a,e[3]=s?LiteGraph.NODE_TITLE_HEIGHT+l:n[1]+LiteGraph.NODE_TITLE_HEIGHT+l,this.processCallbackHandlers("onBounding",{def_cb:this.onBounding},e),e}isPointInside(e,t,i=0,s){var n=this.graph&&this.graph.isLive()?0:LiteGraph.NODE_TITLE_HEIGHT;if(s&&(n=0),this.flags&&this.flags.collapsed){if(LiteGraph.isInsideRectangle(e,t,this.pos[0]-i,this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT-i,(this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH)+2*i,LiteGraph.NODE_TITLE_HEIGHT+2*i))return!0}else if(this.pos[0]-4-i<e&&this.pos[0]+this.size[0]+4+i>e&&this.pos[1]-n-i<t&&this.pos[1]+this.size[1]+i>t)return!0;return!1}getSlotInPosition(e,t){var i=new Float32Array(2);if(this.inputs)for(let s=0,n=this.inputs.length;s<n;++s){let n=this.inputs[s];if(this.getConnectionPos(!0,s,i),LiteGraph.isInsideRectangle(e,t,i[0]-10,i[1]-5,20,10))return{input:n,slot:s,link_pos:i}}if(this.outputs)for(let s=0,n=this.outputs.length;s<n;++s){let n=this.outputs[s];if(this.getConnectionPos(!1,s,i),LiteGraph.isInsideRectangle(e,t,i[0]-10,i[1]-5,20,10))return{output:n,slot:s,link_pos:i}}return null}findInputSlot(e,t){if(!this.inputs)return-1;for(var i=0,s=this.inputs.length;i<s;++i)if(e==this.inputs[i].name)return t?this.inputs[i]:i;return-1}findOutputSlot(e,t=!1){if(!this.outputs)return-1;for(var i=0,s=this.outputs.length;i<s;++i)if(e==this.outputs[i].name)return t?this.outputs[i]:i;return-1}getSlot(e,t,i=!1){return e&&e!==LiteGraph.OUTPUT?"undefined"!==this.inputs[t]?i?this.inputs[t]:t:this.findOutputSlot(t,i):"undefined"!==this.outputs[t]?i?this.outputs[t]:t:this.findInputSlot(t,i)}getOutputSlot(e,t=!1){return this.getSlot(!1,e,t)}getInputSlot(e,t=!1){return this.getSlot(!0,e,t)}findInputSlotFree(e={}){var t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.inputs)return-1;for(var i=0,s=this.inputs.length;i<s;++i)if(!(this.inputs[i].link&&null!=this.inputs[i].link||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.inputs[i].type)))return t.returnObj?this.inputs[i]:i;return-1}findOutputSlotFree(e={}){var t=Object.assign({returnObj:!1,typesNotAccepted:[]},e);if(!this.outputs)return-1;for(let e=0,i=this.outputs.length;e<i;++e)if(!(this.outputs[e].links&&null!=this.outputs[e].links||t.typesNotAccepted&&t.typesNotAccepted.includes&&t.typesNotAccepted.includes(this.outputs[e].type)))return t.returnObj?this.outputs[e]:e;return-1}findInputSlotByType(e,t,i,s){return this.findSlotByType(!0,e,t,i,s)}findOutputSlotByType(e,t,i,s){return this.findSlotByType(!1,e,t,i,s)}findSlotByType(e=!1,t,i=!1,s=!1,n=!1){var o=e?this.inputs:this.outputs;if(!o)return-1;t&&""!=t&&"*"!=t||(t=0);for(let e=0,n=o.length;e<n;++e){let n=(t+"").toLowerCase().split(","),a="0"==o[e].type||"*"==o[e].type?0:o[e].type;a=(a+"").toLowerCase().split(",");for(let r=0;r<n.length;r++)for(let l=0;l<a.length;l++){if("_event_"==n[r]&&(n[r]=LiteGraph.EVENT),"_event_"==a[r]&&(a[r]=LiteGraph.EVENT),"*"==n[r]&&(n[r]=0),"*"==a[r]&&(a[r]=0),n[r]==a[l]){if(s&&(o[e].link&&null!==o[e].link||o[e].links&&null!==o[e].links)){LiteGraph.log_verbose("lgraphnode","findSlotByType","preferFreeSlot but has link",n[r],a[l],"from types",t,"checked types",o[e].type);continue}return LiteGraph.log_verbose("lgraphnode","findSlotByType","found right type",e,o[e],"from types",t,"checked types",o[e].type),i?o[e]:e}LiteGraph.log_verbose("lgraphnode","findSlotByType","slot not right type",n[r],a[l],"from types",t,"checked types",o[e].type)}}if(s&&!n)for(let e=0,s=o.length;e<s;++e){let s=(t+"").toLowerCase().split(","),n="0"==o[e].type||"*"==o[e].type?"0":o[e].type;n=(n+"").toLowerCase().split(",");for(let t=0;t<s.length;t++)for(let a=0;a<n.length;a++)if("*"==s[t]&&(s[t]=0),"*"==n[t]&&(n[t]=0),s[t]==n[a])return i?o[e]:e}return-1}connectByType(e,t,i="*",s={}){var n=Object.assign({createEventInCase:!0,firstFreeIfOutputGeneralInCase:!0,generalTypeInCase:!0,preferFreeSlot:!1},s);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var o=t.findInputSlotByType(i,!1,!0);return o>=0&&null!==o?(LiteGraph.log_debug("lgraphnode","connectByType","type "+i+" for "+o),this.connect(e,t,o)):n.createEventInCase&&i==LiteGraph.EVENT?(LiteGraph.log_debug("lgraphnode","connectByType","connect WILL CREATE THE onTrigger "+i+" to "+t),this.connect(e,t,-1)):n.generalTypeInCase&&(o=t.findInputSlotByType(0,!1,!0,!0),LiteGraph.log_debug("lgraphnode","connectByType","connect TO a general type (*, 0), if not found the specific type ",i," to ",t,"RES_SLOT:",o),o>=0)||n.firstFreeIfOutputGeneralInCase&&(0==i||"*"==i||""==i)&&(o=t.findInputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}),LiteGraph.log_debug("lgraphnode","connectByType","connect TO TheFirstFREE ",i," to ",t,"RES_SLOT:",o),o>=0)?this.connect(e,t,o):(LiteGraph.log_debug("lgraphnode","connectByType","no way to connect type: ",i," to targetNODE ",t),null)}connectByTypeOutput(e,t,i="*",s={}){var n=Object.assign({createEventInCase:!0,firstFreeIfInputGeneralInCase:!0,generalTypeInCase:!0},s);t&&t.constructor===Number&&(t=this.graph.getNodeById(t));var o=t.findOutputSlotByType(i,!1,!0);return o>=0&&null!==o?(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","type "+i+" for "+o),t.connect(o,this,e)):n.generalTypeInCase&&(o=t.findOutputSlotByType(0,!1,!0,!0))>=0?t.connect(o,this,e):n.createEventInCase&&i==LiteGraph.EVENT&&LiteGraph.do_add_triggers_slots?(o=t.addOnExecutedOutput(),t.connect(o,this,e)):n.firstFreeIfInputGeneralInCase&&(0==i||"*"==i||""==i||"undefined"==i)&&(o=t.findOutputSlotFree({typesNotAccepted:[LiteGraph.EVENT]}))>=0?t.connect(o,this,e):(LiteGraph.log_debug("lgraphnode","connectByTypeOutput","no way to connect (not found or not free?) byOUT type: ",i," to sourceNODE ",t),null)}connect(e,t,i=0){if(!this.graph)return LiteGraph.log_warn("lgraphnode","connect","Error, node doesn't belong to any graph. Nodes must be added first to a graph before connecting them.",this),null;let s=null;if(-1==(e=this.getOutputSlot(e)))return LiteGraph.log_warn("lgraphnode","connect","Slot not found",this,e),null;if(t&&t.constructor===Number&&(LiteGraph.log_debug("lgraphnode","connect","Target node constructor is number",t),t=this.graph.getNodeById(t),LiteGraph.log_debug("lgraphnode","connect","Target node number constructor, looked for node by ID",t)),t){if(t==this)return null;if(i===LiteGraph.EVENT){if(!LiteGraph.do_add_triggers_slots)return null;t.changeMode(LiteGraph.ON_TRIGGER),i=t.findInputSlot("onTrigger"),LiteGraph.log_debug("lgraphnode","connect","Created onTrigger slot",i)}else i=t.getInputSlot(i);if(!t.inputs||-1==i)return LiteGraph.log_warn("lgraphnode","connect","Target slot not found",i,t.inputs),null;var n,o=!1,a=t.inputs[i],r=null,l=this.outputs[e];if(!this.outputs[e])return LiteGraph.log_warn("lgraphnode","connect","Invalid processed output slot: ",e,this.outputs),null;if(s=t.processCallbackHandlers("onBeforeConnectInput",{def_cb:t.onBeforeConnectInput},t),null!==s&&"object"==typeof s&&null!==s.return_value&&(LiteGraph.log_debug("lgraphnode","connect","Node onBeforeConnectInput changing target_slot",i,s.return_value),i=s.return_value),s=this.processCallbackHandlers("onConnectOutput",{def_cb:this.onConnectOutput},e,a.type,a,t,i),null!==s&&(!1===s||"object"==typeof s&&!1===s.return_value))return LiteGraph.log_debug("lgraphnode","connect","Node onConnectOutput stopping connection",s.return_value),null;if(!1===i||null===i||!LiteGraph.isValidConnection(l.type,a.type))return LiteGraph.log_warn("lgraphnode","connect","target_slot is NOT valid",i,l.type,a.type),this.setDirtyCanvas(!1,!0),o&&this.graph.connectionChange(this,r),null;if(LiteGraph.log_debug("lgraphnode","connect","target_slot is valid",i),s=t.processCallbackHandlers("onConnectInput",{def_cb:t.onConnectInput},i,l.type,l,this,e),null!==s&&(!1===s||"object"==typeof s&&!1===s.return_value))return LiteGraph.log_debug("lgraphnode","connect","targetNode onConnectInput stopping connection",s.return_value),null;if(t.inputs[i]&&null!=t.inputs[i].link&&(this.graph.beforeChange(),t.disconnectInput(i,{doProcessChange:!1}),o=!0),l.links?.length&&l.type===LiteGraph.EVENT)LiteGraph.allow_multi_output_for_events||(this.graph.beforeChange(),this.disconnectOutput(e,!1,{doProcessChange:!1}),o=!0);return n=LiteGraph.use_uuids?LiteGraph.uuidv4():++this.graph.last_link_id,r=new LiteGraph.LLink(n,a.type||l.type,this.id,e,t.id,i),this.graph.links[r.id]=r,null==l.links&&(l.links=[]),l.links.push(r.id),void 0===t.inputs[i]&&LiteGraph.log_warn("lgraphnode","connect","FIXME error, target_slot does not exists on target_node",t,i),t.inputs[i].link=r.id,this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!0,r,l),t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,i,!0,r,a),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,i,this,e),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,i)),this.graph.onGraphChanged({action:"connect"}),this.setDirtyCanvas(!1,!0),this.graph.afterChange(),this.graph.connectionChange(this,r),r}LiteGraph.log_warn("lgraphnode","connect","Target node null",t)}disconnectOutput(e,t,i={}){var s=Object.assign({doProcessChange:!0},i);e=this.getOutputSlot(e);var n=this.outputs[e];if(!n||!n.links||0==n.links.length)return LiteGraph.log_warn("lgraphnode","disconnectOutput","Error, invalid slot or not linked",e,n),!1;if(t){if(t.constructor===Number&&(LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node constructor is number",t),t=this.graph.getNodeById(t),LiteGraph.log_debug("lgraphnode","disconnectOutput","Target node number constructor, looked for node by ID",t)),!t)return LiteGraph.log_warn("lgraphnode","disconnectOutput","target node not found",t),!1;for(let i=0,a=n.links.length;i<a;i++){let a=n.links[i],r=this.graph.links[a];if(r.target_id==t.id){n.links.splice(i,1);var o=t.inputs[r.target_slot];o.link=null,delete this.graph.links[a],this.graph?.onGraphChanged({action:"disconnectOutput",doSave:s.doProcessChange}),t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,r.target_slot,!1,r,o),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!1,r,n),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,r.target_slot),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,r.target_slot,this,e));break}}}else{for(let i=0,a=n.links.length;i<a;i++){let a=n.links[i],r=this.graph.links[a];r?(t=this.graph.getNodeById(r.target_id),o=null,this.graph?.onGraphChanged({action:"disconnectOutput",doSave:s.doProcessChange}),t&&((o=t.inputs[r.target_slot]).link=null,t.processCallbackHandlers("onConnectionsChange",{def_cb:t.onConnectionsChange},LiteGraph.INPUT,r.target_slot,!1,r,o),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,t,r.target_slot,this)),delete this.graph.links[a],this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.OUTPUT,e,!1,r,n),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,this,e,t,r.target_slot)):LiteGraph.log_warn("lgraphnode","disconnectOutput","A link is invalid",a,this,n)}n.links=null}return this.setDirtyCanvas(!1,!0),this.graph.connectionChange(this),!0}disconnectInput(e,t={}){var i=Object.assign({doProcessChange:!0},t);e=this.getInputSlot(e);var s=this.inputs[e];if(!s)return!1;var n=this.inputs[e].link;if(null!=n){this.inputs[e].link=null;var o=this.graph.links[n];if(o){var a=this.graph.getNodeById(o.origin_id);if(!a)return!1;var r=a.outputs[o.origin_slot];if(!r||!r.links||0==r.links.length)return!1;for(var l=0,h=r.links.length;l<h;l++)if(r.links[l]==n){r.links.splice(l,1);break}delete this.graph.links[n],this.graph?.onGraphChanged({action:"disconnectInput",doSave:i.doProcessChange}),this.processCallbackHandlers("onConnectionsChange",{def_cb:this.onConnectionsChange},LiteGraph.INPUT,e,!1,o,s),a.processCallbackHandlers("onConnectionsChange",{def_cb:a.onConnectionsChange},LiteGraph.OUTPUT,l,!1,o,r),this.graph&&(this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.OUTPUT,a,l),this.graph.processCallbackHandlers("onNodeConnectionChange",{def_cb:this.graph.onNodeConnectionChange},LiteGraph.INPUT,this,e))}}return this.setDirtyCanvas(!1,!0),this.graph&&this.graph.connectionChange(this),!0}getConnectionPos(e,t,i=new Float32Array(2)){var s=0;e&&this.inputs&&(s=this.inputs.length),!e&&this.outputs&&(s=this.outputs.length);var n=.5*LiteGraph.NODE_SLOT_HEIGHT;if(this.flags.collapsed){var o=this._collapsed_width||LiteGraph.NODE_COLLAPSED_WIDTH;return this.horizontal?(i[0]=this.pos[0]+.5*o,i[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]):(i[0]=e?this.pos[0]:this.pos[0]+o,i[1]=this.pos[1]-.5*LiteGraph.NODE_TITLE_HEIGHT),i}if(e&&-1==t)return LiteGraph.log_debug("lgraphnode","getConnectionPos","asking for connection slot -1"),i[0]=this.pos[0]+.5*LiteGraph.NODE_TITLE_HEIGHT,i[1]=this.pos[1]+.5*LiteGraph.NODE_TITLE_HEIGHT,i;if(e&&s>t&&this.inputs[t].pos)return i[0]=this.pos[0]+this.inputs[t].pos[0],i[1]=this.pos[1]+this.inputs[t].pos[1],i;if(!e&&s>t&&this.outputs[t].pos)return i[0]=this.pos[0]+this.outputs[t].pos[0],i[1]=this.pos[1]+this.outputs[t].pos[1],i;if(this.horizontal)return i[0]=this.pos[0]+(t+.5)*(this.size[0]/s),i[1]=e?this.pos[1]-LiteGraph.NODE_TITLE_HEIGHT:this.pos[1]+this.size[1],i;if(i[0]=e?this.pos[0]+n:this.pos[0]+this.size[0]+1-n,e&&this.inputs&&this.inputs[t]&&this.inputs[t].widget_name){let e=this.inputs[t].widget_name,s=this.widgets.find((t=>t.name===e));return i[1]=this.pos[1]+s.last_y+s.computeSize()[1]/2,i}if(e){for(var a=t,r=t-1;r>0;r--)e&&this.inputs&&this.inputs[r]&&this.inputs[t].widget_name&&a--;i[1]=this.pos[1]+(a+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0)}else i[1]=this.pos[1]+(t+.7)*LiteGraph.NODE_SLOT_HEIGHT+(this.constructor.slot_start_y||0);return i}alignToGrid(){this.pos[0]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[0]/LiteGraph.CANVAS_GRID_SIZE),this.pos[1]=LiteGraph.CANVAS_GRID_SIZE*Math.round(this.pos[1]/LiteGraph.CANVAS_GRID_SIZE)}trace(e){this.console||(this.console=[]),this.console.push?.(e),this.console.length>LGraphNode.MAX_CONSOLE&&this.console.shift?.(),this.graph.processCallbackHandlers("onNodeTrace",{def_cb:this.graph.onNodeTrace},this,e)}setDirtyCanvas(e,t){this.graph&&this.graph.sendActionToCanvas("setDirty",[e,t])}loadImage(e){var t=new Image;t.src=LiteGraph.node_images_path+e,t.ready=!1;var i=this;return t.onload=function(){this.ready=!0,i.setDirtyCanvas(!0)},t}captureInput(e){if(this.graph&&this.graph.list_of_graphcanvas)for(var t=this.graph.list_of_graphcanvas,i=0;i<t.length;++i){var s=t[i];(e||s.node_capturing_input==this)&&(s.node_capturing_input=e?this:null)}}collapse(e){this.graph.onGraphChanged({action:"collapse"}),(!1!==this.constructor.collapsable||e)&&(this.flags.collapsed?this.flags.collapsed=!1:this.flags.collapsed=!0,this.setDirtyCanvas(!0,!0))}pin(e){this.graph.onGraphChanged({action:"pin"}),this.flags.pinned=void 0===e?!this.flags.pinned:e}localToScreen(e,t,i){return[(e+this.pos[0])*i.scale+i.offset[0],(t+this.pos[1])*i.scale+i.offset[1]]}refreshAncestors(e={}){var t=Object.assign({action:"",param:null,options:null,passParam:!0},e);if(this.inputs){if(!(LiteGraph.preventAncestorRecalculation&&this.graph.node_ancestorsCalculated&&this.graph.node_ancestorsCalculated[this.id])){t.action&&""!=t.action||(t.action=this.id+"_ancestors"),t.param&&""!=t.param||(t.param=this.id+"_ancestors"),t.options||(t.options={}),t.options=Object.assign({action_call:t.action},t.options),LiteGraph.log_verbose("lgraphnode","refreshAncestors","ancestors processing",this.id+":"+this.order+" "+t.options.action_call,this),this.graph.ancestorsCall=!0;var i={modesSkip:[LiteGraph.NEVER,LiteGraph.ON_EVENT,LiteGraph.ON_TRIGGER],modesOnly:[LiteGraph.ALWAYS,LiteGraph.ON_REQUEST],typesSkip:[LiteGraph.ACTION],typesOnly:[]},s=this.graph.getAncestors(this,i);for(var n in s)LiteGraph.log_verbose("lgraphnode","refreshAncestors","doExecute ancestor",n,s[n],t.param,t.options),s[n].doExecute(t.param,t.options),this.graph.node_ancestorsCalculated[s[n].id]=!0;return this.graph.ancestorsCall=!1,this.graph.node_ancestorsCalculated[this.id]=!0,!0}LiteGraph.log_verbose("lgraphnode","refreshAncestors","already calculated subtree! Prevent! "+this.id+":"+this.order,this)}}syncObjectByProperty(e,t,i,s){var n=Object.assign({},{only_in_source:"append",fallback_checks:[{name:"type"}]},s);null!==e&&e||(e=[]),null!==t&&t||(t=[]);var o=[];let a={},r=t.filter((t=>!e.some((e=>e[i]===t[i])))),l=[],h=[];t.forEach(((t,s)=>{let n=!1;e.forEach(((e,r)=>{n||(l.includes(r)?LiteGraph.log_verbose("syncObjectByProperty","skip used",e,r):e[i]===t[i]&&(n=!0,l.push(r),o[s]=LiteGraph.cloneObject(e),s!=r?(LiteGraph.log_debug("syncObjectByProperty","push SHIFTED",t[i],t,r,s),a[r]=s):LiteGraph.log_verbose("syncObjectByProperty","found ok, same index",t[i],e,s)))})),n||h.push({ob:t,index:s})})),h.length&&(n.fallback_checks.length?h.forEach(((t,s)=>{let r=t.ob,h=t.index,p=!1;n.fallback_checks.forEach(((t,i)=>{p||e.forEach(((e,i)=>{p||(l.includes(i)?LiteGraph.log_verbose("syncObjectByProperty","aNotFoundInSource skip used slot",e,i):e[t.name]===r[t.name]&&(p=!0,l.push(i),o[h]=LiteGraph.cloneObject(e),LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource",t,"push SHIFTED",r[t],r,i,h),a[i]=h))}))})),p||(LiteGraph.log_debug("syncObjectByProperty","aNotFoundInSource, push !foundInSource",t.ob[i],t),o[t.index]=LiteGraph.cloneObject(t.ob))})):h.forEach(((e,t)=>{LiteGraph.log_debug("syncObjectByProperty","!using fallback checks","push !foundInSource",e.ob[i],e),o[e.index]=LiteGraph.cloneObject(e.ob)})));let p=[],c=[];return e.forEach(((e,s)=>{let n=!1;l.includes(s)||(t.forEach(((t,o)=>{n||(p.includes(o)?LiteGraph.log_verbose("syncObjectByProperty","only_in_source","skip checked slot",e,s):e[i]===t[i]&&(p.push(o),n=!0))})),n||(LiteGraph.log_debug("syncObjectByProperty","push only_in_source",e[i],e),o.push(LiteGraph.cloneObject(e)),a[s]=o.length-1,c.push(e)))})),LiteGraph.log_info("lgraphnode","syncByProperty",{only_in_source:c,only_in_target:r,ob_from:e,ob_dest:t,new_dest:o,keys_remap:a}),{ob_dest:o,keys_remap:a,only_in_source:c,only_in_target:r}}}class LGraphGroup{static opts={inclusion_distance:36};constructor(e="Group"){this.title=e,this.font_size=24,this.color=LiteGraph.LGraphCanvas.node_colors.pale_blue?.groupcolor??"#AAA",this._bounding=new Float32Array([10,10,140,80]),this._pos=this._bounding.subarray(0,2),this._size=this._bounding.subarray(2,4),this._nodes=[],this._groups=[],this.graph=null,this.callbackhandler_setup()}callbackhandler_setup(){this.cb_handler=new CallbackHandler(this)}registerCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){return this.cb_handler||this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}set pos(e){!e||e.length<2||(this._pos[0]=e[0],this._pos[1]=e[1])}get pos(){return this._pos}set size(e){!e||e.length<2||(this._size[0]=Math.max(140,e[0]),this._size[1]=Math.max(80,e[1]))}get size(){return this._size}configure(e){this.title=e.title,this._bounding=LiteGraph.cloneObject(e.bounding,this._bounding),this.color=e.color,e.font_size&&(this.font_size=e.font_size)}serialize(){var e=this._bounding;return{title:this.title,bounding:e.map((e=>Math.round(e))),color:this.color,font_size:this.font_size}}move(e,t,i){isNaN(e)&&console.error?.("LGraphGroup.move() deltax NaN"),isNaN(t)&&console.error?.("LGraphGroup.move() deltay NaN"),this._pos[0]+=e,this._pos[1]+=t,i||(this._nodes.forEach((i=>{i.pos[0]+=e,i.pos[1]+=t})),this._groups.forEach((i=>{i.pos[0]+=e,i.pos[1]+=t})))}recomputeInsideNodes(){this._nodes.length=0;var e=this.graph._nodes,t=new Float32Array(4);this._nodes=e.filter((e=>(e.getBounding(t),LiteGraph.overlapBounding(this._bounding,t,-LGraphGroup.opts.inclusion_distance)))),this.recomputeInsideGroups()}recomputeInsideGroups(){this._groups.length=0;var e=this.graph._groups,t=new Float32Array(4);this._groups=e.filter((e=>(e.getBounding(t),LiteGraph.isBoundingInsideRectangle(t,...this._bounding))))}getBounding=function(){LiteGraph.LGraphNode.prototype.getBounding.call(this,...arguments)};isPointInside=LiteGraph.LGraphNode.prototype.isPointInside;setDirtyCanvas=LiteGraph.LGraphNode.prototype.setDirtyCanvas}class Subgraph{static title="Subgraph";static desc="Graph inside a node";constructor(){this.size=[140,80],this.properties={enabled:!0},this.enabled=!0,this.subgraph=new LiteGraph.LGraph,this.subgraph._subgraph_node=this,this.subgraph._is_subgraph=!0,this.subgraph.onTrigger=this.onSubgraphTrigger.bind(this),this.subgraph.onInputAdded=this.onSubgraphNewInput.bind(this),this.subgraph.onInputRenamed=this.onSubgraphRenamedInput.bind(this),this.subgraph.onInputTypeChanged=this.onSubgraphTypeChangeInput.bind(this),this.subgraph.onInputRemoved=this.onSubgraphRemovedInput.bind(this),this.subgraph.onOutputAdded=this.onSubgraphNewOutput.bind(this),this.subgraph.onOutputRenamed=this.onSubgraphRenamedOutput.bind(this),this.subgraph.onOutputTypeChanged=this.onSubgraphTypeChangeOutput.bind(this),this.subgraph.onOutputRemoved=this.onSubgraphRemovedOutput.bind(this)}onGetInputs(){return[["enabled","boolean"]]}onDblClick(e,t,i){var s=this;setTimeout((function(){i.openSubgraph(s.subgraph)}),10)}onAction(e,t){LiteGraph.log_debug("subgraph","onAction",...arguments),this.subgraph.onAction(e,t)}onExecute(){if(this.enabled=this.getInputOrProperty("enabled"),this.enabled){if(this.inputs)for(let e=0;e<this.inputs.length;e++){let t=this.inputs[e],i=this.getInputData(e);this.subgraph.setInputData(t.name,i)}if(LiteGraph.log_verbose("subgraph","onExecute","subgraph runStep",this.subgraph),this.subgraph.runStep(),this.outputs)for(let e=0;e<this.outputs.length;e++){let t=this.outputs[e],i=this.subgraph.getOutputData(t.name);LiteGraph.log_verbose("subgraph","onExecute","outputDataSet",e,i),this.setOutputData(e,i)}}}sendEventToAllNodes(e,t,i){this.enabled&&(LiteGraph.log_debug("subgraph","sendEventToAllNodes",...arguments),this.subgraph.sendEventToAllNodes(e,t,i))}onDrawBackground(e,t,i,s){if(this.flags.collapsed)return;var n=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5,o=LiteGraph.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+n,this.size[0],LiteGraph.NODE_TITLE_HEIGHT);let a=LiteGraph.isInsideRectangle(s[0],s[1],this.pos[0],this.pos[1]+n,this.size[0]/2,LiteGraph.NODE_TITLE_HEIGHT);e.fillStyle=o?"#555":"#222",e.beginPath(),this._shape==LiteGraph.BOX_SHAPE?a?e.rect(0,n,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):e.rect(this.size[0]/2,n,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT):a?e.roundRect(0,n,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]):e.roundRect(this.size[0]/2,n,this.size[0]/2+1,LiteGraph.NODE_TITLE_HEIGHT,[0,0,8,8]),o?e.fill():e.fillRect(0,n,this.size[0]+1,LiteGraph.NODE_TITLE_HEIGHT),e.textAlign="center",e.font="24px Arial",e.fillStyle=o?"#DDD":"#999",e.fillText("+",.25*this.size[0],n+24),e.fillText("+",.75*this.size[0],n+24)}onMouseDown(e,t,i){var s=this.size[1]-LiteGraph.NODE_TITLE_HEIGHT+.5;console.log?.(0),t[1]>s&&(t[0]<this.size[0]/2?(console.log?.(1),i.showSubgraphPropertiesDialog(this)):(console.log?.(2),i.showSubgraphPropertiesDialogRight(this)))}computeSize(){var e=this.inputs?this.inputs.length:0,t=this.outputs?this.outputs.length:0;return[200,Math.max(e,t)*LiteGraph.NODE_SLOT_HEIGHT+LiteGraph.NODE_TITLE_HEIGHT]}onSubgraphTrigger(e){LiteGraph.log_debug("subgraph","onSubgraphTrigger",...arguments);var t=this.findOutputSlot(e);-1!=t&&this.triggerSlot(t)}onSubgraphNewInput(e,t){-1==this.findInputSlot(e)&&this.addInput(e,t)}onSubgraphRenamedInput(e,t){var i=this.findInputSlot(e);-1!=i&&(this.getInputInfo(i).name=t)}onSubgraphTypeChangeInput(e,t){var i=this.findInputSlot(e);-1!=i&&(this.getInputInfo(i).type=t)}onSubgraphRemovedInput(e){var t=this.findInputSlot(e);-1!=t&&this.removeInput(t)}onSubgraphNewOutput(e,t){-1==this.findOutputSlot(e)&&this.addOutput(e,t)}onSubgraphRenamedOutput(e,t){var i=this.findOutputSlot(e);-1!=i&&(this.getOutputInfo(i).name=t)}onSubgraphTypeChangeOutput(e,t){var i=this.findOutputSlot(e);-1!=i&&(this.getOutputInfo(i).type=t)}onSubgraphRemovedOutput(e){var t=this.findOutputSlot(e);-1!=t&&this.removeOutput(t)}getExtraMenuOptions(e){var t=this;return[{content:"Open",callback:function(){e.openSubgraph(t.subgraph)}}]}onResize(e){e[1]+=20}serialize(){var e=LiteGraph.LGraphNode.prototype.serialize.call(this);return e.subgraph=this.subgraph.serialize(),e}reassignSubgraphUUIDs(e){const t={nodeIDs:{},linkIDs:{}};for(const i of e.nodes){const e=i.id,s=LiteGraph.uuidv4();if(i.id=s,t.nodeIDs[e]||t.nodeIDs[s])throw new Error(`New/old node UUID wasn't unique in changed map! ${e} ${s}`);t.nodeIDs[e]=s,t.nodeIDs[s]=e}for(const i of e.links){const e=i[0],s=LiteGraph.uuidv4();if(i[0]=s,t.linkIDs[e]||t.linkIDs[s])throw new Error(`New/old link UUID wasn't unique in changed map! ${e} ${s}`);t.linkIDs[e]=s,t.linkIDs[s]=e;const n=i[1],o=i[3];if(!t.nodeIDs[n])throw new Error(`Old node UUID not found in mapping! ${n}`);if(i[1]=t.nodeIDs[n],!t.nodeIDs[o])throw new Error(`Old node UUID not found in mapping! ${o}`);i[3]=t.nodeIDs[o]}for(const i of e.nodes){if(i.inputs)for(const e of i.inputs)e.link&&(e.link=t.linkIDs[e.link]);if(i.outputs)for(const e of i.outputs)e.links&&(e.links=e.links.map((e=>t.linkIDs[e])))}for(const i of e.nodes)if("graph/subgraph"===i.type){const e=reassignGraphUUIDs(i.subgraph);t.nodeIDs.assign(e.nodeIDs),t.linkIDs.assign(e.linkIDs)}}clone(){var e=LiteGraph.createNode(this.type),t=this.serialize();if(LiteGraph.use_uuids){const e=LiteGraph.cloneObject(t.subgraph);this.reassignSubgraphUUIDs(e),t.subgraph=e}return delete t.id,delete t.inputs,delete t.outputs,e.configure(t),e}buildFromNodes(e){var t={};for(let i=0;i<e.length;++i)t[node.id]=e[i];for(let i=0;i<e.length;++i){let s=e[i];if(s.inputs)for(let e=0;e<s.inputs.length;++e){let i=s.inputs[e];if(!i||!i.link)continue;let n=s.graph.links[i.link];n&&(t[n.origin_id]||this.subgraph.addInput(i.name,n.type))}if(s.outputs)for(let e=0;e<s.outputs.length;++e){let i=s.outputs[e];if(i&&i.links&&i.links.length)for(let e=0;e<i.links.length;++e){let n=s.graph.links[i.links[e]];if(n&&!t[n.target_id])break}}}}static title_color="#334"}class GraphInput{static title="Input";static desc="Input of the graph";constructor(){this.addOutput("","number"),this.name_in_graph="",this.properties={name:"",type:"number",value:0};var e=this;this.name_widget=this.addWidget("text","Name",this.properties.name,(function(t){t&&e.setProperty("name",t)})),this.type_widget=this.addWidget("text","Type",this.properties.type,(function(t){e.setProperty("type",t)})),this.value_widget=this.addWidget("number","Value",this.properties.value,(function(t){e.setProperty("value",t)})),this.widgets_up=!0,this.size=[180,90]}onConfigure(){this.updateType()}updateType(){var e=this.properties.type;this.type_widget.value=e,"action"!=e&&"event"!=e||(e=LiteGraph.EVENT),this.outputs[0].type!==e&&(LiteGraph.isValidConnection(this.outputs[0].type,e)||this.disconnectOutput(0),this.outputs[0].type=e),this.properties.type=e,"number"==e?(this.value_widget.type="number",this.value_widget.value=Number()):"boolean"==e?(this.value_widget.type="toggle",this.value_widget.value=!(!this.value_widget.value||"false"===(this.value_widget.value+"").toLocaleLowerCase()||""===this.value_widget.value)):"string"==e?(this.value_widget.type="text",this.value_widget.value=this.value_widget.value+""):this.value_widget.type=null,this.properties.value=this.value_widget.value,this.graph&&this.name_in_graph&&this.graph.changeInputType(this.name_in_graph,e)}onPropertyChanged(e,t){if("name"==e){if(""==t||t==this.name_in_graph||"enabled"==t)return!1;this.graph&&(this.name_in_graph?this.graph.renameInput(this.name_in_graph,t):this.graph.addInput(t,this.properties.type)),this.name_widget.value=t,this.name_in_graph=t}else"type"==e&&this.updateType()}getTitle(){return this.flags.collapsed?this.properties.name:this.title}onAction(e,t){this.properties.type==LiteGraph.EVENT?(LiteGraph.log_debug("GraphInput","onAction","triggering slot",e,t),this.triggerSlot(0,t)):LiteGraph.log_debug("GraphInput","onAction","NOT eventAction TYPE","this",this,"arugments",...arguments)}onExecute(){var e=this.properties.name,t=this.graph.inputs[e];t?this.setOutputData(0,void 0!==t.value?t.value:this.properties.value):this.setOutputData(0,this.properties.value)}onRemoved(){this.name_in_graph&&this.graph.removeInput(this.name_in_graph)}}class GraphOutput{static title="Output";static desc="Output of the graph";constructor(){this.addInput("",""),this.name_in_graph="",this.properties={name:"",type:""},this.name_widget=this.addWidget("text","Name",this.properties.name,"name"),this.type_widget=this.addWidget("text","Type",this.properties.type,"type"),this.widgets_up=!0,this.size=[180,60]}onPropertyChanged(e,t){if("name"==e){if(""==t||t==this.name_in_graph||"enabled"==t)return!1;this.graph&&(this.name_in_graph?this.graph.renameOutput(this.name_in_graph,t):this.graph.addOutput(t,this.properties.type)),this.name_widget.value=t,this.name_in_graph=t}else"type"==e&&this.updateType()}updateType(){var e=this.properties.type;this.type_widget&&(this.type_widget.value=e),"action"!=e&&"event"!=e||(e=LiteGraph.EVENT),this.inputs[0].type!==e&&(LiteGraph.isValidConnection(this.inputs[0].type,e)||this.disconnectInput(0),this.inputs[0].type=e),this.properties.type=e,this.graph&&this.name_in_graph&&this.graph.changeOutputType(this.name_in_graph,e)}onExecute(){this._value=this.getInputData(0),this.graph.setOutputData(this.properties.name,this._value)}onAction(e,t){this.properties.type==LiteGraph.ACTION?(LiteGraph.log_debug("GraphOutput","onAction",...arguments),LiteGraph.log_debug("GraphOutput","onAction","graphTrigger",this.properties.name,t),this.triggerSlot(this.properties.name,t),this.graph.trigger(this.properties.name,t)):LiteGraph.log_debug("GraphOutput","onAction","skipping not ACTION type",this.properties.type,this.properties)}onRemoved(){this.name_in_graph&&this.graph.removeOutput(this.name_in_graph)}getTitle(){return this.flags.collapsed?this.properties.name:this.title}}class NodeFunction extends LGraphNode{static title="NodeFunction";static desc="Subgraph as function";constructor(){super(...arguments),this._subgraph=null,this._linking=!1,this.addWidget("button","subgraph_link",null,(function(e,t,i,s,n){console.debug("SUBGRAPHLINK",...arguments),i._linking?(i._linking=!1,e.name="subgraph_link"):(i._linking=!0,e.name="click on subgraph")})),this.addWidget("button","refresh",null,this.refreshFunctions_byEvent),this.addWidget("button","CALL",null,this.onBtnExecute),this._wCombo=this.addWidget("combo","functions",this.functionChange,{values:[]}),this._subMap=[],this._subGFuncNode=null,this.properties={func_subgraph_id:null}}onBtnExecute(e,t,i,s,n,o){console.error("SELFEXECUTE",this,...arguments),i.doExecute()}functionChange(e,t,i,s,n,o){console.error("FUNCTIONCHANGE","this",this),console.error("FUNCTIONCHANGE","arguments",...arguments),console.error("FUNCTIONCHANGE","node",i),i.btnSetFunction(null,t,i,s,n)}onConfigure(){this.ensureSubFunction()}onExecute(){this.ensureSubFunction()}onAdded(){null!==this.properties.func_subgraph_id&&void 0!==this.properties.func_subgraph_id&&(this._wCombo.value=this.properties.func_subgraph_id),this.refreshFunctions()}refreshFunctions_byEvent(e,t,i,s,n){i.refreshFunctions.bind(i)}refreshFunctions(){const e=this.graph?.findNodesByClass(Subgraph);console.debug("NODEFUNCTION refreshFunctions",this,e,this._wCombo),this._wCombo.options.values={},this._subMap=[],e&&e.length&&e.forEach((e=>{this._wCombo.options.values[e.id]=e.title,this._subMap.push(e.id),this.properties.func_subgraph_id===e.id&&(this._wCombo.value=e.id)}))}ensureSubFunction(){this._subGFuncNode||null!==this.properties.func_subgraph_id&&void 0!==this.properties.func_subgraph_id&&(this.lookForFuncNodeById(this.properties.func_subgraph_id),this.refreshFunctions())}lookForFuncNodeById(e){const t=this.graph.getNodeById(e);t?(console.error("NODEFUNCTION CALL","this?",this),this.updateSubFunction(t)):(console.error("NODEFUNCTION CALL","nodeNotFound",e),this.updateSubFunction(!1))}btnSetFunction(e,t,i,s,n){console.debug("NODEFUNCTION CALL",i,i._wCombo.value),this.lookForFuncNodeById(i._wCombo.value)}updateSubFunction(e){this._subGFuncNode=e,console.debug("REFRESHSLOTS",this),null!=e&&e?(this.properties.func_subgraph_id=e.id,e.inputs.forEach(((e,t)=>{void 0!==this.inputs[t]&&this.inputs[t].type==e.type||(this.inputs[t]={name:e.name,type:e.type})})),e.outputs.forEach(((e,t)=>{void 0!==this.outputs[t]&&this.outputs[t].type==e.type||(this.outputs[t]={name:e.name,type:e.type})})),this.autoSize()):(this.properties.func_subgraph_id=null,this.inputs=[],this.outputs=[]),this.bindEvents()}bindEvents(){const e=this._subGFuncNode;console.debug("BINDEVENTS",this),this.onExecute=null!=e&&e?function(){console.debug("NODEFUNCTION executing",this),this.inputs.forEach(((t,i)=>{const s=this.getInputData(i);e.inputs[i].hard_coded_value=s,console.debug("read and set input data",i,s)})),console.debug("execute function node",e),e.doExecute(),this.outputs.forEach(((t,i)=>{const s=e.getOutputData(i);this.setOutputData(i,s),console.debug("read and set output node data",i,s)})),this.inputs.forEach(((t,i)=>{delete e.inputs[i].hard_coded_value,console.debug("clean hard coded input data",i)}))}:function(){console.debug("NODEFUNCTION has no functionset",this)}}}function getGlobalObject(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw new Error("Unable to determine global object")}function setGlobalVariable(e,t){getGlobalObject()[e]=t}function getGlobalVariable(e){return getGlobalObject()[e]}class LiteGraphClass{VERSION="a0.11.0";LLink=null;LGraph=null;LGraphNode=null;LGraphGroup=null;LGraphCanvas=null;Subgraph=null;GraphInput=null;GraphOutput=null;DragAndScale=null;ContextMenuClass=null;ContextMenu=null;CallbackHandler=null;CANVAS_GRID_SIZE=10;NODE_TITLE_HEIGHT=30;NODE_TITLE_TEXT_Y=20;NODE_SLOT_HEIGHT=20;NODE_WIDGET_HEIGHT=20;NODE_WIDTH=140;NODE_MIN_WIDTH=50;NODE_MIN_SIZE=[50,0];NODE_COLLAPSED_RADIUS=10;NODE_COLLAPSED_WIDTH=80;NODE_TITLE_COLOR="#999";NODE_SELECTED_TITLE_COLOR="#FFF";NODE_TEXT_SIZE=14;NODE_TEXT_COLOR="#AAA";NODE_SUBTEXT_SIZE=12;NODE_DEFAULT_COLOR="#333";NODE_DEFAULT_BGCOLOR="#353535";NODE_DEFAULT_BOXCOLOR="#666";NODE_DEFAULT_SHAPE="box";NODE_BOX_OUTLINE_COLOR="#FFF";DEFAULT_SHADOW_COLOR="rgba(0,0,0,0.5)";DEFAULT_GROUP_FONT=24;WIDGET_BGCOLOR="#222";WIDGET_OUTLINE_COLOR="#666";WIDGET_TEXT_COLOR="#DDD";WIDGET_SECONDARY_TEXT_COLOR="#999";LINK_COLOR="#9A9";EVENT_LINK_COLOR="#A86";CONNECTING_LINK_COLOR="#AFA";MAX_NUMBER_OF_NODES=1e3;DEFAULT_POSITION=[100,100];VALID_SHAPES=["default","box","round","card"];BOX_SHAPE=1;ROUND_SHAPE=2;CIRCLE_SHAPE=3;CARD_SHAPE=4;ARROW_SHAPE=5;GRID_SHAPE=6;INPUT=1;OUTPUT=2;EVENT=-1;ACTION=-1;NODE_MODES=["Always","On Event","Never","On Trigger","On Request"];NODE_MODES_COLORS=["#666","#422","#333","#224","#626"];ALWAYS=0;ON_EVENT=1;NEVER=2;ON_TRIGGER=3;ON_REQUEST=4;UP=1;DOWN=2;LEFT=3;RIGHT=4;CENTER=5;LINK_RENDER_MODES=["Straight","Linear","Spline"];STRAIGHT_LINK=0;LINEAR_LINK=1;SPLINE_LINK=2;NORMAL_TITLE=0;NO_TITLE=1;TRANSPARENT_TITLE=2;AUTOHIDE_TITLE=3;VERTICAL_LAYOUT="vertical";proxy=null;node_images_path="";catch_exceptions=!0;throw_errors=!0;allow_scripts=!1;use_deferred_actions=!0;registered_node_types={};node_types_by_file_extension={};Nodes={};Globals={};searchbox_extras={};auto_sort_node_types=!1;node_box_coloured_when_on=!1;node_box_coloured_by_mode=!1;dialog_close_on_mouse_leave=!0;dialog_close_on_mouse_leave_delay=500;shift_click_do_break_link_from=!0;click_do_break_link_to=!1;search_filter_enabled=!1;search_hide_on_mouse_leave=!0;search_hide_on_mouse_leave_time=1200;search_show_all_on_open=!0;show_node_tooltip=!1;show_node_tooltip_use_descr_property=!1;auto_load_slot_types=!1;registered_slot_in_types={};registered_slot_out_types={};slot_types_in=[];slot_types_out=[];slot_types_default_in=[];slot_types_default_out=[];graphDefaultConfig={align_to_grid:!0,links_ontop:!1};alt_drag_do_clone_nodes=!1;alt_shift_drag_connect_clone_with_input=!0;do_add_triggers_slots=!1;allow_multi_output_for_events=!0;middle_click_slot_add_default_node=!1;release_link_on_empty_shows_menu=!1;two_fingers_opens_menu=!1;backspace_delete=!0;ctrl_shift_v_paste_connect_unselected_outputs=!1;actionHistory_enabled=!1;actionHistoryMaxSave=300;refreshAncestorsOnTriggers=!1;refreshAncestorsOnActions=!1;ensureUniqueExecutionAndActionCall=!1;use_uuids=!1;context_menu_filter_enabled=!1;canRemoveSlots=!0;canRemoveSlots_onlyOptional=!0;canRenameSlots=!0;canRenameSlots_onlyOptional=!0;ensureNodeSingleExecution=!1;ensureNodeSingleAction=!1;preventAncestorRecalculation=!1;allowMultiOutputForEvents=!1;reprocess_slot_while_node_configure=!1;properties_allow_input_binding=!1;properties_allow_output_binding=!1;log_methods=["error","warn","info","log","debug"];cb_handler=!1;debug=!0;debug_level=2;constructor(){}initialize(){this.callbackhandler_setup(),this.LLink=LLink,this.LGraph=LGraph,this.LGraphNode=LGraphNode,this.LGraphGroup=LGraphGroup,this.LGraphCanvas=LGraphCanvas,this.Subgraph=Subgraph,this.GraphInput=GraphInput,this.GraphOutput=GraphOutput,this.DragAndScale=DragAndScale,this.ContextMenuClass=ContextMenu,this.ContextMenu=function(){return new ContextMenu(...arguments)},this.CallbackHandler=CallbackHandler}includeBasicNodes(){this.registerNodeType("graph/subgraph",Subgraph),this.registerNodeType("graph/input",GraphInput),this.registerNodeType("graph/output",GraphOutput),this.registerNodeType("graph/function",NodeFunction)}callbackhandler_setup(){this.cb_handler||(this.cb_handler=new CallbackHandler(this),this.registerCallbackHandler=function(){return this.cb_handler.registerCallbackHandler(...arguments)},this.unregisterCallbackHandler=function(){return this.cb_handler.unregisterCallbackHandler(...arguments)},this.processCallbackHandlers=function(){return this.cb_handler.processCallbackHandlers(...arguments)})}registerCallbackHandler(){this.callbackhandler_setup(),this.cb_handler.registerCallbackHandler(...arguments)}unregisterCallbackHandler(){this.callbackhandler_setup(),this.cb_handler.unregisterCallbackHandler(...arguments)}processCallbackHandlers(){this.callbackhandler_setup(),this.cb_handler.processCallbackHandlers(...arguments)}logging_set_level(e){this.debug_level=Number(e)}logging(e){if(!this.debug&&this.debug_level>0&&(this.debug_level=0),e>this.debug_level)return;function t(t){let i=[];(e<0||e>4)&&i.push("loglvl:"+e);for(let e=1;e<t.length;e++)void 0!==t[e]&&i.push(t[e]);return i}let i="debug";if(e>=0&&e<=4&&(i=["error","warn","info","log","debug"][e]),"function"!=typeof console[i])throw console.warn("[LG-log] invalid console method",i,t(arguments)),new RangeError;console[i]("[LG]",...t(arguments))}log_error(){this.logging(0,...arguments)}log_warn(){this.logging(1,...arguments)}log_info(){this.logging(2,...arguments)}log_log(){this.logging(3,...arguments)}log_debug(){this.logging(4,...arguments)}log_verbose(){this.logging(5,...arguments)}registerNodeType(e,t){if(!t.prototype)throw new Error("Cannot register a simple object, it must be a class with a prototype");t.type=e,this.log_debug("registerNodeType","start",e);const i=t.name,s=e.lastIndexOf("/");t.category=e.substring(0,s),t.title||(t.title=i);const n=Object.getOwnPropertyDescriptors(LGraphNode.prototype);Object.keys(n).forEach((e=>{t.prototype.hasOwnProperty(e)||Object.defineProperty(t.prototype,e,n[e])}));const o=this.registered_node_types[e];if(o&&this.log_debug("registerNodeType","replacing node type",e,o),!Object.prototype.hasOwnProperty.call(t.prototype,"shape")&&(Object.defineProperty(t.prototype,"shape",{set:function(e){switch(e){case"default":delete this._shape;break;case"box":this._shape=LiteGraph.BOX_SHAPE;break;case"round":this._shape=LiteGraph.ROUND_SHAPE;break;case"circle":this._shape=LiteGraph.CIRCLE_SHAPE;break;case"card":this._shape=LiteGraph.CARD_SHAPE;break;default:this._shape=e}},get:function(){return this._shape},enumerable:!0,configurable:!0}),t.supported_extensions))for(let e in t.supported_extensions){const i=t.supported_extensions[e];i&&i.constructor===String&&(this.node_types_by_file_extension[i.toLowerCase()]=t)}if(this.registered_node_types[e]=t,t.constructor.name&&(this.Nodes[i]=t),this.processCallbackHandlers("onNodeTypeRegistered",{def_cb:this.onNodeTypeRegistered},e,t),o&&this.processCallbackHandlers("onNodeTypeReplaced",{def_cb:this.onNodeTypeReplaced},e,t,o),t.prototype.onPropertyChange&&LiteGraph.log_warn("LiteGraph node class "+e+" has onPropertyChange method, it must be called onPropertyChanged with d at the end"),t.supported_extensions)for(var a=0;a<t.supported_extensions.length;a++){var r=t.supported_extensions[a];r&&r.constructor===String&&(this.node_types_by_file_extension[r.toLowerCase()]=t)}if(this.log_debug("registerNodeType","type registered",e),this.auto_load_slot_types){this.log_debug("registerNodeType","auto_load_slot_types, create empy tmp node",e),new t(t.title??"tmpnode").post_constructor()}}unregisterNodeType(e){const t=e.constructor===String?this.registered_node_types[e]:e;if(!t)throw new Error("node type not found to unregister: "+e);delete this.registered_node_types[t.type],t.constructor.name&&delete this.Nodes[t.constructor.name]}registerNodeAndSlotType(e,t,i=!1){const s=(e.constructor===String&&"anonymous"!==this.registered_node_types[e]?this.registered_node_types[e]:e).constructor.type;let n=[];n="string"==typeof t?t.split(","):t==this.EVENT||t==this.ACTION?["_event_"]:["*"];for(let e=0;e<n.length;++e){let t=n[e];""===t&&(t="*");const o=i?"registered_slot_out_types":"registered_slot_in_types";void 0===this[o][t]&&(this[o][t]={nodes:[]}),this[o][t].nodes.includes(s)||this[o][t].nodes.push(s),i?this.slot_types_out.includes(t.toLowerCase())||(this.slot_types_out.push(t.toLowerCase()),this.slot_types_out.sort()):this.slot_types_in.includes(t.toLowerCase())||(this.slot_types_in.push(t.toLowerCase()),this.slot_types_in.sort())}}buildNodeClassFromObject(e,t){var i="";if(t.inputs)for(let e=0;e<t.inputs.length;++e){let s=t.inputs[e][0],n=t.inputs[e][1];n&&n.constructor===String&&(n='"'+n+'"'),i+="this.addInput('"+s+"',"+n+");\n"}if(t.outputs)for(let e=0;e<t.outputs.length;++e){let s=t.outputs[e][0],n=t.outputs[e][1];n&&n.constructor===String&&(n='"'+n+'"'),i+="this.addOutput('"+s+"',"+n+");\n"}if(t.properties)for(let e in t.properties){let s=t.properties[e];s&&s.constructor===String&&(s='"'+s+'"'),i+="this.addProperty('"+e+"',"+s+");\n"}i+="if(this.onCreate)this.onCreate()";var s=Function(i);for(let e in t)"inputs"!=e&&"outputs"!=e&&"properties"!=e&&(s.prototype[e]=t[e]);return s.title=t.title||e.split("/").pop(),s.desc=t.desc||"Generated from object",this.registerNodeType(e,s),s}wrapFunctionAsNode(e,t,i,s,n){const o=LiteGraph.getParameterNames(t),a=o.map(((e,t)=>`this.addInput('${e}', ${i?.[t]?`'${i[t]}'`:"0"});`)).join("\n"),r=s?`'${s}'`:0,l=n?`this.properties = ${JSON.stringify(n)};`:"",h=new Function(`\n            ${a}\n            this.addOutput('out', ${r});\n            ${l}\n        `);return h.title=e.split("/").pop(),h.desc=`Generated from ${t.name}`,h.prototype.onExecute=function(){const e=o.map(((e,t)=>this.getInputData(t))),i=t.apply(this,e);this.setOutputData(0,i)},this.registerNodeType(e,h),h}wrapObjectAsNodeCollection(e,t){if("object"!=typeof e)return;const i=Object.getOwnPropertyDescriptors(e);Object.keys(i).forEach((i=>{if(console.debug("cyclingProps",t,i,e,typeof e[i]),"function"==typeof e[i]){try{console.info("**",e[i].arguments)}catch(e){}this.wrapFunctionAsNode(t+"/"+i,e[i])}}))}clearRegisteredTypes(){this.registered_node_types={},this.node_types_by_file_extension={},this.Nodes={},this.searchbox_extras={}}addNodeMethod(e,t){for(var i in LGraphNode.prototype[e]=t,this.registered_node_types){var s=this.registered_node_types[i];s.prototype[e]&&(s.prototype["_"+e]=s.prototype[e]),s.prototype[e]=t}}createNode(e,t,i={}){const s=this.registered_node_types[e]??null;if(!s)return this.log_debug(`GraphNode type "${e}" not registered.`),null;LiteGraph.log_verbose("createNode",e,t,i,s),t=t??s.title??e;let n=null;if(LiteGraph.catch_exceptions)try{n=new s(t)}catch(e){return this.log_error("createNode",e),null}else n=new s(t);return n.post_constructor(),n.size_basic=n.size,n.type=e,n.title??=t,n.properties??={},n.properties_info??=[],n.flags??={},n.size??=n.computeSize(),n.pos??=LiteGraph.DEFAULT_POSITION.concat(),n.mode??=LiteGraph.ALWAYS,Object.assign(n,i),LiteGraph.log_verbose("createNode","created",n,n.processCallbackHandlers),n.processCallbackHandlers("onNodeCreated",{def_cb:n.onNodeCreated}),n}getNodeType(e){return this.registered_node_types[e]}getNodeTypesInCategory(e,t){const i=Object.values(this.registered_node_types).filter((i=>i.filter===t&&(""===e?null===i.category:i.category===e)));return this.auto_sort_node_types&&i.sort(((e,t)=>e.title.localeCompare(t.title))),i}getNodeTypesCategories(e){const t={"":1};Object.values(this.registered_node_types).forEach((i=>{i.category&&!i.skip_list&&i.filter===e&&(t[i.category]=1)}));const i=Object.keys(t);return this.auto_sort_node_types?i.sort():i}reloadNodes(e){var t=document.getElementsByTagName("script"),i=[];for(let e=0;e<t.length;e++)i.push(t[e]);var s=document.getElementsByTagName("head")[0];e=document.location.href+e;for(let t=0;t<i.length;t++){var n=i[t].src;if(n&&n.substr(0,e.length)==e)try{this.log_debug("Reloading: "+n);var o=document.createElement("script");o.type="text/javascript",o.src=n,s.appendChild(o),s.removeChild(i[t])}catch(e){if(LiteGraph.throw_errors)throw e;this.log_debug("Error while reloading "+n)}}this.log_debug("Nodes reloaded")}parseStringifyObject(e,t){return this.cloneObject(e,t)}cloneObject(e,t){if(null==e)return null;const i=JSON.parse(JSON.stringify(e));if(!t)return i;for(const e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e]);return t}uuidv4(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^16*Math.random()>>e/4).toString(16)))}isValidConnection(e,t){if(""!==e&&"*"!==e||(e=0),""!==t&&"*"!==t||(t=0),!e||!t||e===t||e===LiteGraph.EVENT&&t===LiteGraph.ACTION)return!0;if(e=String(e).toLowerCase(),t=String(t).toLowerCase(),!e.includes(",")&&!t.includes(","))return e===t;const i=e.split(","),s=t.split(",");for(const e of i)for(const t of s)if(this.isValidConnection(e,t))return!0;return!1}registerSearchboxExtra(e,t,i){this.searchbox_extras[t.toLowerCase()]={type:e,desc:t,data:i}}fetchFile(e,t,i,s){if(!e)return null;if(t=t||"text",e.constructor===String)return"http"==e.substr(0,4)&&LiteGraph.proxy&&(e=LiteGraph.proxy+e.substr(e.indexOf(":")+3)),fetch(e).then((e=>{if(!e.ok)throw new Error("File not found");return"arraybuffer"==t?e.arrayBuffer():"text"==t||"string"==t?e.text():"json"==t?e.json():"blob"==t?e.blob():void 0})).then((e=>{i&&i(e)})).catch((t=>{this.log_error("error fetching file:",e),s&&s(t)}));if(e.constructor===File||e.constructor===Blob){var n=new FileReader;if(n.onload=e=>{var s=e.target.result;"json"==t&&(s=JSON.parse(s)),i&&i(s)},"arraybuffer"==t)return n.readAsArrayBuffer(e);if("text"==t||"json"==t)return n.readAsText(e);if("blob"==t)return n.readAsBinaryString(e)}return null}compareObjects(e,t){const i=Object.keys(e);return i.length===Object.keys(t).length&&i.every((i=>e[i]===t[i]))}distance(e,t){const[i,s]=e,[n,o]=t;return Math.sqrt((n-i)**2+(o-s)**2)}colorToString(e){return"rgba("+Math.round(255*e[0]).toFixed()+","+Math.round(255*e[1]).toFixed()+","+Math.round(255*e[2]).toFixed()+","+(4==e.length?e[3].toFixed(2):"1.0")+")"}textCalculateMaxWidth(e){}canvasFillTextMultiline(e,t,i,s,n,o){var a=(t+"").trim().split(" "),r="",l={lines:[],maxW:0,height:0};if(a.length>1)for(var h=0;h<a.length;h++){var p=r+a[h]+" ",c=e.measureText(p).width;c>n&&h>0?(e.fillText(r,i,s+o*l.lines.length),r=a[h]+" ",l.max=c,l.lines.push(r)):r=p}else r=a[0];return e.fillText(r,i,s+o*l.lines.length),l.lines.push(r),l.height=o*l.lines.length||o,l}isInsideRectangle(e,t,i,s,n,o){return e>i&&e<i+n&&t>s&&t<s+o}isBoundingInsideRectangle(e,t,i,s,n){let o=e[0],a=e[1];return o>t&&o<t+s&&a>i&&a<i+n&&(o=e[0]+e[2],a=e[1]+e[3],o>t&&o<t+s&&a>i&&a<i+n)}growBounding(e,t,i){t<e[0]?e[0]=t:t>e[2]&&(e[2]=t),i<e[1]?e[1]=i:i>e[3]&&(e[3]=i)}isInsideBounding(e,t){return e[0]>=t[0][0]&&e[1]>=t[0][1]&&e[0]<=t[1][0]&&e[1]<=t[1][1]}overlapBounding(e,t,i){i=i||0;const s=e[0]+e[2]+i,n=e[1]+e[3]+i,o=t[0]+t[2]+i,a=t[1]+t[3]+i;return!(e[0]>o||e[1]>a||s<t[0]||n<t[1])}hex2num(e){"#"==e.charAt(0)&&(e=e.slice(1)),e=e.toUpperCase();for(var t,i,s="0123456789ABCDEF",n=new Array(3),o=0,a=0;a<6;a+=2)t=s.indexOf(e.charAt(a)),i=s.indexOf(e.charAt(a+1)),n[o]=16*t+i,o++;return n}num2hex(e){for(var t,i,s="0123456789ABCDEF",n="#",o=0;o<3;o++)t=e[o]/16,i=e[o]%16,n+=s.charAt(t)+s.charAt(i);return n}extendClass=(e,t)=>{for(let i in t)e.hasOwnProperty(i)||(e[i]=t[i]);if(t.prototype)for(let i in t.prototype)t.prototype.hasOwnProperty(i)&&(e.prototype.hasOwnProperty(i)||(t.prototype.__lookupGetter__(i)?e.prototype.__defineGetter__(i,t.prototype.__lookupGetter__(i)):e.prototype[i]=t.prototype[i],t.prototype.__lookupSetter__(i)&&e.prototype.__defineSetter__(i,t.prototype.__lookupSetter__(i))))};getParameterNames=function(e){return(e+"").replace(/[/][/].*$/gm,"").replace(/\s+/g,"").replace(/[/][*][^/*]*[*][/]/g,"").split("){",1)[0].replace(/^[^(]*[(]/,"").replace(/=[^,]+/g,"").split(",").filter(Boolean)};clamp=(e,t,i)=>t>e?t:i<e?i:e;closeAllContextMenus=()=>{LiteGraph.log_verbose("LiteGraph.closeAllContextMenus is deprecated in favor of ContextMenu.closeAll()"),ContextMenu.closeAll()};getTime(){if("undefined"!=typeof performance)return performance.now();if("undefined"==typeof Date||!Date.now){if("undefined"!=typeof process){const e=process.hrtime();return.001*e[0]+1e-6*e[1]}return(new Date).getTime()}}formatNumber(e,t=3){return NaN===(e=Number(e))?"":e.toFixed(t).replace(/(\.\d*[1-9])0+$|\.0*$/,"$1")}}if("undefined"==typeof window||window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||(e=>{window.setTimeout(e,1e3/60)})),getGlobalObject(),!getGlobalVariable("LiteGraph")){setGlobalVariable("LiteGraph",new LiteGraphClass);let e=getGlobalVariable("LiteGraph");e.log_info("LiteGraph instantiated",e.getTime())}var LiteGraph=getGlobalVariable("LiteGraph");exports.CallbackHandler=CallbackHandler,exports.ContextMenu=ContextMenu,exports.DragAndScale=DragAndScale,exports.GraphInput=GraphInput,exports.GraphOutput=GraphOutput,exports.LGraph=LGraph,exports.LGraphCanvas=LGraphCanvas,exports.LGraphGroup=LGraphGroup,exports.LGraphNode=LGraphNode,exports.LLink=LLink,exports.LiteGraph=LiteGraph,exports.NodeFunction=NodeFunction,exports.Subgraph=Subgraph,exports.getGlobalObject=getGlobalObject,exports.getGlobalVariable=getGlobalVariable,exports.setGlobalVariable=setGlobalVariable;
